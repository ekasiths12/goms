<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Group Bills - Garment Management System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1e1e1e;
            color: #eceff1;
            font-size: 12px;
        }

        /* Navigation Bar */
        .nav-bar {
            background: #2c2c2c;
            border-bottom: 2px solid #5c6bc0;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
        }

        .nav-tabs {
            display: flex;
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .nav-tab {
            display: block;
            padding: 15px 20px;
            color: #b0bec5;
            text-decoration: none;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }

        .nav-tab:hover {
            background: #424242;
            color: #ffffff;
        }

        .nav-tab.active {
            color: #5c6bc0;
            border-bottom-color: #5c6bc0;
            background: #1e1e1e;
        }

        .nav-user {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .nav-user span {
            color: #b0bec5;
            font-size: 12px;
        }

        .logout-btn {
            background: #d32f2f;
            color: #ffffff;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: #f44336;
        }

        /* Main Content */
        .main-content {
            margin-top: 60px;
            padding: 20px;
            min-height: calc(100vh - 60px);
        }

        /* Filter Controls */
        .filter-controls {
            background: #2c2c2c;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        /* Action Buttons */
        .action-buttons {
            background: #2c2c2c;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .action-buttons button {
            background: #5c6bc0;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.3s ease;
        }

        .action-buttons button:hover {
            background: #3949ab;
        }

        .action-buttons button:disabled {
            background: #666;
            cursor: not-allowed;
        }

        .action-buttons .btn-danger {
            background: #f44336;
        }

        .action-buttons .btn-danger:hover {
            background: #d32f2f;
        }

        .action-buttons .btn-warning {
            background: #ff9800;
        }

        .action-buttons .btn-warning:hover {
            background: #f57c00;
        }

        .action-buttons .btn-info {
            background: #2196f3;
        }

        .action-buttons .btn-info:hover {
            background: #1976d2;
        }

        .filter-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-group label {
            font-size: 12px;
            color: #b0bec5;
            font-weight: 500;
        }

        .filter-select, .filter-input {
            background: #424242;
            border: 1px solid #555;
            color: #eceff1;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 14px;
            min-width: 120px;
        }

        .filter-select:focus, .filter-input:focus {
            outline: none;
            border-color: #5c6bc0;
        }

        /* Table Styles */
        .table-container {
            background: #2c2c2c;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        .data-table th {
            background: #3949ab;
            color: #eceff1;
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .data-table td {
            padding: 10px 8px;
            border-bottom: 1px solid #444;
        }

        .data-table tr:hover {
            background: #3c3c3c;
        }

        .data-table tr.selected {
            background: #5c6bc0 !important;
            color: #ffffff;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: #3949ab;
            color: #fff;
        }

        .btn-primary:hover {
            background: #5c6bc0;
        }

        .btn-secondary {
            background: #757575;
            color: #fff;
        }

        .btn-secondary:hover {
            background: #9e9e9e;
        }

        .btn-success {
            background: #388e3c;
            color: #fff;
        }

        .btn-success:hover {
            background: #4caf50;
        }

        .btn-warning {
            background: #f57c00;
            color: #fff;
        }

        .btn-warning:hover {
            background: #ff9800;
        }

        .btn-danger {
            background: #d32f2f;
            color: #fff;
        }

        .btn-danger:hover {
            background: #f44336;
        }

        .btn-info {
            background: #1976d2;
            color: #fff;
        }

        .btn-info:hover {
            background: #2196f3;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background: #2c2c2c;
            margin: 5% auto;
            padding: 20px;
            border-radius: 8px;
            width: 80%;
            max-width: 900px;
            color: #eceff1;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #555;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #fff;
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            padding-top: 15px;
            border-top: 1px solid #555;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #b0bec5;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #555;
            border-radius: 4px;
            background: #424242;
            color: #eceff1;
            font-size: 12px;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #5c6bc0;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
            margin: 0;
        }

        /* Checkbox styling */
        .checkbox-wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .checkbox-wrapper input[type="checkbox"] {
            margin: 0;
            cursor: pointer;
            width: 16px;
            height: 16px;
            accent-color: #5c6bc0;
        }

        /* Multi-level table structure */
        .parent-row {
            background: #2c2c2c;
            font-weight: 600;
        }

        .child-row {
            background: #3c3c3c;
            font-weight: 500;
        }

        .sub-child-row {
            background: #4c4c4c;
            font-weight: 400;
        }

        .expand-indicator {
            cursor: pointer;
            color: #4caf50;
            font-weight: bold;
            margin-right: 5px;
            font-size: 14px;
            display: inline-block;
            min-width: 16px;
        }

        .expand-indicator.expanded {
            transform: rotate(90deg);
        }

        /* Indentation for different levels */
        .child-row td:nth-child(2) {
            padding-left: 20px;
        }

        .sub-child-row td:nth-child(2) {
            padding-left: 40px;
        }

        .detail-row td:nth-child(2) {
            padding-left: 60px;
        }

        /* Make it clear that rows are not clickable */
        .data-table tr {
            cursor: default;
        }

        .data-table tr:hover {
            background: #424242 !important;
        }

        .data-table tr:hover td {
            background: #424242 !important;
        }

        /* Loading and Error States */
        .loading-state {
            text-align: center;
            padding: 40px;
            color: #b0bec5;
        }

        .error-state {
            text-align: center;
            padding: 40px;
            color: #e57373;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .filter-row {
                flex-direction: column;
                align-items: stretch;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .table-container {
                overflow-x: auto;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="nav-bar">
        <ul class="nav-tabs">
            <li><a href="fabric-invoices.html" class="nav-tab">Fabric Invoices</a></li>
            <li><a href="stitching-records.html" class="nav-tab">Stitching Records</a></li>
            <li><a href="packing-lists.html" class="nav-tab">Packing Lists</a></li>
            <li><a href="group-bills.html" class="nav-tab active">Group Bills</a></li>
        </ul>
        <div class="nav-user">
            <span id="currentUser"></span>
            <button onclick="logout()" class="logout-btn">Logout</button>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Filter Controls -->
        <div class="filter-controls">
            <div class="filter-row">
                <div class="filter-group">
                    <label>Customer:</label>
                    <input type="text" id="filterCustomer" class="filter-input" placeholder="Customer name">
                </div>
                
                <div class="filter-group">
                    <label>Group Number:</label>
                    <input type="text" id="filterGroupNumber" class="filter-input" placeholder="Group number">
                </div>
                
                <div class="filter-group">
                    <label>From:</label>
                    <input type="text" id="filterDateFrom" class="filter-input" placeholder="DD/MM/YY" oninput="formatDateInput(this)">
                </div>
                
                <div class="filter-group">
                    <label>To:</label>
                    <input type="text" id="filterDateTo" class="filter-input" placeholder="DD/MM/YY" oninput="formatDateInput(this)">
                </div>
                
                <button class="btn btn-secondary" onclick="clearFilters()">Clear Filter</button>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons">
            <button id="downloadStitchingBtn" class="btn-info" onclick="downloadSelectedStitchingPDF()" disabled>
                Download Stitching PDF
            </button>
            <button id="downloadFabricBtn" class="btn-warning" onclick="downloadSelectedFabricPDF()" disabled>
                Download Fabric PDF
            </button>
            <button id="deleteBtn" class="btn-danger" onclick="deleteSelectedGroupBill()" disabled>
                Delete Group Bill
            </button>
        </div>
        
        <div style="margin-bottom: 20px;">
            <button class="btn btn-secondary" onclick="refreshGroupBillsTable()">Refresh</button>
            <button class="btn btn-success" onclick="exportGroupBillsData()">Export Data</button>
        </div>

        <!-- Group Bills Table -->
        <div class="table-container">
            <table id="groupBillsTable" class="data-table">
                <thead>
                    <tr>
                        <th style="width: 30px;">
                            <input type="checkbox" id="selectAllCheckbox" onclick="toggleSelectAll()">
                        </th>
                        <th style="width: 100px;">Bill #</th>
                        <th style="width: 120px;">PL #</th>
                        <th style="width: 80px;">Garment</th>
                        <th style="width: 100px;">Fabric</th>
                        <th style="width: 80px;">Color</th>
                        <th style="width: 120px;">Customer</th>
                        <th style="width: 100px;">Tax Inv #</th>
                        <th style="width: 100px;">Fabric Inv.</th>
                        <th style="width: 100px;">Fabric DN.</th>
                        <th style="width: 70px;">Fab Used</th>
                        <th style="width: 70px;">Fab Cost</th>
                        <th style="width: 80px;">Fab Value</th>
                        <th style="width: 40px;">S</th>
                        <th style="width: 40px;">M</th>
                        <th style="width: 40px;">L</th>
                        <th style="width: 40px;">XL</th>
                        <th style="width: 40px;">XXL</th>
                        <th style="width: 40px;">XXXL</th>
                        <th style="width: 70px;">Total Qty</th>
                        <th style="width: 70px;">Sew Cost</th>
                        <th style="width: 80px;">Sew Value</th>
                        <th style="width: 80px;">Created At</th>
                        <th style="width: 100px;">Actions</th>
                    </tr>
                </thead>
                <tbody id="groupBillsTableBody">
                    <!-- Data will be loaded here -->
                </tbody>
            </table>
        </div>
    </div>



    <script>
        // Group Bills Functions
        let groupBillsData = [];
        let selectedGroupBillIds = [];

        // API Base URL - works for both local development and Railway
        const getApiBaseUrl = () => {
            // Use the same domain as the current page to avoid CORS issues
            return window.location.origin;
        };

        // Load data when page loads
        // Check authentication
        function checkAuth() {
            const isLoggedIn = localStorage.getItem('gms_logged_in');
            if (isLoggedIn !== 'true') {
                window.location.href = 'login.html';
                return false;
            }
            return true;
        }

        window.addEventListener('load', async () => {
            console.log('🔄 Group Bills page loaded');
            
            // Check authentication first
            if (!checkAuth()) {
                return;
            }
            
            // Display current user
            const username = localStorage.getItem('gms_username');
            document.getElementById('currentUser').textContent = `Welcome, ${username}`;
            
            await loadGroupBillsData();
        });

        async function loadGroupBillsData() {
            console.log('🔄 loadGroupBillsData called');
            
            const tbody = document.getElementById('groupBillsTableBody');
            if (!tbody) {
                console.error('❌ Group bills table body not found');
                return;
            }
            
            console.log('✅ Found group bills table body, showing loading state');
            // Show loading state
            tbody.innerHTML = '<tr><td colspan="25" style="text-align: center; padding: 20px; color: #b0bec5;">Loading group bills data...</td></tr>';
            
            try {
                // Build query parameters
                const params = new URLSearchParams();
                const customer = document.getElementById('filterCustomer').value;
                const groupNumber = document.getElementById('filterGroupNumber').value;
                const dateFrom = document.getElementById('filterDateFrom').value;
                const dateTo = document.getElementById('filterDateTo').value;
                
                if (customer) params.append('customer', customer);
                if (groupNumber) params.append('group_number', groupNumber);
                
                // Convert DD/MM/YY to YYYY-MM-DD for backend
                if (dateFrom) {
                    try {
                        const parts = dateFrom.split('/');
                        if (parts.length === 3) {
                            const day = parts[0];
                            const month = parts[1];
                            const year = '20' + parts[2];
                            params.append('date_from', `${year}-${month}-${day}`);
                        }
                    } catch (error) {
                        console.error('Error parsing date_from:', error);
                    }
                }
                
                if (dateTo) {
                    try {
                        const parts = dateTo.split('/');
                        if (parts.length === 3) {
                            const day = parts[0];
                            const month = parts[1];
                            const year = '20' + parts[2];
                            params.append('date_to', `${year}-${month}-${day}`);
                        }
                    } catch (error) {
                        console.error('Error parsing date_to:', error);
                    }
                }
                
                const queryString = params.toString();
                const baseUrl = getApiBaseUrl();
                const url = queryString ? `${baseUrl}/api/group-bills?${queryString}` : `${baseUrl}/api/group-bills`;
                
                console.log('🌐 Fetching', url);
                const response = await fetch(url);
                console.log('📡 Response status:', response.status);
                
                if (response.ok) {
                    groupBillsData = await response.json();
                    console.log('📊 Received group bills data:', groupBillsData.length, 'records');
                    populateGroupBillsTable();
                } else {
                    console.error('❌ Failed to load group bills data, status:', response.status);
                    tbody.innerHTML = '<tr><td colspan="25" style="text-align: center; padding: 20px; color: #f44336;">Failed to load group bills data. Please try refreshing the page.</td></tr>';
                }
            } catch (error) {
                console.error('❌ Error loading group bills data:', error);
                tbody.innerHTML = '<tr><td colspan="25" style="text-align: center; padding: 20px; color: #f44336;">Error loading group bills data. Please check your connection and try again.</td></tr>';
            }
        }

        function populateGroupBillsTable() {
            const tbody = document.getElementById('groupBillsTableBody');
            if (!tbody) return;
            
            if (groupBillsData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="25" style="text-align: center; padding: 20px; color: #b0bec5;">No group bills found.</td></tr>';
                return;
            }
            
            tbody.innerHTML = '';
            
            groupBillsData.forEach((groupBill, index) => {
                // Level 1: Group Bill Summary (Parent Row)
                const parentRow = document.createElement('tr');
                parentRow.className = 'parent-row group-bill-row';
                parentRow.setAttribute('data-group-id', groupBill.id);
                parentRow.innerHTML = `
                    <td class="checkbox-wrapper">
                        <input type="checkbox" class="group-bill-checkbox" data-group-id="${groupBill.id}" onclick="toggleGroupBillSelection(event, ${groupBill.id})">
                    </td>
                    <td onclick="toggleGroupExpansion(${groupBill.id})">
                        <span class="expand-indicator">▶</span> ${groupBill.group_number || ''}
                    </td>
                    <td>Summary (${groupBill.line_count || 0} records)</td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td>${groupBill.customer_name || ''}</td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td>${formatDate(groupBill.invoice_date || groupBill.created_at)}</td>
                    <td></td>
                `;
                tbody.appendChild(parentRow);
                
                // Level 2: Fabric Invoice and Stitching Invoice Summary Rows
                if (groupBill.details) {
                    // Fabric Invoice Summary Row
                    const fabricRow = document.createElement('tr');
                    fabricRow.className = 'child-row fabric-summary-row';
                    fabricRow.setAttribute('data-group-id', groupBill.id);
                    fabricRow.style.display = 'none';
                    fabricRow.innerHTML = `
                        <td></td>
                        <td onclick="toggleFabricExpansion(${groupBill.id})">
                            <span class="expand-indicator">▶</span> Fabric Invoice
                        </td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td>${formatNumber(groupBill.details.total_fabric_used || 0)}</td>
                        <td></td>
                        <td>${formatCurrency(groupBill.details.total_fabric_value || 0)}</td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    `;
                    tbody.appendChild(fabricRow);
                    
                    // Level 3: Fabric Invoice Details (under Fabric Invoice)
                    if (groupBill.details.individual_records && groupBill.details.individual_records.length > 0) {
                        // Fabric Detail Rows (for records with fabric invoices)
                        groupBill.details.individual_records.filter(record => record.fabric_invoice_number).forEach(record => {
                            const fabricDetailRow = document.createElement('tr');
                            fabricDetailRow.className = 'detail-row fabric-detail-row';
                            fabricDetailRow.setAttribute('data-group-id', groupBill.id);
                            fabricDetailRow.setAttribute('data-pl-serial', record.packing_list_serial || 'No PL');
                            fabricDetailRow.style.display = 'none';
                            fabricDetailRow.innerHTML = `
                                <td></td>
                                <td></td>
                                <td></td>
                                <td></td>
                                <td>${record.item_name || ''}</td>
                                <td>${record.color || ''}</td>
                                <td>${record.customer || ''}</td>
                                <td>${record.tax_invoice_number || ''}</td>
                                <td>${record.fabric_invoice_number || ''}</td>
                                <td>${record.delivery_note || ''}</td>
                                <td>${formatNumber(record.yard_consumed || 0)}</td>
                                <td>${formatNumber(record.fabric_unit_price || 0)}</td>
                                <td>${formatCurrency((record.yard_consumed || 0) * (record.fabric_unit_price || 0))}</td>
                                <td></td>
                                <td></td>
                                <td></td>
                                <td></td>
                                <td></td>
                                <td></td>
                                <td></td>
                                <td></td>
                                <td></td>
                                <td>${formatDate(record.created_at)}</td>
                                <td></td>
                            `;
                            tbody.appendChild(fabricDetailRow);
                        });
                    }
                    
                    // Stitching Invoice Summary Row
                    const stitchingRow = document.createElement('tr');
                    stitchingRow.className = 'child-row stitching-summary-row';
                    stitchingRow.setAttribute('data-group-id', groupBill.id);
                    stitchingRow.style.display = 'none';
                    stitchingRow.innerHTML = `
                        <td></td>
                        <td onclick="toggleStitchingExpansion(${groupBill.id})">
                            <span class="expand-indicator">▶</span> Stitching Invoice
                        </td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td>${formatInteger(groupBill.details.size_totals?.S || 0)}</td>
                        <td>${formatInteger(groupBill.details.size_totals?.M || 0)}</td>
                        <td>${formatInteger(groupBill.details.size_totals?.L || 0)}</td>
                        <td>${formatInteger(groupBill.details.size_totals?.XL || 0)}</td>
                        <td>${formatInteger(groupBill.details.size_totals?.XXL || 0)}</td>
                        <td>${formatInteger(groupBill.details.size_totals?.XXXL || 0)}</td>
                        <td>${formatInteger(groupBill.details.total_items || 0)}</td>
                        <td></td>
                        <td>${formatCurrency(groupBill.details.total_stitching_value || 0)}</td>
                        <td></td>
                        <td></td>
                    `;
                    tbody.appendChild(stitchingRow);
                    
                    // Level 3: Stitching Invoice Details (under Stitching Invoice)
                    if (groupBill.details.individual_records && groupBill.details.individual_records.length > 0) {
                        // Stitching Detail Rows (for all records)
                        groupBill.details.individual_records.forEach(record => {
                            const stitchingDetailRow = document.createElement('tr');
                            stitchingDetailRow.className = 'detail-row stitching-detail-row';
                            stitchingDetailRow.setAttribute('data-group-id', groupBill.id);
                            stitchingDetailRow.setAttribute('data-pl-serial', record.packing_list_serial || 'No PL');
                            stitchingDetailRow.style.display = 'none';
                            stitchingDetailRow.innerHTML = `
                                <td></td>
                                <td></td>
                                <td>${record.packing_list_serial || ''}</td>
                                <td>${record.stitched_item || ''}</td>
                                <td>${record.item_name || ''}</td>
                                <td>${record.color || ''}</td>
                                <td>${record.customer || ''}</td>
                                <td>${record.pl_tax_invoice_number || ''}</td>
                                <td></td>
                                <td></td>
                                <td></td>
                                <td></td>
                                <td></td>
                                <td>${formatInteger(getSizeQuantity(record.size_qty_json, 'S'))}</td>
                                <td>${formatInteger(getSizeQuantity(record.size_qty_json, 'M'))}</td>
                                <td>${formatInteger(getSizeQuantity(record.size_qty_json, 'L'))}</td>
                                <td>${formatInteger(getSizeQuantity(record.size_qty_json, 'XL'))}</td>
                                <td>${formatInteger(getSizeQuantity(record.size_qty_json, 'XXL'))}</td>
                                <td>${formatInteger(getSizeQuantity(record.size_qty_json, 'XXXL'))}</td>
                                <td>${formatInteger(getTotalQuantity(record.size_qty_json))}</td>
                                <td>${formatNumber(record.price || 0)}</td>
                                <td>${formatCurrency(record.total_value || 0)}</td>
                                <td>${formatDate(record.created_at)}</td>
                                <td></td>
                            `;
                            tbody.appendChild(stitchingDetailRow);
                        });
                    }

                }
            });
        }

        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            const checkboxes = document.querySelectorAll('.group-bill-checkbox');
            
            // For single selection, uncheck all others when one is selected
            if (selectAllCheckbox.checked) {
                checkboxes.forEach(checkbox => {
                    checkbox.checked = false;
                });
                selectAllCheckbox.checked = false;
            }
            
            updateSelectedGroupBillIds();
        }

        function toggleGroupBillSelection(event, groupId) {
            event.stopPropagation();
            
            // Single selection: uncheck all other checkboxes
            const checkboxes = document.querySelectorAll('.group-bill-checkbox');
            checkboxes.forEach(checkbox => {
                if (checkbox.getAttribute('data-group-id') != groupId) {
                    checkbox.checked = false;
                }
            });
            
            // Uncheck select all checkbox
            document.getElementById('selectAllCheckbox').checked = false;
            
            updateSelectedGroupBillIds();
        }

        function updateSelectedGroupBillIds() {
            selectedGroupBillIds = [];
            const checkboxes = document.querySelectorAll('.group-bill-checkbox:checked');
            
            checkboxes.forEach(checkbox => {
                selectedGroupBillIds.push(parseInt(checkbox.getAttribute('data-group-id')));
            });
            
            updateActionButtons();
        }

        function updateActionButtons() {
            const hasSelection = selectedGroupBillIds.length === 1;
            
            document.getElementById('downloadStitchingBtn').disabled = !hasSelection;
            document.getElementById('downloadFabricBtn').disabled = !hasSelection;
            document.getElementById('deleteBtn').disabled = !hasSelection;
        }

        function downloadSelectedStitchingPDF() {
            if (selectedGroupBillIds.length === 1) {
                downloadStitchingPDF(selectedGroupBillIds[0]);
            }
        }

        function downloadSelectedFabricPDF() {
            if (selectedGroupBillIds.length === 1) {
                downloadFabricPDF(selectedGroupBillIds[0]);
            }
        }

        function deleteSelectedGroupBill() {
            if (selectedGroupBillIds.length === 1) {
                deleteGroupBill(selectedGroupBillIds[0]);
            }
        }

        function getSelectedGroupBillIds() {
            return selectedGroupBillIds;
        }

        function clearFilters() {
            document.getElementById('filterCustomer').value = '';
            document.getElementById('filterGroupNumber').value = '';
            document.getElementById('filterDateFrom').value = '';
            document.getElementById('filterDateTo').value = '';
            loadGroupBillsData();
        }

        function refreshGroupBillsTable() {
            loadGroupBillsData();
        }



        async function downloadStitchingPDF(groupId) {
            try {
                const response = await fetch(`${getApiBaseUrl()}/api/group-bills/${groupId}/stitching-pdf`);
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `group_bill_${groupId}_stitching.pdf`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } else {
                    alert('Failed to download stitching PDF');
                }
            } catch (error) {
                console.error('Error downloading stitching PDF:', error);
                alert('Error downloading stitching PDF');
            }
        }

        async function downloadFabricPDF(groupId) {
            try {
                const response = await fetch(`${getApiBaseUrl()}/api/group-bills/${groupId}/fabric-pdf`);
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `group_bill_${groupId}_fabric.pdf`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } else {
                    alert('Failed to download fabric PDF');
                }
            } catch (error) {
                console.error('Error downloading fabric PDF:', error);
                alert('Error downloading fabric PDF');
            }
        }

        async function deleteGroupBill(groupId) {
            if (!confirm('Are you sure you want to delete this group bill? This action cannot be undone.')) {
                return;
            }
            
            try {
                const response = await fetch(`${getApiBaseUrl()}/api/group-bills/${groupId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    alert('Group bill deleted successfully');
                    loadGroupBillsData();
                } else {
                    const error = await response.json();
                    alert(`Failed to delete group bill: ${error.error}`);
                }
            } catch (error) {
                console.error('Error deleting group bill:', error);
                alert('Error deleting group bill');
            }
        }

        function exportGroupBillsData() {
            if (groupBillsData.length === 0) {
                alert('No data to export');
                return;
            }
            
            const csvContent = generateCSV(groupBillsData);
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `group_bills_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function generateCSV(data) {
            const headers = ['Date', 'Customer', 'Group Number', 'Invoice Date', 'Line Count', 'Total Stitching Value', 'Total Fabric Value', 'Total Items'];
            const csvRows = [headers.join(',')];
            
            data.forEach(item => {
                const row = [
                    formatDate(item.created_at),
                    `"${item.customer_name || ''}"`,
                    item.group_number || '',
                    formatDate(item.invoice_date),
                    item.line_count || 0,
                    item.total_stitching_value || 0,
                    item.total_fabric_value || 0,
                    item.total_items || 0
                ];
                csvRows.push(row.join(','));
            });
            
            return csvRows.join('\n');
        }



        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-GB');
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'THB',
                minimumFractionDigits: 2
            }).format(amount);
        }

        // Utility functions
        function formatNumber(num) {
            if (num === null || num === undefined) return '0.00';
            return parseFloat(num).toFixed(2);
        }

        function formatInteger(num) {
            if (num === null || num === undefined) return '0';
            return parseInt(num).toString();
        }

        function formatCurrency(amount) {
            if (amount === null || amount === undefined) return '0.00';
            return parseFloat(amount).toLocaleString('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            try {
                const date = new Date(dateString);
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = String(date.getFullYear()).slice(-2);
                return `${day}/${month}/${year}`;
            } catch (error) {
                return dateString;
            }
        }

        function formatDateInput(input) {
            let value = input.value.replace(/\D/g, '');
            if (value.length > 6) {
                value = value.substring(0, 6);
            }
            if (value.length >= 4) {
                value = value.substring(0, 2) + '/' + value.substring(2, 4) + '/' + value.substring(4);
            } else if (value.length >= 2) {
                value = value.substring(0, 2) + '/' + value.substring(2);
            }
            input.value = value;
        }

        function getSizeQuantity(sizeQtyJson, size) {
            if (!sizeQtyJson) return 0;
            try {
                const sizeQty = typeof sizeQtyJson === 'string' ? JSON.parse(sizeQtyJson) : sizeQtyJson;
                return sizeQty[size] || 0;
            } catch (error) {
                return 0;
            }
        }

        function getTotalQuantity(sizeQtyJson) {
            if (!sizeQtyJson) return 0;
            try {
                const sizeQty = typeof sizeQtyJson === 'string' ? JSON.parse(sizeQtyJson) : sizeQtyJson;
                return (sizeQty.S || 0) + (sizeQty.M || 0) + (sizeQty.L || 0) + (sizeQty.XL || 0) + (sizeQty.XXL || 0) + (sizeQty.XXXL || 0);
            } catch (error) {
                return 0;
            }
        }

        function toggleGroupExpansion(groupId) {
            const parentRow = document.querySelector(`tr[data-group-id="${groupId}"].parent-row`);
            const expandIndicator = parentRow.querySelector('.expand-indicator');
            const childRows = document.querySelectorAll(`tr[data-group-id="${groupId}"].child-row`);
            const subChildRows = document.querySelectorAll(`tr[data-group-id="${groupId}"].sub-child-row`);
            const detailRows = document.querySelectorAll(`tr[data-group-id="${groupId}"].detail-row`);
            
            const isExpanded = expandIndicator.classList.contains('expanded');
            
            if (isExpanded) {
                // Collapse
                expandIndicator.classList.remove('expanded');
                expandIndicator.textContent = '▶';
                childRows.forEach(row => row.style.display = 'none');
                subChildRows.forEach(row => row.style.display = 'none');
                detailRows.forEach(row => row.style.display = 'none');
            } else {
                // Expand
                expandIndicator.classList.add('expanded');
                expandIndicator.textContent = '▼';
                childRows.forEach(row => row.style.display = 'table-row');
                // Don't auto-expand sub-levels
            }
        }

        function toggleFabricExpansion(groupId) {
            const fabricRow = document.querySelector(`tr[data-group-id="${groupId}"].fabric-summary-row`);
            const expandIndicator = fabricRow.querySelector('.expand-indicator');
            const plFabricRows = document.querySelectorAll(`tr[data-group-id="${groupId}"].pl-fabric-row`);
            const fabricDetailRows = document.querySelectorAll(`tr[data-group-id="${groupId}"].fabric-detail-row`);
            
            const isExpanded = expandIndicator.classList.contains('expanded');
            
            if (isExpanded) {
                // Collapse
                expandIndicator.classList.remove('expanded');
                expandIndicator.textContent = '▶';
                plFabricRows.forEach(row => row.style.display = 'none');
                fabricDetailRows.forEach(row => row.style.display = 'none');
            } else {
                // Expand
                expandIndicator.classList.add('expanded');
                expandIndicator.textContent = '▼';
                plFabricRows.forEach(row => row.style.display = 'table-row');
                fabricDetailRows.forEach(row => row.style.display = 'table-row');
            }
        }

        function toggleStitchingExpansion(groupId) {
            const stitchingRow = document.querySelector(`tr[data-group-id="${groupId}"].stitching-summary-row`);
            const expandIndicator = stitchingRow.querySelector('.expand-indicator');
            const plStitchingRows = document.querySelectorAll(`tr[data-group-id="${groupId}"].pl-stitching-row`);
            const stitchingDetailRows = document.querySelectorAll(`tr[data-group-id="${groupId}"].stitching-detail-row`);
            
            const isExpanded = expandIndicator.classList.contains('expanded');
            
            if (isExpanded) {
                // Collapse
                expandIndicator.classList.remove('expanded');
                expandIndicator.textContent = '▶';
                plStitchingRows.forEach(row => row.style.display = 'none');
                stitchingDetailRows.forEach(row => row.style.display = 'none');
            } else {
                // Expand
                expandIndicator.classList.add('expanded');
                expandIndicator.textContent = '▼';
                plStitchingRows.forEach(row => row.style.display = 'table-row');
                stitchingDetailRows.forEach(row => row.style.display = 'table-row');
            }
        }

        function logout() {
            localStorage.removeItem('gms_logged_in');
            localStorage.removeItem('gms_username');
            window.location.href = 'login.html';
        }

    </script>
</body>
</html>

