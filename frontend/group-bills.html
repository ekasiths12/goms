<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Group Bills - Garment Management System</title>
    <link rel="stylesheet" href="css/common.css">
    <link rel="stylesheet" href="css/table-sorting.css">
    <style>
        /* Page-specific styles only - common styles moved to common.css */

        /* Filter Controls */
        .filter-controls {
            background: var(--card-bg);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        /* Action Buttons */
        .action-buttons {
            background: var(--card-bg);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
            border: 1px solid var(--border-color);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .action-buttons {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .filter-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-group label {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .filter-select, .filter-input {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 13px;
            min-width: 120px;
            transition: border-color 0.3s ease;
        }

        .filter-select:focus, .filter-input:focus {
            outline: none;
            border-color: var(--focus-color);
        }

        /* Table Styles */
        .table-container {
            background: var(--card-bg);
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .data-table-container {
            background: var(--card-bg);
            border-radius: 8px;
            overflow-x: auto;
            margin-bottom: 10px;
            max-height: 600px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
            white-space: nowrap;
            min-width: 1950px; /* Increased to accommodate wider sew columns */
        }
        
        /* Commission sales table - more compact */
        .commission-sales-table {
            min-width: 700px !important; /* Much more compact for commission sales */
        }

        .data-table th {
            background: var(--nav-active);
            color: var(--text-primary);
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .data-table td {
            padding: 10px 8px;
            border-bottom: 1px solid var(--border-color);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: var(--text-primary);
        }

        .data-table tr:hover {
            background: var(--bg-tertiary);
        }

        .data-table tr.selected {
            background: var(--focus-color) !important;
            color: var(--text-primary);
        }

        /* Pagination Styles */
        .table-container {
            max-height: 500px;
            overflow-y: auto;
            background: var(--card-bg);
            border-radius: 8px;
            margin-bottom: 10px;
            border: 1px solid var(--border-color);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .table-container::-webkit-scrollbar,
        .data-table-container::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        .table-container::-webkit-scrollbar-track,
        .data-table-container::-webkit-scrollbar-track {
            background: var(--bg-tertiary);
            border-radius: 4px;
        }

        .table-container::-webkit-scrollbar-thumb,
        .data-table-container::-webkit-scrollbar-thumb {
            background: var(--focus-color);
            border-radius: 4px;
        }

        .table-container::-webkit-scrollbar-thumb:hover,
        .data-table-container::-webkit-scrollbar-thumb:hover {
            background: var(--nav-active);
        }

        /* Checkbox styling */
        .checkbox-wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .checkbox-wrapper input[type="checkbox"] {
            margin: 0;
            cursor: pointer;
            width: 16px;
            height: 16px;
            accent-color: var(--focus-color);
        }

        /* Make it clear that rows are not clickable */
        .data-table tr {
            cursor: default;
        }

        .data-table tr:hover {
            background: var(--bg-tertiary) !important;
        }

        .data-table tr:hover td {
            background: var(--bg-tertiary) !important;
        }

        .pagination-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--card-bg);
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
            border: 1px solid var(--border-color);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .pagination-info {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .pagination-buttons {
            display: flex;
            gap: 10px;
        }

        .pagination-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .pagination-btn:hover:not(:disabled) {
            background: var(--focus-color);
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination-btn.active {
            background: var(--focus-color);
            color: var(--text-primary);
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: var(--focus-color);
            color: #fff;
        }

        .btn-primary:hover {
            background: var(--nav-active);
        }

        .btn-secondary {
            background: #757575;
            color: #fff;
        }

        .btn-secondary:hover {
            background: #9e9e9e;
        }

        .btn-success {
            background: #388e3c;
            color: #fff;
        }

        .btn-success:hover {
            background: #4caf50;
        }

        .btn-warning {
            background: #f57c00;
            color: #fff;
        }

        .btn-warning:hover {
            background: #ff9800;
        }

        .btn-danger {
            background: #d32f2f;
            color: #fff;
        }

        .btn-danger:hover {
            background: #f44336;
        }

        .btn-info {
            background: #1976d2;
            color: #fff;
        }

        .btn-info:hover {
            background: #2196f3;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background: var(--card-bg);
            margin: 5% auto;
            padding: 20px;
            border-radius: 8px;
            width: 80%;
            max-width: 900px;
            color: var(--text-primary);
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--focus-color);
        }

        .close {
            color: var(--text-secondary);
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: var(--text-primary);
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-size: 12px;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--focus-color);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
            margin: 0;
        }

        /* Checkbox styling */
        .checkbox-wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .checkbox-wrapper input[type="checkbox"] {
            margin: 0;
            cursor: pointer;
            width: 16px;
            height: 16px;
            accent-color: var(--focus-color);
        }

        /* Multi-level table structure */
        .parent-row {
            background: var(--bg-secondary);
            font-weight: 600;
        }

        .child-row {
            background: var(--bg-tertiary);
            font-weight: 500;
        }

        .sub-child-row {
            background: var(--bg-tertiary);
            font-weight: 400;
        }

        .expand-indicator {
            cursor: pointer;
            color: var(--focus-color);
            font-weight: bold;
            margin-right: 5px;
            font-size: 14px;
            display: inline-block;
            min-width: 16px;
        }

        .expand-indicator.expanded {
            transform: rotate(90deg);
        }

        /* Indentation for different levels */
        .child-row td:nth-child(2) {
            padding-left: 20px;
        }

        .sub-child-row td:nth-child(2) {
            padding-left: 40px;
        }

        .detail-row td:nth-child(2) {
            padding-left: 60px;
        }

        .secondary-fabric-row {
            background: var(--bg-tertiary);
        }

        .secondary-fabric-row td {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
        }

        .secondary-fabric-row td:nth-child(2) {
            padding-left: 80px;
        }

        .lining-fabric-row {
            background: var(--bg-tertiary);
        }

        .lining-fabric-row td {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
        }

        .lining-fabric-row td:nth-child(2) {
            padding-left: 80px;
        }

        /* Make it clear that rows are not clickable */
        .data-table tr {
            cursor: default;
        }

        .data-table tr:hover {
            background: var(--bg-tertiary) !important;
        }

        .data-table tr:hover td {
            background: var(--bg-tertiary) !important;
        }

        /* Loading and Error States */
        .loading-state {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .error-state {
            text-align: center;
            padding: 40px;
            color: #e57373;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .filter-row {
                flex-direction: column;
                align-items: stretch;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .table-container {
                overflow-x: auto;
            }
        }

        /* Ensure table cells don't wrap and show ellipsis for long content */
        .data-table th,
        .data-table td {
            max-width: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* Specific column widths to prevent wrapping */
        .data-table th:nth-child(1),
        .data-table td:nth-child(1) { /* Checkbox column */
            width: 30px;
            min-width: 30px;
            max-width: 30px;
            text-align: center;
        }

        .data-table th:nth-child(2),
        .data-table td:nth-child(2) { /* Created At */
            width: 80px;
            min-width: 80px;
            max-width: 80px;
        }

        .data-table th:nth-child(3),
        .data-table td:nth-child(3) { /* Bill # */
            width: 140px;
            min-width: 140px;
            max-width: 140px;
        }

        .data-table th:nth-child(4),
        .data-table td:nth-child(4) { /* PL # */
            width: 140px;
            min-width: 140px;
            max-width: 140px;
        }

        .data-table th:nth-child(5),
        .data-table td:nth-child(5) { /* Garment */
            width: 80px;
            min-width: 80px;
            max-width: 80px;
        }

        .data-table th:nth-child(6),
        .data-table td:nth-child(6) { /* Fabric */
            width: 100px;
            min-width: 100px;
            max-width: 100px;
        }

        .data-table th:nth-child(7),
        .data-table td:nth-child(7) { /* Color */
            width: 80px;
            min-width: 80px;
            max-width: 80px;
        }

        .data-table th:nth-child(8),
        .data-table td:nth-child(8) { /* Customer */
            width: 120px;
            min-width: 120px;
            max-width: 120px;
        }

        .data-table th:nth-child(9),
        .data-table td:nth-child(9) { /* Beta T# */
            width: 90px;
            min-width: 90px;
            max-width: 90px;
        }

        .data-table th:nth-child(10),
        .data-table td:nth-child(10) { /* MSK T# */
            width: 90px;
            min-width: 90px;
            max-width: 90px;
        }

        .data-table th:nth-child(11),
        .data-table td:nth-child(11) { /* Fabric Inv */
            width: 100px;
            min-width: 100px;
            max-width: 100px;
        }

        .data-table th:nth-child(12),
        .data-table td:nth-child(12) { /* Fabric DN */
            width: 100px;
            min-width: 100px;
            max-width: 100px;
        }

        .data-table th:nth-child(13),
        .data-table td:nth-child(13) { /* Fab Used */
            width: 70px;
            min-width: 70px;
            max-width: 70px;
            text-align: right;
        }

        .data-table th:nth-child(14),
        .data-table td:nth-child(14) { /* Fab Cost */
            width: 70px;
            min-width: 70px;
            max-width: 70px;
            text-align: right;
        }

        .data-table th:nth-child(15),
        .data-table td:nth-child(15) { /* Fab Value */
            width: 80px;
            min-width: 80px;
            max-width: 80px;
            text-align: right;
        }

        .data-table th:nth-child(16),
        .data-table td:nth-child(16),
        .data-table th:nth-child(17),
        .data-table td:nth-child(17),
        .data-table th:nth-child(18),
        .data-table td:nth-child(18),
        .data-table th:nth-child(19),
        .data-table td:nth-child(19),
        .data-table th:nth-child(20),
        .data-table td:nth-child(20),
        .data-table th:nth-child(21),
        .data-table td:nth-child(21),
        .data-table th:nth-child(22),
        .data-table td:nth-child(22) { /* Size columns */
            width: 55px;
            min-width: 55px;
            max-width: 55px;
            text-align: center;
        }

        .data-table th:nth-child(23),
        .data-table td:nth-child(23) { /* Total Qty */
            width: 90px;
            min-width: 90px;
            max-width: 90px;
            text-align: center;
        }

        .data-table th:nth-child(24),
        .data-table td:nth-child(24) { /* Sew Value */
            width: 100px;
            min-width: 100px;
            max-width: 100px;
            text-align: right;
        }

        .data-table th:nth-child(25),
        .data-table td:nth-child(25) { /* Sew Price */
            width: 70px;
            min-width: 70px;
            max-width: 70px;
            text-align: right;
        }

        /* Pagination Styles */
        .pagination-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            padding: 15px 20px;
            background: var(--card-bg);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .pagination-info {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .pagination-buttons {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .pagination-btn {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
            min-width: 60px;
        }

        .pagination-btn:hover:not(:disabled) {
            background: var(--focus-color);
            border-color: var(--nav-active);
        }

        .pagination-btn:disabled {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            cursor: not-allowed;
        }

        .pagination-btn.active {
            background: var(--focus-color);
            border-color: var(--nav-active);
            font-weight: bold;
        }

        .page-numbers {
            display: flex;
            gap: 5px;
        }
    </style>
    <script src="js/common/nav-bar.js"></script>
    <script src="js/common/utils.js"></script>
    <script src="js/table-sorting.js"></script>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="nav-bar">
        <!-- Navigation will be rendered by nav-bar.js -->
    </nav>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Filter Controls -->
        <div class="filter-controls">
            <div class="filter-row">
                <div class="filter-group">
                    <label>Customer:</label>
                    <input type="text" id="filterCustomer" class="filter-input" placeholder="Customer name">
                </div>
                
                <div class="filter-group">
                    <label>Group Number:</label>
                    <input type="text" id="filterGroupNumber" class="filter-input" placeholder="Group number">
                </div>
                
                <div class="filter-group">
                    <label>From:</label>
                    <input type="text" id="filterDateFrom" class="filter-input" placeholder="DD/MM/YY" oninput="formatDateInput(this)">
                </div>
                
                <div class="filter-group">
                    <label>To:</label>
                    <input type="text" id="filterDateTo" class="filter-input" placeholder="DD/MM/YY" oninput="formatDateInput(this)">
                </div>
                
                <button class="btn btn-secondary" onclick="clearFilters()">Clear Filter</button>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons">
            <button id="downloadStitchingBtn" class="btn btn-info" onclick="downloadSelectedStitchingPDF()">
                Download Stitching PDF
            </button>
            <button id="downloadFabricBtn" class="btn btn-warning" onclick="downloadSelectedFabricPDF()">
                Download Fabric PDF
            </button>
            <button id="deleteBtn" class="btn btn-danger" onclick="deleteSelectedItem()">
                Delete
            </button>
            <button id="toggleCommissionBtn" class="btn btn-success" onclick="toggleCommissionSales()">
                Show Commission Sales
            </button>
        </div>
        
        <div style="margin-bottom: 20px;">
            <button class="btn btn-secondary" onclick="refreshGroupBillsTable()">Refresh</button>
            <button class="btn btn-success" onclick="exportGroupBillsData()">Export Data</button>
        </div>

        <!-- Group Bills Table -->
        <div class="data-table-container">
            <table id="groupBillsTable" class="data-table">
                <thead>
                    <tr>
                        <th style="width: 30px;">
                            <input type="checkbox" id="selectAllCheckbox" onclick="toggleSelectAll()">
                        </th>
                        <th class="sortable-header" data-sort="created_at" style="width: 90px;">Created At</th>
                        <th class="sortable-header" data-sort="group_bill_number" style="width: 150px;">Bill #</th>
                        <th class="sortable-header" data-sort="packing_list_number" style="width: 150px;">PL #</th>
                        <th class="sortable-header" data-sort="garment" style="width: 90px;">Garment</th>
                        <th class="sortable-header" data-sort="fabric" style="width: 110px;">Fabric</th>
                        <th class="sortable-header" data-sort="color" style="width: 90px;">Color</th>
                        <th class="sortable-header" data-sort="customer" style="width: 130px;">Customer</th>
                        <th class="sortable-header" data-sort="tax_invoice_number" style="width: 110px;">Beta T#</th>
                        <th class="sortable-header" data-sort="msk_invoice_number" style="width: 110px;">MSK T#</th>
                        <th class="sortable-header" data-sort="fabric_invoice" style="width: 110px;">Fabric Inv.</th>
                        <th class="sortable-header" data-sort="fabric_delivery_note" style="width: 110px;">Fabric DN.</th>
                        <th class="sortable-header" data-sort="fabric_used" style="width: 80px;">Fab Used</th>
                        <th class="sortable-header" data-sort="fabric_cost" style="width: 80px;">Fab Cost</th>
                        <th class="sortable-header" data-sort="fabric_value" style="width: 90px;">Fab Value</th>
                        <th class="sortable-header" data-sort="size_s" style="width: 45px;">S</th>
                        <th class="sortable-header" data-sort="size_m" style="width: 45px;">M</th>
                        <th class="sortable-header" data-sort="size_l" style="width: 45px;">L</th>
                        <th class="sortable-header" data-sort="size_xl" style="width: 45px;">XL</th>
                        <th class="sortable-header" data-sort="size_xxl" style="width: 45px;">2XL</th>
                        <th class="sortable-header" data-sort="size_xxxl" style="width: 45px;">3XL</th>
                        <th class="sortable-header" data-sort="total_qty" style="width: 70px;">Total Qty</th>
                        <th class="sortable-header" data-sort="sewing_value" style="width: 80px;">Sew Value</th>
                        <th class="sortable-header" data-sort="sewing_cost" style="width: 70px;">Sew Price</th>

                    </tr>
                </thead>
                <tbody id="groupBillsTableBody">
                    <!-- Data will be loaded here -->
                </tbody>
            </table>
        </div>
        
        <!-- Pagination Controls -->
        <div class="pagination-controls">
            <div class="pagination-info">
                <span id="paginationInfo">Showing 0 of 0 records</span>
            </div>
            <div class="pagination-buttons">
                <button class="pagination-btn" onclick="goToPage(1)" id="firstPage">First</button>
                <button class="pagination-btn" onclick="goToPage(currentPage - 1)" id="prevPage">Previous</button>
                <div id="pageNumbers" class="page-numbers"></div>
                <button class="pagination-btn" onclick="goToPage(currentPage + 1)" id="nextPage">Next</button>
                <button class="pagination-btn" onclick="goToPage(getTotalPages())" id="lastPage">Last</button>
            </div>
        </div>
    </div>



    <script>
        // Group Bills Functions
        let groupBillsData = [];
        let selectedGroupBillIds = [];
        let currentPage = 1;
        const itemsPerPage = 50;
        let showingCommissionSales = false;

        // API utilities moved to js/common/utils.js

        // Load data when page loads
        // Authentication functions moved to js/common/utils.js

        window.addEventListener('load', async () => {
            console.log('üîÑ Group Bills page loaded');
            
            // Render navigation bar
            renderNavBar('group-bills');
            
            // Check authentication first
            if (!checkAuth()) {
                return;
            }
            
            await loadGroupBillsData();
        });

        async function loadGroupBillsData() {
            console.log('üîÑ loadGroupBillsData called');
            
            const tbody = document.getElementById('groupBillsTableBody');
            if (!tbody) {
                console.error('‚ùå Group bills table body not found');
                return;
            }
            
            console.log('‚úÖ Found group bills table body, showing loading state');
            // Show loading state
            tbody.innerHTML = '<tr><td colspan="25" style="text-align: center; padding: 20px; color: var(--text-secondary);">Loading group bills data...</td></tr>';
            
            try {
                // Build query parameters
                const params = new URLSearchParams();
                const customer = document.getElementById('filterCustomer').value;
                const groupNumber = document.getElementById('filterGroupNumber').value;
                const dateFrom = document.getElementById('filterDateFrom').value;
                const dateTo = document.getElementById('filterDateTo').value;
                
                if (customer) params.append('customer', customer);
                if (groupNumber) params.append('group_number', groupNumber);
                
                // Convert DD/MM/YY to YYYY-MM-DD for backend
                if (dateFrom) {
                    try {
                        const parts = dateFrom.split('/');
                        if (parts.length === 3) {
                            const day = parts[0];
                            const month = parts[1];
                            const year = '20' + parts[2];
                            params.append('date_from', `${year}-${month}-${day}`);
                        }
                    } catch (error) {
                        console.error('Error parsing date_from:', error);
                    }
                }
                
                if (dateTo) {
                    try {
                        const parts = dateTo.split('/');
                        if (parts.length === 3) {
                            const day = parts[0];
                            const month = parts[1];
                            const year = '20' + parts[2];
                            params.append('date_to', `${year}-${month}-${day}`);
                        }
                    } catch (error) {
                        console.error('Error parsing date_to:', error);
                    }
                }
                
                const queryString = params.toString();
                const baseUrl = getApiBaseUrl();
                let url;
                
                if (showingCommissionSales) {
                    // Load commission sales data
                    url = queryString ? `${baseUrl}/api/group-bills/commission-sales?${queryString}` : `${baseUrl}/api/group-bills/commission-sales`;
                    url += queryString ? `&_t=${Date.now()}` : `?_t=${Date.now()}`;
                } else {
                    // Load regular group bills data
                    url = queryString ? `${baseUrl}/api/group-bills?${queryString}` : `${baseUrl}/api/group-bills`;
                    url += queryString ? `&_t=${Date.now()}` : `?_t=${Date.now()}`;
                }
                
                console.log('üîç API URL debug:', { baseUrl, url, windowLocation: window.location.href });
                console.log('üåê Fetching', url);
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    }
                });
                console.log('üì° Response status:', response.status);
                
                if (response.ok) {
                    groupBillsData = await response.json();
                    console.log('üìä Received group bills data:', groupBillsData.length, 'records');
                    currentPage = 1; // Reset to first page when new data is loaded
                    populateGroupBillsTable();
                } else {
                    console.error('‚ùå Failed to load group bills data, status:', response.status);
                    tbody.innerHTML = '<tr><td colspan="25" style="text-align: center; padding: 20px; color: #f44336;">Failed to load group bills data. Please try refreshing the page.</td></tr>';
                }
            } catch (error) {
                console.error('‚ùå Error loading group bills data:', error);
                tbody.innerHTML = '<tr><td colspan="25" style="text-align: center; padding: 20px; color: #f44336;">Error loading group bills data. Please check your connection and try again.</td></tr>';
            }
        }

        function toggleCommissionSales() {
            console.log('üîÑ Toggle Commission Sales called');
            showingCommissionSales = !showingCommissionSales;
            const toggleBtn = document.getElementById('toggleCommissionBtn');
            const deleteBtn = document.getElementById('deleteBtn');
            const downloadStitchingBtn = document.getElementById('downloadStitchingBtn');
            const downloadFabricBtn = document.getElementById('downloadFabricBtn');
            
            console.log('üìä Current state:', showingCommissionSales ? 'Commission Sales' : 'Group Bills');
            
            if (showingCommissionSales) {
                console.log('üéØ Switching to Commission Sales view');
                toggleBtn.textContent = 'Show Group Bills';
                toggleBtn.className = 'btn btn-primary';
                updateTableHeadersForCommissionSales();
                // Add compact table class
                document.getElementById('groupBillsTable').classList.add('commission-sales-table');
                // Keep buttons visible but disable them for commission sales
                downloadStitchingBtn.style.display = 'inline-block';
                downloadFabricBtn.style.display = 'inline-block';
                downloadStitchingBtn.disabled = true;
                downloadFabricBtn.disabled = true;
            } else {
                console.log('üéØ Switching to Group Bills view');
                toggleBtn.textContent = 'Show Commission Sales';
                toggleBtn.className = 'btn btn-success';
                updateTableHeadersForGroupBills();
                // Remove compact table class
                document.getElementById('groupBillsTable').classList.remove('commission-sales-table');
                // Enable buttons for group bills
                downloadStitchingBtn.style.display = 'inline-block';
                downloadFabricBtn.style.display = 'inline-block';
                downloadStitchingBtn.disabled = false;
                downloadFabricBtn.disabled = false;
            }
            
            // Clear selections when switching views
            selectedGroupBillIds = [];
            selectedCommissionSaleIds = [];
            updateActionButtons();
            
            // Reload data with new view
            loadGroupBillsData();
        }
        
        function updateTableHeadersForCommissionSales() {
            const thead = document.querySelector('#groupBillsTable thead tr');
            if (!thead) return;
            
            thead.innerHTML = `
                <th style="width: 30px;">
                    <input type="checkbox" id="selectAllCheckbox" onclick="toggleSelectAll()">
                </th>
                <th class="sortable-header" data-sort="commission_date" style="width: 80px;">Date</th>
                <th class="sortable-header" data-sort="serial_number" style="width: 120px;">Serial #</th>
                <th class="sortable-header" data-sort="item_name" style="width: 100px;">Fabric</th>
                <th class="sortable-header" data-sort="color" style="width: 70px;">Color</th>
                <th class="sortable-header" data-sort="customer" style="width: 100px;">Customer</th>
                <th class="sortable-header" data-sort="commission_yards" style="width: 70px;">Yards</th>
                <th class="sortable-header" data-sort="unit_price" style="width: 70px;">Price</th>
                <th class="sortable-header" data-sort="total_sale_value" style="width: 80px;">Sale Value</th>
                <th class="sortable-header" data-sort="commission_amount" style="width: 80px;">Com Value</th>
            `;
        }
        
        function updateTableHeadersForGroupBills() {
            const thead = document.querySelector('#groupBillsTable thead tr');
            if (!thead) return;
            
            thead.innerHTML = `
                <th style="width: 30px;">
                    <input type="checkbox" id="selectAllCheckbox" onclick="toggleSelectAll()">
                </th>
                <th class="sortable-header" data-sort="created_at" style="width: 90px;">Created At</th>
                <th class="sortable-header" data-sort="group_bill_number" style="width: 150px;">Bill #</th>
                <th class="sortable-header" data-sort="packing_list_number" style="width: 150px;">PL #</th>
                <th class="sortable-header" data-sort="garment" style="width: 90px;">Garment</th>
                <th class="sortable-header" data-sort="fabric" style="width: 110px;">Fabric</th>
                <th class="sortable-header" data-sort="color" style="width: 90px;">Color</th>
                <th class="sortable-header" data-sort="customer" style="width: 130px;">Customer</th>
                <th class="sortable-header" data-sort="tax_invoice_number" style="width: 110px;">Beta T#</th>
                <th class="sortable-header" data-sort="msk_invoice_number" style="width: 110px;">MSK T#</th>
                <th class="sortable-header" data-sort="fabric_invoice" style="width: 110px;">Fabric Inv.</th>
                <th class="sortable-header" data-sort="fabric_delivery_note" style="width: 110px;">Fabric DN.</th>
                <th class="sortable-header" data-sort="fabric_used" style="width: 80px;">Fab Used</th>
                <th class="sortable-header" data-sort="fabric_cost" style="width: 80px;">Fab Cost</th>
                <th class="sortable-header" data-sort="fabric_value" style="width: 90px;">Fab Value</th>
                <th class="sortable-header" data-sort="size_s" style="width: 45px;">S</th>
                <th class="sortable-header" data-sort="size_m" style="width: 45px;">M</th>
                <th class="sortable-header" data-sort="size_l" style="width: 45px;">L</th>
                <th class="sortable-header" data-sort="size_xl" style="width: 45px;">XL</th>
                <th class="sortable-header" data-sort="size_xxl" style="width: 45px;">2XL</th>
                <th class="sortable-header" data-sort="size_xxxl" style="width: 45px;">3XL</th>
                <th class="sortable-header" data-sort="total_qty" style="width: 70px;">Total Qty</th>
                <th class="sortable-header" data-sort="sewing_value" style="width: 80px;">Sew Value</th>
                <th class="sortable-header" data-sort="sewing_cost" style="width: 70px;">Sew Price</th>
            `;
        }
        
        function populateCommissionSalesTable() {
            const tbody = document.getElementById('groupBillsTableBody');
            if (!tbody) return;
            
            // Calculate pagination
            const totalPages = Math.ceil(groupBillsData.length / itemsPerPage);
            if (currentPage > totalPages && totalPages > 0) {
                currentPage = totalPages;
            }
            
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, groupBillsData.length);
            const pageData = groupBillsData.slice(startIndex, endIndex);
            
            tbody.innerHTML = '';
            
            pageData.forEach((sale, pageIndex) => {
                const actualIndex = startIndex + pageIndex;
                const row = document.createElement('tr');
                row.className = 'commission-sale-row';
                row.setAttribute('data-sale-id', sale.id);
                
                row.innerHTML = `
                    <td class="checkbox-wrapper">
                        <input type="checkbox" class="commission-sale-checkbox" data-sale-id="${sale.id}" onclick="toggleCommissionSaleSelection(event, ${sale.id})">
                    </td>
                    <td>${formatDate(sale.commission_date)}</td>
                    <td>${sale.serial_number || ''}</td>
                    <td>${sale.item_name || ''}</td>
                    <td>${sale.color || ''}</td>
                    <td>${sale.customer_name || ''}</td>
                    <td>${formatNumber(sale.commission_yards || 0)}</td>
                    <td>${formatNumber(sale.unit_price || 0)}</td>
                    <td>${formatNumber(sale.total_sale_value || 0)}</td>
                    <td>${formatNumber(sale.commission_amount || 0)}</td>
                `;
                
                tbody.appendChild(row);
            });
            
            updatePaginationControls();
        }

        function populateGroupBillsTable() {
            const tbody = document.getElementById('groupBillsTableBody');
            if (!tbody) return;
            
            if (groupBillsData.length === 0) {
                const message = showingCommissionSales ? 'No commission sales found.' : 'No group bills found.';
                const colspan = showingCommissionSales ? '9' : '25';
                tbody.innerHTML = `<tr><td colspan="${colspan}" style="text-align: center; padding: 20px; color: var(--text-secondary);">${message}</td></tr>`;
                updatePaginationControls();
                return;
            }
            
            // Handle commission sales differently - simple line items
            if (showingCommissionSales) {
                populateCommissionSalesTable();
                return;
            }
            
            // Calculate pagination
            const totalPages = Math.ceil(groupBillsData.length / itemsPerPage);
            if (currentPage > totalPages && totalPages > 0) {
                currentPage = totalPages;
            }
            
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, groupBillsData.length);
            const pageData = groupBillsData.slice(startIndex, endIndex);
            
            tbody.innerHTML = '';
            
            pageData.forEach((groupBill, pageIndex) => {
                const actualIndex = startIndex + pageIndex;
                // Level 1: Group Bill Summary (Parent Row)
                const parentRow = document.createElement('tr');
                parentRow.className = 'parent-row group-bill-row';
                parentRow.setAttribute('data-group-id', groupBill.id);
                parentRow.innerHTML = `
                    <td class="checkbox-wrapper">
                        <input type="checkbox" class="group-bill-checkbox" data-group-id="${groupBill.id}" onclick="toggleGroupBillSelection(event, ${groupBill.id})">
                    </td>
                    <td>${formatDate(groupBill.invoice_date || groupBill.created_at)}</td>
                    <td onclick="toggleGroupExpansion(${groupBill.id})">
                        <span class="expand-indicator">‚ñ∂</span> ${groupBill.group_number || ''}
                    </td>
                    <td>Summary (${groupBill.line_count || 0} records)</td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td>${groupBill.customer_name || ''}</td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                `;
                tbody.appendChild(parentRow);
                
                // Level 2: Fabric Invoice and Stitching Invoice Summary Rows
                if (groupBill.details) {
                    // Fabric Invoice Summary Row
                    const fabricRow = document.createElement('tr');
                    fabricRow.className = 'child-row fabric-summary-row';
                    fabricRow.setAttribute('data-group-id', groupBill.id);
                    fabricRow.style.display = 'none';
                    fabricRow.innerHTML = `
                        <td></td>
                        <td></td>
                        <td onclick="toggleFabricExpansion(${groupBill.id})">
                            <span class="expand-indicator">‚ñ∂</span> Fabric Invoice
                        </td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td>${formatNumber(groupBill.details.total_fabric_used || 0)}</td>
                        <td></td>
                        <td>${formatCurrency(groupBill.details.total_fabric_value || 0)}</td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    `;
                    tbody.appendChild(fabricRow);
                    
                    // Level 3: Fabric Invoice Details (under Fabric Invoice)
                    if (groupBill.details.individual_records && groupBill.details.individual_records.length > 0) {
                        // Fabric Detail Rows (for records with fabric invoices)
                        groupBill.details.individual_records.filter(record => record.fabric_invoice_number).forEach(record => {
                            const fabricDetailRow = document.createElement('tr');
                            fabricDetailRow.className = 'detail-row fabric-detail-row';
                            fabricDetailRow.setAttribute('data-group-id', groupBill.id);
                            fabricDetailRow.setAttribute('data-pl-serial', record.packing_list_serial || 'No PL');
                            fabricDetailRow.style.display = 'none';
                            fabricDetailRow.innerHTML = `
                                <td></td>
                                <td></td>
                                <td></td>
                                <td>${record.packing_list_serial || ''}</td>
                                <td></td>
                                <td>${record.item_name || ''}</td>
                                <td>${record.color || ''}</td>
                                <td>${record.customer || ''}</td>
                                <td>${record.beta_tax_invoice_number || ''}</td>
                                <td>${record.tax_invoice_number || ''}</td>
                                <td>${record.fabric_invoice_number || ''}</td>
                                <td>${record.delivery_note || ''}</td>
                                <td>${formatNumber(record.yard_consumed || 0)}</td>
                                <td>${formatNumber(record.fabric_unit_price || 0)}</td>
                                <td>${formatCurrency((record.yard_consumed || 0) * (record.fabric_unit_price || 0))}</td>
                                <td></td>
                                <td></td>
                                <td></td>
                                <td></td>
                                <td></td>
                                <td></td>
                                <td></td>
                                <td></td>
                                <td></td>
                                <td></td>
                            `;
                            tbody.appendChild(fabricDetailRow);
                        });
                        
                        // Add secondary fabric rows for each record
                        groupBill.details.individual_records.filter(record => record.fabric_invoice_number && record.garment_fabrics && record.garment_fabrics.length > 0).forEach(record => {
                            record.garment_fabrics.forEach(fabric => {
                                const fabricValue = parseFloat(fabric.total_fabric_cost || 0);
                                const secondaryFabricRow = document.createElement('tr');
                                secondaryFabricRow.className = 'detail-row secondary-fabric-row';
                                secondaryFabricRow.setAttribute('data-group-id', groupBill.id);
                                secondaryFabricRow.setAttribute('data-pl-serial', record.packing_list_serial || 'No PL');
                                secondaryFabricRow.style.display = 'none';
                                secondaryFabricRow.innerHTML = `
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td>${record.packing_list_serial || ''}</td>
                                    <td></td>
                                    <td style="padding-left: 20px; color: var(--text-secondary);">‚Ü≥ ${fabric.lining_name || fabric.fabric_name || ''}</td>
                                    <td>${fabric.color || ''}</td>
                                    <td>${record.customer || ''}</td>
                                    <td>${fabric.beta_tax_invoice_number || ''}</td>
                                    <td>${fabric.tax_invoice_number || ''}</td>
                                    <td>${fabric.fabric_invoice_number || ''}</td>
                                    <td>${fabric.delivery_note || ''}</td>
                                    <td>${formatNumber(parseFloat(fabric.consumption_yards || 0))}</td>
                                    <td>${formatNumber(parseFloat(fabric.unit_price || 0))}</td>
                                    <td>${formatCurrency(fabricValue)}</td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                `;
                                tbody.appendChild(secondaryFabricRow);
                            });
                        });
                    }
                    
                    // Stitching Invoice Summary Row
                    const stitchingRow = document.createElement('tr');
                    stitchingRow.className = 'child-row stitching-summary-row';
                    stitchingRow.setAttribute('data-group-id', groupBill.id);
                    stitchingRow.style.display = 'none';
                    stitchingRow.innerHTML = `
                        <td></td>
                        <td></td>
                        <td onclick="toggleStitchingExpansion(${groupBill.id})">
                            <span class="expand-indicator">‚ñ∂</span> Stitching Invoice
                        </td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td>${formatInteger(groupBill.details.size_totals?.S || 0)}</td>
                        <td>${formatInteger(groupBill.details.size_totals?.M || 0)}</td>
                        <td>${formatInteger(groupBill.details.size_totals?.L || 0)}</td>
                        <td>${formatInteger(groupBill.details.size_totals?.XL || 0)}</td>
                        <td>${formatInteger(groupBill.details.size_totals?.XXL || 0)}</td>
                        <td>${formatInteger(groupBill.details.size_totals?.XXXL || 0)}</td>
                        <td>${formatInteger((groupBill.details.size_totals?.S || 0) + (groupBill.details.size_totals?.M || 0) + (groupBill.details.size_totals?.L || 0) + (groupBill.details.size_totals?.XL || 0) + (groupBill.details.size_totals?.XXL || 0) + (groupBill.details.size_totals?.XXXL || 0))}</td>
                        <td>${formatCurrency(groupBill.details.total_stitching_value || 0)}</td>
                        <td></td>
                        <td></td>
                    `;
                    tbody.appendChild(stitchingRow);
                    
                    // Level 3: Stitching Invoice Details (under Stitching Invoice)
                    if (groupBill.details.individual_records && groupBill.details.individual_records.length > 0) {
                        // Stitching Detail Rows (for records with stitching invoices)
                        groupBill.details.individual_records.filter(record => record.stitching_invoice_number).forEach(record => {
                            // Parse size quantities from JSON string
                            let sizeQty = {};
                            if (record.size_qty_json) {
                                try {
                                    // Parse the JSON string from the database
                                    sizeQty = JSON.parse(record.size_qty_json.replace(/'/g, '"'));
                                } catch (e) {
                                    console.error('Error parsing size_qty_json:', e, record.size_qty_json);
                                    sizeQty = {};
                                }
                            }
                            const totalQty = Object.values(sizeQty).reduce((sum, qty) => sum + (parseInt(qty) || 0), 0);
                            
                            const stitchingDetailRow = document.createElement('tr');
                            stitchingDetailRow.className = 'detail-row stitching-detail-row';
                            stitchingDetailRow.setAttribute('data-group-id', groupBill.id);
                            stitchingDetailRow.setAttribute('data-pl-serial', record.packing_list_serial || 'No PL');
                            stitchingDetailRow.style.display = 'none';
                            stitchingDetailRow.innerHTML = `
                                <td></td>
                                <td></td>
                                <td></td>
                                <td>${record.packing_list_serial || ''}</td>
                                <td></td>
                                <td>${record.item_name || ''}</td>
                                <td>${record.color || ''}</td>
                                <td>${record.customer || ''}</td>
                                <td>${record.beta_tax_invoice_number || ''}</td>
                                <td>${record.tax_invoice_number || ''}</td>
                                <td>${record.fabric_invoice_number || ''}</td>
                                <td>${record.delivery_note || ''}</td>
                                <td></td>
                                <td></td>
                                <td></td>
                                <td>${formatInteger(sizeQty.S || 0)}</td>
                                <td>${formatInteger(sizeQty.M || 0)}</td>
                                <td>${formatInteger(sizeQty.L || 0)}</td>
                                <td>${formatInteger(sizeQty.XL || 0)}</td>
                                <td>${formatInteger(sizeQty.XXL || 0)}</td>
                                <td>${formatInteger(sizeQty.XXXL || 0)}</td>
                                <td>${formatInteger(totalQty)}</td>
                                <td>${formatCurrency(record.total_value || 0)}</td>
                                <td>${formatCurrency(record.price || 0)}</td>
                            `;
                            tbody.appendChild(stitchingDetailRow);
                        });
                        
                        // Add lining fabric rows for each record
                        groupBill.details.individual_records.filter(record => record.stitching_invoice_number && record.lining_fabrics && record.lining_fabrics.length > 0).forEach(record => {
                            // Calculate totalQty for this record
                            let sizeQty = {};
                            if (record.size_qty_json) {
                                try {
                                    sizeQty = JSON.parse(record.size_qty_json.replace(/'/g, '"'));
                                } catch (e) {
                                    console.error('Error parsing size_qty_json:', e, record.size_qty_json);
                                    sizeQty = {};
                                }
                            }
                            const totalQty = Object.values(sizeQty).reduce((sum, qty) => sum + (parseInt(qty) || 0), 0);
                            
                            record.lining_fabrics.forEach(lining => {
                                const liningValue = parseFloat(lining.total_cost || 0);
                                const liningFabricRow = document.createElement('tr');
                                liningFabricRow.className = 'detail-row lining-fabric-row';
                                liningFabricRow.setAttribute('data-group-id', groupBill.id);
                                liningFabricRow.setAttribute('data-pl-serial', record.packing_list_serial || 'No PL');
                                liningFabricRow.style.display = 'none';
                                liningFabricRow.innerHTML = `
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td>${record.packing_list_serial || ''}</td>
                                    <td></td>
                                    <td style="padding-left: 20px; color: var(--text-secondary);">‚Ü≥ Lining: ${lining.lining_name || ''}</td>
                                    <td>${lining.color || ''}</td>
                                    <td>${record.customer || ''}</td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td>${formatNumber(parseFloat(lining.consumption_yards || 0))}</td>
                                    <td>${formatNumber(parseFloat(lining.unit_price || 0))}</td>
                                    <td>${formatCurrency(liningValue)}</td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td>${formatCurrency(record.total_value || 0)}</td>
                                    <td>${formatCurrency(record.price || 0)}</td>
                                `;
                                tbody.appendChild(liningFabricRow);
                            });
                        });
                    }

                }
            });
            
            updatePaginationControls();
        }

        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            const checkboxes = document.querySelectorAll('.group-bill-checkbox');
            
            // For single selection, uncheck all others when one is selected
            if (selectAllCheckbox.checked) {
                checkboxes.forEach(checkbox => {
                    checkbox.checked = false;
                });
                selectAllCheckbox.checked = false;
            }
            
            updateSelectedGroupBillIds();
        }

        function toggleGroupBillSelection(event, groupId) {
            event.stopPropagation();
            
            // Single selection: uncheck all other checkboxes
            const checkboxes = document.querySelectorAll('.group-bill-checkbox');
            checkboxes.forEach(checkbox => {
                if (checkbox.getAttribute('data-group-id') != groupId) {
                    checkbox.checked = false;
                }
            });
            
            // Uncheck select all checkbox
            document.getElementById('selectAllCheckbox').checked = false;
            
            updateSelectedGroupBillIds();
        }

        function updateSelectedGroupBillIds() {
            selectedGroupBillIds = [];
            const checkboxes = document.querySelectorAll('.group-bill-checkbox:checked');
            
            checkboxes.forEach(checkbox => {
                selectedGroupBillIds.push(parseInt(checkbox.getAttribute('data-group-id')));
            });
            
            updatePaginationControls();
            updateActionButtons();
        }
        
        function toggleCommissionSaleSelection(event, saleId) {
            event.stopPropagation();
            
            // Single selection: uncheck all other checkboxes
            const checkboxes = document.querySelectorAll('.commission-sale-checkbox');
            checkboxes.forEach(checkbox => {
                if (checkbox.getAttribute('data-sale-id') != saleId) {
                    checkbox.checked = false;
                }
            });
            
            // Uncheck select all checkbox
            document.getElementById('selectAllCheckbox').checked = false;
            
            updateSelectedCommissionSaleIds();
        }
        
        function updateSelectedCommissionSaleIds() {
            selectedCommissionSaleIds = Array.from(document.querySelectorAll('.commission-sale-checkbox:checked'))
                .map(checkbox => parseInt(checkbox.getAttribute('data-sale-id')));
            
            updatePaginationControls();
            updateActionButtons();
        }
        
        async function deleteCommissionSale(saleId) {
            if (!confirm('Are you sure you want to delete this commission sale? This will revert all fabric usage, consumption, and pending amounts.')) {
                return;
            }
            
            try {
                const baseUrl = getApiBaseUrl();
                const response = await fetch(`${baseUrl}/api/invoices/delete-commission-sale`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ sale_id: saleId })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    alert('Commission sale deleted successfully!');
                    // Clear selections and reload the data to reflect changes
                    selectedCommissionSaleIds = [];
                    updateActionButtons();
                    loadGroupBillsData();
                } else {
                    const errorData = await response.json();
                    alert(`Error deleting commission sale: ${errorData.error || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Error deleting commission sale:', error);
                alert('Error deleting commission sale. Please try again.');
            }
        }

        function updateActionButtons() {
            if (showingCommissionSales) {
                const hasSelection = selectedCommissionSaleIds.length === 1;
                document.getElementById('deleteBtn').disabled = !hasSelection;
            } else {
                const hasSelection = selectedGroupBillIds.length === 1;
                document.getElementById('downloadStitchingBtn').disabled = !hasSelection;
                document.getElementById('downloadFabricBtn').disabled = !hasSelection;
                document.getElementById('deleteBtn').disabled = !hasSelection;
            }
        }

        function downloadSelectedStitchingPDF() {
            if (selectedGroupBillIds.length === 1) {
                downloadStitchingPDF(selectedGroupBillIds[0]);
            }
        }

        function downloadSelectedFabricPDF() {
            if (selectedGroupBillIds.length === 1) {
                downloadFabricPDF(selectedGroupBillIds[0]);
            }
        }

        function deleteSelectedItem() {
            if (showingCommissionSales) {
                if (selectedCommissionSaleIds.length === 1) {
                    deleteCommissionSale(selectedCommissionSaleIds[0]);
                }
            } else {
                if (selectedGroupBillIds.length === 1) {
                    deleteGroupBill(selectedGroupBillIds[0]);
                }
            }
        }

        function getSelectedGroupBillIds() {
            return selectedGroupBillIds;
        }

        function clearFilters() {
            document.getElementById('filterCustomer').value = '';
            document.getElementById('filterGroupNumber').value = '';
            document.getElementById('filterDateFrom').value = '';
            document.getElementById('filterDateTo').value = '';
            loadGroupBillsData();
        }

        function refreshGroupBillsTable() {
            loadGroupBillsData();
        }



        async function downloadStitchingPDF(groupId) {
            try {
                const response = await fetch(`${getApiBaseUrl()}/api/group-bills/${groupId}/stitching-pdf`);
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `group_bill_${groupId}_stitching.pdf`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } else {
                    alert('Failed to download stitching PDF');
                }
            } catch (error) {
                console.error('Error downloading stitching PDF:', error);
                alert('Error downloading stitching PDF');
            }
        }

        async function downloadFabricPDF(groupId) {
            try {
                const response = await fetch(`${getApiBaseUrl()}/api/group-bills/${groupId}/fabric-pdf`);
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `group_bill_${groupId}_fabric.pdf`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } else {
                    alert('Failed to download fabric PDF');
                }
            } catch (error) {
                console.error('Error downloading fabric PDF:', error);
                alert('Error downloading fabric PDF');
            }
        }

        async function deleteGroupBill(groupId) {
            if (!confirm('Are you sure you want to delete this group bill? This action cannot be undone.')) {
                return;
            }
            
            try {
                const response = await fetch(`${getApiBaseUrl()}/api/group-bills/${groupId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    alert('Group bill deleted successfully');
                    loadGroupBillsData();
                } else {
                    const error = await response.json();
                    alert(`Failed to delete group bill: ${error.error}`);
                }
            } catch (error) {
                console.error('Error deleting group bill:', error);
                alert('Error deleting group bill');
            }
        }

        function exportGroupBillsData() {
            if (groupBillsData.length === 0) {
                alert('No data to export');
                return;
            }
            
            const csvContent = generateCSV(groupBillsData);
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `group_bills_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function generateCSV(data) {
            const headers = ['Date', 'Customer', 'Group Number', 'Invoice Date', 'Line Count', 'Total Stitching Value', 'Total Fabric Value', 'Total Items'];
            const csvRows = [headers.join(',')];
            
            data.forEach(item => {
                const row = [
                    formatDate(item.created_at),
                    `"${item.customer_name || ''}"`,
                    item.group_number || '',
                    formatDate(item.invoice_date),
                    item.line_count || 0,
                    item.total_stitching_value || 0,
                    item.total_fabric_value || 0,
                    item.total_items || 0
                ];
                csvRows.push(row.join(','));
            });
            
            return csvRows.join('\n');
        }



        // Formatting functions moved to js/common/utils.js
        // Note: formatCurrency is page-specific, kept here
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'THB',
                minimumFractionDigits: 2
            }).format(amount);
        }

        // Utility functions
        // Formatting functions moved to js/common/utils.js
        // Note: formatCurrency is page-specific, kept here

        function getSizeQuantity(sizeQtyJson, size) {
            if (!sizeQtyJson) return 0;
            try {
                let sizeQty;
                if (typeof sizeQtyJson === 'string') {
                    // Handle single quotes in JSON string by replacing with double quotes
                    const jsonString = sizeQtyJson.replace(/'/g, '"');
                    sizeQty = JSON.parse(jsonString);
                } else {
                    sizeQty = sizeQtyJson;
                }
                return sizeQty[size] || 0;
            } catch (error) {
                console.error('Error parsing size_qty_json:', error, sizeQtyJson);
                return 0;
            }
        }

        function getTotalQuantity(sizeQtyJson) {
            if (!sizeQtyJson) return 0;
            try {
                let sizeQty;
                if (typeof sizeQtyJson === 'string') {
                    // Handle single quotes in JSON string by replacing with double quotes
                    const jsonString = sizeQtyJson.replace(/'/g, '"');
                    sizeQty = JSON.parse(jsonString);
                } else {
                    sizeQty = sizeQtyJson;
                }
                return (sizeQty.S || 0) + (sizeQty.M || 0) + (sizeQty.L || 0) + (sizeQty.XL || 0) + (sizeQty.XXL || 0) + (sizeQty.XXXL || 0);
            } catch (error) {
                console.error('Error parsing size_qty_json:', error, sizeQtyJson);
                return 0;
            }
        }

        function toggleGroupExpansion(groupId) {
            const parentRow = document.querySelector(`tr[data-group-id="${groupId}"].parent-row`);
            const expandIndicator = parentRow.querySelector('.expand-indicator');
            const childRows = document.querySelectorAll(`tr[data-group-id="${groupId}"].child-row`);
            const subChildRows = document.querySelectorAll(`tr[data-group-id="${groupId}"].sub-child-row`);
            const detailRows = document.querySelectorAll(`tr[data-group-id="${groupId}"].detail-row`);
            
            const isExpanded = expandIndicator.classList.contains('expanded');
            
            if (isExpanded) {
                // Collapse
                expandIndicator.classList.remove('expanded');
                expandIndicator.textContent = '‚ñ∂';
                childRows.forEach(row => row.style.display = 'none');
                subChildRows.forEach(row => row.style.display = 'none');
                detailRows.forEach(row => row.style.display = 'none');
            } else {
                // Expand
                expandIndicator.classList.add('expanded');
                expandIndicator.textContent = '‚ñº';
                childRows.forEach(row => row.style.display = 'table-row');
                // Don't auto-expand sub-levels
            }
        }

        function toggleFabricExpansion(groupId) {
            const fabricRow = document.querySelector(`tr[data-group-id="${groupId}"].fabric-summary-row`);
            const expandIndicator = fabricRow.querySelector('.expand-indicator');
            const plFabricRows = document.querySelectorAll(`tr[data-group-id="${groupId}"].pl-fabric-row`);
            const fabricDetailRows = document.querySelectorAll(`tr[data-group-id="${groupId}"].fabric-detail-row`);
            const secondaryFabricRows = document.querySelectorAll(`tr[data-group-id="${groupId}"].secondary-fabric-row`);
            
            const isExpanded = expandIndicator.classList.contains('expanded');
            
            if (isExpanded) {
                // Collapse
                expandIndicator.classList.remove('expanded');
                expandIndicator.textContent = '‚ñ∂';
                plFabricRows.forEach(row => row.style.display = 'none');
                fabricDetailRows.forEach(row => row.style.display = 'none');
                secondaryFabricRows.forEach(row => row.style.display = 'none');
            } else {
                // Expand
                expandIndicator.classList.add('expanded');
                expandIndicator.textContent = '‚ñº';
                plFabricRows.forEach(row => row.style.display = 'table-row');
                fabricDetailRows.forEach(row => row.style.display = 'table-row');
                secondaryFabricRows.forEach(row => row.style.display = 'table-row');
            }
        }

        function toggleStitchingExpansion(groupId) {
            const stitchingRow = document.querySelector(`tr[data-group-id="${groupId}"].stitching-summary-row`);
            const expandIndicator = stitchingRow.querySelector('.expand-indicator');
            const plStitchingRows = document.querySelectorAll(`tr[data-group-id="${groupId}"].pl-stitching-row`);
            const stitchingDetailRows = document.querySelectorAll(`tr[data-group-id="${groupId}"].stitching-detail-row`);
            const liningFabricRows = document.querySelectorAll(`tr[data-group-id="${groupId}"].lining-fabric-row`);
            
            const isExpanded = expandIndicator.classList.contains('expanded');
            
            if (isExpanded) {
                // Collapse
                expandIndicator.classList.remove('expanded');
                expandIndicator.textContent = '‚ñ∂';
                plStitchingRows.forEach(row => row.style.display = 'none');
                stitchingDetailRows.forEach(row => row.style.display = 'none');
                liningFabricRows.forEach(row => row.style.display = 'none');
            } else {
                // Expand
                expandIndicator.classList.add('expanded');
                expandIndicator.textContent = '‚ñº';
                plStitchingRows.forEach(row => row.style.display = 'table-row');
                stitchingDetailRows.forEach(row => row.style.display = 'table-row');
                liningFabricRows.forEach(row => row.style.display = 'table-row');
            }
        }

        // Authentication functions moved to js/common/utils.js

        // Theme Management
        // Theme functions moved to js/common/utils.js

        // Pagination Functions
        function getTotalPages() {
            return Math.ceil(groupBillsData.length / itemsPerPage);
        }

        function goToPage(page) {
            const totalPages = getTotalPages();
            if (page < 1 || page > totalPages) {
                return;
            }
            currentPage = page;
            populateGroupBillsTable();
        }

        function updatePaginationControls() {
            const totalPages = getTotalPages();
            const startRecord = (currentPage - 1) * itemsPerPage + 1;
            const endRecord = Math.min(currentPage * itemsPerPage, groupBillsData.length);
            
            // Update pagination info
            const paginationInfo = document.getElementById('paginationInfo');
            if (paginationInfo) {
                paginationInfo.textContent = `Showing ${startRecord} to ${endRecord} of ${groupBillsData.length} records`;
            }
            
            // Update button states
            const firstPageBtn = document.getElementById('firstPage');
            const prevPageBtn = document.getElementById('prevPage');
            const nextPageBtn = document.getElementById('nextPage');
            const lastPageBtn = document.getElementById('lastPage');
            
            if (firstPageBtn) firstPageBtn.disabled = currentPage === 1;
            if (prevPageBtn) prevPageBtn.disabled = currentPage === 1;
            if (nextPageBtn) nextPageBtn.disabled = currentPage === totalPages;
            if (lastPageBtn) lastPageBtn.disabled = currentPage === totalPages;
            
            // Update page numbers
            const pageNumbersContainer = document.getElementById('pageNumbers');
            if (pageNumbersContainer) {
                pageNumbersContainer.innerHTML = '';
                
                const maxVisiblePages = 5;
                let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
                let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
                
                if (endPage - startPage + 1 < maxVisiblePages) {
                    startPage = Math.max(1, endPage - maxVisiblePages + 1);
                }
                
                for (let i = startPage; i <= endPage; i++) {
                    const pageBtn = document.createElement('button');
                    pageBtn.className = `pagination-btn ${i === currentPage ? 'active' : ''}`;
                    pageBtn.textContent = i;
                    pageBtn.onclick = () => goToPage(i);
                    pageNumbersContainer.appendChild(pageBtn);
                }
            }
        }

        // ===== TABLE SORTING FUNCTIONALITY =====
        
        // Initialize table sorter
        let tableSorter = null;

        // Custom data getter for group bills data
        function getGroupBillsValueForSorting(item, column) {
            switch (column) {
                case 'created_at':
                    return item.created_at;
                case 'group_bill_number':
                    return item.group_bill_number;
                case 'packing_list_number':
                    return item.packing_list_number;
                case 'garment':
                    return item.garment;
                case 'fabric':
                    return item.fabric;
                case 'color':
                    return item.color;
                case 'customer':
                    return item.customer;
                case 'tax_invoice_number':
                    return item.tax_invoice_number;
                case 'msk_invoice_number':
                    return item.msk_invoice_number;
                case 'fabric_invoice':
                    return item.fabric_invoice;
                case 'fabric_delivery_note':
                    return item.fabric_delivery_note;
                case 'fabric_used':
                    return item.fabric_used;
                case 'fabric_cost':
                    return item.fabric_cost;
                case 'fabric_value':
                    return item.fabric_value;
                case 'size_s':
                    return item.size_s;
                case 'size_m':
                    return item.size_m;
                case 'size_l':
                    return item.size_l;
                case 'size_xl':
                    return item.size_xl;
                case 'size_xxl':
                    return item.size_xxl;
                case 'size_xxxl':
                    return item.size_xxxl;
                case 'total_qty':
                    return item.total_qty;
                case 'sewing_cost':
                    return item.sewing_cost;
                case 'sewing_value':
                    return item.sewing_value;
                default:
                    return '';
            }
        }

        // Initialize table sorter when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Load theme immediately to prevent flashing
            loadTheme();
            
            // Initialize table headers for group bills view
            updateTableHeadersForGroupBills();
            
            // Initialize table sorter
            tableSorter = createTableSorter('groupBillsTable', {
                dataGetter: getGroupBillsValueForSorting
            });
            
            // Listen for sort events
            document.getElementById('groupBillsTable').addEventListener('tableSorted', function(event) {
                const { data } = event.detail;
                groupBillsData = data;
                populateGroupBillsTable();
            });
            
            console.log('‚úÖ Group bills table sorter initialized and ready');
        });

        // Override the loadGroupBillsData function to update table sorter
        const originalLoadGroupBillsData = loadGroupBillsData;
        loadGroupBillsData = async function() {
            await originalLoadGroupBillsData();
            
            // Initialize table sorter if not already done
            if (!tableSorter) {
                tableSorter = createTableSorter('groupBillsTable', {
                    dataGetter: getGroupBillsValueForSorting
                });
                
                // Listen for sort events
                document.getElementById('groupBillsTable').addEventListener('tableSorted', function(event) {
                    const { data } = event.detail;
                    groupBillsData = data;
                    populateGroupBillsTable();
                });
                
                console.log('‚úÖ Group bills table sorter initialized after data load');
            }
            
            // Update table sorter with new data
            if (tableSorter && groupBillsData && groupBillsData.length > 0) {
                tableSorter.setData(groupBillsData, getGroupBillsValueForSorting);
                console.log(`üíæ Updated group bills table sorter with ${groupBillsData.length} records`);
            } else {
                console.log('‚ö†Ô∏è No group bills data available for table sorter');
            }
        }
    </script>
</body>
</html>

