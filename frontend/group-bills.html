<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Group Bills - Garment Management System</title>
    <link rel="stylesheet" href="css/table-sorting.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #212121;
            color: #eceff1;
            font-size: 13px;
        }

        /* Navigation Bar */
        .nav-bar {
            background: #23272f;
            border-bottom: 1px solid #3949ab;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            height: 60px;
            display: flex;
            align-items: center;
            padding: 0 20px;
        }

        .nav-tabs {
            display: flex;
            list-style: none;
            gap: 0;
        }

        .nav-tab {
            background: transparent;
            border: none;
            color: #eceff1;
            padding: 15px 25px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            text-decoration: none;
            display: inline-block;
        }

        .nav-tab:hover {
            background-color: #3949ab;
            color: #ffffff;
        }

        .nav-tab.active {
            background-color: #3949ab;
            color: #ffffff;
            border-bottom-color: #5c6bc0;
        }

        .nav-user {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .nav-user span {
            color: #b0bec5;
            font-size: 12px;
        }

        .logout-btn {
            background: #d32f2f;
            color: #ffffff;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: #f44336;
        }

        /* Main Content */
        .main-content {
            margin-top: 60px;
            padding: 20px;
            min-height: calc(100vh - 60px);
        }

        /* Filter Controls */
        .filter-controls {
            background: #2c2c2c;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        /* Action Buttons */
        .action-buttons {
            background: #2c2c2c;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .action-buttons button {
            background: #5c6bc0;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: background 0.3s ease;
        }

        .action-buttons button:hover {
            background: #3949ab;
        }

        .action-buttons button:disabled {
            background: #666;
            cursor: not-allowed;
        }

        .action-buttons .btn-danger {
            background: #f44336;
        }

        .action-buttons .btn-danger:hover {
            background: #d32f2f;
        }

        .action-buttons .btn-warning {
            background: #ff9800;
        }

        .action-buttons .btn-warning:hover {
            background: #f57c00;
        }

        .action-buttons .btn-info {
            background: #2196f3;
        }

        .action-buttons .btn-info:hover {
            background: #1976d2;
        }

        .filter-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-group label {
            font-size: 13px;
            color: #b0bec5;
            font-weight: 500;
        }

        .filter-select, .filter-input {
            background: #424242;
            border: 1px solid #555;
            color: #eceff1;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 13px;
            min-width: 120px;
        }

        .filter-select:focus, .filter-input:focus {
            outline: none;
            border-color: #5c6bc0;
        }

        /* Table Styles */
        .table-container {
            background: #2c2c2c;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .data-table-container {
            background: #2c2c2c;
            border-radius: 8px;
            overflow-x: auto;
            margin-bottom: 10px;
            max-height: 600px;
            overflow-y: auto;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
            white-space: nowrap;
            min-width: 1950px; /* Increased to accommodate wider sew columns */
        }

        .data-table th {
            background: #3949ab;
            color: #eceff1;
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .data-table td {
            padding: 10px 8px;
            border-bottom: 1px solid #444;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .data-table tr:hover {
            background: #3c3c3c;
        }

        .data-table tr.selected {
            background: #5c6bc0 !important;
            color: #ffffff;
        }

        /* Pagination Styles */
        .table-container {
            max-height: 500px;
            overflow-y: auto;
            background: #2c2c2c;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .table-container::-webkit-scrollbar,
        .data-table-container::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        .table-container::-webkit-scrollbar-track,
        .data-table-container::-webkit-scrollbar-track {
            background: #424242;
            border-radius: 4px;
        }

        .table-container::-webkit-scrollbar-thumb,
        .data-table-container::-webkit-scrollbar-thumb {
            background: #5c6bc0;
            border-radius: 4px;
        }

        .table-container::-webkit-scrollbar-thumb:hover,
        .data-table-container::-webkit-scrollbar-thumb:hover {
            background: #3949ab;
        }

        /* Checkbox styling */
        .checkbox-wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .checkbox-wrapper input[type="checkbox"] {
            margin: 0;
            cursor: pointer;
            width: 16px;
            height: 16px;
            accent-color: #5c6bc0;
        }

        /* Make it clear that rows are not clickable */
        .data-table tr {
            cursor: default;
        }

        .data-table tr:hover {
            background: #424242 !important;
        }

        .data-table tr:hover td {
            background: #424242 !important;
        }

        .pagination-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #2c2c2c;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .pagination-info {
            color: #b0bec5;
            font-size: 14px;
        }

        .pagination-buttons {
            display: flex;
            gap: 10px;
        }

        .pagination-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            background: #424242;
            color: #eceff1;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .pagination-btn:hover:not(:disabled) {
            background: #5c6bc0;
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination-btn.active {
            background: #5c6bc0;
            color: #fff;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: #3949ab;
            color: #fff;
        }

        .btn-primary:hover {
            background: #5c6bc0;
        }

        .btn-secondary {
            background: #757575;
            color: #fff;
        }

        .btn-secondary:hover {
            background: #9e9e9e;
        }

        .btn-success {
            background: #388e3c;
            color: #fff;
        }

        .btn-success:hover {
            background: #4caf50;
        }

        .btn-warning {
            background: #f57c00;
            color: #fff;
        }

        .btn-warning:hover {
            background: #ff9800;
        }

        .btn-danger {
            background: #d32f2f;
            color: #fff;
        }

        .btn-danger:hover {
            background: #f44336;
        }

        .btn-info {
            background: #1976d2;
            color: #fff;
        }

        .btn-info:hover {
            background: #2196f3;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background: #2c2c2c;
            margin: 5% auto;
            padding: 20px;
            border-radius: 8px;
            width: 80%;
            max-width: 900px;
            color: #eceff1;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #555;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #fff;
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            padding-top: 15px;
            border-top: 1px solid #555;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #b0bec5;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #555;
            border-radius: 4px;
            background: #424242;
            color: #eceff1;
            font-size: 12px;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #5c6bc0;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
            margin: 0;
        }

        /* Checkbox styling */
        .checkbox-wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .checkbox-wrapper input[type="checkbox"] {
            margin: 0;
            cursor: pointer;
            width: 16px;
            height: 16px;
            accent-color: #5c6bc0;
        }

        /* Multi-level table structure */
        .parent-row {
            background: #2c2c2c;
            font-weight: 600;
        }

        .child-row {
            background: #3c3c3c;
            font-weight: 500;
        }

        .sub-child-row {
            background: #4c4c4c;
            font-weight: 400;
        }

        .expand-indicator {
            cursor: pointer;
            color: #4caf50;
            font-weight: bold;
            margin-right: 5px;
            font-size: 14px;
            display: inline-block;
            min-width: 16px;
        }

        .expand-indicator.expanded {
            transform: rotate(90deg);
        }

        /* Indentation for different levels */
        .child-row td:nth-child(2) {
            padding-left: 20px;
        }

        .sub-child-row td:nth-child(2) {
            padding-left: 40px;
        }

        .detail-row td:nth-child(2) {
            padding-left: 60px;
        }

        .secondary-fabric-row {
            background: #1e1e1e;
        }

        .secondary-fabric-row td {
            background: #1e1e1e;
            color: #b0bec5;
        }

        .secondary-fabric-row td:nth-child(2) {
            padding-left: 80px;
        }

        .lining-fabric-row {
            background: #1a1a1a;
        }

        .lining-fabric-row td {
            background: #1a1a1a;
            color: #90a4ae;
        }

        .lining-fabric-row td:nth-child(2) {
            padding-left: 80px;
        }

        /* Make it clear that rows are not clickable */
        .data-table tr {
            cursor: default;
        }

        .data-table tr:hover {
            background: #424242 !important;
        }

        .data-table tr:hover td {
            background: #424242 !important;
        }

        /* Loading and Error States */
        .loading-state {
            text-align: center;
            padding: 40px;
            color: #b0bec5;
        }

        .error-state {
            text-align: center;
            padding: 40px;
            color: #e57373;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .filter-row {
                flex-direction: column;
                align-items: stretch;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .table-container {
                overflow-x: auto;
            }
        }

        /* Ensure table cells don't wrap and show ellipsis for long content */
        .data-table th,
        .data-table td {
            max-width: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* Specific column widths to prevent wrapping */
        .data-table th:nth-child(1),
        .data-table td:nth-child(1) { /* Checkbox column */
            width: 30px;
            min-width: 30px;
            max-width: 30px;
            text-align: center;
        }

        .data-table th:nth-child(2),
        .data-table td:nth-child(2) { /* Created At */
            width: 80px;
            min-width: 80px;
            max-width: 80px;
        }

        .data-table th:nth-child(3),
        .data-table td:nth-child(3) { /* Bill # */
            width: 140px;
            min-width: 140px;
            max-width: 140px;
        }

        .data-table th:nth-child(4),
        .data-table td:nth-child(4) { /* PL # */
            width: 140px;
            min-width: 140px;
            max-width: 140px;
        }

        .data-table th:nth-child(5),
        .data-table td:nth-child(5) { /* Garment */
            width: 80px;
            min-width: 80px;
            max-width: 80px;
        }

        .data-table th:nth-child(6),
        .data-table td:nth-child(6) { /* Fabric */
            width: 100px;
            min-width: 100px;
            max-width: 100px;
        }

        .data-table th:nth-child(7),
        .data-table td:nth-child(7) { /* Color */
            width: 80px;
            min-width: 80px;
            max-width: 80px;
        }

        .data-table th:nth-child(8),
        .data-table td:nth-child(8) { /* Customer */
            width: 120px;
            min-width: 120px;
            max-width: 120px;
        }

        .data-table th:nth-child(9),
        .data-table td:nth-child(9) { /* Beta T# */
            width: 90px;
            min-width: 90px;
            max-width: 90px;
        }

        .data-table th:nth-child(10),
        .data-table td:nth-child(10) { /* MSK T# */
            width: 90px;
            min-width: 90px;
            max-width: 90px;
        }

        .data-table th:nth-child(11),
        .data-table td:nth-child(11) { /* Fabric Inv */
            width: 100px;
            min-width: 100px;
            max-width: 100px;
        }

        .data-table th:nth-child(12),
        .data-table td:nth-child(12) { /* Fabric DN */
            width: 100px;
            min-width: 100px;
            max-width: 100px;
        }

        .data-table th:nth-child(13),
        .data-table td:nth-child(13) { /* Fab Used */
            width: 70px;
            min-width: 70px;
            max-width: 70px;
            text-align: right;
        }

        .data-table th:nth-child(14),
        .data-table td:nth-child(14) { /* Fab Cost */
            width: 70px;
            min-width: 70px;
            max-width: 70px;
            text-align: right;
        }

        .data-table th:nth-child(15),
        .data-table td:nth-child(15) { /* Fab Value */
            width: 80px;
            min-width: 80px;
            max-width: 80px;
            text-align: right;
        }

        .data-table th:nth-child(16),
        .data-table td:nth-child(16),
        .data-table th:nth-child(17),
        .data-table td:nth-child(17),
        .data-table th:nth-child(18),
        .data-table td:nth-child(18),
        .data-table th:nth-child(19),
        .data-table td:nth-child(19),
        .data-table th:nth-child(20),
        .data-table td:nth-child(20),
        .data-table th:nth-child(21),
        .data-table td:nth-child(21),
        .data-table th:nth-child(22),
        .data-table td:nth-child(22) { /* Size columns */
            width: 55px;
            min-width: 55px;
            max-width: 55px;
            text-align: center;
        }

        .data-table th:nth-child(23),
        .data-table td:nth-child(23) { /* Total Qty */
            width: 90px;
            min-width: 90px;
            max-width: 90px;
            text-align: center;
        }

        .data-table th:nth-child(24),
        .data-table td:nth-child(24) { /* Sew Cost */
            width: 90px;
            min-width: 90px;
            max-width: 90px;
            text-align: right;
        }

        .data-table th:nth-child(25),
        .data-table td:nth-child(25) { /* Sew Value */
            width: 100px;
            min-width: 100px;
            max-width: 100px;
            text-align: right;
        }

        /* Pagination Styles */
        .pagination-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            padding: 15px 20px;
            background: #2c3e50;
            border-radius: 8px;
            border: 1px solid #34495e;
        }

        .pagination-info {
            color: #bdc3c7;
            font-size: 14px;
        }

        .pagination-buttons {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .pagination-btn {
            background: #34495e;
            color: #ecf0f1;
            border: 1px solid #2c3e50;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
            min-width: 60px;
        }

        .pagination-btn:hover:not(:disabled) {
            background: #3498db;
            border-color: #2980b9;
        }

        .pagination-btn:disabled {
            background: #2c3e50;
            color: #7f8c8d;
            cursor: not-allowed;
        }

        .pagination-btn.active {
            background: #3498db;
            border-color: #2980b9;
            font-weight: bold;
        }

        .page-numbers {
            display: flex;
            gap: 5px;
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="nav-bar">
        <ul class="nav-tabs">
            <li><a href="fabric-invoices.html" class="nav-tab">Fabric Invoices</a></li>
            <li><a href="stitching-records.html" class="nav-tab">Stitching Records</a></li>
            <li><a href="packing-lists.html" class="nav-tab">Packing Lists</a></li>
            <li><a href="group-bills.html" class="nav-tab active">Group Bills</a></li>
            <li><a href="dashboard.html" class="nav-tab">Dashboard</a></li>
        </ul>
        <div class="nav-user">
            <span id="currentUser"></span>
            <button onclick="logout()" class="logout-btn">Logout</button>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Filter Controls -->
        <div class="filter-controls">
            <div class="filter-row">
                <div class="filter-group">
                    <label>Customer:</label>
                    <input type="text" id="filterCustomer" class="filter-input" placeholder="Customer name">
                </div>
                
                <div class="filter-group">
                    <label>Group Number:</label>
                    <input type="text" id="filterGroupNumber" class="filter-input" placeholder="Group number">
                </div>
                
                <div class="filter-group">
                    <label>From:</label>
                    <input type="text" id="filterDateFrom" class="filter-input" placeholder="DD/MM/YY" oninput="formatDateInput(this)">
                </div>
                
                <div class="filter-group">
                    <label>To:</label>
                    <input type="text" id="filterDateTo" class="filter-input" placeholder="DD/MM/YY" oninput="formatDateInput(this)">
                </div>
                
                <button class="btn btn-secondary" onclick="clearFilters()">Clear Filter</button>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons">
            <button id="downloadStitchingBtn" class="btn-info" onclick="downloadSelectedStitchingPDF()" disabled>
                Download Stitching PDF
            </button>
            <button id="downloadFabricBtn" class="btn-warning" onclick="downloadSelectedFabricPDF()" disabled>
                Download Fabric PDF
            </button>
            <button id="deleteBtn" class="btn-danger" onclick="deleteSelectedGroupBill()" disabled>
                Delete Group Bill
            </button>
        </div>
        
        <div style="margin-bottom: 20px;">
            <button class="btn btn-secondary" onclick="refreshGroupBillsTable()">Refresh</button>
            <button class="btn btn-success" onclick="exportGroupBillsData()">Export Data</button>
        </div>

        <!-- Group Bills Table -->
        <div class="data-table-container">
            <table id="groupBillsTable" class="data-table">
                <thead>
                    <tr>
                        <th style="width: 30px;">
                            <input type="checkbox" id="selectAllCheckbox" onclick="toggleSelectAll()">
                        </th>
                        <th class="sortable-header" data-sort="created_at" style="width: 90px;">Created At</th>
                        <th class="sortable-header" data-sort="group_bill_number" style="width: 150px;">Bill #</th>
                        <th class="sortable-header" data-sort="packing_list_number" style="width: 150px;">PL #</th>
                        <th class="sortable-header" data-sort="garment" style="width: 90px;">Garment</th>
                        <th class="sortable-header" data-sort="fabric" style="width: 110px;">Fabric</th>
                        <th class="sortable-header" data-sort="color" style="width: 90px;">Color</th>
                        <th class="sortable-header" data-sort="customer" style="width: 130px;">Customer</th>
                        <th class="sortable-header" data-sort="tax_invoice_number" style="width: 110px;">Beta T#</th>
                        <th class="sortable-header" data-sort="msk_invoice_number" style="width: 110px;">MSK T#</th>
                        <th class="sortable-header" data-sort="fabric_invoice" style="width: 110px;">Fabric Inv.</th>
                        <th class="sortable-header" data-sort="fabric_delivery_note" style="width: 110px;">Fabric DN.</th>
                        <th class="sortable-header" data-sort="fabric_used" style="width: 80px;">Fab Used</th>
                        <th class="sortable-header" data-sort="fabric_cost" style="width: 80px;">Fab Cost</th>
                        <th class="sortable-header" data-sort="fabric_value" style="width: 90px;">Fab Value</th>
                        <th class="sortable-header" data-sort="size_s" style="width: 45px;">S</th>
                        <th class="sortable-header" data-sort="size_m" style="width: 45px;">M</th>
                        <th class="sortable-header" data-sort="size_l" style="width: 45px;">L</th>
                        <th class="sortable-header" data-sort="size_xl" style="width: 45px;">XL</th>
                        <th class="sortable-header" data-sort="size_xxl" style="width: 45px;">2XL</th>
                        <th class="sortable-header" data-sort="size_xxxl" style="width: 45px;">3XL</th>
                        <th class="sortable-header" data-sort="total_qty" style="width: 70px;">Total Qty</th>
                        <th class="sortable-header" data-sort="sewing_cost" style="width: 70px;">Sew Cost</th>
                        <th class="sortable-header" data-sort="sewing_value" style="width: 80px;">Sew Value</th>

                    </tr>
                </thead>
                <tbody id="groupBillsTableBody">
                    <!-- Data will be loaded here -->
                </tbody>
            </table>
        </div>
        
        <!-- Pagination Controls -->
        <div class="pagination-controls">
            <div class="pagination-info">
                <span id="paginationInfo">Showing 0 of 0 records</span>
            </div>
            <div class="pagination-buttons">
                <button class="pagination-btn" onclick="goToPage(1)" id="firstPage">First</button>
                <button class="pagination-btn" onclick="goToPage(currentPage - 1)" id="prevPage">Previous</button>
                <div id="pageNumbers" class="page-numbers"></div>
                <button class="pagination-btn" onclick="goToPage(currentPage + 1)" id="nextPage">Next</button>
                <button class="pagination-btn" onclick="goToPage(getTotalPages())" id="lastPage">Last</button>
            </div>
        </div>
    </div>



    <script>
        // Group Bills Functions
        let groupBillsData = [];
        let selectedGroupBillIds = [];
        let currentPage = 1;
        const itemsPerPage = 50;

        // API Base URL - works for both local development and Railway
        const getApiBaseUrl = () => {
            const hostname = window.location.hostname;
            const port = window.location.port;
            const protocol = window.location.protocol;
            
            console.log('🔍 getApiBaseUrl debug:', { hostname, port, protocol });
            
            // Local development - Flask backend runs on port 8000
            if (hostname === 'localhost' || hostname === '127.0.0.1') {
                // If frontend is on port 3000, backend should be on 8000
                if (port === '3000') {
                    return 'http://localhost:8000';
                }
                // If frontend is on port 5000, backend is on 8000
                if (port === '5000') {
                    return 'http://localhost:8000';
                }
                // Default to port 8000 for local development
                return 'http://localhost:8000';
            }
            
            // Railway deployment - force HTTPS
            if (hostname.includes('railway.app') || hostname.includes('up.railway.app')) {
                // Force HTTPS for Railway
                const httpsUrl = `https://${hostname}`;
                console.log('🚀 Using Railway HTTPS URL:', httpsUrl);
                return httpsUrl;
            }
            
            // Other deployments - use same protocol and domain, but prefer HTTPS
            const origin = window.location.origin;
            if (protocol === 'https:') {
                return origin;
            } else {
                // Force HTTPS for production
                return origin.replace('http://', 'https://');
            }
        };

        // Load data when page loads
        // Check authentication
        function checkAuth() {
            const isLoggedIn = localStorage.getItem('gms_logged_in');
            if (isLoggedIn !== 'true') {
                window.location.href = 'login.html';
                return false;
            }
            return true;
        }

        window.addEventListener('load', async () => {
            console.log('🔄 Group Bills page loaded');
            
            // Check authentication first
            if (!checkAuth()) {
                return;
            }
            
            // Display current user
            const username = localStorage.getItem('gms_username');
            document.getElementById('currentUser').textContent = `Welcome, ${username}`;
            
            await loadGroupBillsData();
        });

        async function loadGroupBillsData() {
            console.log('🔄 loadGroupBillsData called');
            
            const tbody = document.getElementById('groupBillsTableBody');
            if (!tbody) {
                console.error('❌ Group bills table body not found');
                return;
            }
            
            console.log('✅ Found group bills table body, showing loading state');
            // Show loading state
            tbody.innerHTML = '<tr><td colspan="25" style="text-align: center; padding: 20px; color: #b0bec5;">Loading group bills data...</td></tr>';
            
            try {
                // Build query parameters
                const params = new URLSearchParams();
                const customer = document.getElementById('filterCustomer').value;
                const groupNumber = document.getElementById('filterGroupNumber').value;
                const dateFrom = document.getElementById('filterDateFrom').value;
                const dateTo = document.getElementById('filterDateTo').value;
                
                if (customer) params.append('customer', customer);
                if (groupNumber) params.append('group_number', groupNumber);
                
                // Convert DD/MM/YY to YYYY-MM-DD for backend
                if (dateFrom) {
                    try {
                        const parts = dateFrom.split('/');
                        if (parts.length === 3) {
                            const day = parts[0];
                            const month = parts[1];
                            const year = '20' + parts[2];
                            params.append('date_from', `${year}-${month}-${day}`);
                        }
                    } catch (error) {
                        console.error('Error parsing date_from:', error);
                    }
                }
                
                if (dateTo) {
                    try {
                        const parts = dateTo.split('/');
                        if (parts.length === 3) {
                            const day = parts[0];
                            const month = parts[1];
                            const year = '20' + parts[2];
                            params.append('date_to', `${year}-${month}-${day}`);
                        }
                    } catch (error) {
                        console.error('Error parsing date_to:', error);
                    }
                }
                
                const queryString = params.toString();
                const baseUrl = getApiBaseUrl();
                let url = queryString ? `${baseUrl}/api/group-bills?${queryString}` : `${baseUrl}/api/group-bills`;
                url += queryString ? `&_t=${Date.now()}` : `?_t=${Date.now()}`;
                
                console.log('🔍 API URL debug:', { baseUrl, url, windowLocation: window.location.href });
                console.log('🌐 Fetching', url);
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    }
                });
                console.log('📡 Response status:', response.status);
                
                if (response.ok) {
                    groupBillsData = await response.json();
                    console.log('📊 Received group bills data:', groupBillsData.length, 'records');
                    currentPage = 1; // Reset to first page when new data is loaded
                    populateGroupBillsTable();
                } else {
                    console.error('❌ Failed to load group bills data, status:', response.status);
                    tbody.innerHTML = '<tr><td colspan="25" style="text-align: center; padding: 20px; color: #f44336;">Failed to load group bills data. Please try refreshing the page.</td></tr>';
                }
            } catch (error) {
                console.error('❌ Error loading group bills data:', error);
                tbody.innerHTML = '<tr><td colspan="25" style="text-align: center; padding: 20px; color: #f44336;">Error loading group bills data. Please check your connection and try again.</td></tr>';
            }
        }

        function populateGroupBillsTable() {
            const tbody = document.getElementById('groupBillsTableBody');
            if (!tbody) return;
            
            if (groupBillsData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="25" style="text-align: center; padding: 20px; color: #b0bec5;">No group bills found.</td></tr>';
                updatePaginationControls();
                return;
            }
            
            // Calculate pagination
            const totalPages = Math.ceil(groupBillsData.length / itemsPerPage);
            if (currentPage > totalPages && totalPages > 0) {
                currentPage = totalPages;
            }
            
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, groupBillsData.length);
            const pageData = groupBillsData.slice(startIndex, endIndex);
            
            tbody.innerHTML = '';
            
            pageData.forEach((groupBill, pageIndex) => {
                const actualIndex = startIndex + pageIndex;
                // Level 1: Group Bill Summary (Parent Row)
                const parentRow = document.createElement('tr');
                parentRow.className = 'parent-row group-bill-row';
                parentRow.setAttribute('data-group-id', groupBill.id);
                parentRow.innerHTML = `
                    <td class="checkbox-wrapper">
                        <input type="checkbox" class="group-bill-checkbox" data-group-id="${groupBill.id}" onclick="toggleGroupBillSelection(event, ${groupBill.id})">
                    </td>
                    <td>${formatDate(groupBill.invoice_date || groupBill.created_at)}</td>
                    <td onclick="toggleGroupExpansion(${groupBill.id})">
                        <span class="expand-indicator">▶</span> ${groupBill.group_number || ''}
                    </td>
                    <td>Summary (${groupBill.line_count || 0} records)</td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td>${groupBill.customer_name || ''}</td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                `;
                tbody.appendChild(parentRow);
                
                // Level 2: Fabric Invoice and Stitching Invoice Summary Rows
                if (groupBill.details) {
                    // Fabric Invoice Summary Row
                    const fabricRow = document.createElement('tr');
                    fabricRow.className = 'child-row fabric-summary-row';
                    fabricRow.setAttribute('data-group-id', groupBill.id);
                    fabricRow.style.display = 'none';
                    fabricRow.innerHTML = `
                        <td></td>
                        <td></td>
                        <td onclick="toggleFabricExpansion(${groupBill.id})">
                            <span class="expand-indicator">▶</span> Fabric Invoice
                        </td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td>${formatNumber(groupBill.details.total_fabric_used || 0)}</td>
                        <td></td>
                        <td>${formatCurrency(groupBill.details.total_fabric_value || 0)}</td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    `;
                    tbody.appendChild(fabricRow);
                    
                    // Level 3: Fabric Invoice Details (under Fabric Invoice)
                    if (groupBill.details.individual_records && groupBill.details.individual_records.length > 0) {
                        // Fabric Detail Rows (for records with fabric invoices)
                        groupBill.details.individual_records.filter(record => record.fabric_invoice_number).forEach(record => {
                            const fabricDetailRow = document.createElement('tr');
                            fabricDetailRow.className = 'detail-row fabric-detail-row';
                            fabricDetailRow.setAttribute('data-group-id', groupBill.id);
                            fabricDetailRow.setAttribute('data-pl-serial', record.packing_list_serial || 'No PL');
                            fabricDetailRow.style.display = 'none';
                            fabricDetailRow.innerHTML = `
                                <td></td>
                                <td></td>
                                <td></td>
                                <td>${record.packing_list_serial || ''}</td>
                                <td></td>
                                <td>${record.item_name || ''}</td>
                                <td>${record.color || ''}</td>
                                <td>${record.customer || ''}</td>
                                <td>${record.beta_tax_invoice_number || ''}</td>
                                <td>${record.tax_invoice_number || ''}</td>
                                <td>${record.fabric_invoice_number || ''}</td>
                                <td>${record.delivery_note || ''}</td>
                                <td>${formatNumber(record.yard_consumed || 0)}</td>
                                <td>${formatNumber(record.fabric_unit_price || 0)}</td>
                                <td>${formatCurrency((record.yard_consumed || 0) * (record.fabric_unit_price || 0))}</td>
                                <td></td>
                                <td></td>
                                <td></td>
                                <td></td>
                                <td></td>
                                <td></td>
                                <td></td>
                                <td></td>
                                <td></td>
                                <td></td>
                            `;
                            tbody.appendChild(fabricDetailRow);
                        });
                        
                        // Add secondary fabric rows for each record
                        groupBill.details.individual_records.filter(record => record.fabric_invoice_number && record.garment_fabrics && record.garment_fabrics.length > 0).forEach(record => {
                            record.garment_fabrics.forEach(fabric => {
                                const fabricValue = parseFloat(fabric.total_fabric_cost || 0);
                                const secondaryFabricRow = document.createElement('tr');
                                secondaryFabricRow.className = 'detail-row secondary-fabric-row';
                                secondaryFabricRow.setAttribute('data-group-id', groupBill.id);
                                secondaryFabricRow.setAttribute('data-pl-serial', record.packing_list_serial || 'No PL');
                                secondaryFabricRow.style.display = 'none';
                                secondaryFabricRow.innerHTML = `
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td>${record.packing_list_serial || ''}</td>
                                    <td></td>
                                    <td style="padding-left: 20px; color: #666;">↳ ${fabric.lining_name || fabric.fabric_name || ''}</td>
                                    <td>${fabric.color || ''}</td>
                                    <td>${record.customer || ''}</td>
                                    <td>${fabric.beta_tax_invoice_number || ''}</td>
                                    <td>${fabric.tax_invoice_number || ''}</td>
                                    <td>${fabric.fabric_invoice_number || ''}</td>
                                    <td>${fabric.delivery_note || ''}</td>
                                    <td>${formatNumber(parseFloat(fabric.consumption_yards || 0))}</td>
                                    <td>${formatNumber(parseFloat(fabric.unit_price || 0))}</td>
                                    <td>${formatCurrency(fabricValue)}</td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                `;
                                tbody.appendChild(secondaryFabricRow);
                            });
                        });
                    }
                    
                    // Stitching Invoice Summary Row
                    const stitchingRow = document.createElement('tr');
                    stitchingRow.className = 'child-row stitching-summary-row';
                    stitchingRow.setAttribute('data-group-id', groupBill.id);
                    stitchingRow.style.display = 'none';
                    stitchingRow.innerHTML = `
                        <td></td>
                        <td></td>
                        <td onclick="toggleStitchingExpansion(${groupBill.id})">
                            <span class="expand-indicator">▶</span> Stitching Invoice
                        </td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td>${formatInteger(groupBill.details.size_totals?.S || 0)}</td>
                        <td>${formatInteger(groupBill.details.size_totals?.M || 0)}</td>
                        <td>${formatInteger(groupBill.details.size_totals?.L || 0)}</td>
                        <td>${formatInteger(groupBill.details.size_totals?.XL || 0)}</td>
                        <td>${formatInteger(groupBill.details.size_totals?.XXL || 0)}</td>
                        <td>${formatInteger(groupBill.details.size_totals?.XXXL || 0)}</td>
                        <td>${formatInteger((groupBill.details.size_totals?.S || 0) + (groupBill.details.size_totals?.M || 0) + (groupBill.details.size_totals?.L || 0) + (groupBill.details.size_totals?.XL || 0) + (groupBill.details.size_totals?.XXL || 0) + (groupBill.details.size_totals?.XXXL || 0))}</td>
                        <td>${formatCurrency(groupBill.details.total_stitching_value || 0)}</td>
                        <td></td>
                        <td></td>
                    `;
                    tbody.appendChild(stitchingRow);
                    
                    // Level 3: Stitching Invoice Details (under Stitching Invoice)
                    if (groupBill.details.individual_records && groupBill.details.individual_records.length > 0) {
                        // Stitching Detail Rows (for records with stitching invoices)
                        groupBill.details.individual_records.filter(record => record.stitching_invoice_number).forEach(record => {
                            // Parse size quantities from JSON string
                            let sizeQty = {};
                            if (record.size_qty_json) {
                                try {
                                    // Parse the JSON string from the database
                                    sizeQty = JSON.parse(record.size_qty_json.replace(/'/g, '"'));
                                } catch (e) {
                                    console.error('Error parsing size_qty_json:', e, record.size_qty_json);
                                    sizeQty = {};
                                }
                            }
                            const totalQty = Object.values(sizeQty).reduce((sum, qty) => sum + (parseInt(qty) || 0), 0);
                            
                            const stitchingDetailRow = document.createElement('tr');
                            stitchingDetailRow.className = 'detail-row stitching-detail-row';
                            stitchingDetailRow.setAttribute('data-group-id', groupBill.id);
                            stitchingDetailRow.setAttribute('data-pl-serial', record.packing_list_serial || 'No PL');
                            stitchingDetailRow.style.display = 'none';
                            stitchingDetailRow.innerHTML = `
                                <td></td>
                                <td></td>
                                <td></td>
                                <td>${record.packing_list_serial || ''}</td>
                                <td></td>
                                <td>${record.item_name || ''}</td>
                                <td>${record.color || ''}</td>
                                <td>${record.customer || ''}</td>
                                <td>${record.beta_tax_invoice_number || ''}</td>
                                <td>${record.tax_invoice_number || ''}</td>
                                <td>${record.fabric_invoice_number || ''}</td>
                                <td>${record.delivery_note || ''}</td>
                                <td></td>
                                <td></td>
                                <td></td>
                                <td>${formatInteger(sizeQty.S || 0)}</td>
                                <td>${formatInteger(sizeQty.M || 0)}</td>
                                <td>${formatInteger(sizeQty.L || 0)}</td>
                                <td>${formatInteger(sizeQty.XL || 0)}</td>
                                <td>${formatInteger(sizeQty.XXL || 0)}</td>
                                <td>${formatInteger(sizeQty.XXXL || 0)}</td>
                                <td>${formatInteger(totalQty)}</td>
                                <td>${formatCurrency(record.stitching_cost || 0)}</td>
                                <td>${formatCurrency(record.total_value || 0)}</td>
                                <td></td>
                            `;
                            tbody.appendChild(stitchingDetailRow);
                        });
                        
                        // Add lining fabric rows for each record
                        groupBill.details.individual_records.filter(record => record.stitching_invoice_number && record.lining_fabrics && record.lining_fabrics.length > 0).forEach(record => {
                            record.lining_fabrics.forEach(lining => {
                                const liningValue = parseFloat(lining.total_cost || 0);
                                const liningFabricRow = document.createElement('tr');
                                liningFabricRow.className = 'detail-row lining-fabric-row';
                                liningFabricRow.setAttribute('data-group-id', groupBill.id);
                                liningFabricRow.setAttribute('data-pl-serial', record.packing_list_serial || 'No PL');
                                liningFabricRow.style.display = 'none';
                                liningFabricRow.innerHTML = `
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td>${record.packing_list_serial || ''}</td>
                                    <td></td>
                                    <td style="padding-left: 20px; color: #666;">↳ Lining: ${lining.lining_name || ''}</td>
                                    <td>${lining.color || ''}</td>
                                    <td>${record.customer || ''}</td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td>${formatNumber(parseFloat(lining.consumption_yards || 0))}</td>
                                    <td>${formatNumber(parseFloat(lining.unit_price || 0))}</td>
                                    <td>${formatCurrency(liningValue)}</td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                `;
                                tbody.appendChild(liningFabricRow);
                            });
                        });
                    }

                }
            });
            
            updatePaginationControls();
        }

        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            const checkboxes = document.querySelectorAll('.group-bill-checkbox');
            
            // For single selection, uncheck all others when one is selected
            if (selectAllCheckbox.checked) {
                checkboxes.forEach(checkbox => {
                    checkbox.checked = false;
                });
                selectAllCheckbox.checked = false;
            }
            
            updateSelectedGroupBillIds();
        }

        function toggleGroupBillSelection(event, groupId) {
            event.stopPropagation();
            
            // Single selection: uncheck all other checkboxes
            const checkboxes = document.querySelectorAll('.group-bill-checkbox');
            checkboxes.forEach(checkbox => {
                if (checkbox.getAttribute('data-group-id') != groupId) {
                    checkbox.checked = false;
                }
            });
            
            // Uncheck select all checkbox
            document.getElementById('selectAllCheckbox').checked = false;
            
            updateSelectedGroupBillIds();
        }

        function updateSelectedGroupBillIds() {
            selectedGroupBillIds = [];
            const checkboxes = document.querySelectorAll('.group-bill-checkbox:checked');
            
            checkboxes.forEach(checkbox => {
                selectedGroupBillIds.push(parseInt(checkbox.getAttribute('data-group-id')));
            });
            
            updatePaginationControls();
            updateActionButtons();
        }

        function updateActionButtons() {
            const hasSelection = selectedGroupBillIds.length === 1;
            
            document.getElementById('downloadStitchingBtn').disabled = !hasSelection;
            document.getElementById('downloadFabricBtn').disabled = !hasSelection;
            document.getElementById('deleteBtn').disabled = !hasSelection;
        }

        function downloadSelectedStitchingPDF() {
            if (selectedGroupBillIds.length === 1) {
                downloadStitchingPDF(selectedGroupBillIds[0]);
            }
        }

        function downloadSelectedFabricPDF() {
            if (selectedGroupBillIds.length === 1) {
                downloadFabricPDF(selectedGroupBillIds[0]);
            }
        }

        function deleteSelectedGroupBill() {
            if (selectedGroupBillIds.length === 1) {
                deleteGroupBill(selectedGroupBillIds[0]);
            }
        }

        function getSelectedGroupBillIds() {
            return selectedGroupBillIds;
        }

        function clearFilters() {
            document.getElementById('filterCustomer').value = '';
            document.getElementById('filterGroupNumber').value = '';
            document.getElementById('filterDateFrom').value = '';
            document.getElementById('filterDateTo').value = '';
            loadGroupBillsData();
        }

        function refreshGroupBillsTable() {
            loadGroupBillsData();
        }



        async function downloadStitchingPDF(groupId) {
            try {
                const response = await fetch(`${getApiBaseUrl()}/api/group-bills/${groupId}/stitching-pdf`);
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `group_bill_${groupId}_stitching.pdf`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } else {
                    alert('Failed to download stitching PDF');
                }
            } catch (error) {
                console.error('Error downloading stitching PDF:', error);
                alert('Error downloading stitching PDF');
            }
        }

        async function downloadFabricPDF(groupId) {
            try {
                const response = await fetch(`${getApiBaseUrl()}/api/group-bills/${groupId}/fabric-pdf`);
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `group_bill_${groupId}_fabric.pdf`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } else {
                    alert('Failed to download fabric PDF');
                }
            } catch (error) {
                console.error('Error downloading fabric PDF:', error);
                alert('Error downloading fabric PDF');
            }
        }

        async function deleteGroupBill(groupId) {
            if (!confirm('Are you sure you want to delete this group bill? This action cannot be undone.')) {
                return;
            }
            
            try {
                const response = await fetch(`${getApiBaseUrl()}/api/group-bills/${groupId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    alert('Group bill deleted successfully');
                    loadGroupBillsData();
                } else {
                    const error = await response.json();
                    alert(`Failed to delete group bill: ${error.error}`);
                }
            } catch (error) {
                console.error('Error deleting group bill:', error);
                alert('Error deleting group bill');
            }
        }

        function exportGroupBillsData() {
            if (groupBillsData.length === 0) {
                alert('No data to export');
                return;
            }
            
            const csvContent = generateCSV(groupBillsData);
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `group_bills_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function generateCSV(data) {
            const headers = ['Date', 'Customer', 'Group Number', 'Invoice Date', 'Line Count', 'Total Stitching Value', 'Total Fabric Value', 'Total Items'];
            const csvRows = [headers.join(',')];
            
            data.forEach(item => {
                const row = [
                    formatDate(item.created_at),
                    `"${item.customer_name || ''}"`,
                    item.group_number || '',
                    formatDate(item.invoice_date),
                    item.line_count || 0,
                    item.total_stitching_value || 0,
                    item.total_fabric_value || 0,
                    item.total_items || 0
                ];
                csvRows.push(row.join(','));
            });
            
            return csvRows.join('\n');
        }



        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-GB');
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'THB',
                minimumFractionDigits: 2
            }).format(amount);
        }

        // Utility functions
        function formatNumber(num) {
            if (num === null || num === undefined) return '0.00';
            return parseFloat(num).toFixed(2);
        }

        function formatInteger(num) {
            if (num === null || num === undefined) return '0';
            return parseInt(num).toString();
        }

        function formatCurrency(amount) {
            if (amount === null || amount === undefined) return '0.00';
            return parseFloat(amount).toLocaleString('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            try {
                const date = new Date(dateString);
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = String(date.getFullYear()).slice(-2);
                return `${day}/${month}/${year}`;
            } catch (error) {
                return dateString;
            }
        }

        function formatDateInput(input) {
            let value = input.value.replace(/\D/g, '');
            if (value.length > 6) {
                value = value.substring(0, 6);
            }
            if (value.length >= 4) {
                value = value.substring(0, 2) + '/' + value.substring(2, 4) + '/' + value.substring(4);
            } else if (value.length >= 2) {
                value = value.substring(0, 2) + '/' + value.substring(2);
            }
            input.value = value;
        }

        function getSizeQuantity(sizeQtyJson, size) {
            if (!sizeQtyJson) return 0;
            try {
                let sizeQty;
                if (typeof sizeQtyJson === 'string') {
                    // Handle single quotes in JSON string by replacing with double quotes
                    const jsonString = sizeQtyJson.replace(/'/g, '"');
                    sizeQty = JSON.parse(jsonString);
                } else {
                    sizeQty = sizeQtyJson;
                }
                return sizeQty[size] || 0;
            } catch (error) {
                console.error('Error parsing size_qty_json:', error, sizeQtyJson);
                return 0;
            }
        }

        function getTotalQuantity(sizeQtyJson) {
            if (!sizeQtyJson) return 0;
            try {
                let sizeQty;
                if (typeof sizeQtyJson === 'string') {
                    // Handle single quotes in JSON string by replacing with double quotes
                    const jsonString = sizeQtyJson.replace(/'/g, '"');
                    sizeQty = JSON.parse(jsonString);
                } else {
                    sizeQty = sizeQtyJson;
                }
                return (sizeQty.S || 0) + (sizeQty.M || 0) + (sizeQty.L || 0) + (sizeQty.XL || 0) + (sizeQty.XXL || 0) + (sizeQty.XXXL || 0);
            } catch (error) {
                console.error('Error parsing size_qty_json:', error, sizeQtyJson);
                return 0;
            }
        }

        function toggleGroupExpansion(groupId) {
            const parentRow = document.querySelector(`tr[data-group-id="${groupId}"].parent-row`);
            const expandIndicator = parentRow.querySelector('.expand-indicator');
            const childRows = document.querySelectorAll(`tr[data-group-id="${groupId}"].child-row`);
            const subChildRows = document.querySelectorAll(`tr[data-group-id="${groupId}"].sub-child-row`);
            const detailRows = document.querySelectorAll(`tr[data-group-id="${groupId}"].detail-row`);
            
            const isExpanded = expandIndicator.classList.contains('expanded');
            
            if (isExpanded) {
                // Collapse
                expandIndicator.classList.remove('expanded');
                expandIndicator.textContent = '▶';
                childRows.forEach(row => row.style.display = 'none');
                subChildRows.forEach(row => row.style.display = 'none');
                detailRows.forEach(row => row.style.display = 'none');
            } else {
                // Expand
                expandIndicator.classList.add('expanded');
                expandIndicator.textContent = '▼';
                childRows.forEach(row => row.style.display = 'table-row');
                // Don't auto-expand sub-levels
            }
        }

        function toggleFabricExpansion(groupId) {
            const fabricRow = document.querySelector(`tr[data-group-id="${groupId}"].fabric-summary-row`);
            const expandIndicator = fabricRow.querySelector('.expand-indicator');
            const plFabricRows = document.querySelectorAll(`tr[data-group-id="${groupId}"].pl-fabric-row`);
            const fabricDetailRows = document.querySelectorAll(`tr[data-group-id="${groupId}"].fabric-detail-row`);
            const secondaryFabricRows = document.querySelectorAll(`tr[data-group-id="${groupId}"].secondary-fabric-row`);
            
            const isExpanded = expandIndicator.classList.contains('expanded');
            
            if (isExpanded) {
                // Collapse
                expandIndicator.classList.remove('expanded');
                expandIndicator.textContent = '▶';
                plFabricRows.forEach(row => row.style.display = 'none');
                fabricDetailRows.forEach(row => row.style.display = 'none');
                secondaryFabricRows.forEach(row => row.style.display = 'none');
            } else {
                // Expand
                expandIndicator.classList.add('expanded');
                expandIndicator.textContent = '▼';
                plFabricRows.forEach(row => row.style.display = 'table-row');
                fabricDetailRows.forEach(row => row.style.display = 'table-row');
                secondaryFabricRows.forEach(row => row.style.display = 'table-row');
            }
        }

        function toggleStitchingExpansion(groupId) {
            const stitchingRow = document.querySelector(`tr[data-group-id="${groupId}"].stitching-summary-row`);
            const expandIndicator = stitchingRow.querySelector('.expand-indicator');
            const plStitchingRows = document.querySelectorAll(`tr[data-group-id="${groupId}"].pl-stitching-row`);
            const stitchingDetailRows = document.querySelectorAll(`tr[data-group-id="${groupId}"].stitching-detail-row`);
            const liningFabricRows = document.querySelectorAll(`tr[data-group-id="${groupId}"].lining-fabric-row`);
            
            const isExpanded = expandIndicator.classList.contains('expanded');
            
            if (isExpanded) {
                // Collapse
                expandIndicator.classList.remove('expanded');
                expandIndicator.textContent = '▶';
                plStitchingRows.forEach(row => row.style.display = 'none');
                stitchingDetailRows.forEach(row => row.style.display = 'none');
                liningFabricRows.forEach(row => row.style.display = 'none');
            } else {
                // Expand
                expandIndicator.classList.add('expanded');
                expandIndicator.textContent = '▼';
                plStitchingRows.forEach(row => row.style.display = 'table-row');
                stitchingDetailRows.forEach(row => row.style.display = 'table-row');
                liningFabricRows.forEach(row => row.style.display = 'table-row');
            }
        }

        function logout() {
            localStorage.removeItem('gms_logged_in');
            localStorage.removeItem('gms_username');
            window.location.href = 'login.html';
        }

        // Pagination Functions
        function getTotalPages() {
            return Math.ceil(groupBillsData.length / itemsPerPage);
        }

        function goToPage(page) {
            const totalPages = getTotalPages();
            if (page < 1 || page > totalPages) {
                return;
            }
            currentPage = page;
            populateGroupBillsTable();
        }

        function updatePaginationControls() {
            const totalPages = getTotalPages();
            const startRecord = (currentPage - 1) * itemsPerPage + 1;
            const endRecord = Math.min(currentPage * itemsPerPage, groupBillsData.length);
            
            // Update pagination info
            const paginationInfo = document.getElementById('paginationInfo');
            if (paginationInfo) {
                paginationInfo.textContent = `Showing ${startRecord} to ${endRecord} of ${groupBillsData.length} records`;
            }
            
            // Update button states
            const firstPageBtn = document.getElementById('firstPage');
            const prevPageBtn = document.getElementById('prevPage');
            const nextPageBtn = document.getElementById('nextPage');
            const lastPageBtn = document.getElementById('lastPage');
            
            if (firstPageBtn) firstPageBtn.disabled = currentPage === 1;
            if (prevPageBtn) prevPageBtn.disabled = currentPage === 1;
            if (nextPageBtn) nextPageBtn.disabled = currentPage === totalPages;
            if (lastPageBtn) lastPageBtn.disabled = currentPage === totalPages;
            
            // Update page numbers
            const pageNumbersContainer = document.getElementById('pageNumbers');
            if (pageNumbersContainer) {
                pageNumbersContainer.innerHTML = '';
                
                const maxVisiblePages = 5;
                let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
                let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
                
                if (endPage - startPage + 1 < maxVisiblePages) {
                    startPage = Math.max(1, endPage - maxVisiblePages + 1);
                }
                
                for (let i = startPage; i <= endPage; i++) {
                    const pageBtn = document.createElement('button');
                    pageBtn.className = `pagination-btn ${i === currentPage ? 'active' : ''}`;
                    pageBtn.textContent = i;
                    pageBtn.onclick = () => goToPage(i);
                    pageNumbersContainer.appendChild(pageBtn);
                }
            }
        }

        // ===== TABLE SORTING FUNCTIONALITY =====
        
        // Initialize table sorter
        let tableSorter = null;

        // Custom data getter for group bills data
        function getGroupBillsValueForSorting(item, column) {
            switch (column) {
                case 'created_at':
                    return item.created_at;
                case 'group_bill_number':
                    return item.group_bill_number;
                case 'packing_list_number':
                    return item.packing_list_number;
                case 'garment':
                    return item.garment;
                case 'fabric':
                    return item.fabric;
                case 'color':
                    return item.color;
                case 'customer':
                    return item.customer;
                case 'tax_invoice_number':
                    return item.tax_invoice_number;
                case 'msk_invoice_number':
                    return item.msk_invoice_number;
                case 'fabric_invoice':
                    return item.fabric_invoice;
                case 'fabric_delivery_note':
                    return item.fabric_delivery_note;
                case 'fabric_used':
                    return item.fabric_used;
                case 'fabric_cost':
                    return item.fabric_cost;
                case 'fabric_value':
                    return item.fabric_value;
                case 'size_s':
                    return item.size_s;
                case 'size_m':
                    return item.size_m;
                case 'size_l':
                    return item.size_l;
                case 'size_xl':
                    return item.size_xl;
                case 'size_xxl':
                    return item.size_xxl;
                case 'size_xxxl':
                    return item.size_xxxl;
                case 'total_qty':
                    return item.total_qty;
                case 'sewing_cost':
                    return item.sewing_cost;
                case 'sewing_value':
                    return item.sewing_value;
                default:
                    return '';
            }
        }

        // Initialize table sorter when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize table sorter
            tableSorter = createTableSorter('groupBillsTable', {
                dataGetter: getGroupBillsValueForSorting
            });
            
            // Listen for sort events
            document.getElementById('groupBillsTable').addEventListener('tableSorted', function(event) {
                const { data } = event.detail;
                groupBillsData = data;
                populateGroupBillsTable();
            });
            
            console.log('✅ Group bills table sorter initialized and ready');
        });

        // Override the loadGroupBillsData function to update table sorter
        const originalLoadGroupBillsData = loadGroupBillsData;
        loadGroupBillsData = async function() {
            await originalLoadGroupBillsData();
            
            // Initialize table sorter if not already done
            if (!tableSorter) {
                tableSorter = createTableSorter('groupBillsTable', {
                    dataGetter: getGroupBillsValueForSorting
                });
                
                // Listen for sort events
                document.getElementById('groupBillsTable').addEventListener('tableSorted', function(event) {
                    const { data } = event.detail;
                    groupBillsData = data;
                    populateGroupBillsTable();
                });
                
                console.log('✅ Group bills table sorter initialized after data load');
            }
            
            // Update table sorter with new data
            if (tableSorter && groupBillsData && groupBillsData.length > 0) {
                tableSorter.setData(groupBillsData, getGroupBillsValueForSorting);
                console.log(`💾 Updated group bills table sorter with ${groupBillsData.length} records`);
            } else {
                console.log('⚠️ No group bills data available for table sorter');
            }
        }
    </script>
    <script src="js/table-sorting.js"></script>
</body>
</html>

