<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    <title>Fabric Invoices - Garment Management System</title>
    <link rel="stylesheet" href="css/table-sorting.css">
    <style>
        :root {
            /* Dark theme (default) */
            --bg-primary: #212121;
            --bg-secondary: #2c2c2c;
            --bg-tertiary: #424242;
            --text-primary: #eceff1;
            --text-secondary: #b0bec5;
            --nav-bg: #23272f;
            --nav-border: #3949ab;
            --nav-active: #3949ab;
            --nav-hover: #3949ab;
            --border-color: #555;
            --focus-color: #5c6bc0;
            --card-bg: #2c2c2c;
            --chart-grid: #37474f;
        }

        [data-theme="light"] {
            /* Light theme */
            --bg-primary: #f5f5f5;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f8f9fa;
            --text-primary: #212121;
            --text-secondary: #666666;
            --nav-bg: #ffffff;
            --nav-border: #e0e0e0;
            --nav-active: #1976d2;
            --nav-hover: #f5f5f5;
            --border-color: #e0e0e0;
            --focus-color: #1976d2;
            --card-bg: #ffffff;
            --chart-grid: #e0e0e0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            font-size: 13px;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* Navigation Bar */
        .nav-bar {
            background: var(--nav-bg);
            border-bottom: 1px solid var(--nav-border);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            height: 60px;
            display: flex;
            align-items: center;
            padding: 0 20px;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .nav-tabs {
            display: flex;
            list-style: none;
            gap: 0;
        }

        .nav-tab {
            background: transparent;
            border: none;
            color: var(--text-primary);
            padding: 15px 25px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            text-decoration: none;
            display: inline-block;
        }

        .nav-tab:hover {
            background-color: var(--nav-hover);
            color: var(--text-primary);
        }

        .nav-tab.active {
            background-color: var(--nav-active);
            color: var(--text-primary);
            border-bottom-color: var(--focus-color);
        }

        .nav-user {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .nav-user span {
            color: var(--text-secondary);
            font-size: 12px;
        }

        /* Theme Toggle Button */
        .theme-toggle {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .theme-toggle:hover {
            background: var(--bg-secondary);
            border-color: var(--focus-color);
        }

        .theme-toggle .icon {
            font-size: 14px;
        }

        .logout-btn {
            background: #d32f2f;
            color: #fff;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: #f44336;
        }

        /* Main Content */
        .main-content {
            margin-top: 60px;
            padding: 20px;
            min-height: calc(100vh - 60px);
        }



        /* Filter Controls */
        .filter-controls {
            background: var(--card-bg);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .filter-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-group label {
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .filter-select, .filter-input {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 14px;
        }

        /* Enhanced Filter Dropdown Styling */
        .searchable-dropdown {
            position: relative;
            width: 100%;
        }

        .dropdown-options {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-top: none;
            border-radius: 0 0 4px 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .dropdown-option {
            padding: 8px 12px;
            cursor: pointer;
            color: var(--text-primary);
            border-bottom: 1px solid var(--border-color);
            transition: background-color 0.2s ease;
        }

        .dropdown-option:hover {
            background-color: var(--focus-color);
        }

        .dropdown-option.selected {
            background-color: var(--focus-color);
            color: var(--text-primary);
        }

        .selected-items {
            margin-top: 5px;
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }

        .selected-item {
            background: var(--focus-color);
            color: var(--text-primary);
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .selected-item .remove-btn {
            background: none;
            border: none;
            color: var(--text-primary);
            cursor: pointer;
            font-size: 14px;
            padding: 0;
            margin: 0;
            line-height: 1;
        }

        .selected-item .remove-btn:hover {
            color: #f44336;
        }

        .filter-select:focus, .filter-input:focus {
            outline: none;
            border-color: var(--focus-color);
        }

        /* Enhanced Filter Dropdown Styles */
        .filter-container {
            position: relative;
            display: inline-block;
        }

        .filter-select-enhanced {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 12px;
            min-width: 120px;
            cursor: text;
            position: relative;
            user-select: text;
            transition: border-color 0.3s ease, background-color 0.3s ease;
        }

        .filter-select-enhanced:focus {
            outline: none;
            border-color: var(--focus-color);
            background: var(--bg-secondary);
        }

        .filter-select-enhanced::after {
            content: '▼';
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 10px;
            color: var(--text-secondary);
            pointer-events: none;
        }

        .filter-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-top: none;
            border-radius: 0 0 4px 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .filter-dropdown.show {
            display: block;
        }

        .filter-input-search {
            width: 100%;
            background: var(--bg-tertiary);
            border: none;
            color: var(--text-primary);
            padding: 8px 12px;
            font-size: 12px;
            border-bottom: 1px solid var(--border-color);
        }

        .filter-input-search:focus {
            outline: none;
            background: var(--bg-secondary);
        }

        .filter-option {
            padding: 8px 12px;
            cursor: pointer;
            color: var(--text-primary);
            font-size: 12px;
            border-bottom: 1px solid var(--border-color);
        }

        .filter-option:hover {
            background: var(--focus-color);
        }

        .filter-option.selected {
            background: var(--nav-active);
        }

        .filter-option.empty {
            color: var(--text-secondary);
            font-style: italic;
        }

        .filter-option:first-child {
            font-weight: bold;
            color: var(--focus-color);
            border-bottom: 2px solid var(--border-color);
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .checkbox-label input[type="checkbox"] {
            width: 16px;
            height: 16px;
        }

        /* Table Styles */
        .table-container {
            background: var(--card-bg);
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 10px;
            border: 1px solid var(--border-color);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        .data-table th {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            padding: 12px 8px;
            text-align: center;
            font-weight: 600;
            font-size: 13px;
            border-bottom: 2px solid var(--border-color);
            white-space: nowrap;
        }

        .data-table td {
            padding: 10px 8px;
            border-bottom: 1px solid var(--border-color);
            vertical-align: middle;
            text-align: center;
        }

        .data-table tr:hover {
            background: var(--bg-tertiary);
        }

        .data-table tr.selected {
            background: var(--focus-color) !important;
            color: var(--text-primary);
        }

        /* Pagination Styles */
        .table-container {
            max-height: 600px;
            overflow-y: auto;
            background: var(--card-bg);
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .table-container::-webkit-scrollbar {
            width: 8px;
        }

        .table-container::-webkit-scrollbar-track {
            background: var(--bg-tertiary);
            border-radius: 4px;
        }

        .table-container::-webkit-scrollbar-thumb {
            background: var(--focus-color);
            border-radius: 4px;
        }

        .table-container::-webkit-scrollbar-thumb:hover {
            background: var(--nav-active);
        }

        .pagination-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--card-bg);
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
            border: 1px solid var(--border-color);
        }

        /* Checkbox styling */
        .checkbox-wrapper {
            text-align: center;
        }

        .checkbox-wrapper input[type="checkbox"] {
            margin: 0;
            cursor: pointer;
            width: 16px;
            height: 16px;
            accent-color: var(--focus-color);
        }
        
        /* Ensure checkbox cell alignment */
        .data-table td.checkbox-wrapper {
            text-align: center;
            vertical-align: middle;
            padding: 10px 8px;
            border-bottom: 1px solid var(--border-color);
        }

        /* Make it clear that rows are not clickable */
        .data-table tr {
            cursor: default;
        }

        .data-table tr:hover {
            background: var(--bg-tertiary) !important;
        }

        .data-table tr:hover td {
            background: var(--bg-tertiary) !important;
        }

        .pagination-info {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .pagination-buttons {
            display: flex;
            gap: 10px;
        }

        .pagination-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .pagination-btn:hover:not(:disabled) {
            background: var(--focus-color);
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination-btn.active {
            background: #5c6bc0;
            color: #fff;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: var(--focus-color);
            color: #fff;
        }

        .btn-primary:hover {
            background: var(--nav-active);
        }

        .btn-secondary {
            background: #757575;
            color: #fff;
        }

        .btn-secondary:hover {
            background: #9e9e9e;
        }

        .btn-success {
            background: #388e3c;
            color: #fff;
        }

        .btn-success:hover {
            background: #4caf50;
        }

        .btn-warning {
            background: #f57c00;
            color: #fff;
        }

        .btn-warning:hover {
            background: #ff9800;
        }

        .btn-danger {
            background: #d32f2f;
            color: #fff;
        }

        .btn-danger:hover {
            background: #f44336;
        }

        .btn-info {
            background: #1976d2;
            color: #fff;
        }

        .btn-info:hover {
            background: #2196f3;
        }

        /* Import Progress */
        .import-progress {
            background: var(--card-bg);
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid var(--border-color);
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: var(--bg-tertiary);
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            height: 100%;
            background: var(--focus-color);
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            text-align: center;
            color: var(--text-secondary);
            font-size: 14px;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }
        
        /* FIXED: Edit dialogs should appear on top of list dialogs */
        #costDialog, #priceDialog {
            z-index: 10002;
        }

        .modal-content {
            background: var(--card-bg);
            margin: 2% auto;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            color: var(--text-primary);
            position: relative;
            border: 1px solid var(--border-color);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--focus-color);
        }

        .close {
            color: var(--text-secondary);
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: var(--text-primary);
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: var(--text-secondary);
            font-size: 14px;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            color: var(--text-primary);
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: var(--focus-color);
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
            position: sticky;
            bottom: 0;
            background: var(--card-bg);
            padding-bottom: 10px;
        }

        /* Custom Dialog Styles */
        .custom-dialog {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .custom-dialog-content {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            color: var(--text-primary);
        }

        .custom-dialog-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .custom-dialog-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--focus-color);
        }

        .custom-dialog-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 20px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .custom-dialog-close:hover {
            color: var(--text-primary);
        }

        .custom-dialog-body {
            margin-bottom: 20px;
        }

        .custom-dialog-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
        }

        .custom-dialog-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .custom-dialog-btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .custom-dialog-btn-secondary:hover {
            background: var(--bg-secondary);
            border-color: var(--focus-color);
        }

        .custom-dialog-btn-primary {
            background: var(--focus-color);
            color: #fff;
        }

        .custom-dialog-btn-primary:hover {
            background: var(--nav-active);
        }

        .custom-dialog-btn-success {
            background: #388e3c;
            color: #fff;
        }

        .custom-dialog-btn-success:hover {
            background: #4caf50;
        }

        .custom-dialog-btn-warning {
            background: #f57c00;
            color: #fff;
        }

        .custom-dialog-btn-warning:hover {
            background: #ff9800;
        }

        .custom-dialog-btn-danger {
            background: #d32f2f;
            color: #fff;
        }

        .custom-dialog-btn-danger:hover {
            background: #f44336;
        }

        /* Fabric Selection Dialog Hover Effects */
        .fabric-selection-dialog table tbody tr:hover {
            background: var(--bg-tertiary) !important;
        }

        .fabric-selection-dialog table tbody tr:hover td {
            background: var(--bg-tertiary) !important;
        }

        .custom-dialog-btn-info {
            background: #1976d2;
            color: #fff;
        }

        .custom-dialog-btn-info:hover {
            background: #2196f3;
        }

        /* Content Section Styles */
        .content-section {
            margin-top: 20px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .section-header h2 {
            color: var(--text-primary);
            margin: 0;
        }

        /* Cost and Price List Table Styles */
        #costListTable, #priceListTable {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        #costListTable th, #costListTable td,
        #priceListTable th, #priceListTable td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        #costListTable th, #priceListTable th {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        #costListTable tbody tr:hover,
        #priceListTable tbody tr:hover {
            background: var(--bg-tertiary);
        }

        .action-buttons {
            display: flex;
            gap: 5px;
        }

        .btn-edit, .btn-delete {
            padding: 4px 8px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.3s ease;
        }

        .btn-edit {
            background: #1976d2;
            color: white;
        }

        .btn-edit:hover {
            background: #2196f3;
        }

        .btn-delete {
            background: #d32f2f;
            color: white;
        }

        .btn-delete:hover {
            background: #f44336;
        }

        /* Dialog-specific styles */
        .modal-content[style*="width: 90%"] {
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-content[style*="width: 90%"] .modal-body {
            max-height: 60vh;
            overflow-y: auto;
        }

        .modal-content[style*="width: 90%"] .table-container {
            max-height: 50vh;
            overflow-y: auto;
        }

        /* Location dialog specific styles */
        #selectedLinesInfo {
            max-height: 200px;
            overflow-y: auto;
        }

        #selectedLinesInfo div {
            font-family: monospace;
            font-size: 11px;
        }


    </style>
    <script src="js/table-sorting.js"></script>
    <script src="js/common/table-manager.js"></script>
    <script src="js/common/action-manager.js"></script>
    <script src="js/common/fabric-invoice-template.js"></script>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="nav-bar">
        <ul class="nav-tabs">
            <li><a href="fabric-invoices.html" class="nav-tab active">Fabric Invoices</a></li>
            <li><a href="stitching-records.html" class="nav-tab">Stitching Records</a></li>
            <li><a href="packing-lists.html" class="nav-tab">Packing Lists</a></li>
            <li><a href="group-bills.html" class="nav-tab">Group Bills</a></li>
            <li><a href="dashboard.html" class="nav-tab">Dashboard</a></li>
        </ul>
        <div class="nav-user">
            <button onclick="toggleTheme()" class="theme-toggle" id="themeToggle">
                <span class="icon" id="themeIcon">🌙</span>
                <span id="themeText">Dark</span>
            </button>
            <span id="currentUser"></span>
            <button onclick="logout()" class="logout-btn">Logout</button>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        
        <!-- Filter Controls -->
        <div class="filter-controls">
            <div class="filter-row">
                <div class="filter-group">
                    <label>Customer:</label>
                    <div class="filter-container">
                        <input type="text" id="filterCustomer" class="filter-select-enhanced" placeholder="Select Customer">
                        <div id="filterCustomerDropdown" class="filter-dropdown">
                            <input type="text" class="filter-input-search" placeholder="Type to search...">
                            <div class="filter-options"></div>
                        </div>
                    </div>
                </div>
                
                <div class="filter-group">
                    <label>Fab Inv:</label>
                    <div class="filter-container">
                        <input type="text" id="filterFabInvoice" class="filter-select-enhanced" placeholder="Select Invoice">
                        <div id="filterFabInvoiceDropdown" class="filter-dropdown">
                            <input type="text" class="filter-input-search" placeholder="Type to search...">
                            <div class="filter-options"></div>
                        </div>
                    </div>
                </div>
                
                <div class="filter-group">
                    <label>Tax Inv:</label>
                    <div class="filter-container">
                        <input type="text" id="filterTaxInvoice" class="filter-select-enhanced" placeholder="Select Tax Invoice">
                        <div id="filterTaxInvoiceDropdown" class="filter-dropdown">
                            <input type="text" class="filter-input-search" placeholder="Type to search...">
                            <div class="filter-options"></div>
                        </div>
                    </div>
                </div>
                
                <div class="filter-group">
                    <label>Item:</label>
                    <div class="filter-container">
                        <input type="text" id="filterItemCode" class="filter-select-enhanced" placeholder="Select Item">
                        <div id="filterItemCodeDropdown" class="filter-dropdown">
                            <input type="text" class="filter-input-search" placeholder="Type to search...">
                            <div class="filter-options"></div>
                        </div>
                    </div>
                </div>
                
                <div class="filter-group">
                    <label>DN:</label>
                    <div class="filter-container">
                        <input type="text" id="filterDN" class="filter-select-enhanced" placeholder="Select DN">
                        <div id="filterDNDropdown" class="filter-dropdown">
                            <input type="text" class="filter-input-search" placeholder="Type to search...">
                            <div class="filter-options"></div>
                        </div>
                    </div>
                </div>
                
                <div class="filter-group">
                    <label>Location:</label>
                    <div class="filter-container">
                        <input type="text" id="filterLocation" class="filter-select-enhanced" placeholder="Select Location">
                        <div id="filterLocationDropdown" class="filter-dropdown">
                            <input type="text" class="filter-input-search" placeholder="Type to search...">
                            <div class="filter-options"></div>
                        </div>
                    </div>
                </div>
                
                <div class="filter-group">
                    <label>From:</label>
                    <input type="text" id="filterDateFrom" class="filter-input" placeholder="DD/MM/YY">
                </div>
                
                <div class="filter-group">
                    <label>To:</label>
                    <input type="text" id="filterDateTo" class="filter-input" placeholder="DD/MM/YY">
                </div>
                
                <div class="filter-group">
                    <label style="display: block; margin-bottom: 5px; color: var(--text-secondary); font-size: 12px;">Stock Status:</label>
                    <div style="display: flex; gap: 10px;">
                        <label class="checkbox-label">
                            <input type="radio" name="stockStatus" value="inStock" id="inStock" checked>
                            In Stock
                        </label>
                        <label class="checkbox-label">
                            <input type="radio" name="stockStatus" value="noStock" id="noStock">
                            No Stock
                        </label>
                    </div>
                </div>
                
                <button class="btn btn-secondary" onclick="clearFilters()">Clear Filter</button>
            </div>
        </div>
        
        <!-- Action Buttons -->
        <div class="action-buttons">
            <button class="btn btn-primary" onclick="assignDeliveredLocation()">Assign Delivered Location</button>
            <button class="btn btn-danger" onclick="removeLocationFromSelected()">Remove Location</button>
            <button class="btn btn-primary" onclick="assignTaxInvoiceNumber()">Assign Tax Invoice Number</button>
            <button class="btn btn-secondary" onclick="refreshInvoiceTable()">Refresh</button>
            <button class="btn btn-info" onclick="openCustomerIdDialog()">Customer IDs</button>
            <button class="btn btn-warning" onclick="openAddInvoiceLineDialog()">Add Invoice Line</button>
            <button class="btn btn-primary" onclick="editSelectedInvoice()">Edit Selected Invoice</button>
            <button class="btn btn-danger" onclick="deleteSelectedInvoice()">Delete Selected Invoice</button>
            <button class="btn btn-primary" onclick="openDatImportDialog()">Import .DAT File</button>
            <button class="btn btn-success" onclick="openCostListDialog()">Cost List</button>
            <button class="btn btn-success" onclick="openPriceListDialog()">Price List</button>
        </div>

        <!-- Invoice Table -->
        <div class="table-container">
            <table id="invoiceTable" class="data-table">
                <thead>
                    <tr>
                        <th style="width: 30px;">
                            <input type="checkbox" id="selectAllCheckbox" onclick="toggleSelectAll()">
                        </th>
                        <th class="sortable-header" data-sort="date">Date</th>
                        <th class="sortable-header" data-sort="short_name">Short Name</th>
                        <th class="sortable-header" data-sort="invoice_number">Invoice Number</th>
                        <th class="sortable-header" data-sort="tax_invoice_number">Beta T#</th>
                        <th class="sortable-header" data-sort="item_name">Item Code</th>
                        <th class="sortable-header" data-sort="color">Color</th>
                        <th class="sortable-header" data-sort="delivery_note">Delivery Note</th>
                        <th class="sortable-header" data-sort="yards_sent">In Stock</th>
                        <th class="sortable-header" data-sort="total_used">Used</th>
                        <th class="sortable-header" data-sort="pending">Pending</th>
                        <th class="sortable-header" data-sort="unit_price">Price</th>
                        <th class="sortable-header" data-sort="total">Total</th>
                        <th class="sortable-header" data-sort="delivered_location">Location</th>
                        <th>Actions</th>
                        <th style="display: none;">Line ID</th>
                    </tr>
                </thead>
                <tbody id="invoiceTableBody">
                    <!-- Data will be loaded here -->
                </tbody>
            </table>
        </div>

        <!-- Pagination Controls -->
        <div class="pagination-controls">
            <div class="pagination-info">
                Showing <span id="paginationStart">0</span> to <span id="paginationEnd">0</span> of <span id="paginationTotal">0</span> records
            </div>
            <div class="pagination-buttons">
                <button class="pagination-btn" id="firstPage" onclick="goToPage(1)">First</button>
                <button class="pagination-btn" id="prevPage" onclick="goToPage(currentPage - 1)">Previous</button>
                <span id="pageNumbers"></span>
                <button class="pagination-btn" id="nextPage" onclick="goToPage(currentPage + 1)">Next</button>
                <button class="pagination-btn" id="lastPage" onclick="goToPage(getTotalPages())">Last</button>
            </div>
        </div>
        
        <!-- Import Progress -->
        <div id="importProgress" class="import-progress" style="display: none;">
            <div class="progress-bar">
                <div class="progress-fill"></div>
            </div>
            <div class="progress-text">Importing...</div>
        </div>

        <!-- Edit Invoice Line Dialog -->
        <div id="editInvoiceDialog" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">Edit Invoice Line</h2>
                    <span class="close" onclick="closeEditInvoiceDialog()">&times;</span>
                </div>
                <div class="modal-body">
                    <form id="editInvoiceForm">
                        <div class="form-group">
                            <label for="editItemName">Item Name:</label>
                            <input type="text" id="editItemName" required>
                        </div>
                        <div class="form-group">
                            <label for="editColor">Color:</label>
                            <input type="text" id="editColor">
                        </div>
                        <div class="form-group">
                            <label for="editDeliveryNote">Delivery Note:</label>
                            <input type="text" id="editDeliveryNote">
                        </div>
                        <div class="form-group">
                            <label for="editYardsSent">Yards Sent:</label>
                            <input type="number" id="editYardsSent" step="0.01" min="0" required>
                        </div>
                        <div class="form-group">
                            <label for="editYardsConsumed">Yards Consumed:</label>
                            <input type="number" id="editYardsConsumed" step="0.01" min="0" required>
                        </div>
                        <div class="form-group">
                            <label for="editUnitPrice">Unit Price:</label>
                            <input type="number" id="editUnitPrice" step="0.01" min="0" required>
                        </div>
                        <div class="form-group">
                            <label for="editDeliveredLocation">Delivered Location:</label>
                            <input type="text" id="editDeliveredLocation">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeEditInvoiceDialog()">Cancel</button>
                    <button class="btn btn-primary" onclick="saveEditInvoice()">Save Changes</button>
                </div>
            </div>
        </div>
        
        <!-- Commission Sale Dialog -->
        <div id="commissionSaleDialog" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">Mark as Commission Sale</h2>
                    <span class="close" onclick="closeCommissionSaleDialog()">&times;</span>
                </div>
                <div class="modal-body">
                    <div style="margin-bottom: 20px;">
                        <h3 style="color: var(--text-primary); margin-bottom: 10px;">Fabric Details:</h3>
                        <div style="background: var(--bg-tertiary); padding: 15px; border-radius: 4px; border: 1px solid var(--border-color);">
                            <p style="margin: 5px 0; color: var(--text-primary);"><strong>Item:</strong> <span id="commissionItemName"></span></p>
                            <p style="margin: 5px 0; color: var(--text-primary);"><strong>Color:</strong> <span id="commissionItemColor"></span></p>
                            <p style="margin: 5px 0; color: var(--text-primary);"><strong>Available Yards:</strong> <span id="commissionAvailableYards"></span></p>
                            <p style="margin: 5px 0; color: var(--text-primary);"><strong>Unit Price:</strong> ฿<span id="commissionUnitPrice"></span></p>
                        </div>
                    </div>
                    
                    <form id="commissionSaleForm">
                        <div class="form-group">
                            <label for="commissionYardsSold">Yards to Sell:</label>
                            <input type="number" id="commissionYardsSold" step="0.01" min="0" required>
                        </div>
                        <div class="form-group">
                            <label for="commissionSaleDate">Sale Date:</label>
                            <input type="date" id="commissionSaleDate" required>
                        </div>
                        <div class="form-group">
                            <label>Commission Rate:</label>
                            <input type="text" value="5.1%" readonly style="background: var(--bg-secondary);">
                        </div>
                        <div class="form-group">
                            <label>Commission Amount:</label>
                            <input type="text" id="commissionAmount" readonly style="background: var(--bg-secondary);">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeCommissionSaleDialog()">Cancel</button>
                    <button class="btn btn-success" onclick="confirmCommissionSale()">Confirm Sale</button>
                </div>
            </div>
        </div>
        

        
        <!-- Add/Edit Cost Dialog -->
        <div id="costDialog" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title" id="costDialogTitle">Add New Cost</h2>
                    <span class="close" onclick="closeCostDialog()">&times;</span>
                </div>
                <div class="modal-body">
                    <form id="costForm">
                        <input type="hidden" id="costId">
                        <div class="form-group">
                            <label for="costGarmentName">Garment Name:</label>
                            <input type="text" id="costGarmentName" required>
                        </div>
                        <div class="form-group">
                            <label for="costStitchingLocation">Stitching Location:</label>
                            <input type="text" id="costStitchingLocation" required>
                        </div>
                        <div class="form-group">
                            <label for="costAmount">Cost (฿):</label>
                            <input type="number" id="costAmount" step="0.01" min="0" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeCostDialog()">Cancel</button>
                    <button class="btn btn-primary" onclick="saveCost()">Save</button>
                </div>
            </div>
        </div>
        
        <!-- Add/Edit Price Dialog -->
        <div id="priceDialog" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title" id="priceDialogTitle">Add New Price</h2>
                    <span class="close" onclick="closePriceDialog()">&times;</span>
                </div>
                <div class="modal-body">
                    <form id="priceForm">
                        <input type="hidden" id="priceId">
                        <div class="form-group">
                            <label for="priceGarmentName">Garment Name:</label>
                            <input type="text" id="priceGarmentName" required>
                        </div>
                        <div class="form-group">
                            <label for="priceCustomerId">Customer:</label>
                            <select id="priceCustomerId" required>
                                <option value="">Select Customer</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="priceAmount">Price (฿):</label>
                            <input type="number" id="priceAmount" step="0.01" min="0" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closePriceDialog()">Cancel</button>
                    <button class="btn btn-primary" onclick="savePrice()">Save</button>
                </div>
            </div>
        </div>
        
        <!-- Cost List Dialog -->
        <div id="costListDialog" class="modal" style="display: none;">
            <div class="modal-content" style="width: 90%; max-width: 1200px; max-height: 80vh;">
                <div class="modal-header">
                    <h2 class="modal-title">Stitching Cost List</h2>
                    <span class="close" onclick="closeCostListDialog()">&times;</span>
                </div>
                <div class="modal-body">
                    <div class="filter-controls">
                        <div class="filter-row">
                            <div class="filter-group">
                                <label>Garment:</label>
                                <div class="searchable-dropdown">
                                    <input type="text" id="costFilterGarment" class="filter-input" placeholder="Type to search garments..." oninput="filterCostDropdown('costFilterGarment', 'costGarmentDropdown')" onfocus="showCostDropdown('costGarmentDropdown')">
                                    <div id="costGarmentDropdown" class="dropdown-options" style="display: none;"></div>
                                    <div id="costGarmentSelected" class="selected-items"></div>
                                </div>
                            </div>
                            <div class="filter-group">
                                <label>Location:</label>
                                <div class="searchable-dropdown">
                                    <input type="text" id="costFilterLocation" class="filter-input" placeholder="Type to search locations..." oninput="filterCostDropdown('costFilterLocation', 'costLocationDropdown')" onfocus="showCostDropdown('costLocationDropdown')">
                                    <div id="costLocationDropdown" class="dropdown-options" style="display: none;"></div>
                                    <div id="costLocationSelected" class="selected-items"></div>
                                </div>
                            </div>
                            <div class="filter-group">
                                <button class="btn btn-secondary" onclick="loadCostList()">Refresh</button>
                                <button class="btn btn-primary" onclick="showAddCostDialog()">Add New Cost</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="table-container" style="max-height: 60vh; overflow-y: auto;">
                        <table id="costListTable" class="data-table">
                            <thead>
                                <tr>
                                    <th>Garment</th>
                                    <th>Stitching Location</th>
                                    <th>Cost (฿)</th>
                                    <th>Last Updated</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="costListTableBody">
                                <!-- Cost data will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeCostListDialog()">Close</button>
                </div>
            </div>
        </div>
        
        <!-- Price List Dialog -->
        <div id="priceListDialog" class="modal" style="display: none;">
            <div class="modal-content" style="width: 90%; max-width: 1200px; max-height: 80vh;">
                <div class="modal-header">
                    <h2 class="modal-title">Stitching Price List</h2>
                    <span class="close" onclick="closePriceListDialog()">&times;</span>
                </div>
                <div class="modal-body">
                    <div class="filter-controls">
                        <div class="filter-row">
                            <div class="filter-group">
                                <label>Garment:</label>
                                <div class="searchable-dropdown">
                                    <input type="text" id="priceFilterGarment" class="filter-input" placeholder="Type to search garments..." oninput="filterPriceDropdown('priceFilterGarment', 'priceGarmentDropdown')" onfocus="showPriceDropdown('priceGarmentDropdown')">
                                    <div id="priceGarmentDropdown" class="dropdown-options" style="display: none;"></div>
                                    <div id="priceGarmentSelected" class="selected-items"></div>
                                </div>
                            </div>
                            <div class="filter-group">
                                <label>Customer:</label>
                                <div class="searchable-dropdown">
                                    <input type="text" id="priceFilterCustomer" class="filter-input" placeholder="Type to search customers..." oninput="filterPriceDropdown('priceFilterCustomer', 'priceCustomerDropdown')" onfocus="showPriceDropdown('priceCustomerDropdown')">
                                    <div id="priceCustomerDropdown" class="dropdown-options" style="display: none;"></div>
                                    <div id="priceCustomerSelected" class="selected-items"></div>
                                </div>
                            </div>
                            <div class="filter-group">
                                <button class="btn btn-secondary" onclick="loadPriceList()">Refresh</button>
                                <button class="btn btn-primary" onclick="showAddPriceDialog()">Add New Price</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="table-container" style="max-height: 60vh; overflow-y: auto;">
                        <table id="priceListTable" class="data-table">
                            <thead>
                                <tr>
                                    <th>Garment</th>
                                    <th>Customer</th>
                                    <th>Price (฿)</th>
                                    <th>Last Updated</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="priceListTableBody">
                                <!-- Price data will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closePriceListDialog()">Close</button>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Fabric Invoice Functions - Using new modular system
        let selectedRows = [];
        let currentPage = 1;
        const itemsPerPage = 50;
        
        // Initialize modular components
        let tableManager = null;
        let actionManager = null;
        let rowTemplate = null;
        
        // Cost and Price List Data
        let costListData = [];
        let priceListData = [];
        let customersList = [];
        
        // API Base URL - works for both local development and Railway
        const getApiBaseUrl = () => {
            const hostname = window.location.hostname;
            const port = window.location.port;
            const protocol = window.location.protocol;
            
            console.log('🔍 getApiBaseUrl debug:', { hostname, port, protocol });
            
            // Local development - Flask backend runs on port 8000
            if (hostname === 'localhost' || hostname === '127.0.0.1') {
                // Always use port 8000 for backend in local development
                return 'http://localhost:8000';
            }
            
            // Railway deployment - force HTTPS
            if (hostname.includes('railway.app') || hostname.includes('up.railway.app')) {
                const httpsUrl = `https://${hostname}`;
                console.log('🚀 Using Railway HTTPS URL:', httpsUrl);
                return httpsUrl;
            }
            
            // Other deployments - use same protocol and domain, but prefer HTTPS
            const origin = window.location.origin;
            if (protocol === 'https:') {
                return origin;
            } else {
                // Force HTTPS for production
                return origin.replace('http://', 'https://');
            }
        };

        // Simple notification function
        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                padding: 12px 20px;
                border-radius: 4px;
                color: white;
                font-weight: 500;
                z-index: 10000;
                max-width: 300px;
                word-wrap: break-word;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                transition: all 0.3s ease;
            `;
            
            // Set background color based on type
            switch(type) {
                case 'success':
                    notification.style.backgroundColor = '#4caf50';
                    break;
                case 'error':
                    notification.style.backgroundColor = '#f44336';
                    break;
                case 'warning':
                    notification.style.backgroundColor = '#ff9800';
                    break;
                default:
                    notification.style.backgroundColor = '#2196f3';
            }
            
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // Auto-remove after 3 seconds
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // Enhanced Filter Dropdown Variables
        let filterTimer = null;
        let filterData = {
            customers: [],
            invoiceNumbers: [],
            taxInvoices: [],
            itemCodes: [],
            deliveryNotes: [],
            locations: []
        };

        // Check authentication
        function checkAuth() {
            const isLoggedIn = localStorage.getItem('gms_logged_in');
            if (isLoggedIn !== 'true') {
                window.location.href = 'login.html';
                return false;
            }
            return true;
        }

        // Load data when page loads
        window.addEventListener('load', async () => {
            console.log('🔄 Fabric Invoices page loaded');
            
            // Check authentication first
            if (!checkAuth()) {
                return;
            }
            
            // Display current user
            const username = localStorage.getItem('gms_username');
            document.getElementById('currentUser').textContent = `Welcome, ${username}`;
            
            // Initialize table manager first
            initializeTableManager();
            
            await loadInvoiceData();
            
            // Initialize enhanced filter dropdowns
            initializeEnhancedFilters();
            
            // Load cost and price lists for filter options
            await loadCostList();
            await loadPriceList();
            
            // Add date input formatting
            const dateFromInput = document.getElementById('filterDateFrom');
            const dateToInput = document.getElementById('filterDateTo');
            
            if (dateFromInput) {
                dateFromInput.addEventListener('input', () => formatDateInput(dateFromInput));
            }
            if (dateToInput) {
                dateToInput.addEventListener('input', () => formatDateInput(dateToInput));
            }
            
            // Add filter change listeners
            const stockStatusRadios = document.querySelectorAll('input[name="stockStatus"]');
            stockStatusRadios.forEach(radio => {
                radio.addEventListener('change', applyFilters);
            });

            // Add real-time filter listeners for text inputs
            const filterInputs = ['filterCustomer', 'filterFabInvoice', 'filterTaxInvoice', 'filterItemCode', 'filterDN', 'filterLocation'];
            filterInputs.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('input', () => {
                        // Clear existing timer
                        if (filterTimer) {
                            clearTimeout(filterTimer);
                        }
                        // Set new timer for debounced update
                        filterTimer = setTimeout(() => {
                            applyFilters();
                        }, 500);
                    });
                }
            });
        });

        async function loadInvoiceData() {
            console.log('🔄 loadInvoiceData called');
            
            // Initialize components if not already done
            if (!tableManager) {
                initializeTableManager();
            }
            
            // Clear selected rows when refreshing data
            selectedRows = [];
            console.log('🧹 Cleared selectedRows due to data refresh');
            
            try {
                // Build query parameters from filters
                const params = new URLSearchParams();
                
                const customerFilter = document.getElementById('filterCustomer')?.value?.trim();
                const invoiceFilter = document.getElementById('filterFabInvoice')?.value?.trim();
                const taxInvoiceFilter = document.getElementById('filterTaxInvoice')?.value?.trim();
                const itemFilter = document.getElementById('filterItemCode')?.value?.trim();
                const dnFilter = document.getElementById('filterDN')?.value?.trim();
                const locationFilter = document.getElementById('filterLocation')?.value?.trim();
                const dateFrom = document.getElementById('filterDateFrom')?.value;
                const dateTo = document.getElementById('filterDateTo')?.value;
                const stockStatus = document.querySelector('input[name="stockStatus"]:checked')?.value;
                
                if (customerFilter) params.append('customer', customerFilter);
                if (invoiceFilter) params.append('invoice_number', invoiceFilter);
                if (taxInvoiceFilter) params.append('tax_invoice', taxInvoiceFilter);
                if (itemFilter) params.append('item_code', itemFilter);
                if (dnFilter) params.append('dn', dnFilter);
                if (locationFilter) params.append('location', locationFilter);
                if (dateFrom) params.append('date_from', dateFrom);
                if (dateTo) params.append('date_to', dateTo);
                if (stockStatus) params.append('stock_status', stockStatus);
                
                console.log('🌐 Fetching /api/invoices with filters...');
                const apiBaseUrl = getApiBaseUrl();
                const apiUrl = `${apiBaseUrl}/api/invoices?${params.toString()}`;
                console.log('🌐 Full API URL:', apiUrl);
                
                const response = await fetch(apiUrl, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const responseText = await response.text();
                    try {
                        const data = JSON.parse(responseText);
                        console.log('📊 Received invoice data:', data.length, 'records');
                        
                        // Use table manager to set data
                        tableManager.setData(data);
                        
                        // Update filter data for enhanced dropdowns
                        // Add a small delay to ensure table manager is fully ready
                        setTimeout(() => {
                            updateFilterData();
                        }, 100);
                        
                    } catch (parseError) {
                        console.error('❌ JSON parse error:', parseError);
                        tableManager.tableBody.innerHTML = '<tr><td colspan="15" style="text-align: center; padding: 20px; color: #f44336;">Error parsing response data.</td></tr>';
                    }
                } else {
                    console.error('❌ Failed to load invoice data, status:', response.status);
                    const errorText = await response.text();
                    console.error('❌ Error response:', errorText);
                    tableManager.tableBody.innerHTML = '<tr><td colspan="15" style="text-align: center; padding: 20px; color: #f44336;">Failed to load invoice data. Please try refreshing the page.</td></tr>';
                }
            } catch (error) {
                console.error('❌ Error loading invoice data:', error);
                tableManager.tableBody.innerHTML = '<tr><td colspan="15" style="text-align: center; padding: 20px; color: #f44336;">Error loading invoice data. Please check your connection and try again.</td></tr>';
            }
        }
        
        function initializeTableManager() {
            console.log('🔄 Initializing TableManager...');
            
            // Create row template
            rowTemplate = new FabricInvoiceRowTemplate();
            
            // Initialize table manager
            tableManager = new TableManager('invoiceTable', {
                itemsPerPage: 50,
                rowTemplate: rowTemplate.template,
                rowIdentifier: 'id',
                optimisticUpdates: true,
                onDataUpdate: (data) => {
                    console.log('📊 Table data updated:', data.length, 'records');
                },
                onRowUpdate: (rowElement, updates) => {
                    // Custom row update handler
                    if (rowTemplate) {
                        rowTemplate.updateRowInUI(rowElement, updates);
                    }
                }
            });
            
            // Initialize action manager
            actionManager = new ActionManager(tableManager, {
                apiBaseUrl: getApiBaseUrl(),
                showNotifications: true,
                optimisticUpdates: true
            });
            
            console.log('✅ TableManager and ActionManager initialized');
        }









        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            const isChecked = selectAllCheckbox.checked;
            
            // Use table manager to select all
            tableManager.selectAll(isChecked);
            
            console.log('📋 Select all - Selected rows:', tableManager.getSelectedRowIds());
        }

        function toggleInvoiceSelection(event, invoiceId) {
            event.stopPropagation(); // Prevent row selection when clicking checkbox
            
            const checkbox = event.target;
            const isChecked = checkbox.checked;
            
            // Let the table manager handle the selection state
            // The checkbox state is already updated by the user interaction
            // We just need to update the select all checkbox state
            
            console.log('📋 Row selection toggled:', invoiceId, 'checked:', isChecked);
            console.log('📋 Current selected rows:', tableManager.getSelectedRowIds());
            updateSelectAllCheckbox();
        }

        function updateSelectAllCheckbox() {
            const allCheckboxes = tableManager.tableBody.querySelectorAll('.row-checkbox');
            const allChecked = Array.from(allCheckboxes).every(cb => cb.checked);
            const anyChecked = Array.from(allCheckboxes).some(cb => cb.checked);
            
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            if (selectAllCheckbox) {
                selectAllCheckbox.checked = allChecked;
                selectAllCheckbox.indeterminate = anyChecked && !allChecked;
            }
        }

        function getSelectedInvoiceIds() {
            return tableManager.getSelectedRowIds();
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            // Format as DD/MM/YY like old Qt app
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const year = date.getFullYear().toString().slice(-2);
            return `${day}/${month}/${year}`;
        }

        function formatNumber(num) {
            return new Intl.NumberFormat('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(num || 0);
        }

        function formatDateInput(input) {
            // Auto-format date input to DD/MM/YY format (like old Qt app)
            let text = input.value;
            // Remove any non-digit characters
            let digitsOnly = text.replace(/\D/g, '');
            
            // Format as DD/MM/YY
            let formatted = "";
            if (digitsOnly.length >= 1) {
                formatted += digitsOnly.slice(0, 2);
            }
            if (digitsOnly.length >= 3) {
                formatted += "/" + digitsOnly.slice(2, 4);
            }
            if (digitsOnly.length >= 5) {
                formatted += "/" + digitsOnly.slice(4, 6);
            }
            
            // Update text if different
            if (formatted !== text) {
                input.value = formatted;
            }
        }

        // Filter functions
        function clearFilters() {
            // Clear enhanced filter inputs
            const enhancedFilters = ['filterCustomer', 'filterFabInvoice', 'filterTaxInvoice', 'filterItemCode', 'filterDN', 'filterLocation'];
            enhancedFilters.forEach(filterId => {
                const filterInput = document.getElementById(filterId);
                if (filterInput) {
                    filterInput.value = '';
                    filterInput.dataset.selectedValue = '';
                }
            });
            
            // Clear date inputs
            document.getElementById('filterDateFrom').value = '';
            document.getElementById('filterDateTo').value = '';
            // Reset stock status to "In Stock"
            document.getElementById('inStock').checked = true;
            
            // Close all dropdowns
            closeAllDropdowns();
            
            currentPage = 1; // Reset to first page when clearing filters
            loadInvoiceData(); // Show all data
        }

        function applyFilters() {
            loadInvoiceData();
        }

        // Enhanced Filter Functions
        function initializeEnhancedFilters() {
            console.log('🔄 Initializing enhanced filters');
            
            // Initialize each filter dropdown
            const filters = [
                { id: 'filterCustomer', dropdownId: 'filterCustomerDropdown', dataKey: 'customers' },
                { id: 'filterFabInvoice', dropdownId: 'filterFabInvoiceDropdown', dataKey: 'invoiceNumbers' },
                { id: 'filterTaxInvoice', dropdownId: 'filterTaxInvoiceDropdown', dataKey: 'taxInvoices' },
                { id: 'filterItemCode', dropdownId: 'filterItemCodeDropdown', dataKey: 'itemCodes' },
                { id: 'filterDN', dropdownId: 'filterDNDropdown', dataKey: 'deliveryNotes' },
                { id: 'filterLocation', dropdownId: 'filterLocationDropdown', dataKey: 'locations' }
            ];

            filters.forEach(filter => {
                initializeFilterDropdown(filter.id, filter.dropdownId, filter.dataKey);
            });
        }

        function initializeFilterDropdown(filterId, dropdownId, dataKey) {
            const filterInput = document.getElementById(filterId);
            const dropdown = document.getElementById(dropdownId);
            const searchInput = dropdown.querySelector('.filter-input-search');
            const optionsContainer = dropdown.querySelector('.filter-options');

            // Toggle dropdown on input click
            filterInput.addEventListener('click', (e) => {
                e.preventDefault();
                closeAllDropdowns();
                dropdown.classList.add('show');
                // Don't auto-focus the search input - let user click on it if they want to search
                populateFilterOptions(filterId, dataKey, '');
            });

            // Handle direct typing in the main filter input
            filterInput.addEventListener('input', (e) => {
                const value = e.target.value;
                // Clear the selected value when user types
                filterInput.dataset.selectedValue = '';
            });

            // Handle backspace and delete to clear the filter
            filterInput.addEventListener('keydown', (e) => {
                if (e.key === 'Backspace' || e.key === 'Delete') {
                    // Allow normal backspace/delete behavior
                    // The main input listener will handle the filter update
                }
            });

            // Handle search input in dropdown
            searchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                populateFilterOptions(filterId, dataKey, searchTerm);
            });

            // Handle option selection
            optionsContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('filter-option')) {
                    const value = e.target.dataset.value;
                    const text = e.target.textContent;
                    
                    filterInput.value = text;
                    filterInput.dataset.selectedValue = value;
                    
                    dropdown.classList.remove('show');
                    triggerFilterUpdate();
                }
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!filterInput.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.classList.remove('show');
                }
            });

            // Handle keyboard navigation in dropdown
            searchInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    const firstOption = optionsContainer.querySelector('.filter-option:not(.empty)');
                    if (firstOption) {
                        firstOption.click();
                    }
                } else if (e.key === 'Escape') {
                    dropdown.classList.remove('show');
                }
            });
        }

        function populateFilterOptions(filterId, dataKey, searchTerm) {
            const dropdown = document.getElementById(filterId.replace('filter', 'filter') + 'Dropdown');
            const optionsContainer = dropdown.querySelector('.filter-options');
            
            let options = filterData[dataKey] || [];
            
            // Filter options based on search term
            if (searchTerm) {
                options = options.filter(option => 
                    option.toLowerCase().includes(searchTerm)
                );
            }

            // Clear existing options
            optionsContainer.innerHTML = '';

            // Add filtered options (removed "All" option)
            if (options.length === 0) {
                const emptyOption = document.createElement('div');
                emptyOption.className = 'filter-option empty';
                emptyOption.textContent = 'No matches found';
                optionsContainer.appendChild(emptyOption);
            } else {
                options.forEach(option => {
                    const optionElement = document.createElement('div');
                    optionElement.className = 'filter-option';
                    optionElement.dataset.value = option;
                    optionElement.textContent = option;
                    optionsContainer.appendChild(optionElement);
                });
            }
        }

        function closeAllDropdowns() {
            const dropdowns = document.querySelectorAll('.filter-dropdown');
            dropdowns.forEach(dropdown => dropdown.classList.remove('show'));
        }

        function triggerFilterUpdate() {
            // Clear existing timer
            if (filterTimer) {
                clearTimeout(filterTimer);
            }
            
            // Set new timer for debounced update
            filterTimer = setTimeout(() => {
                applyFilters();
            }, 500); // 500ms delay like Qt app
        }

        function updateFilterData() {
            console.log('🔄 Updating filter data from table manager data');
            
            // Safety check - ensure tableManager is initialized
            if (!tableManager) {
                console.warn('⚠️ TableManager not initialized yet, skipping filter data update');
                return;
            }
            
            // Get data from table manager instead of old invoiceData
            const data = tableManager.getData();
            
            // Safety check - ensure data exists
            if (!data || !Array.isArray(data)) {
                console.warn('⚠️ No data available for filter update');
                return;
            }
            
            // Extract unique values from invoice data
            filterData.customers = [...new Set(data.map(inv => inv.customer?.short_name).filter(Boolean))];
            filterData.invoiceNumbers = [...new Set(data.map(inv => inv.invoice_number).filter(Boolean))];
            filterData.taxInvoices = [...new Set(data.map(inv => inv.tax_invoice_number).filter(Boolean))];

            filterData.itemCodes = [...new Set(data.map(inv => inv.item_name).filter(Boolean))];
            filterData.deliveryNotes = [...new Set(data.map(inv => inv.delivery_note).filter(Boolean))];
            filterData.locations = [...new Set(data.map(inv => inv.delivered_location).filter(Boolean))];
            
            console.log('✅ Filter data updated:', filterData);
        }

        // Action button functions - Using new modular system
        async function assignDeliveredLocation() {
            const selectedRowIds = tableManager.getSelectedRowIds();
            if (selectedRowIds.length === 0) {
                showNotification('Please select one or more invoice lines.', 'warning');
                return;
            }
            
            // Load delivery locations and show dialog
            loadDeliveryLocationsAndShowDialog();
        }
        
        function loadDeliveryLocationsAndShowDialog() {
            fetch(`${getApiBaseUrl()}/api/invoices/delivery-locations`)
                .then(response => response.json())
                .then(locations => {
                    showLocationSelectionDialog(locations);
                })
                .catch(error => {
                    console.error('Error loading delivery locations:', error);
                    alert('Error loading delivery locations: ' + error.message);
                });
        }
        
        function showLocationSelectionDialog(locations) {
            // Create dialog HTML
            let dialogHtml = `
                <div class="custom-dialog-content" style="min-width: 400px;">
                    <div class="custom-dialog-header">
                        <h3 class="custom-dialog-title" style="margin: 0;">Select Delivery Location</h3>
                        <button class="custom-dialog-close" onclick="closeLocationDialog()">×</button>
                    </div>
                    <div class="custom-dialog-body">
                        <div style="margin-bottom: 15px;">
                            <div style="background: var(--bg-secondary); padding: 10px; border-radius: 4px; margin-bottom: 10px;">
                                <strong style="color: var(--text-primary);">Selected Lines:</strong>
                                <div id="selectedLinesInfo" style="margin-top: 5px; font-size: 12px; color: var(--text-secondary);">
                                    <!-- Selected lines info will be populated here -->
                                </div>
                            </div>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; color: var(--text-secondary);">Location:</label>
                            <div style="display: flex; gap: 10px; align-items: flex-end;">
                                <select id="locationSelect" style="flex: 1; padding: 8px; background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 4px;">
                                    <option value="">-- Select Location --</option>
            `;
            
            locations.forEach(location => {
                dialogHtml += `<option value="${location.name}" data-id="${location.id}">${location.name}</option>`;
            });
            
            dialogHtml += `
                                </select>
                                <button onclick="deleteSelectedLocation()" class="custom-dialog-btn custom-dialog-btn-danger" style="white-space: nowrap;">Delete</button>
                            </div>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; color: var(--text-secondary);">Or add new location:</label>
                            <div style="display: flex; gap: 10px;">
                                <input type="text" id="newLocationInput" placeholder="Enter new location name" style="flex: 1; padding: 8px; background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 4px;">
                                <button onclick="addNewLocation()" class="custom-dialog-btn custom-dialog-btn-success">Add</button>
                            </div>
                        </div>
                    </div>
                    <div class="custom-dialog-footer">
                        <button onclick="closeLocationDialog()" class="custom-dialog-btn custom-dialog-btn-secondary">Cancel</button>
                        <button onclick="confirmLocationSelection()" class="custom-dialog-btn custom-dialog-btn-primary">Assign Location</button>
                    </div>
                </div>
            `;
            
            // Create and show dialog
            const dialog = document.createElement('div');
            dialog.className = 'custom-dialog';
            dialog.innerHTML = dialogHtml;
            dialog.id = 'locationDialog';
            document.body.appendChild(dialog);
            
            // Populate selected lines info
            populateSelectedLinesInfo();
        }
        
        function addNewLocation() {
            const newLocationInput = document.getElementById('newLocationInput');
            const locationName = newLocationInput.value.trim();
            
            if (!locationName) {
                alert('Please enter a location name.');
                return;
            }
            
            fetch(`${getApiBaseUrl()}/api/invoices/delivery-locations`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ name: locationName })
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    // Add new location to dropdown
                    const locationSelect = document.getElementById('locationSelect');
                    const option = document.createElement('option');
                    option.value = locationName;
                    option.textContent = locationName;
                    locationSelect.appendChild(option);
                    locationSelect.value = locationName;
                    
                    // Clear input
                    newLocationInput.value = '';
                    
                    alert(data.message);
                } else {
                    alert('Error: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                alert('Error adding location: ' + error.message);
            });
        }
        
        async function confirmLocationSelection() {
            const locationSelect = document.getElementById('locationSelect');
            const selectedLocation = locationSelect.value;
            
            if (!selectedLocation) {
                showNotification('Please select a location.', 'warning');
                return;
            }
            
            const selectedRowIds = tableManager.getSelectedRowIds();
            const success = await actionManager.assignDeliveryLocation(selectedRowIds, selectedLocation);
            
            if (success) {
                closeLocationDialog();
            }
        }
        
        function closeLocationDialog() {
            const dialog = document.getElementById('locationDialog');
            if (dialog) {
                dialog.remove();
            }
        }
        
        function deleteSelectedLocation() {
            const locationSelect = document.getElementById('locationSelect');
            const selectedOption = locationSelect.options[locationSelect.selectedIndex];
            
            if (!selectedOption || !selectedOption.value) {
                alert('Please select a location to delete.');
                return;
            }
            
            const locationId = selectedOption.getAttribute('data-id');
            const locationName = selectedOption.value;
            
            if (!locationId) {
                alert('Cannot delete this location (no ID found).');
                return;
            }
            
            if (!confirm(`Are you sure you want to delete location "${locationName}"?`)) {
                return;
            }
            
            fetch(`${getApiBaseUrl()}/api/invoices/delivery-locations/${locationId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    // Remove from dropdown
                    locationSelect.removeChild(selectedOption);
                    locationSelect.value = '';
                    
                    alert(data.message);
                } else {
                    alert('Error: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                alert('Error deleting location: ' + error.message);
            });
        }
        
        async function removeLocationFromSelected() {
            const selectedRowIds = tableManager.getSelectedRowIds();
            if (selectedRowIds.length === 0) {
                showNotification('Please select one or more invoice lines.', 'warning');
                return;
            }
            
            if (!confirm('Are you sure you want to remove the delivery location from the selected invoice lines?')) {
                return;
            }
            
            await actionManager.removeDeliveryLocation(selectedRowIds);
        }
        
        function populateSelectedLinesInfo() {
            const selectedLinesInfo = document.getElementById('selectedLinesInfo');
            if (!selectedLinesInfo) return;
            
            // Safety check - ensure tableManager is initialized
            if (!tableManager) {
                console.warn('⚠️ TableManager not initialized yet, skipping selected lines info');
                return;
            }
            
            const data = tableManager.getData();
            if (!data || !Array.isArray(data)) {
                console.warn('⚠️ No data available for selected lines info');
                return;
            }
            
            let infoHtml = '';
            let linesWithLocation = 0;
            let linesWithoutLocation = 0;
            
            // Get selected row IDs from table manager
            const selectedRowIds = tableManager.getSelectedRowIds();
            console.log('🔍 Selected row IDs:', selectedRowIds);
            
            selectedRowIds.forEach(rowId => {
                const line = tableManager.getRowById(rowId);
                if (!line) {
                    console.warn(`⚠️ Line with ID ${rowId} not found`);
                    return;
                }
                
                const hasLocation = line.delivered_location && line.delivered_location.trim() !== '';
                const locationText = hasLocation ? `📍 ${line.delivered_location}` : '❌ No location';
                const statusColor = hasLocation ? 'color: #4CAF50;' : 'color: #f44336;';
                
                infoHtml += `<div style="margin-bottom: 3px; ${statusColor}">`;
                infoHtml += `Invoice #${line.invoice_number} | ${line.item_name} | ${line.color} | ${locationText}`;
                infoHtml += `</div>`;
                
                if (hasLocation) {
                    linesWithLocation++;
                } else {
                    linesWithoutLocation++;
                }
            });
            
            // Add summary
            infoHtml += `<div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--border-color); font-weight: bold;">`;
            infoHtml += `Summary: ${linesWithLocation} with location, ${linesWithoutLocation} without location`;
            infoHtml += `</div>`;
            
            selectedLinesInfo.innerHTML = infoHtml;
        }

        // ===== STITCHED ITEMS MANAGEMENT FUNCTIONS =====

        function loadStitchedItemsAndShowDialog(selectedLines) {
            fetch(`${getApiBaseUrl()}/api/stitching/stitched-items`)
                .then(response => response.json())
                .then(items => {
                    createStitchingRecordDialog(selectedLines, items);
                })
                .catch(error => {
                    console.error('Error loading stitched items:', error);
                    alert('Error loading stitched items: ' + error.message);
                    // Show dialog without items as fallback
                    createStitchingRecordDialog(selectedLines, []);
                });
        }

        function populateStitchedItemsDropdown(items) {
            const select = document.getElementById('stitchedItemSelect');
            if (!select) return;
            
            // Clear existing options except the first one
            select.innerHTML = '<option value="">-- Select Item --</option>';
            
            // Add items to dropdown
            items.forEach(item => {
                const option = document.createElement('option');
                option.value = item.name;
                option.textContent = item.name;
                option.setAttribute('data-id', item.id);
                select.appendChild(option);
            });
        }

        function addNewStitchedItem() {
            const newItemInput = document.getElementById('newStitchedItemInput');
            const itemName = newItemInput.value.trim();
            
            if (!itemName) {
                alert('Please enter an item name.');
                return;
            }
            
            fetch(`${getApiBaseUrl()}/api/stitching/stitched-items`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ name: itemName })
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    // Add new item to dropdown
                    const select = document.getElementById('stitchedItemSelect');
                    const option = document.createElement('option');
                    option.value = itemName;
                    option.textContent = itemName;
                    option.setAttribute('data-id', data.item.id);
                    select.appendChild(option);
                    select.value = itemName;
                    
                    // Clear input
                    newItemInput.value = '';
                    
                    alert(data.message);
                } else {
                    alert('Error: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                alert('Error adding item: ' + error.message);
            });
        }

        function deleteSelectedStitchedItem() {
            const select = document.getElementById('stitchedItemSelect');
            const selectedOption = select.options[select.selectedIndex];
            
            if (!selectedOption || !selectedOption.value) {
                alert('Please select an item to delete.');
                return;
            }
            
            const itemId = selectedOption.getAttribute('data-id');
            const itemName = selectedOption.value;
            
            if (!itemId) {
                alert('Cannot delete this item (no ID found).');
                return;
            }
            
            if (!confirm(`Are you sure you want to delete item "${itemName}"?`)) {
                return;
            }
            
            fetch(`${getApiBaseUrl()}/api/stitching/stitched-items/${itemId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    // Remove from dropdown
                    select.removeChild(selectedOption);
                    select.value = '';
                    
                    alert(data.message);
                } else {
                    alert('Error: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                alert('Error deleting item: ' + error.message);
            });
        }

        async function assignTaxInvoiceNumber() {
            const selectedRowIds = tableManager.getSelectedRowIds();
            if (selectedRowIds.length === 0) {
                showNotification('Please select one or more fabric invoice lines to assign tax invoice numbers.', 'warning');
                return;
            }
            
            const taxInvoiceNumber = prompt('Enter tax invoice number (enter "0" to clear/remove):');
            if (taxInvoiceNumber === null) return;
            
            await actionManager.assignTaxInvoiceNumber(selectedRowIds, taxInvoiceNumber);
        }
        
        // Helper function for base invoice selection
        function confirmBaseInvoiceSelection() {
            const select = document.getElementById('baseInvoiceSelect');
            const selectedBase = select.value;
            
            // Remove the dialog
            document.querySelector('.base-invoice-dialog').remove();
            
            // Call the callback with the selected base
            if (window.tempBaseInvoiceCallback) {
                window.tempBaseInvoiceCallback(selectedBase);
            }
        }
        
        // Stitching Record Dialog Functions
        function createStitchingRecordDialog(selectedLines, stitchedItems = []) {
            // Remove any existing dialog
            const existingDialog = document.querySelector('.stitching-record-dialog');
            if (existingDialog) {
                existingDialog.remove();
            }
            
            // Create dialog container
            const dialog = document.createElement('div');
            dialog.className = 'custom-dialog';
            
            // Create dialog content
            const content = document.createElement('div');
            content.className = 'custom-dialog-content';
            content.style.cssText = `
                min-width: 600px; max-width: 90%; max-height: 90%; overflow-y: auto;
            `;
            
            content.innerHTML = `
                <div class="custom-dialog-header">
                    <h2 class="custom-dialog-title" style="margin: 0;">Create Stitching Record</h2>
                    <button class="custom-dialog-close" onclick="closeStitchingRecordDialog()">×</button>
                </div>
                
                <div class="custom-dialog-body">
                    <div style="margin-bottom: 20px;">
                        <h3 style="color: var(--text-primary); margin-bottom: 10px;">Enter yardage consumed for each selected fabric line:</h3>
                        <div id="consumedInputs"></div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h3 style="color: var(--text-primary); margin-bottom: 10px;">Stitched Item Details:</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; color: var(--text-secondary);">Stitched Item:</label>
                            <div style="display: flex; gap: 10px; align-items: flex-end;">
                                <select id="stitchedItemSelect" style="flex: 1; padding: 8px; background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 4px;">
                                    <option value="">-- Select Item --</option>
                                </select>
                                <button onclick="deleteSelectedStitchedItem()" class="custom-dialog-btn custom-dialog-btn-danger" style="white-space: nowrap;">Delete</button>
                            </div>
                            <div style="margin-top: 10px;">
                                <label style="display: block; margin-bottom: 5px; color: var(--text-secondary);">Or add new item:</label>
                                <div style="display: flex; gap: 10px;">
                                    <input type="text" id="newStitchedItemInput" placeholder="Enter new item name" style="flex: 1; padding: 8px; background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 4px;">
                                    <button onclick="addNewStitchedItem()" class="custom-dialog-btn custom-dialog-btn-success">Add</button>
                                </div>
                            </div>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; color: var(--text-secondary);">Price (THB):</label>
                            <input type="number" id="price" step="0.01" min="0" style="width: 100%; padding: 8px; background: var(--bg-tertiary); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 4px;" placeholder="0.00">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; color: var(--text-secondary);">Cost (THB): <span style="color: var(--error-color);">*</span></label>
                            <input type="number" id="stitchingCost" step="0.01" min="0" required style="width: 100%; padding: 8px; background: var(--bg-tertiary); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 4px;" placeholder="0.00">
                        </div>
                    </div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h3 style="color: var(--text-primary); margin-bottom: 10px;">Size Quantities:</h3>
                    <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 10px;">
                        <div><label style="display: block; margin-bottom: 5px; color: var(--text-secondary);">S:</label><input type="number" id="sizeS" min="0" value="0" style="width: 100%; padding: 8px; background: var(--bg-tertiary); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 4px;"></div>
                        <div><label style="display: block; margin-bottom: 5px; color: var(--text-secondary);">M:</label><input type="number" id="sizeM" min="0" value="0" style="width: 100%; padding: 8px; background: var(--bg-tertiary); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 4px;"></div>
                        <div><label style="display: block; margin-bottom: 5px; color: var(--text-secondary);">L:</label><input type="number" id="sizeL" min="0" value="0" style="width: 100%; padding: 8px; background: var(--bg-tertiary); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 4px;"></div>
                        <div><label style="display: block; margin-bottom: 5px; color: var(--text-secondary);">XL:</label><input type="number" id="sizeXL" min="0" value="0" style="width: 100%; padding: 8px; background: var(--bg-tertiary); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 4px;"></div>
                        <div><label style="display: block; margin-bottom: 5px; color: var(--text-secondary);">XXL:</label><input type="number" id="sizeXXL" min="0" value="0" style="width: 100%; padding: 8px; background: var(--bg-tertiary); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 4px;"></div>
                        <div><label style="display: block; margin-bottom: 5px; color: var(--text-secondary);">XXXL:</label><input type="number" id="sizeXXXL" min="0" value="0" style="width: 100%; padding: 8px; background: var(--bg-tertiary); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 4px;"></div>
                    </div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" id="addVat" checked style="width: 16px; height: 16px;">
                        <label for="addVat" style="color: var(--text-secondary);">Add VAT 7%</label>
                    </div>
                    <div style="margin-top: 10px;">
                        <label style="display: block; margin-bottom: 5px; color: var(--text-secondary);">Total Value:</label>
                        <div id="totalValue" style="padding: 8px; background: var(--bg-tertiary); border: 1px solid var(--border-color); color: var(--focus-color); font-weight: bold; border-radius: 4px;">0.00</div>
                    </div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h3 style="color: var(--text-primary); margin-bottom: 10px;">Lining Fabrics (Stitcher-Purchased):</h3>
                    <div id="liningTable" style="margin-bottom: 10px;">
                        <table style="width: 100%; border-collapse: collapse; background: var(--bg-tertiary); border-radius: 4px;">
                            <thead>
                                <tr style="background: var(--bg-secondary);">
                                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid var(--border-color); color: var(--text-primary);">Lining Name</th>
                                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid var(--border-color); color: var(--text-primary);">Consumption (yards)</th>
                                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid var(--border-color); color: var(--text-primary);">Unit Price (THB)</th>
                                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid var(--border-color); color: var(--text-primary);">Total Cost</th>
                                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid var(--border-color); color: var(--text-primary);">Action</th>
                                </tr>
                            </thead>
                            <tbody id="liningTableBody"></tbody>
                        </table>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr auto auto; gap: 10px; align-items: end;">
                        <input type="text" id="liningName" placeholder="Lining Name" style="padding: 8px; background: var(--bg-tertiary); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 4px;">
                        <input type="number" id="liningConsumption" step="0.01" min="0" placeholder="Consumption (yards)" style="padding: 8px; background: var(--bg-tertiary); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 4px;">
                        <input type="number" id="liningUnitPrice" step="0.01" min="0" placeholder="Unit Price (THB)" style="padding: 8px; background: var(--bg-tertiary); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 4px;">
                        <button onclick="addLiningFabric()" class="custom-dialog-btn custom-dialog-btn-primary">Add Lining</button>
                        <button onclick="removeSelectedLining()" class="custom-dialog-btn custom-dialog-btn-danger">Remove</button>
                    </div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h3 style="color: var(--text-primary); margin-bottom: 10px;">Multi-Fabric Selection (Beta Weaving Fabrics):</h3>
                    <div id="multiFabricTable" style="margin-bottom: 10px; overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; background: var(--bg-tertiary); border-radius: 4px; min-width: 800px;">
                            <thead>
                                <tr style="background: var(--bg-secondary);">
                                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid var(--border-color); color: var(--text-primary);">Fabric Name</th>
                                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid var(--border-color); color: var(--text-primary);">Color</th>
                                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid var(--border-color); color: var(--text-primary);">Invoice</th>
                                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid var(--border-color); color: var(--text-primary);">Customer</th>
                                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid var(--border-color); color: var(--text-primary);">Delivery Note</th>
                                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid var(--border-color); color: var(--text-primary);">Location</th>
                                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid var(--border-color); color: var(--text-primary);">Pending Yards</th>
                                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid var(--border-color); color: var(--text-primary);">Consumption (yards)</th>
                                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid var(--border-color); color: var(--text-primary);">Unit Price (THB)</th>
                                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid var(--border-color); color: var(--text-primary);">Action</th>
                                </tr>
                            </thead>
                            <tbody id="multiFabricTableBody"></tbody>
                        </table>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="openFabricSelectionDialog()" class="custom-dialog-btn custom-dialog-btn-primary">Add Fabric</button>
                        <button onclick="removeSelectedMultiFabric()" class="custom-dialog-btn custom-dialog-btn-danger">Remove</button>
                    </div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h3 style="color: var(--text-primary); margin-bottom: 10px;">Garment Image:</h3>
                    <div style="display: flex; gap: 15px; align-items: center;">
                        <input type="file" id="garmentImage" accept="image/*" style="display: none;" onchange="handleImageUpload(event)">
                        <button onclick="document.getElementById('garmentImage').click()" class="custom-dialog-btn custom-dialog-btn-primary">Upload Image</button>
                        <div id="imagePreview" style="width: 120px; height: 120px; border: 1px solid var(--border-color); background: var(--bg-tertiary); display: flex; align-items: center; justify-content: center; color: var(--text-secondary);">No image</div>
                    </div>
                </div>
                
                <div class="custom-dialog-footer">
                    <button onclick="closeStitchingRecordDialog()" class="custom-dialog-btn custom-dialog-btn-secondary">Cancel</button>
                    <button onclick="submitStitchingRecord()" class="custom-dialog-btn custom-dialog-btn-success">Create Stitching Record</button>
                </div>
            `;
            
            dialog.appendChild(content);
            document.body.appendChild(dialog);
            
            // Initialize the dialog
            initializeStitchingRecordDialog(selectedLines);
            
            // Populate stitched items dropdown
            populateStitchedItemsDropdown(stitchedItems);
        }

        // Global variables for stitching record dialog
        let stitchingSelectedLines = [];
        let stitchingLiningFabrics = [];
        let stitchingMultiFabrics = [];
        let stitchingImagePath = null;
        let stitchingImageFile = null;
        
        function initializeStitchingRecordDialog(selectedLines) {
            stitchingSelectedLines = selectedLines;
            stitchingLiningFabrics = [];
            stitchingMultiFabrics = [];
            stitchingImagePath = null;
            stitchingImageFile = null;
            
            // Populate consumed inputs
            const consumedInputs = document.getElementById('consumedInputs');
            consumedInputs.innerHTML = '';
            
            selectedLines.forEach((line, index) => {
                const div = document.createElement('div');
                div.style.cssText = 'display: flex; align-items: center; gap: 10px; margin-bottom: 10px; padding: 10px; background: var(--bg-tertiary); border-radius: 4px; border: 1px solid var(--border-color);';
                div.innerHTML = `
                    <span style="color: var(--text-secondary); min-width: 200px;">Invoice #${line.invoice_number} | Item: ${line.item_name} | Pending: ${line.pending} yards</span>
                    <input type="number" id="consumed${index}" step="0.01" min="0" max="${line.pending}" value="0" 
                           style="padding: 8px; background: var(--bg-secondary); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 4px; width: 100px;"
                           onchange="updateStitchingSelectedLine(${index}, this.value)">
                `;
                consumedInputs.appendChild(div);
            });
            
            // Add event listeners for total calculation
            document.getElementById('price').addEventListener('input', updateTotalValue);
            document.getElementById('stitchingCost').addEventListener('input', updateTotalValue);
            document.getElementById('addVat').addEventListener('change', updateTotalValue);
            ['sizeS', 'sizeM', 'sizeL', 'sizeXL', 'sizeXXL', 'sizeXXXL'].forEach(id => {
                document.getElementById(id).addEventListener('input', updateTotalValue);
            });
            
            // Add event listener for stitched item selection to trigger auto-population
            document.getElementById('stitchedItemSelect').addEventListener('change', function() {
                const selectedItem = this.value;
                
                // Reset fields if no garment is selected
                if (!selectedItem || selectedItem === '') {
                    document.getElementById('stitchingCost').value = '0';
                    document.getElementById('price').value = '0';
                    updateTotalValue();
                    console.log('🔄 No garment selected, fields reset to 0');
                    return;
                }
                
                // Trigger auto-population when stitched item changes
                if (selectedLines.length > 0) {
                    const firstLine = selectedLines[0];
                    const invoiceLine = tableManager.getRowById(firstLine.id);
                    console.log('🔍 Auto-population triggered:', {
                        firstLine: firstLine,
                        invoiceLine: invoiceLine,
                        selectedItem: selectedItem
                    });
                    
                    if (invoiceLine) {
                        
                        // Auto-populate cost
                        if (invoiceLine.delivered_location && selectedItem) {
                            console.log('💰 Auto-populating cost for:', selectedItem, 'at location:', invoiceLine.delivered_location);
                            const apiBaseUrl = getApiBaseUrl();
                            fetch(`${apiBaseUrl}/api/stitching/auto-populate-cost?garment_name=${encodeURIComponent(selectedItem)}&stitching_location=${encodeURIComponent(invoiceLine.delivered_location)}`)
                                .then(response => response.json())
                                .then(data => {
                                    console.log('💰 Cost auto-population result:', data);
                                    if (data.cost !== null) {
                                        document.getElementById('stitchingCost').value = data.cost;
                                        console.log('✅ Cost auto-populated:', data.cost);
                                    } else {
                                        document.getElementById('stitchingCost').value = '0';
                                        console.log('ℹ️ No memorized cost found, reset to 0');
                                    }
                                })
                                .catch(error => {
                                    console.error('❌ Error auto-populating cost:', error);
                                    document.getElementById('stitchingCost').value = '0';
                                });
                        } else {
                            console.log('⚠️ Cannot auto-populate cost - missing location or item');
                            document.getElementById('stitchingCost').value = '0';
                        }
                        
                        // Auto-populate price
                        if (invoiceLine.customer?.id && selectedItem) {
                            console.log('💵 Auto-populating price for:', selectedItem, 'for customer:', invoiceLine.customer.id);
                            const apiBaseUrl = getApiBaseUrl();
                            fetch(`${apiBaseUrl}/api/stitching/auto-populate-price?garment_name=${encodeURIComponent(selectedItem)}&customer_id=${invoiceLine.customer.id}`)
                                .then(response => response.json())
                                .then(data => {
                                    console.log('💵 Price auto-population result:', data);
                                    if (data.price !== null) {
                                        document.getElementById('price').value = data.price;
                                        updateTotalValue();
                                        console.log('✅ Price auto-populated:', data.price);
                                    } else {
                                        document.getElementById('price').value = '0';
                                        updateTotalValue();
                                        console.log('ℹ️ No memorized price found, reset to 0');
                                    }
                                })
                                .catch(error => {
                                    console.error('❌ Error auto-populating price:', error);
                                    document.getElementById('price').value = '0';
                                    updateTotalValue();
                                });
                        } else {
                            console.log('⚠️ Cannot auto-populate price - missing customer or item');
                            document.getElementById('price').value = '0';
                            updateTotalValue();
                        }
                    } else {
                        console.log('❌ Invoice line not found for auto-population');
                        document.getElementById('stitchingCost').value = '0';
                        document.getElementById('price').value = '0';
                        updateTotalValue();
                    }
                }
            });
            
            updateTotalValue();
            
            // Auto-population will be triggered when stitched item is selected
        }
        
        function updateStitchingSelectedLine(index, consumed) {
            if (stitchingSelectedLines[index]) {
                stitchingSelectedLines[index].consumed = parseFloat(consumed) || 0;
            }
        }
        
        function updateTotalValue() {
            const price = parseFloat(document.getElementById('price').value) || 0;
            const addVat = document.getElementById('addVat').checked;
            const sizes = ['sizeS', 'sizeM', 'sizeL', 'sizeXL', 'sizeXXL', 'sizeXXXL'];
            const totalQty = sizes.reduce((sum, id) => sum + (parseInt(document.getElementById(id).value) || 0), 0);
            
            const baseTotal = price * totalQty;
            const total = addVat ? baseTotal * 1.07 : baseTotal;
            
            document.getElementById('totalValue').textContent = total.toFixed(2);
        }
        
        function addLiningFabric() {
            const name = document.getElementById('liningName').value.trim();
            const consumption = parseFloat(document.getElementById('liningConsumption').value) || 0;
            const unitPrice = parseFloat(document.getElementById('liningUnitPrice').value) || 0;
            
            if (!name) {
                alert('Please enter a lining name.');
                return;
            }
            if (consumption <= 0) {
                alert('Consumption must be greater than 0.');
                return;
            }
            if (unitPrice <= 0) {
                alert('Unit price must be greater than 0.');
                return;
            }
            
            const totalCost = consumption * unitPrice;
            const lining = {
                name: name,
                consumption: consumption,
                unit_price: unitPrice,
                total_cost: totalCost
            };
            
            stitchingLiningFabrics.push(lining);
            updateLiningTable();
            
            // Clear inputs
            document.getElementById('liningName').value = '';
            document.getElementById('liningConsumption').value = '';
            document.getElementById('liningUnitPrice').value = '';
        }
        
        function updateLiningTable() {
            const tbody = document.getElementById('liningTableBody');
            tbody.innerHTML = '';
            
            if (stitchingLiningFabrics.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="5" style="padding: 20px; text-align: center; color: var(--text-secondary);">No lining fabrics</td>
                `;
                tbody.appendChild(row);
                return;
            }
            
            stitchingLiningFabrics.forEach((lining, index) => {
                const row = document.createElement('tr');
                row.style.cssText = 'border-bottom: 1px solid var(--border-color);';
                row.innerHTML = `
                    <td style="padding: 8px; color: var(--text-primary);">${lining.name}</td>
                    <td style="padding: 8px; color: var(--text-primary);">${lining.consumption.toFixed(2)}</td>
                    <td style="padding: 8px; color: var(--text-primary);">${lining.unit_price.toFixed(2)}</td>
                    <td style="padding: 8px; color: var(--text-primary);">${lining.total_cost.toFixed(2)}</td>
                    <td style="padding: 8px;">
                        <button onclick="removeLiningFabric(${index})" class="custom-dialog-btn custom-dialog-btn-danger" style="padding: 4px 8px; font-size: 12px;">Remove</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function removeLiningFabric(index) {
            stitchingLiningFabrics.splice(index, 1);
            updateLiningTable();
        }
        
        function removeSelectedLining() {
            // For simplicity, remove the last added lining
            if (stitchingLiningFabrics.length > 0) {
                stitchingLiningFabrics.pop();
                updateLiningTable();
            }
        }
        
        function openFabricSelectionDialog() {
            // Load available fabrics
            fetch(`${getApiBaseUrl()}/api/stitching/available-fabrics`)
                .then(response => response.json())
                .then(fabrics => {
                    createFabricSelectionDialog(fabrics);
                })
                .catch(error => {
                    console.error('Error loading fabrics:', error);
                    alert('Error loading available fabrics.');
                });
        }
        
        function createFabricSelectionDialog(fabrics) {
            // Remove any existing dialog
            const existingDialog = document.querySelector('.fabric-selection-dialog');
            if (existingDialog) {
                existingDialog.remove();
            }
            
            const dialog = document.createElement('div');
            dialog.className = 'fabric-selection-dialog';
            dialog.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.8); z-index: 10001; display: flex; 
                align-items: center; justify-content: center;
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: var(--card-bg); padding: 20px; border-radius: 8px; 
                min-width: 800px; max-width: 90%; max-height: 90%; overflow-y: auto;
                border: 1px solid var(--border-color);
            `;
            
            content.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0; color: var(--focus-color);">Select Fabric</h2>
                    <button onclick="closeFabricSelectionDialog()" style="background: none; border: none; color: var(--text-secondary); font-size: 20px; cursor: pointer;">×</button>
                </div>
                
                <!-- Enhanced Filters like Original Qt App -->
                <div style="margin-bottom: 20px; background: var(--bg-tertiary); padding: 15px; border-radius: 4px;">
                    <h3 style="color: var(--text-primary); margin-bottom: 15px; font-size: 16px;">Filters</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; color: var(--text-secondary); font-size: 12px;">Customer:</label>
                            <input type="text" id="fabricFilterCustomer" placeholder="Filter by customer" 
                                   style="width: 100%; padding: 8px; background: var(--bg-secondary); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 4px; font-size: 12px;"
                                   onkeyup="filterFabrics()">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; color: var(--text-secondary); font-size: 12px;">Invoice Number:</label>
                            <input type="text" id="fabricFilterInvoice" placeholder="Filter by invoice number" 
                                   style="width: 100%; padding: 8px; background: var(--bg-secondary); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 4px; font-size: 12px;"
                                   onkeyup="filterFabrics()">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; color: var(--text-secondary); font-size: 12px;">Item Name:</label>
                            <input type="text" id="fabricFilterItem" placeholder="Filter by item name" 
                                   style="width: 100%; padding: 8px; background: var(--bg-secondary); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 4px; font-size: 12px;"
                                   onkeyup="filterFabrics()">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; color: var(--text-secondary); font-size: 12px;">Color:</label>
                            <input type="text" id="fabricFilterColor" placeholder="Filter by color" 
                                   style="width: 100%; padding: 8px; background: var(--bg-secondary); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 4px; font-size: 12px;"
                                   onkeyup="filterFabrics()">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; color: var(--text-secondary); font-size: 12px;">Delivery Note:</label>
                            <input type="text" id="fabricFilterDN" placeholder="Filter by delivery note" 
                                   style="width: 100%; padding: 8px; background: var(--bg-secondary); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 4px; font-size: 12px;"
                                   onkeyup="filterFabrics()">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; color: var(--text-secondary); font-size: 12px;">Location:</label>
                            <input type="text" id="fabricFilterLocation" placeholder="Filter by location" 
                                   style="width: 100%; padding: 8px; background: var(--bg-secondary); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 4px; font-size: 12px;"
                                   onkeyup="filterFabrics()">
                        </div>
                    </div>
                    <div style="margin-top: 15px; display: flex; gap: 10px;">
                        <button onclick="clearFabricFilters()" style="padding: 6px 12px; background: var(--bg-secondary); color: #fff; border: 1px solid var(--border-color); border-radius: 4px; cursor: pointer; font-size: 12px;">Clear Filters</button>
                        <button onclick="refreshFabricList()" style="padding: 6px 12px; background: var(--focus-color); color: #fff; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">Refresh</button>
                    </div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <input type="text" id="fabricSearch" placeholder="Quick search all fields..." 
                           style="width: 100%; padding: 8px; background: var(--bg-tertiary); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 4px;"
                           onkeyup="filterFabrics()">
                </div>
                
                <div style="max-height: 400px; overflow-y: auto;">
                    <table style="width: 100%; border-collapse: collapse; background: var(--bg-tertiary); border-radius: 4px;">
                        <thead>
                            <tr style="background: var(--bg-secondary);">
                                <th style="padding: 8px; text-align: left; border-bottom: 1px solid var(--border-color); color: var(--text-primary);">Fabric Name</th>
                                <th style="padding: 8px; text-align: left; border-bottom: 1px solid var(--border-color); color: var(--text-primary);">Color</th>
                                <th style="padding: 8px; text-align: left; border-bottom: 1px solid var(--border-color); color: var(--text-primary);">Invoice</th>
                                <th style="padding: 8px; text-align: left; border-bottom: 1px solid var(--border-color); color: var(--text-primary);">Customer</th>
                                <th style="padding: 8px; text-align: left; border-bottom: 1px solid var(--border-color); color: var(--text-primary);">Delivery Note</th>
                                <th style="padding: 8px; text-align: left; border-bottom: 1px solid var(--border-color); color: var(--text-primary);">Location</th>
                                <th style="padding: 8px; text-align: left; border-bottom: 1px solid var(--border-color); color: var(--text-primary);">Pending Yards</th>
                                <th style="padding: 8px; text-align: left; border-bottom: 1px solid var(--border-color); color: var(--text-primary);">Unit Price</th>
                                <th style="padding: 8px; text-align: left; border-bottom: 1px solid var(--border-color); color: var(--text-primary);">Action</th>
                            </tr>
                        </thead>
                        <tbody id="fabricSelectionTableBody">
                            ${fabrics.map(fabric => `
                                <tr style="border-bottom: 1px solid var(--border-color); color: var(--text-primary);" data-fabric-id="${fabric.id}">
                                    <td style="padding: 8px; color: var(--text-primary);">${fabric.item_name || ''}</td>
                                    <td style="padding: 8px; color: var(--text-primary);">${fabric.color || ''}</td>
                                    <td style="padding: 8px; color: var(--text-primary);">${fabric.invoice_number || ''}</td>
                                    <td style="padding: 8px; color: var(--text-primary);">${fabric.customer_name || ''}</td>
                                    <td style="padding: 8px; color: var(--text-primary);">${fabric.delivery_note || ''}</td>
                                    <td style="padding: 8px; color: var(--text-primary);">${fabric.delivered_location || ''}</td>
                                    <td style="padding: 8px; color: var(--text-primary);">${fabric.pending_yards.toFixed(2)}</td>
                                    <td style="padding: 8px; color: var(--text-primary);">${fabric.unit_price.toFixed(2)}</td>
                                    <td style="padding: 8px;">
                                        <button onclick="selectFabric(${fabric.id}, '${fabric.item_name || ''}', '${fabric.color || ''}', '${fabric.invoice_number || ''}', ${fabric.unit_price}, ${fabric.pending_yards})" 
                                                style="padding: 4px 8px; background: var(--focus-color); color: #fff; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">Select</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                    <button onclick="closeFabricSelectionDialog()" style="padding: 8px 16px; background: var(--bg-secondary); color: #fff; border: 1px solid var(--border-color); border-radius: 4px; cursor: pointer;">Cancel</button>
                </div>
            `;
            
            dialog.appendChild(content);
            document.body.appendChild(dialog);
        }
        
        function filterFabrics() {
            const searchTerm = document.getElementById('fabricSearch').value.toLowerCase();
            const customerFilter = document.getElementById('fabricFilterCustomer').value.toLowerCase();
            const invoiceFilter = document.getElementById('fabricFilterInvoice').value.toLowerCase();
            const itemFilter = document.getElementById('fabricFilterItem').value.toLowerCase();
            const colorFilter = document.getElementById('fabricFilterColor').value.toLowerCase();
            const dnFilter = document.getElementById('fabricFilterDN').value.toLowerCase();
            const locationFilter = document.getElementById('fabricFilterLocation').value.toLowerCase();
            
            const rows = document.querySelectorAll('#fabricSelectionTableBody tr');
            
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length < 8) return; // Skip if not enough columns
                
                const itemName = (cells[0]?.textContent || '').toLowerCase();
                const color = (cells[1]?.textContent || '').toLowerCase();
                const invoice = (cells[2]?.textContent || '').toLowerCase();
                const customer = (cells[3]?.textContent || '').toLowerCase();
                const deliveryNote = (cells[4]?.textContent || '').toLowerCase();
                const location = (cells[5]?.textContent || '').toLowerCase();
                
                // Check all filters
                const matchesSearch = !searchTerm || 
                    itemName.includes(searchTerm) || 
                    color.includes(searchTerm) || 
                    invoice.includes(searchTerm) || 
                    customer.includes(searchTerm) ||
                    deliveryNote.includes(searchTerm) ||
                    location.includes(searchTerm);
                
                const matchesCustomer = !customerFilter || customer.includes(customerFilter);
                const matchesInvoice = !invoiceFilter || invoice.includes(invoiceFilter);
                const matchesItem = !itemFilter || itemName.includes(itemFilter);
                const matchesColor = !colorFilter || color.includes(colorFilter);
                const matchesDN = !dnFilter || deliveryNote.includes(dnFilter);
                const matchesLocation = !locationFilter || location.includes(locationFilter);
                
                const shouldShow = matchesSearch && matchesCustomer && matchesInvoice && 
                                 matchesItem && matchesColor && matchesDN && matchesLocation;
                
                row.style.display = shouldShow ? '' : 'none';
            });
        }
        
        function clearFabricFilters() {
            document.getElementById('fabricSearch').value = '';
            document.getElementById('fabricFilterCustomer').value = '';
            document.getElementById('fabricFilterInvoice').value = '';
            document.getElementById('fabricFilterItem').value = '';
            document.getElementById('fabricFilterColor').value = '';
            document.getElementById('fabricFilterDN').value = '';
            document.getElementById('fabricFilterLocation').value = '';
            filterFabrics();
        }
        
        function refreshFabricList() {
            openFabricSelectionDialog();
        }
        
        function selectFabric(id, name, color, invoice, unitPrice, pendingYards) {
            // Add to multi-fabrics list
            const fabric = {
                invoice_line_id: id,
                name: name,
                color: color,
                invoice: invoice,
                unit_price: unitPrice,
                pending_yards: pendingYards,
                consumption: 0,
                customer_name: '', // Will be populated from the row data
                delivery_note: '', // Will be populated from the row data
                delivered_location: '' // Will be populated from the row data
            };
            
            // Get additional data from the selected row
            const row = document.querySelector(`tr[data-fabric-id="${id}"]`);
            if (row) {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 6) {
                    fabric.customer_name = cells[3]?.textContent || '';
                    fabric.delivery_note = cells[4]?.textContent || '';
                    fabric.delivered_location = cells[5]?.textContent || '';
                }
            }
            
            stitchingMultiFabrics.push(fabric);
            updateMultiFabricTable();
            closeFabricSelectionDialog();
        }
        
        function updateMultiFabricTable() {
            const tbody = document.getElementById('multiFabricTableBody');
            tbody.innerHTML = '';
            
            if (stitchingMultiFabrics.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="10" style="padding: 20px; text-align: center; color: var(--text-secondary);">No additional fabrics</td>
                `;
                tbody.appendChild(row);
                return;
            }
            
            stitchingMultiFabrics.forEach((fabric, index) => {
                const row = document.createElement('tr');
                row.style.cssText = 'border-bottom: 1px solid var(--border-color);';
                row.innerHTML = `
                    <td style="padding: 8px; color: var(--text-primary);">${fabric.name}</td>
                    <td style="padding: 8px; color: var(--text-primary);">${fabric.color}</td>
                    <td style="padding: 8px; color: var(--text-primary);">${fabric.invoice}</td>
                    <td style="padding: 8px; color: var(--text-primary);">${fabric.customer_name}</td>
                    <td style="padding: 8px; color: var(--text-primary);">${fabric.delivery_note}</td>
                    <td style="padding: 8px; color: var(--text-primary);">${fabric.delivered_location}</td>
                    <td style="padding: 8px; color: var(--text-primary);">${fabric.pending_yards.toFixed(2)}</td>
                    <td style="padding: 8px;">
                        <input type="number" step="0.01" min="0" max="${fabric.pending_yards}" value="${fabric.consumption}"
                               style="padding: 4px; background: var(--bg-secondary); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 4px; width: 80px;"
                               onchange="updateMultiFabricConsumption(${index}, this.value)">
                    </td>
                    <td style="padding: 8px; color: var(--text-primary);">${fabric.unit_price.toFixed(2)}</td>
                    <td style="padding: 8px;">
                        <button onclick="removeMultiFabric(${index})" class="custom-dialog-btn custom-dialog-btn-danger" style="padding: 4px 8px; font-size: 12px;">Remove</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function updateMultiFabricConsumption(index, consumption) {
            if (stitchingMultiFabrics[index]) {
                stitchingMultiFabrics[index].consumption = parseFloat(consumption) || 0;
            }
        }
        
        function removeMultiFabric(index) {
            stitchingMultiFabrics.splice(index, 1);
            updateMultiFabricTable();
        }
        
        function removeSelectedMultiFabric() {
            // For simplicity, remove the last added fabric
            if (stitchingMultiFabrics.length > 0) {
                stitchingMultiFabrics.pop();
                updateMultiFabricTable();
            }
        }
        
        function closeFabricSelectionDialog() {
            const dialog = document.querySelector('.fabric-selection-dialog');
            if (dialog) {
                dialog.remove();
            }
        }
        
        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('imagePreview');
                    preview.innerHTML = `<img src="${e.target.result}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 4px;">`;
                    
                    // Store the file for later upload
                    stitchingImageFile = file;
                    stitchingImagePath = null; // Will be set after upload
                };
                reader.readAsDataURL(file);
            }
        }
        
        async function submitStitchingRecord() {
            // Validate inputs
            const stitchedItem = document.getElementById('stitchedItemSelect').value.trim();
            const price = parseFloat(document.getElementById('price').value) || 0;
            const stitchingCost = parseFloat(document.getElementById('stitchingCost').value) || 0;
            
            if (!stitchedItem) {
                alert('Please select a stitched item.');
                return;
            }
            
            if (price <= 0) {
                alert('Please enter a valid price.');
                return;
            }
            
            if (stitchingCost <= 0) {
                alert('Cost is required and must be greater than 0.');
                document.getElementById('stitchingCost').focus();
                return;
            }
            
            // Check if any consumption is entered
            const hasConsumption = stitchingSelectedLines.some(line => line.consumed > 0);
            if (!hasConsumption) {
                alert('Please enter consumption for at least one fabric line.');
                return;
            }
            
            // Generate serial number first
            let serial_number = null;
            try {
                const serialResponse = await fetch(`${getApiBaseUrl()}/api/stitching/generate-serial`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (serialResponse.ok) {
                    const serialResult = await serialResponse.json();
                    serial_number = serialResult.serial_number;
                } else {
                    console.warn('Failed to generate serial number, proceeding without it');
                }
            } catch (error) {
                console.warn('Error generating serial number:', error);
            }
            
            // Upload image first if provided
            let imageData = null;
            if (stitchingImageFile) {
                try {
                    const formData = new FormData();
                    formData.append('image', stitchingImageFile);
                    formData.append('garment_name', stitchedItem);
                    formData.append('fabric_name', stitchingSelectedLines[0]?.item_name || 'unknown');
                    formData.append('fabric_color', stitchingSelectedLines[0]?.color || 'unknown');
                    if (serial_number) {
                        formData.append('stitching_serial_number', serial_number);
                    }
                    
                    const uploadResponse = await fetch(`${getApiBaseUrl()}/api/images/upload`, {
                        method: 'POST',
                        body: formData
                    });
                    
                    const uploadResult = await uploadResponse.json();
                    
                    if (uploadResult.success) {
                        imageData = {
                            image_id: uploadResult.image_id,
                                            file_url: uploadResult.file_url,
                filename: uploadResult.filename,
                            local_path: uploadResult.local_path
                        };
                    } else {
                        alert('Image upload failed: ' + (uploadResult.error || 'Unknown error'));
                        return;
                    }
                } catch (error) {
                    alert('Image upload failed: ' + error.message);
                    return;
                }
            }
            
            // Prepare data
            const sizeQty = {
                'S': parseInt(document.getElementById('sizeS').value) || 0,
                'M': parseInt(document.getElementById('sizeM').value) || 0,
                'L': parseInt(document.getElementById('sizeL').value) || 0,
                'XL': parseInt(document.getElementById('sizeXL').value) || 0,
                'XXL': parseInt(document.getElementById('sizeXXL').value) || 0,
                'XXXL': parseInt(document.getElementById('sizeXXXL').value) || 0
            };
            
            const addVat = document.getElementById('addVat').checked;
            
            const data = {
                selected_lines: stitchingSelectedLines,
                stitched_item: stitchedItem,
                size_qty: sizeQty,
                price: price,
                stitching_cost: stitchingCost,
                add_vat: addVat,
                lining_fabrics: stitchingLiningFabrics,
                garment_fabrics: stitchingMultiFabrics,
                image_data: imageData
            };
            
            // Submit to server
            try {
                const response = await fetch(`${getApiBaseUrl()}/api/stitching/create`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.message) {
                    alert(result.message);
                    closeStitchingRecordDialog();
                    loadInvoiceData(); // Refresh the table
                } else {
                    alert('Error: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Error creating stitching record: ' + error.message);
            }
        }
        
        function closeStitchingRecordDialog() {
            const dialog = document.querySelector('.custom-dialog');
            if (dialog) {
                dialog.remove();
            }
        }
        
        function refreshInvoiceTable() {
            loadInvoiceData();
        }

        function openStitchingRecordDialog(selectedLineIds = null) {
            console.log('🔍 Opening stitching record dialog...');
            
            let selectedLines = [];
            
            if (selectedLineIds && selectedLineIds.length > 0) {
                // Use directly provided line IDs
                console.log('📋 Using provided line IDs:', selectedLineIds);
                selectedLines = selectedLineIds.map(lineId => {
                    const line = tableManager.getRowById(lineId);
                    if (!line) {
                        console.error('❌ Line not found for ID:', lineId);
                        return null;
                    }
                    
                    const yardsSent = line.yards_sent || line.quantity || 0;
                    const yardsConsumed = line.yards_consumed || 0;
                    const commissionYards = line.total_commission_yards || 0;
                    // Use the backend's calculated pending_yards which properly accounts for commission sales
                    const pending = line.pending_yards || 0;
                    
                    return {
                        id: line.id,
                        invoice_number: line.invoice_number,
                        item_name: line.item_name,
                        color: line.color,
                        pending: pending,
                        consumed: 0 // Will be set by user
                    };
                }).filter(line => line !== null);
            } else {
                // Use checkbox selection from table manager
                const selectedRowIds = tableManager.getSelectedRowIds();
                console.log('📋 Current selectedRowIds:', selectedRowIds);
                console.log('📋 selectedRowIds.length:', selectedRowIds.length);
                
                if (selectedRowIds.length === 0) {
                    alert('Please select one or more fabric invoice lines to create a stitching record.');
                    return;
                }
                
                selectedLines = selectedRowIds.map(rowId => {
                    const line = tableManager.getRowById(rowId);
                    const yardsSent = line.yards_sent || line.quantity || 0;
                    const yardsConsumed = line.yards_consumed || 0;
                    const commissionYards = line.total_commission_yards || 0;
                    // Use the backend's calculated pending_yards which properly accounts for commission sales
                    const pending = line.pending_yards || 0;
                    
                    // Check if delivery location is assigned
                    if (!line.delivered_location || line.delivered_location.trim() === '') {
                        console.warn(`⚠️ Line ${line.id} (${line.item_name}) has no delivery location assigned`);
                        return null;
                    }
                    
                    return {
                        id: line.id,
                        invoice_number: line.invoice_number,
                        item_name: line.item_name,
                        color: line.color,
                        pending: pending,
                        consumed: 0 // Will be set by user
                    };
                }).filter(line => line !== null);
            }
            
            if (selectedLines.length === 0) {
                // Check if any lines were filtered out due to missing delivery location
                const selectedRowIds = tableManager.getSelectedRowIds();
                const linesWithoutLocation = selectedRowIds.map(rowId => {
                    const line = tableManager.getRowById(rowId);
                    return (!line.delivered_location || line.delivered_location.trim() === '') ? line : null;
                }).filter(line => line !== null);
                
                if (linesWithoutLocation.length > 0) {
                    alert('Cannot create stitching record: Some selected lines have no delivery location assigned. Please assign delivery locations first.');
                } else {
                    alert('No valid lines selected for stitching record.');
                }
                return;
            }
            
            // Load stitched items and show dialog
            loadStitchedItemsAndShowDialog(selectedLines);
        }

        function openCustomerIdDialog() {
            openModal('customerIdModal', 'Manage Customer IDs');
        }

        function openAddInvoiceLineDialog() {
            openModal('addInvoiceLineModal', 'Add Invoice Line');
        }

        async function deleteSelectedInvoice() {
            const selectedRowIds = tableManager.getSelectedRowIds();
            if (selectedRowIds.length === 0) {
                showNotification('Please select at least one invoice to delete.', 'warning');
                return;
            }
            
            if (confirm(`Are you sure you want to delete ${selectedRowIds.length} selected invoice line(s)?`)) {
                await actionManager.deleteInvoiceLines(selectedRowIds);
            }
        }

        function openDatImportDialog() {
            openModal('datImportModal', 'Import .DAT File');
        }



        // Modal functions
        function openModal(modalId, title) {
            const modal = document.getElementById(modalId);
            if (!modal) {
                createModal(modalId, title);
            }
            document.getElementById(modalId).style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function logout() {
            localStorage.removeItem('gms_logged_in');
            localStorage.removeItem('gms_username');
            window.location.href = 'login.html';
        }

        // Theme Management
        function toggleTheme() {
            const html = document.documentElement;
            const themeIcon = document.getElementById('themeIcon');
            const themeText = document.getElementById('themeText');
            
            if (html.getAttribute('data-theme') === 'light') {
                // Switch to dark theme
                html.removeAttribute('data-theme');
                localStorage.setItem('theme', 'dark');
                themeIcon.textContent = '🌙';
                themeText.textContent = 'Dark';
            } else {
                // Switch to light theme
                html.setAttribute('data-theme', 'light');
                localStorage.setItem('theme', 'light');
                themeIcon.textContent = '☀️';
                themeText.textContent = 'Light';
            }
            
            // Update any charts if they exist
            if (window.charts) {
                setTimeout(() => {
                    Object.values(window.charts).forEach(chart => {
                        if (chart && chart.update) {
                            chart.update('none');
                        }
                    });
                }, 100);
            }
        }

        function loadTheme() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            const html = document.documentElement;
            const themeIcon = document.getElementById('themeIcon');
            const themeText = document.getElementById('themeText');
            
            if (savedTheme === 'light') {
                html.setAttribute('data-theme', 'light');
                themeIcon.textContent = '☀️';
                themeText.textContent = 'Light';
            } else {
                html.removeAttribute('data-theme');
                themeIcon.textContent = '🌙';
                themeText.textContent = 'Dark';
            }
        }



        function createModal(modalId, title) {
            const modal = document.createElement('div');
            modal.id = modalId;
            modal.className = 'modal';
            
            if (modalId === 'datImportModal') {
                modal.innerHTML = `
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2 class="modal-title">${title}</h2>
                            <span class="close" onclick="closeModal('${modalId}')">&times;</span>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label for="datFile">Select .DAT File:</label>
                                <input type="file" id="datFile" accept=".dat" required>
                            </div>
                            <div class="form-group">
                                <label>Customer ID Filtering:</label>
                                <p style="color: var(--text-secondary); font-size: 12px; margin: 5px 0;">
                                    Use the "Customer IDs" button to manage which customer IDs to import. 
                                    If no customer IDs are selected, all customers will be imported.
                                </p>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="closeModal('${modalId}')">Cancel</button>
                            <button class="btn btn-primary" onclick="importDatFile()">Import</button>
                        </div>
                    </div>
                `;
            } else if (modalId === 'addInvoiceLineModal') {
                modal.innerHTML = `
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2 class="modal-title">${title}</h2>
                            <span class="close" onclick="closeModal('${modalId}')">&times;</span>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label for="customerSelect">Customer:</label>
                                <select id="customerSelect" required>
                                    <option value="">Select Customer</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="invoiceNumber">Invoice Number:</label>
                                <input type="text" id="invoiceNumber" required>
                            </div>
                            <div class="form-group">
                                <label for="itemName">Item Name:</label>
                                <input type="text" id="itemName" required>
                            </div>
                            <div class="form-group">
                                <label for="quantity">Quantity:</label>
                                <input type="number" id="quantity" step="0.01" required>
                            </div>
                            <div class="form-group">
                                <label for="unitPrice">Unit Price:</label>
                                <input type="number" id="unitPrice" step="0.01" required>
                            </div>
                            <div class="form-group">
                                <label for="color">Color:</label>
                                <input type="text" id="color">
                            </div>
                            <div class="form-group">
                                <label for="deliveryNote">Delivery Note:</label>
                                <input type="text" id="deliveryNote">
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="closeModal('${modalId}')">Cancel</button>
                            <button class="btn btn-primary" onclick="addInvoiceLine()">Add</button>
                        </div>
                    </div>
                `;
            } else if (modalId === 'customerIdModal') {
                modal.innerHTML = `
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2 class="modal-title">${title}</h2>
                            <span class="close" onclick="closeModal('${modalId}')">&times;</span>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label for="customerIdInput">Customer ID:</label>
                                <div style="display: flex; gap: 10px;">
                                    <input type="text" id="customerIdInput" placeholder="Enter Customer ID" style="flex: 1;">
                                    <button class="btn btn-primary" onclick="addCustomerId()" style="width: 80px;">Add</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Selected Customer IDs:</label>
                                <div id="customerIdList" style="max-height: 200px; overflow-y: auto; border: 1px solid var(--border-color); padding: 10px; background: var(--bg-tertiary);">
                                    <!-- Customer IDs will be loaded here -->
                                </div>
                            </div>
                            <div style="display: flex; gap: 10px; margin-top: 10px;">
                                <button class="btn btn-danger" onclick="removeSelectedCustomerId()">Remove Selected</button>
                                <button class="btn btn-warning" onclick="clearAllCustomerIds()">Clear All</button>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="closeModal('${modalId}')">Close</button>
                        </div>
                    </div>
                `;
                // Load customer IDs when modal is created
                loadCustomerIds();
            }
            
            document.body.appendChild(modal);
        }

        async function importDatFile() {
            const fileInput = document.getElementById('datFile');
            
            if (!fileInput.files[0]) {
                alert('Please select a .DAT file to import.');
                return;
            }

            // Get selected customer IDs for filtering
            const selectedCustomerIds = customerIds;
            
            // If no customer IDs are selected, ask user if they want to proceed
            if (selectedCustomerIds.length === 0) {
                const proceed = confirm('No customer IDs are selected for filtering. This will import ALL customers from the .dat file.\n\nDo you want to proceed with importing all customers?');
                if (!proceed) {
                    return;
                }
            } else {
                // Show which customer IDs will be imported
                alert(`Only data for the following customer IDs will be imported:\n${selectedCustomerIds.join(', ')}`);
            }

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            if (selectedCustomerIds.length > 0) {
                formData.append('customer_ids', selectedCustomerIds.join(','));
            }

            // Show progress
            document.getElementById('importProgress').style.display = 'block';
            const progressFill = document.querySelector('.progress-fill');
            const progressText = document.querySelector('.progress-text');

            try {
                const response = await fetch(`${getApiBaseUrl()}/api/files/import-dat`, {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const result = await response.json();
                    let resultMsg = `Import completed!\n\nImported: ${result.imported_count} lines`;
                    if (selectedCustomerIds.length > 0) {
                        resultMsg += `\nSkipped (not in selected customer IDs): ${result.skipped_count} lines`;
                    }
                    if (result.errors.length > 0) {
                        resultMsg += `\n\nErrors:\n${result.errors.join('\n')}`;
                    }
                    alert(resultMsg);
                    closeModal('datImportModal');
                    loadInvoiceData(); // Refresh the table
                } else {
                    alert('Import failed. Please check the file format and try again.');
                }
            } catch (error) {
                alert('Import failed: ' + error.message);
            } finally {
                document.getElementById('importProgress').style.display = 'none';
            }
        }

        async function addInvoiceLine() {
            const formData = {
                customer_id: document.getElementById('customerSelect').value,
                invoice_number: document.getElementById('invoiceNumber').value,
                item_name: document.getElementById('itemName').value,
                quantity: parseFloat(document.getElementById('quantity').value),
                unit_price: parseFloat(document.getElementById('unitPrice').value),
                color: document.getElementById('color').value,
                delivery_note: document.getElementById('deliveryNote').value
            };

            const success = await actionManager.addInvoiceLine(formData);
            
            if (success) {
                closeModal('addInvoiceLineModal');
            }
        }

        // Customer ID Management Functions
        let customerIds = [];
        let customerIdMappings = [];

        async function loadCustomerIds() {
            try {
                console.log('🔄 Loading customer IDs...');
                const response = await fetch(`${getApiBaseUrl()}/api/customers/customer-ids`);
                console.log('📡 Customer IDs response status:', response.status);
                if (response.ok) {
                    customerIds = await response.json();
                    console.log('✅ Loaded customer IDs:', customerIds.length, 'items:', customerIds);
                    
                    // Load customer ID mappings with short names
                    const mappingsResponse = await fetch(`${getApiBaseUrl()}/api/customers/customer-id-mappings`);
                    if (mappingsResponse.ok) {
                        customerIdMappings = await mappingsResponse.json();
                        console.log('✅ Loaded customer ID mappings:', customerIdMappings.length, 'items');
                    }
                    
                    displayCustomerIds();
                } else {
                    console.error('❌ Failed to load customer IDs, status:', response.status);
                }
            } catch (error) {
                console.error('❌ Error loading customer IDs:', error);
            }
        }

        function displayCustomerIds() {
            const list = document.getElementById('customerIdList');
            if (!list) {
                console.error('❌ Could not find customerIdList element');
                return;
            }
            
            console.log('🔄 Displaying customer IDs:', customerIds.length, 'items');
            list.innerHTML = '';
            customerIds.sort().forEach(id => {
                const div = document.createElement('div');
                div.style.cssText = 'padding: 5px; margin: 2px 0; background: var(--bg-secondary); border-radius: 3px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: background-color 0.2s;';
                div.onclick = () => {
                    div.classList.toggle('selected');
                    // Update background color for visual feedback
                    if (div.classList.contains('selected')) {
                        div.style.backgroundColor = '#2196F3';
                        div.style.color = 'var(--text-primary)';
                    } else {
                        div.style.backgroundColor = 'var(--bg-secondary)';
                        div.style.color = 'inherit';
                    }
                };
                
                // Find mapping for this customer ID
                const mapping = customerIdMappings.find(m => m.customer_id === id);
                const shortName = mapping ? mapping.short_name : '';
                
                div.innerHTML = `
                    <span>${id}</span>
                    <span style="color: #90caf9; font-size: 0.9em; margin-left: 10px;">${shortName || 'No name'}</span>
                `;
                div.ondblclick = () => removeCustomerId(id);
                list.appendChild(div);
            });
            console.log('✅ Displayed', customerIds.length, 'customer IDs in the dialog');
        }

        async function addCustomerId() {
            const input = document.getElementById('customerIdInput');
            const id = input.value.trim();
            
            if (!id) {
                alert('Please enter a customer ID');
                return;
            }
            
            if (customerIds.includes(id)) {
                alert('Customer ID already exists');
                return;
            }
            
            customerIds.push(id);
            customerIds.sort();
            displayCustomerIds();
            input.value = '';
            
            await saveCustomerIds();
        }

        async function removeSelectedCustomerId() {
            const selected = document.querySelectorAll('#customerIdList .selected');
            if (selected.length === 0) {
                alert('Please select customer IDs to remove');
                return;
            }
            
            selected.forEach(el => {
                // Get the customer ID from the first span element (the ID, not the name)
                const idSpan = el.querySelector('span:first-child');
                const id = idSpan ? idSpan.textContent : el.textContent.split(' ')[0];
                customerIds = customerIds.filter(cid => cid !== id);
            });
            
            displayCustomerIds();
            await saveCustomerIds();
        }

        function removeCustomerId(id) {
            customerIds = customerIds.filter(cid => cid !== id);
            displayCustomerIds();
            saveCustomerIds();
        }

        async function clearAllCustomerIds() {
            if (confirm('Are you sure you want to clear all customer IDs?')) {
                customerIds = [];
                displayCustomerIds();
                await saveCustomerIds();
            }
        }

        async function saveCustomerIds() {
            try {
                const response = await fetch(`${getApiBaseUrl()}/api/customers/customer-ids`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ customer_ids: customerIds })
                });
                
                if (!response.ok) {
                    console.error('Failed to save customer IDs');
                }
            } catch (error) {
                console.error('Error saving customer IDs:', error);
            }
        }

        // Edit Invoice Line Functions
        let currentEditInvoiceId = null;

        function editSelectedInvoice() {
            const selectedRowIds = tableManager.getSelectedRowIds();
            if (selectedRowIds.length === 0) {
                alert('Please select an invoice line to edit');
                return;
            }
            
            if (selectedRowIds.length > 1) {
                alert('Please select only one invoice line to edit');
                return;
            }
            
            const selectedRowId = selectedRowIds[0];
            const invoice = tableManager.getRowById(selectedRowId);
            
            if (!invoice) {
                alert('Selected invoice not found');
                return;
            }
            
            // Check if invoice is already used in stitching records
            if (invoice.yards_consumed > 0) {
                const result = confirm('This invoice line has been used in stitching records. Editing may affect existing records. Do you want to continue?');
                if (!result) {
                    return;
                }
            }
            
            currentEditInvoiceId = invoice.id;
            
            // Populate the edit form
            document.getElementById('editItemName').value = invoice.item_name || '';
            document.getElementById('editColor').value = invoice.color || '';
            document.getElementById('editDeliveryNote').value = invoice.delivery_note || '';
            document.getElementById('editYardsSent').value = invoice.yards_sent || invoice.quantity || 0;
            document.getElementById('editYardsConsumed').value = invoice.yards_consumed || 0;
            document.getElementById('editUnitPrice').value = invoice.unit_price || 0;
            document.getElementById('editDeliveredLocation').value = invoice.delivered_location || '';
            
            // Show the dialog
            document.getElementById('editInvoiceDialog').style.display = 'block';
        }

        function editSelectedInvoiceLine() {
            const selectedRowIds = tableManager.getSelectedRowIds();
            if (selectedRowIds.length === 0) {
                alert('Please select an invoice line to edit');
                return;
            }
            
            if (selectedRowIds.length > 1) {
                alert('Please select only one invoice line to edit');
                return;
            }
            
            const selectedRowId = selectedRowIds[0];
            const invoice = tableManager.getRowById(selectedRowId);
            
            if (!invoice) {
                alert('Selected invoice line not found');
                return;
            }
            
            // Check if invoice line is already used in stitching records or commission sales
            const hasStitching = invoice.yards_consumed > 0;
            const hasCommission = invoice.commission_sales_count > 0;
            
            if (hasStitching || hasCommission) {
                let warningMessage = 'This invoice line has been used in:';
                if (hasStitching) warningMessage += '\n- Stitching records';
                if (hasCommission) warningMessage += '\n- Commission sales';
                warningMessage += '\n\nEditing may affect existing records. Do you want to continue?';
                
                const result = confirm(warningMessage);
                if (!result) {
                    return;
                }
            }
            
            currentEditInvoiceId = invoice.id;
            
            // Populate the edit form
            document.getElementById('editItemName').value = invoice.item_name || '';
            document.getElementById('editColor').value = invoice.color || '';
            document.getElementById('editDeliveryNote').value = invoice.delivery_note || '';
            document.getElementById('editYardsSent').value = invoice.yards_sent || invoice.quantity || 0;
            document.getElementById('editYardsConsumed').value = invoice.yards_consumed || 0;
            document.getElementById('editUnitPrice').value = invoice.unit_price || 0;
            document.getElementById('editDeliveredLocation').value = invoice.delivered_location || '';
            
            // Show the dialog
            document.getElementById('editInvoiceDialog').style.display = 'block';
        }

        function closeEditInvoiceDialog() {
            document.getElementById('editInvoiceDialog').style.display = 'none';
            currentEditInvoiceId = null;
        }

        async function saveEditInvoice() {
            if (!currentEditInvoiceId) {
                showNotification('No invoice selected for editing', 'warning');
                return;
            }
            
            // Get form values
            const updates = {
                item_name: document.getElementById('editItemName').value.trim(),
                color: document.getElementById('editColor').value.trim(),
                delivery_note: document.getElementById('editDeliveryNote').value.trim(),
                yards_sent: parseFloat(document.getElementById('editYardsSent').value) || 0,
                yards_consumed: parseFloat(document.getElementById('editYardsConsumed').value) || 0,
                unit_price: parseFloat(document.getElementById('editUnitPrice').value) || 0,
                delivered_location: document.getElementById('editDeliveredLocation').value.trim()
            };
            
            // Validate required fields
            if (!updates.item_name) {
                showNotification('Item Name is required', 'warning');
                return;
            }
            
            if (updates.yards_sent < 0) {
                showNotification('Yards Sent cannot be negative', 'warning');
                return;
            }
            
            if (updates.yards_consumed < 0) {
                showNotification('Yards Consumed cannot be negative', 'warning');
                return;
            }
            
            if (updates.yards_consumed > updates.yards_sent) {
                showNotification('Yards Consumed cannot be greater than Yards Sent', 'warning');
                return;
            }
            
            const success = await actionManager.updateInvoiceLine(currentEditInvoiceId, updates);
            
            if (success) {
                closeEditInvoiceDialog();
            }
        }

        function deleteInvoice(index) {
            if (confirm('Are you sure you want to delete this invoice?')) {
                // TODO: Implement delete functionality
                alert('Delete functionality will be implemented next.');
            }
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }

        // ===== COMMISSION SALE FUNCTIONALITY =====
        
        let currentCommissionSaleData = null;
        
        function openCommissionSaleDialog(lineId, availableYards, itemName, itemColor) {
            // Find the invoice line data
            const invoiceLine = tableManager.getRowById(lineId);
            if (!invoiceLine) {
                alert('Invoice line not found');
                return;
            }
            
            currentCommissionSaleData = {
                lineId: lineId,
                availableYards: availableYards,
                itemName: itemName,
                itemColor: itemColor,
                unitPrice: invoiceLine.unit_price || 0
            };
            
            // Populate dialog
            document.getElementById('commissionItemName').textContent = itemName;
            document.getElementById('commissionItemColor').textContent = itemColor;
            document.getElementById('commissionAvailableYards').textContent = formatNumber(availableYards);
            document.getElementById('commissionUnitPrice').textContent = formatNumber(invoiceLine.unit_price || 0);
            
            // Set default values
            document.getElementById('commissionYardsSold').value = availableYards;
            document.getElementById('commissionYardsSold').max = availableYards;
            
            // Set commission sale date to the same date as the fabric invoice line
            let defaultSaleDate = new Date().toISOString().split('T')[0]; // fallback to current date
            if (invoiceLine.invoice && invoiceLine.invoice.invoice_date) {
                // Use the fabric invoice date
                defaultSaleDate = invoiceLine.invoice.invoice_date;
            } else if (invoiceLine.invoice_date) {
                // Fallback to invoice_date if invoice object is not available
                defaultSaleDate = invoiceLine.invoice_date;
            }
            document.getElementById('commissionSaleDate').value = defaultSaleDate;
            
            // Calculate initial commission amount
            updateCommissionAmount();
            
            // Show dialog
            document.getElementById('commissionSaleDialog').style.display = 'block';
        }
        
        function closeCommissionSaleDialog() {
            document.getElementById('commissionSaleDialog').style.display = 'none';
            currentCommissionSaleData = null;
        }
        
        function updateCommissionAmount() {
            if (!currentCommissionSaleData) return;
            
            const yardsSold = parseFloat(document.getElementById('commissionYardsSold').value) || 0;
            const commissionAmount = yardsSold * currentCommissionSaleData.unitPrice * 0.051;
            
            document.getElementById('commissionAmount').value = `฿${formatNumber(commissionAmount)}`;
        }
        
        async function confirmCommissionSale() {
            if (!currentCommissionSaleData) return;
            
            const yardsSold = parseFloat(document.getElementById('commissionYardsSold').value) || 0;
            const saleDate = document.getElementById('commissionSaleDate').value;
            
            if (yardsSold <= 0) {
                showNotification('Please enter a valid number of yards to sell', 'warning');
                return;
            }
            
            if (yardsSold > currentCommissionSaleData.availableYards) {
                showNotification(`Cannot sell ${yardsSold} yards, only ${currentCommissionSaleData.availableYards} yards available`, 'error');
                return;
            }
            
            if (!saleDate) {
                showNotification('Please select a sale date', 'warning');
                return;
            }
            
            const success = await actionManager.createCommissionSale(
                currentCommissionSaleData.lineId, 
                yardsSold, 
                saleDate
            );
            
            if (success) {
                closeCommissionSaleDialog();
            }
        }
        
        function createStitchingRecordFromTable(lineId) {
            // Find the invoice line data
            const invoiceLine = tableManager.getRowById(lineId);
            if (!invoiceLine) {
                alert('Invoice line not found');
                return;
            }
            
            // Check if line has pending yards
            const yardsSent = invoiceLine.yards_sent || invoiceLine.quantity || 0;
            const yardsConsumed = invoiceLine.yards_consumed || 0;
            const commissionYards = invoiceLine.total_commission_yards || 0;
            // Use the backend's calculated pending_yards which properly accounts for commission sales
            const pending = invoiceLine.pending_yards || 0;
            
            if (pending <= 0) {
                alert('No pending yards available for this line');
                return;
            }
            
            // Check if delivery location is assigned
            if (!invoiceLine.delivered_location || invoiceLine.delivered_location.trim() === '') {
                alert('Cannot create stitching record: No delivery location assigned. Please assign a delivery location first.');
                return;
            }
            
            // Open stitching record dialog with the selected line
            openStitchingRecordDialog([lineId]);
        }
        
        // Add event listener for commission amount calculation
        document.addEventListener('DOMContentLoaded', function() {
            const yardsInput = document.getElementById('commissionYardsSold');
            if (yardsInput) {
                yardsInput.addEventListener('input', updateCommissionAmount);
            }
        });



        // Initialize theme when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Load theme immediately to prevent flashing
            loadTheme();
        });

        // ===== COST LIST AND PRICE LIST FUNCTIONALITY =====

        // Show/Hide dialog boxes
        function openCostListDialog() {
            document.getElementById('costListDialog').style.display = 'block';
            loadCostList();
        }

        function closeCostListDialog() {
            document.getElementById('costListDialog').style.display = 'none';
        }

        function openPriceListDialog() {
            document.getElementById('priceListDialog').style.display = 'block';
            loadPriceList();
        }

        function closePriceListDialog() {
            document.getElementById('priceListDialog').style.display = 'none';
        }

        // Load Cost List
        async function loadCostList() {
            try {
                // Get selected items from dropdowns
                const selectedGarments = getSelectedItems('costGarmentSelected');
                const selectedLocations = getSelectedItems('costLocationSelected');
                
                const apiBaseUrl = getApiBaseUrl();
                let url = `${apiBaseUrl}/api/cost-price/costs`;
                const params = new URLSearchParams();
                
                // Add garment filters
                if (selectedGarments.length > 0) {
                    selectedGarments.forEach(garment => {
                        params.append('garment_name', garment);
                    });
                }
                
                // Add location filters
                if (selectedLocations.length > 0) {
                    selectedLocations.forEach(location => {
                        params.append('location', location);
                    });
                }
                
                if (params.toString()) url += '?' + params.toString();

                const response = await fetch(url);
                if (!response.ok) throw new Error('Failed to load cost list');
                
                costListData = await response.json();
                populateCostListTable();
            } catch (error) {
                console.error('Error loading cost list:', error);
                showNotification('Error loading cost list', 'error');
            }
        }

        // Load Price List
        async function loadPriceList() {
            try {
                // Get selected items from dropdowns
                const selectedGarments = getSelectedItems('priceGarmentSelected');
                const selectedCustomers = getSelectedItems('priceCustomerSelected');
                
                const apiBaseUrl = getApiBaseUrl();
                let url = `${apiBaseUrl}/api/cost-price/prices`;
                const params = new URLSearchParams();
                
                // Add garment filters
                if (selectedGarments.length > 0) {
                    selectedGarments.forEach(garment => {
                        params.append('garment_name', garment);
                    });
                }
                
                // Add customer filters
                if (selectedCustomers.length > 0) {
                    selectedCustomers.forEach(customer => {
                        params.append('customer_name', customer);
                    });
                }
                
                if (params.toString()) url += '?' + params.toString();

                const response = await fetch(url);
                if (!response.ok) throw new Error('Failed to load price list');
                
                priceListData = await response.json();
                populatePriceListTable();
            } catch (error) {
                console.error('Error loading price list:', error);
                showNotification('Error loading price list', 'error');
            }
        }

        // Load Customers for Price Dialog
        async function loadCustomers() {
            try {
                const apiBaseUrl = getApiBaseUrl();
                const response = await fetch(`${apiBaseUrl}/api/customers`);
                if (!response.ok) throw new Error('Failed to load customers');
                
                customersList = await response.json();
                populateCustomerSelect();
            } catch (error) {
                console.error('Error loading customers:', error);
            }
        }

        function populateCustomerSelect() {
            const select = document.getElementById('priceCustomerId');
            select.innerHTML = '<option value="">Select Customer</option>';
            
            customersList.forEach(customer => {
                const option = document.createElement('option');
                option.value = customer.id;
                option.textContent = customer.short_name;
                select.appendChild(option);
            });
        }

        // Populate Cost List Table
        function populateCostListTable() {
            const tbody = document.getElementById('costListTableBody');
            tbody.innerHTML = '';

            costListData.forEach(cost => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${cost.garment_name}</td>
                    <td>${cost.stitching_location}</td>
                    <td>฿${cost.cost.toFixed(2)}</td>
                    <td>${new Date(cost.updated_at).toLocaleDateString()}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-edit" onclick="editCost(${cost.id})">Edit</button>
                            <button class="btn-delete" onclick="deleteCost(${cost.id})">Delete</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Populate Price List Table
        function populatePriceListTable() {
            const tbody = document.getElementById('priceListTableBody');
            tbody.innerHTML = '';

            priceListData.forEach(price => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${price.garment_name}</td>
                    <td>${price.customer_name}</td>
                    <td>฿${price.price.toFixed(2)}</td>
                    <td>${new Date(price.updated_at).toLocaleDateString()}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-edit" onclick="editPrice(${price.id})">Edit</button>
                            <button class="btn-delete" onclick="deletePrice(${price.id})">Delete</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Cost Dialog Functions
        function showAddCostDialog() {
            document.getElementById('costDialogTitle').textContent = 'Add New Cost';
            document.getElementById('costId').value = '';
            document.getElementById('costForm').reset();
            document.getElementById('costDialog').style.display = 'block';
        }

        function editCost(costId) {
            const cost = costListData.find(c => c.id === costId);
            if (!cost) return;

            document.getElementById('costDialogTitle').textContent = 'Edit Cost';
            document.getElementById('costId').value = cost.id;
            document.getElementById('costGarmentName').value = cost.garment_name;
            document.getElementById('costStitchingLocation').value = cost.stitching_location;
            document.getElementById('costAmount').value = cost.cost;
            document.getElementById('costDialog').style.display = 'block';
        }

        function closeCostDialog() {
            document.getElementById('costDialog').style.display = 'none';
        }

        async function saveCost() {
            try {
                const costId = document.getElementById('costId').value;
                const data = {
                    garment_name: document.getElementById('costGarmentName').value,
                    stitching_location: document.getElementById('costStitchingLocation').value,
                    cost: parseFloat(document.getElementById('costAmount').value)
                };

                const apiBaseUrl = getApiBaseUrl();
                const url = costId ? `${apiBaseUrl}/api/cost-price/costs/${costId}` : `${apiBaseUrl}/api/cost-price/costs`;
                const method = costId ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (!response.ok) throw new Error('Failed to save cost');

                closeCostDialog();
                loadCostList();
                showNotification('Cost saved successfully', 'success');
            } catch (error) {
                console.error('Error saving cost:', error);
                showNotification('Error saving cost', 'error');
            }
        }

        async function deleteCost(costId) {
            if (!confirm('Are you sure you want to delete this cost?')) return;

            try {
                const apiBaseUrl = getApiBaseUrl();
                const response = await fetch(`${apiBaseUrl}/api/cost-price/costs/${costId}`, {
                    method: 'DELETE'
                });

                if (!response.ok) throw new Error('Failed to delete cost');

                loadCostList();
                showNotification('Cost deleted successfully', 'success');
            } catch (error) {
                console.error('Error deleting cost:', error);
                showNotification('Error deleting cost', 'error');
            }
        }

        // Price Dialog Functions
        function showAddPriceDialog() {
            document.getElementById('priceDialogTitle').textContent = 'Add New Price';
            document.getElementById('priceId').value = '';
            document.getElementById('priceForm').reset();
            loadCustomers();
            document.getElementById('priceDialog').style.display = 'block';
        }

        function editPrice(priceId) {
            const price = priceListData.find(p => p.id === priceId);
            if (!price) return;

            document.getElementById('priceDialogTitle').textContent = 'Edit Price';
            document.getElementById('priceId').value = price.id;
            document.getElementById('priceGarmentName').value = price.garment_name;
            document.getElementById('priceCustomerId').value = price.customer_id;
            document.getElementById('priceAmount').value = price.price;
            loadCustomers();
            document.getElementById('priceDialog').style.display = 'block';
        }

        function closePriceDialog() {
            document.getElementById('priceDialog').style.display = 'none';
        }

        async function savePrice() {
            try {
                const priceId = document.getElementById('priceId').value;
                const data = {
                    garment_name: document.getElementById('priceGarmentName').value,
                    customer_id: parseInt(document.getElementById('priceCustomerId').value),
                    price: parseFloat(document.getElementById('priceAmount').value)
                };

                const apiBaseUrl = getApiBaseUrl();
                const url = priceId ? `${apiBaseUrl}/api/cost-price/prices/${priceId}` : `${apiBaseUrl}/api/cost-price/prices`;
                const method = priceId ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (!response.ok) throw new Error('Failed to save price');

                closePriceDialog();
                loadPriceList();
                showNotification('Price saved successfully', 'success');
            } catch (error) {
                console.error('Error saving price:', error);
                showNotification('Error saving price', 'error');
            }
        }

        async function deletePrice(priceId) {
            if (!confirm('Are you sure you want to delete this price?')) return;

            try {
                const apiBaseUrl = getApiBaseUrl();
                const response = await fetch(`${apiBaseUrl}/api/cost-price/prices/${priceId}`, {
                    method: 'DELETE'
                });

                if (!response.ok) throw new Error('Failed to delete price');

                loadPriceList();
                showNotification('Price deleted successfully', 'success');
            } catch (error) {
                console.error('Error deleting price:', error);
                showNotification('Error deleting price', 'error');
            }
        }

        // Enhanced Filter Functions
        function getSelectedItems(selectedElementId) {
            const selectedElement = document.getElementById(selectedElementId);
            if (!selectedElement) return [];
            
            const selectedItems = selectedElement.querySelectorAll('.selected-item');
            return Array.from(selectedItems).map(item => item.dataset.value);
        }

        function filterCostDropdown(inputId, dropdownId) {
            const input = document.getElementById(inputId);
            const dropdown = document.getElementById(dropdownId);
            if (!input || !dropdown) return;
            
            const searchTerm = input.value.toLowerCase();
            const filterType = dropdownId.replace('Dropdown', '');
            
            // Get unique values from cost data
            let options = [];
            if (filterType === 'costGarment') {
                options = [...new Set(costListData.map(cost => cost.garment_name))];
            } else if (filterType === 'costLocation') {
                options = [...new Set(costListData.map(cost => cost.stitching_location))];
            }
            
            dropdown.innerHTML = '';
            const filteredOptions = options.filter(option => 
                option.toLowerCase().includes(searchTerm)
            );
            
            filteredOptions.forEach(option => {
                const optionElement = document.createElement('div');
                optionElement.className = 'dropdown-option';
                optionElement.textContent = option;
                optionElement.dataset.value = option;
                optionElement.onclick = () => selectCostOption(filterType, option);
                dropdown.appendChild(optionElement);
            });
            
            dropdown.style.display = filteredOptions.length > 0 ? 'block' : 'none';
        }

        function filterPriceDropdown(inputId, dropdownId) {
            const input = document.getElementById(inputId);
            const dropdown = document.getElementById(dropdownId);
            if (!input || !dropdown) return;
            
            const searchTerm = input.value.toLowerCase();
            const filterType = dropdownId.replace('Dropdown', '');
            
            // Get unique values from price data
            let options = [];
            if (filterType === 'priceGarment') {
                options = [...new Set(priceListData.map(price => price.garment_name))];
            } else if (filterType === 'priceCustomer') {
                options = [...new Set(priceListData.map(price => price.customer_name))];
            }
            
            dropdown.innerHTML = '';
            const filteredOptions = options.filter(option => 
                option.toLowerCase().includes(searchTerm)
            );
            
            filteredOptions.forEach(option => {
                const optionElement = document.createElement('div');
                optionElement.className = 'dropdown-option';
                optionElement.textContent = option;
                optionElement.dataset.value = option;
                optionElement.onclick = () => selectPriceOption(filterType, option);
                dropdown.appendChild(optionElement);
            });
            
            dropdown.style.display = filteredOptions.length > 0 ? 'block' : 'none';
        }

        function selectCostOption(filterType, value) {
            const selectedElement = document.getElementById(filterType + 'Selected');
            const input = document.getElementById(filterType.replace('cost', 'costFilter').replace('Garment', 'Garment').replace('Location', 'Location'));
            const dropdown = document.getElementById(filterType + 'Dropdown');
            
            if (!selectedElement || !input) return;
            
            // Check if already selected
            const existingItems = selectedElement.querySelectorAll('.selected-item');
            const alreadySelected = Array.from(existingItems).some(item => item.dataset.value === value);
            
            if (!alreadySelected) {
                // Add selected item
                const selectedItem = document.createElement('div');
                selectedItem.className = 'selected-item';
                selectedItem.dataset.value = value;
                selectedItem.innerHTML = `
                    ${value}
                    <button class="remove-btn" onclick="removeCostSelectedItem('${filterType}', '${value}')">&times;</button>
                `;
                selectedElement.appendChild(selectedItem);
            }
            
            // Clear input and hide dropdown
            input.value = '';
            dropdown.style.display = 'none';
            
            // Update cost list
            loadCostList();
        }

        function selectPriceOption(filterType, value) {
            const selectedElement = document.getElementById(filterType + 'Selected');
            const input = document.getElementById(filterType.replace('price', 'priceFilter').replace('Garment', 'Garment').replace('Customer', 'Customer'));
            const dropdown = document.getElementById(filterType + 'Dropdown');
            
            if (!selectedElement || !input) return;
            
            // Check if already selected
            const existingItems = selectedElement.querySelectorAll('.selected-item');
            const alreadySelected = Array.from(existingItems).some(item => item.dataset.value === value);
            
            if (!alreadySelected) {
                // Add selected item
                const selectedItem = document.createElement('div');
                selectedItem.className = 'selected-item';
                selectedItem.dataset.value = value;
                selectedItem.innerHTML = `
                    ${value}
                    <button class="remove-btn" onclick="removePriceSelectedItem('${filterType}', '${value}')">&times;</button>
                `;
                selectedElement.appendChild(selectedItem);
            }
            
            // Clear input and hide dropdown
            input.value = '';
            dropdown.style.display = 'none';
            
            // Update price list
            loadPriceList();
        }

        function removeCostSelectedItem(filterType, value) {
            const selectedElement = document.getElementById(filterType + 'Selected');
            if (!selectedElement) return;
            
            const itemToRemove = selectedElement.querySelector(`[data-value="${value}"]`);
            if (itemToRemove) {
                itemToRemove.remove();
                loadCostList();
            }
        }

        function removePriceSelectedItem(filterType, value) {
            const selectedElement = document.getElementById(filterType + 'Selected');
            if (!selectedElement) return;
            
            const itemToRemove = selectedElement.querySelector(`[data-value="${value}"]`);
            if (itemToRemove) {
                itemToRemove.remove();
                loadPriceList();
            }
        }

        function showCostDropdown(dropdownId) {
            const dropdown = document.getElementById(dropdownId);
            if (dropdown) {
                dropdown.style.display = 'block';
            }
        }

        function showPriceDropdown(dropdownId) {
            const dropdown = document.getElementById(dropdownId);
            if (dropdown) {
                dropdown.style.display = 'block';
            }
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', function(event) {
            const dropdowns = document.querySelectorAll('.dropdown-options');
            dropdowns.forEach(dropdown => {
                if (!dropdown.contains(event.target) && !event.target.closest('.searchable-dropdown')) {
                    dropdown.style.display = 'none';
                }
            });
        });

        // Add filter event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Cost list filters - now using enhanced dropdowns
            // Price list filters - now using enhanced dropdowns
        });

        // Debounce function for filters
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
    </script>
</body>
</html>

