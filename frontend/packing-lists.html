<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Packing Lists - Garment Management System</title>
    <link rel="stylesheet" href="css/common.css">
    <link rel="stylesheet" href="css/table-sorting.css">
    <style>
        /* Page-specific styles only - filter/nav/pagination in common.css */

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .btn-primary {
            background: var(--focus-color);
            color: #fff;
        }

        .btn-primary:hover {
            background: var(--nav-active);
        }

        .btn-secondary {
            background: #757575;
            color: #fff;
        }

        .btn-secondary:hover {
            background: #9e9e9e;
        }

        .btn-success {
            background: #388e3c;
            color: #fff;
        }

        .btn-success:hover {
            background: #4caf50;
        }

        .btn-warning {
            background: #f57c00;
            color: #fff;
        }

        .btn-warning:hover {
            background: #ff9800;
        }

        .btn-danger {
            background: #d32f2f;
            color: #fff;
        }

        .btn-danger:hover {
            background: #f44336;
        }

        .btn-info {
            background: #1976d2;
            color: #fff;
        }

        .btn-info:hover {
            background: #2196f3;
        }

        /* Table Styles */
        .table-container {
            background: var(--card-bg);
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 10px;
            border: 1px solid var(--border-color);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .data-table-container {
            background: var(--card-bg);
            border-radius: 8px;
            overflow-x: auto;
            margin-bottom: 10px;
            max-height: 600px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
            white-space: nowrap;
            min-width: 2300px; /* Ensure minimum width for all columns */
        }

        .data-table th {
            background: var(--nav-active);
            color: var(--text-primary);
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .data-table td {
            padding: 10px 8px;
            border-bottom: 1px solid var(--border-color);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: var(--text-primary);
        }

        .data-table tr:hover {
            background: var(--bg-tertiary);
        }

        .data-table tr.selected {
            background: var(--focus-color) !important;
            color: var(--text-primary);
        }

        /* Pagination Styles */
        .table-container {
            max-height: 500px;
            overflow-y: auto;
            background: var(--card-bg);
            border-radius: 8px;
            margin-bottom: 10px;
            border: 1px solid var(--border-color);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .table-container::-webkit-scrollbar,
        .data-table-container::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        .table-container::-webkit-scrollbar-track,
        .data-table-container::-webkit-scrollbar-track {
            background: var(--bg-tertiary);
            border-radius: 4px;
        }

        .table-container::-webkit-scrollbar-thumb,
        .data-table-container::-webkit-scrollbar-thumb {
            background: var(--focus-color);
            border-radius: 4px;
        }

        .table-container::-webkit-scrollbar-thumb:hover,
        .data-table-container::-webkit-scrollbar-thumb:hover {
            background: var(--nav-active);
        }



        .data-table tr:hover {
            background: var(--bg-tertiary) !important;
        }

        .data-table tr:hover td {
            background: var(--bg-tertiary) !important;
        }

        .parent-row {
            background: var(--bg-tertiary);
            font-weight: bold;
        }

        .parent-row td {
            background: var(--bg-secondary);
            color: var(--focus-color);
        }

        .parent-row td:first-child {
            cursor: default;
        }

        .child-row {
            background: var(--bg-secondary);
            display: none;
        }

        .child-row.expanded {
            display: table-row;
        }

        .child-row td {
            padding-left: 20px;
            background: var(--bg-secondary);
        }

        .child-row td:first-child {
            cursor: default;
        }

        .secondary-fabric-row {
            background: var(--bg-tertiary);
            display: none;
        }

        .secondary-fabric-row.expanded {
            display: table-row;
        }

        .secondary-fabric-row td {
            padding-left: 20px;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
        }

        .secondary-fabric-row td:first-child {
            cursor: default;
        }

        .lining-fabric-row {
            background: var(--bg-tertiary);
            display: none;
        }

        .lining-fabric-row.expanded {
            display: table-row;
        }

        .lining-fabric-row td {
            padding-left: 20px;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
        }

        .lining-fabric-row td:first-child {
            cursor: default;
        }

        /* Checkbox styling */
        .checkbox-wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .checkbox-wrapper input[type="checkbox"] {
            margin: 0;
            cursor: pointer;
            width: 16px;
            height: 16px;
            accent-color: #5c6bc0;
        }

        /* Make it clear that rows are not clickable */
        .data-table tr {
            cursor: default;
        }

        /* Expand/Collapse indicator */
        .expand-indicator {
            cursor: pointer;
            user-select: none;
            font-weight: bold;
            color: var(--focus-color);
        }

        .expand-indicator:hover {
            color: var(--text-primary);
        }

        /* Checkbox styling */
        .checkbox-wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .checkbox-wrapper input[type="checkbox"] {
            margin: 0;
            cursor: pointer;
            width: 16px;
            height: 16px;
            accent-color: #5c6bc0;
        }

        /* Make it clear that rows are not clickable */
        .data-table tr {
            cursor: default;
        }

        .data-table tr:hover {
            background: var(--bg-tertiary) !important;
        }

        .data-table tr:hover td {
            background: var(--bg-tertiary) !important;
        }

        /* Loading and Error States */
        .loading-state {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .error-state {
            text-align: center;
            padding: 40px;
            color: #e57373;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .filter-row {
                flex-direction: column;
                align-items: stretch;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .data-table-container {
                overflow-x: auto;
            }
        }

        /* Ensure table cells don't wrap and show ellipsis for long content */
        .data-table th,
        .data-table td {
            max-width: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* Specific column widths to prevent wrapping */
        .data-table th:nth-child(1),
        .data-table td:nth-child(1) { /* Checkbox column */
            width: 30px;
            min-width: 30px;
            max-width: 30px;
            text-align: center;
        }

        .data-table th:nth-child(2),
        .data-table td:nth-child(2) { /* Created At */
            width: 80px;
            min-width: 80px;
            max-width: 80px;
        }

        .data-table th:nth-child(3),
        .data-table td:nth-child(3) { /* PL # */
            width: 120px;
            min-width: 120px;
            max-width: 120px;
        }

        .data-table th:nth-child(4),
        .data-table td:nth-child(4) { /* Serial # */
            width: 120px;
            min-width: 120px;
            max-width: 120px;
        }

        .data-table th:nth-child(5),
        .data-table td:nth-child(5) { /* Garment */
            width: 80px;
            min-width: 80px;
            max-width: 80px;
        }

        .data-table th:nth-child(6),
        .data-table td:nth-child(6) { /* Fabric */
            width: 100px;
            min-width: 100px;
            max-width: 100px;
        }

        .data-table th:nth-child(7),
        .data-table td:nth-child(7) { /* Color */
            width: 80px;
            min-width: 80px;
            max-width: 80px;
        }

        .data-table th:nth-child(8),
        .data-table td:nth-child(8) { /* Customer */
            width: 120px;
            min-width: 120px;
            max-width: 120px;
        }

        .data-table th:nth-child(9),
        .data-table td:nth-child(9) { /* Beta T# */
            width: 100px;
            min-width: 100px;
            max-width: 100px;
        }

        .data-table th:nth-child(10),
        .data-table td:nth-child(10) { /* MSK T# */
            width: 100px;
            min-width: 100px;
            max-width: 100px;
        }

        .data-table th:nth-child(11),
        .data-table td:nth-child(11) { /* Group Bill # */
            width: 140px;
            min-width: 140px;
            max-width: 140px;
        }

        .data-table th:nth-child(12),
        .data-table td:nth-child(12) { /* Fabric Inv */
            width: 100px;
            min-width: 100px;
            max-width: 100px;
        }

        .data-table th:nth-child(13),
        .data-table td:nth-child(13) { /* Fabric DN */
            width: 100px;
            min-width: 100px;
            max-width: 100px;
        }

        .data-table th:nth-child(14),
        .data-table td:nth-child(14) { /* Fab Used */
            width: 70px;
            min-width: 70px;
            max-width: 70px;
            text-align: right;
        }

        .data-table th:nth-child(15),
        .data-table td:nth-child(15) { /* Fab Cost */
            width: 70px;
            min-width: 70px;
            max-width: 70px;
            text-align: right;
        }

        .data-table th:nth-child(16),
        .data-table td:nth-child(16) { /* Fab Value */
            width: 80px;
            min-width: 80px;
            max-width: 80px;
            text-align: right;
        }

        .data-table th:nth-child(17),
        .data-table td:nth-child(17),
        .data-table th:nth-child(18),
        .data-table td:nth-child(18),
        .data-table th:nth-child(19),
        .data-table td:nth-child(19),
        .data-table th:nth-child(20),
        .data-table td:nth-child(20),
        .data-table th:nth-child(21),
        .data-table td:nth-child(21),
        .data-table th:nth-child(22),
        .data-table td:nth-child(22) { /* Size columns */
            width: 40px;
            min-width: 40px;
            max-width: 40px;
            text-align: center;
        }

        .data-table th:nth-child(23),
        .data-table td:nth-child(23) { /* Total Qty */
            width: 70px;
            min-width: 70px;
            max-width: 70px;
            text-align: center;
        }

        .data-table th:nth-child(24),
        .data-table td:nth-child(24) { /* Sew Cost */
            width: 70px;
            min-width: 70px;
            max-width: 70px;
            text-align: right;
        }

        .data-table th:nth-child(25),
        .data-table td:nth-child(25) { /* Sew Value */
            width: 80px;
            min-width: 80px;
            max-width: 80px;
            text-align: right;
        }
    </style>
    <script src="js/common/nav-bar.js"></script>
    <script src="js/common/utils.js"></script>
    <script src="js/common/filter-manager.js"></script>
    <script src="js/common/pagination.js"></script>
    <script src="js/common/page-initializer.js"></script>
    <script src="js/table-sorting.js"></script>
    <script src="js/common/hierarchical-table-manager.js"></script>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="nav-bar">
        <!-- Navigation will be rendered by nav-bar.js -->
    </nav>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Filter Controls - Managed by FilterManager -->
        <div class="filter-controls" id="filterControls">
            <!-- Filters will be rendered by FilterManager -->
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons">
            <button class="btn btn-success" onclick="downloadPDF(false)">
                <i class="fas fa-download"></i> Save PDF
            </button>
            <button class="btn btn-warning" onclick="downloadPDF(true)">
                <i class="fas fa-download"></i> Save PDF with Cost
            </button>
            <button class="btn btn-success" onclick="createGroupBillingNote()">
                <i class="fas fa-file-invoice"></i> Group and Create Billing Note
            </button>
            <button class="btn btn-secondary" onclick="refreshPackingListTable()">
            <i class="fas fa-sync-alt"></i> Refresh
        </button>
            <button class="btn btn-warning" onclick="assignTaxInvoice()">
                <i class="fas fa-tag"></i> Apply MSK Tax #
            </button>
            <div style="flex-grow: 1;"></div>
            <span style="color: var(--text-secondary); font-size: 12px; align-self: center;">
                Tip: Use checkboxes to select packing lists, then click 'Save PDF' to download PDFs or 'Group and Create Billing Note' to create billing notes.
            </span>
            <button class="btn btn-danger" onclick="deleteSelectedPackingList()">
                <i class="fas fa-trash"></i> Delete Selected Packing List
        </button>
    </div>

        <!-- Data Table -->
        <div class="data-table-container">
            <table class="data-table" id="packingListTable">
                <thead>
                    <tr>
                        <th style="width: 30px;">
                            <input type="checkbox" id="selectAllCheckbox" onclick="toggleSelectAll()">
                        </th>
                        <th class="sortable-header" data-sort="created_at" style="width: 90px;">Created At</th>
                        <th class="sortable-header" data-sort="packing_list_number" style="width: 130px;">PL #</th>
                        <th class="sortable-header" data-sort="serial_number" style="width: 130px;">Serial #</th>
                        <th class="sortable-header" data-sort="garment" style="width: 90px;">Garment</th>
                        <th class="sortable-header" data-sort="fabric" style="width: 110px;">Fabric</th>
                        <th class="sortable-header" data-sort="color" style="width: 90px;">Color</th>
                        <th class="sortable-header" data-sort="customer" style="width: 130px;">Customer</th>
                        <th class="sortable-header" data-sort="tax_invoice_number" style="width: 110px;">Beta T#</th>
                        <th class="sortable-header" data-sort="msk_invoice_number" style="width: 110px;">MSK T#</th>
                        <th class="sortable-header" data-sort="group_bill_number" style="width: 150px;">Group Bill #</th>
                        <th class="sortable-header" data-sort="fabric_invoice" style="width: 110px;">Fabric Inv.</th>
                        <th class="sortable-header" data-sort="fabric_delivery_note" style="width: 110px;">Fabric DN.</th>
                        <th class="sortable-header" data-sort="fabric_used" style="width: 80px;">Fab Used</th>
                        <th class="sortable-header" data-sort="fabric_cost" style="width: 80px;">Fab Cost</th>
                        <th class="sortable-header" data-sort="fabric_value" style="width: 90px;">Fab Value</th>
                        <th class="sortable-header" data-sort="size_s" style="width: 45px;">S</th>
                        <th class="sortable-header" data-sort="size_m" style="width: 45px;">M</th>
                        <th class="sortable-header" data-sort="size_l" style="width: 45px;">L</th>
                        <th class="sortable-header" data-sort="size_xl" style="width: 45px;">XL</th>
                        <th class="sortable-header" data-sort="size_xxl" style="width: 45px;">2XL</th>
                        <th class="sortable-header" data-sort="size_xxxl" style="width: 45px;">3XL</th>
                        <th class="sortable-header" data-sort="total_qty" style="width: 70px;">Total Qty</th>
                        <th class="sortable-header" data-sort="sewing_cost" style="width: 70px;">Sew Cost</th>
                        <th class="sortable-header" data-sort="sewing_value" style="width: 80px;">Sew Value</th>
                    </tr>
                </thead>
                <tbody id="packingListTableBody">
                    <tr>
                        <td colspan="23" class="loading-state">Loading packing lists...</td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <!-- Pagination Controls -->
        <div id="paginationContainer"></div>
    </div>

    <script>
        // Global variables
        let packingListData = [];
        let filteredPackingListData = []; // Kept for compatibility; tableManager holds current view
        let selectedPackingListIds = [];
        let currentPage = 1;
        const itemsPerPage = 50;
        let filterManager = null;
        let tableManager = null;
        let tableSorter = null;

        // API utilities moved to js/common/utils.js

        // Authentication functions moved to js/common/utils.js

        // Initialize page using PageInitializer
        PageInitializer.onLoad({
            activeTab: 'packing-lists',
            onAuthSuccess: async () => {
                // Table manager and filters first, then load data
                initializeTableManager();
                initializeFilterManager();
                await refreshPackingListTable();
            }
        });

        /**
         * Initialize table manager (pagination + custom render) and table sorter
         */
        function initializeTableManager() {
            tableManager = new HierarchicalTableManager('packingListTable', {
                hierarchical: false,
                itemsPerPage: itemsPerPage,
                paginationContainerId: 'paginationContainer',
                customRender: (pageData) => {
                    populatePackingListTable(pageData, { skipPagination: true });
                }
            });
            tableSorter = window.createTableSorter ? window.createTableSorter('packingListTable', {
                dataGetter: getPackingListValueForSorting
            }) : null;
            if (tableSorter) {
                const tableEl = document.getElementById('packingListTable');
                if (tableEl) {
                    tableEl.addEventListener('tableSorted', function(event) {
                        const sortedData = event.detail?.data || [];
                        tableManager.setData(sortedData);
                        tableSorter.setData(sortedData, getPackingListValueForSorting);
                    });
                }
            }
        }

        /**
         * Initialize FilterManager with packing list filters
         */
        function initializeFilterManager() {
            const filterConfig = [
                {
                    id: 'plFilter',
                    type: 'dropdown',
                    label: 'PL#',
                    placeholder: 'Select PL#',
                    multiSelect: true,
                    customExtract: (packingList) => packingList.packing_list_serial || null,
                    customFilter: (packingList, filterValue) => {
                        if (!filterValue || (Array.isArray(filterValue) && filterValue.length === 0)) return true;
                        const plSerial = (packingList.packing_list_serial || '').toLowerCase();
                        if (Array.isArray(filterValue)) {
                            return filterValue.some(val => plSerial.includes(String(val).toLowerCase()));
                        }
                        return plSerial.includes(String(filterValue).toLowerCase());
                    }
                },
                {
                    id: 'serialFilter',
                    type: 'dropdown',
                    label: 'Serial#',
                    placeholder: 'Select Serial #',
                    multiSelect: true,
                    customExtract: (packingList) => {
                        if (!packingList.lines) return null;
                        return packingList.lines.map(line => line.stitching_invoice_number).filter(Boolean);
                    },
                    customFilter: (packingList, filterValue) => {
                        if (!filterValue || (Array.isArray(filterValue) && filterValue.length === 0)) return true;
                        const searchTerms = Array.isArray(filterValue) ? filterValue : [filterValue];
                        return packingList.lines && packingList.lines.some(line => {
                            const serial = (line.stitching_invoice_number || '').toLowerCase();
                            return searchTerms.some(term => serial.includes(String(term).toLowerCase()));
                        });
                    }
                },
                {
                    id: 'fabricFilter',
                    type: 'dropdown',
                    label: 'Fab.',
                    placeholder: 'Select Fabric',
                    multiSelect: true,
                    customExtract: (packingList) => {
                        if (!packingList.lines) return null;
                        return packingList.lines.map(line => line.fabric_name).filter(Boolean);
                    },
                    customFilter: (packingList, filterValue) => {
                        if (!filterValue || (Array.isArray(filterValue) && filterValue.length === 0)) return true;
                        const searchTerms = Array.isArray(filterValue) ? filterValue : [filterValue];
                        return packingList.lines && packingList.lines.some(line => {
                            const fabric = (line.fabric_name || '').toLowerCase();
                            return searchTerms.some(term => fabric.includes(String(term).toLowerCase()));
                        });
                    }
                },
                {
                    id: 'customerFilter',
                    type: 'dropdown',
                    label: 'Cust.',
                    placeholder: 'Select Customer',
                    dataKey: 'customer_name',
                    multiSelect: true,
                    customFilter: (packingList, filterValue) => {
                        if (!filterValue || (Array.isArray(filterValue) && filterValue.length === 0)) return true;
                        const customerName = (packingList.customer_name || '').toLowerCase();
                        if (Array.isArray(filterValue)) {
                            return filterValue.some(val => customerName.includes(String(val).toLowerCase()));
                        }
                        return customerName.includes(String(filterValue).toLowerCase());
                    }
                },
                {
                    id: 'taxInvFilter',
                    type: 'dropdown',
                    label: 'Tax Inv #',
                    placeholder: 'Select Tax Inv #',
                    multiSelect: true,
                    customExtract: (packingList) => {
                        if (!packingList.lines) return null;
                        return packingList.lines.map(line => line.tax_invoice_number).filter(Boolean);
                    },
                    customFilter: (packingList, filterValue) => {
                        if (!filterValue || (Array.isArray(filterValue) && filterValue.length === 0)) return true;
                        const searchTerms = Array.isArray(filterValue) ? filterValue : [filterValue];
                        return packingList.lines && packingList.lines.some(line => {
                            const taxInv = (line.tax_invoice_number || '').toLowerCase();
                            return searchTerms.some(term => taxInv.includes(String(term).toLowerCase()));
                        });
                    }
                },
                {
                    id: 'fabInvFilter',
                    type: 'dropdown',
                    label: 'Fab. Inv',
                    placeholder: 'Select Fabric Inv',
                    multiSelect: true,
                    customExtract: (packingList) => {
                        if (!packingList.lines) return null;
                        return packingList.lines.map(line => line.fabric_invoice_number).filter(Boolean);
                    },
                    customFilter: (packingList, filterValue) => {
                        if (!filterValue || (Array.isArray(filterValue) && filterValue.length === 0)) return true;
                        const searchTerms = Array.isArray(filterValue) ? filterValue : [filterValue];
                        return packingList.lines && packingList.lines.some(line => {
                            const fabInv = (line.fabric_invoice_number || '').toLowerCase();
                            return searchTerms.some(term => fabInv.includes(String(term).toLowerCase()));
                        });
                    }
                },
                {
                    id: 'fabDnFilter',
                    type: 'dropdown',
                    label: 'Fab. DN',
                    placeholder: 'Select Fabric DN',
                    multiSelect: true,
                    customExtract: (packingList) => {
                        if (!packingList.lines) return null;
                        return packingList.lines.map(line => line.delivery_note).filter(Boolean);
                    },
                    customFilter: (packingList, filterValue) => {
                        if (!filterValue || (Array.isArray(filterValue) && filterValue.length === 0)) return true;
                        const searchTerms = Array.isArray(filterValue) ? filterValue : [filterValue];
                        return packingList.lines && packingList.lines.some(line => {
                            const fabDn = (line.delivery_note || '').toLowerCase();
                            return searchTerms.some(term => fabDn.includes(String(term).toLowerCase()));
                        });
                    }
                },
                {
                    id: 'dateFromFilter',
                    type: 'date',
                    label: 'From',
                    placeholder: 'DD/MM/YY',
                    customFilter: (packingList, filterValue) => {
                        if (!filterValue || !String(filterValue).trim()) return true;
                        const createdDate = new Date(packingList.created_at);
                        return isDateInRange(createdDate, filterValue, 'from');
                    }
                },
                {
                    id: 'dateToFilter',
                    type: 'date',
                    label: 'To',
                    placeholder: 'DD/MM/YY',
                    customFilter: (packingList, filterValue) => {
                        if (!filterValue || !String(filterValue).trim()) return true;
                        const createdDate = new Date(packingList.created_at);
                        return isDateInRange(createdDate, filterValue, 'to');
                    }
                },
                {
                    id: 'billingStatus',
                    type: 'radio',
                    label: 'Show',
                    options: [
                        { value: 'unbilled', label: 'Unbilled' },
                        { value: 'billed', label: 'Billed' },
                        { value: 'all', label: 'All' }
                    ],
                    defaultValue: 'unbilled',
                    customFilter: (packingList, filterValue) => {
                        if (filterValue === 'all') return true;
                        const hasBilledRecords = packingList.lines && packingList.lines.some(line => 
                            line.billing_group_id !== null && line.billing_group_id !== undefined
                        );
                        if (filterValue === 'billed') return hasBilledRecords;
                        if (filterValue === 'unbilled') return !hasBilledRecords;
                        return true;
                    }
                }
            ];

            filterManager = new FilterManager({
                containerId: 'filterControls',
                filters: filterConfig,
                data: packingListData,
                onFilterChange: (filteredData, filterValues) => {
                    filteredPackingListData = filteredData;
                    if (tableManager) tableManager.setData(filteredData);
                    if (tableSorter) tableSorter.setData(filteredData, getPackingListValueForSorting);
                },
                debounceDelay: 500
            });

            // Add Clear Filter button
            const clearBtn = document.createElement('div');
            clearBtn.className = 'filter-group';
            clearBtn.innerHTML = '<button class="btn btn-secondary" onclick="clearFilters()">Clear Filter</button>';
            document.getElementById('filterControls').querySelector('.filter-row').appendChild(clearBtn);
        }

        // Formatting functions moved to js/common/utils.js

        function clearFilters() {
            if (filterManager) {
                filterManager.clearFilters();
            }
        }

        // Date utilities moved to js/common/utils.js

        async function refreshPackingListTable() {
            try {
                const tableBody = document.getElementById('packingListTableBody');
                if (!tableBody) {
                    console.error('‚ùå Could not find packing table body');
                    return;
                }
                
                tableBody.innerHTML = '<tr><td colspan="23" class="loading-state">Loading packing lists...</td></tr>';
                
                const apiUrl = getApiBaseUrl();
                const requestUrl = `${apiUrl}/api/packing-lists?_t=${Date.now()}`;
                console.log('üîç API URL debug:', { apiUrl, requestUrl, windowLocation: window.location.href });
                console.log('üåê Fetching', requestUrl);
                
                const response = await fetch(requestUrl, {
                    method: 'GET',
                    headers: {
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    }
                });
                console.log('üì° Response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('‚ùå Failed to load packing data, status:', response.status);
                    tableBody.innerHTML = `<tr><td colspan="23" class="error-state">Failed to load packing lists: ${errorText}</td></tr>`;
                    return;
                }
                
                const data = await response.json();
                console.log('üìä Received packing list data:', data.length, 'records');
                
                packingListData = data;
                filteredPackingListData = data;
                if (filterManager) {
                    filterManager.updateData(data);
                } else {
                    if (tableManager) tableManager.setData(data);
                    if (tableSorter) tableSorter.setData(data, getPackingListValueForSorting);
                }
                console.log('‚úÖ Packing list data loaded successfully');
                
            } catch (error) {
                console.error('‚ùå Error loading packing list data:', error);
                const tableBody = document.getElementById('packingListTableBody');
                if (tableBody) {
                    tableBody.innerHTML = `<tr><td colspan="23" class="error-state">Error loading packing lists: ${error.message}</td></tr>`;
                }
            }
        }

        function populatePackingListTable(data, options = {}) {
            const tableBody = document.getElementById('packingListTableBody');
            if (!tableBody) {
                console.error('‚ùå Could not find table body for population');
                return;
            }
            const skipPagination = options.skipPagination === true;
            
            if (!data || data.length === 0) {
                console.log('üì≠ No packing lists found');
                tableBody.innerHTML = '<tr><td colspan="24" class="loading-state">No packing lists found.</td></tr>';
                if (!skipPagination && tableManager && tableManager.paginationComponent) {
                    tableManager.paginationComponent.update();
                }
                return;
            }
            
            let pageData;
            let startIndex;
            if (skipPagination) {
                pageData = data;
                startIndex = 0;
            } else {
                const totalPages = Math.ceil(data.length / itemsPerPage);
                if (currentPage > totalPages && totalPages > 0) currentPage = totalPages;
                startIndex = (currentPage - 1) * itemsPerPage;
                const endIndex = Math.min(startIndex + itemsPerPage, data.length);
                pageData = data.slice(startIndex, endIndex);
            }
            
            console.log('üìã Populating table with', pageData.length, 'packing lists' + (skipPagination ? '' : ' (page ' + currentPage + ')'));
            let html = '';
            
            pageData.forEach((packingList, pageIndex) => {
                const actualIndex = startIndex + pageIndex;
                console.log('üì¶ Processing packing list', actualIndex + 1, ':', packingList.packing_list_serial);
                
                // Create parent row (packing list summary)
                html += `
                    <tr class="parent-row" data-packing-list-id="${packingList.id}">
                        <td class="checkbox-wrapper">
                            <input type="checkbox" class="packing-list-checkbox" data-packing-list-id="${packingList.id}" onclick="togglePackingListSelection(${packingList.id})">
                        </td>
                        <td>${formatDate(packingList.delivery_date || packingList.created_at)}</td>
                        <td onclick="toggleExpansion(${packingList.id})">
                            <span class="expand-indicator">‚ñ∂</span> ${packingList.packing_list_serial || ''}
                        </td>
                        <td>Summary (${packingList.total_records || 0} records)</td>
                        <td>Total Items: ${packingList.total_items || 0}</td>
                        <td></td>
                        <td></td>
                        <td>${packingList.customer_name || ''}</td>
                        <td>${packingList.beta_tax_invoice_number || ''}</td>
                        <td>${packingList.tax_invoice_number || ''}</td>
                        <td>${packingList.group_bill_number || ''}</td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td>${formatInteger(packingList.total_items || 0)}</td>
                        <td></td>
                        <td></td>
                    </tr>
                `;
                
                // Add child rows (stitching records)
                if (packingList.lines && packingList.lines.length > 0) {
                    console.log('üìÑ Adding', packingList.lines.length, 'child rows for', packingList.packing_list_serial);
                    packingList.lines.forEach(line => {
                        let sizeQty = {};
                        if (line.size_qty_json) {
                            try {
                                // Parse the JSON string from the database
                                sizeQty = JSON.parse(line.size_qty_json.replace(/'/g, '"'));
                            } catch (e) {
                                console.error('Error parsing size_qty_json:', e, line.size_qty_json);
                                sizeQty = {};
                            }
                        }
                        const totalQty = Object.values(sizeQty).reduce((sum, qty) => sum + (parseInt(qty) || 0), 0);
                        
                        // Calculate fabric values
                        const fabricUnitPrice = parseFloat(line.fabric_unit_price || 0);
                        const yardsConsumed = parseFloat(line.yards_consumed || 0);
                        const fabricCost = fabricUnitPrice;
                        const fabricValue = fabricUnitPrice * yardsConsumed;
                        
                        // Calculate VAT-inclusive price
                        const basePrice = parseFloat(line.price || 0);
                        const addVat = line.add_vat || false;
                        const vatInclusivePrice = addVat ? basePrice * 1.07 : basePrice;
                        
                        html += `
                            <tr class="child-row" data-packing-list-id="${packingList.id}" data-stitching-id="${line.stitching_invoice_id}">
                                <td></td>
                                <td>${formatDate(line.created_at)}</td>
                                <td>${packingList.packing_list_serial || ''}</td>
                                <td>${line.stitching_invoice_number || ''}</td>
                                <td>${line.stitched_item || ''}</td>
                                <td>${line.fabric_name || ''}</td>
                                <td>${line.color || ''}</td>
                                <td>${packingList.customer_name || ''}</td>
                                <td>${line.beta_tax_invoice_number || ''}</td>
                                <td>${line.tax_invoice_number || ''}</td>
                                <td>${line.group_bill_number || ''}</td>
                                <td>${line.fabric_invoice_number || ''}</td>
                                <td>${line.delivery_note || ''}</td>
                                <td>${formatNumber(yardsConsumed)}</td>
                                <td>${formatNumber(fabricCost)}</td>
                                <td>${formatNumber(fabricValue)}</td>
                                <td>${formatInteger(sizeQty.S || 0)}</td>
                                <td>${formatInteger(sizeQty.M || 0)}</td>
                                <td>${formatInteger(sizeQty.L || 0)}</td>
                                <td>${formatInteger(sizeQty.XL || 0)}</td>
                                <td>${formatInteger(sizeQty.XXL || 0)}</td>
                                <td>${formatInteger(sizeQty.XXXL || 0)}</td>
                                <td>${formatInteger(totalQty)}</td>
                                <td>${formatNumber(vatInclusivePrice)}</td>
                                <td>${formatNumber(line.total_value || 0)}</td>
                            </tr>
                        `;
                        
                        // Add secondary fabric rows if they exist
                        if (line.garment_fabrics && line.garment_fabrics.length > 0) {
                            line.garment_fabrics.forEach(fabric => {
                                const fabricValue = parseFloat(fabric.total_fabric_cost || 0);
                                html += `
                                    <tr class="secondary-fabric-row" data-packing-list-id="${packingList.id}" data-stitching-id="${line.stitching_invoice_id}">
                                        <td></td>
                                        <td>${formatDate(line.created_at)}</td>
                                        <td>${packingList.packing_list_serial || ''}</td>
                                        <td>${line.stitching_invoice_number || ''}</td>
                                        <td>${line.stitched_item || ''}</td>
                                        <td style="padding-left: 20px; color: var(--text-secondary);">‚Ü≥ ${fabric.lining_name || fabric.fabric_name || ''}</td>
                                        <td>${fabric.color || ''}</td>
                                        <td>${packingList.customer_name || ''}</td>
                                        <td>${fabric.beta_tax_invoice_number || ''}</td>
                                        <td>${fabric.tax_invoice_number || ''}</td>
                                        <td>${line.group_bill_number || ''}</td>
                                        <td>${fabric.fabric_invoice_number || ''}</td>
                                        <td>${fabric.delivery_note || ''}</td>
                                        <td>${formatNumber(parseFloat(fabric.consumption_yards || 0))}</td>
                                        <td>${formatNumber(parseFloat(fabric.unit_price || 0))}</td>
                                        <td>${formatNumber(fabricValue)}</td>
                                        <td colspan="6"></td>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                    </tr>
                                `;
                            });
                        }
                        
                        // Add lining fabric rows if they exist
                        if (line.lining_fabrics && line.lining_fabrics.length > 0) {
                            line.lining_fabrics.forEach(lining => {
                                const liningValue = parseFloat(lining.total_cost || 0);
                                html += `
                                    <tr class="lining-fabric-row" data-packing-list-id="${packingList.id}" data-stitching-id="${line.stitching_invoice_id}">
                                        <td></td>
                                        <td>${formatDate(line.created_at)}</td>
                                        <td>${packingList.packing_list_serial || ''}</td>
                                        <td>${line.stitching_invoice_number || ''}</td>
                                        <td>${line.stitched_item || ''}</td>
                                        <td style="padding-left: 20px; color: var(--text-secondary);">‚Ü≥ Lining: ${lining.lining_name || ''}</td>
                                        <td>${lining.color || ''}</td>
                                        <td>${packingList.customer_name || ''}</td>
                                        <td></td>
                                        <td></td>
                                        <td>${line.group_bill_number || ''}</td>
                                        <td></td>
                                        <td></td>
                                        <td>${formatNumber(parseFloat(lining.consumption_yards || 0))}</td>
                                        <td>${formatNumber(parseFloat(lining.unit_price || 0))}</td>
                                        <td>${formatNumber(liningValue)}</td>
                                        <td colspan="6"></td>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                    </tr>
                                `;
                            });
                        }
                    });
                }
            });
            
            tableBody.innerHTML = html;
            if (!skipPagination && tableManager && tableManager.paginationComponent) {
                tableManager.paginationComponent.update();
            }
            console.log('‚úÖ Table population completed');
        }

        function toggleExpansion(packingListId) {
            const childRows = document.querySelectorAll(`tr[data-packing-list-id="${packingListId}"].child-row`);
            const secondaryFabricRows = document.querySelectorAll(`tr[data-packing-list-id="${packingListId}"].secondary-fabric-row`);
            const liningFabricRows = document.querySelectorAll(`tr[data-packing-list-id="${packingListId}"].lining-fabric-row`);
            const parentRow = document.querySelector(`tr[data-packing-list-id="${packingListId}"].parent-row`);
            const expandIndicator = parentRow.querySelector('.expand-indicator');
            
            const allDetailRows = [...childRows, ...secondaryFabricRows, ...liningFabricRows];
            const isExpanded = allDetailRows[0] && allDetailRows[0].classList.contains('expanded');
            
            allDetailRows.forEach(row => {
                if (isExpanded) {
                    row.classList.remove('expanded');
                } else {
                    row.classList.add('expanded');
                }
            });
            
            // Update expand indicator
            if (isExpanded) {
                expandIndicator.textContent = '‚ñ∂';
            } else {
                expandIndicator.textContent = '‚ñº';
            }
        }

        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            const isChecked = selectAllCheckbox.checked;
            
            // Select/deselect all packing list checkboxes
            document.querySelectorAll('.packing-list-checkbox').forEach(checkbox => {
                checkbox.checked = isChecked;
            });
        }

        function togglePackingListSelection(packingListId) {
            console.log('üîÑ togglePackingListSelection called with packingListId:', packingListId);
            const checkbox = document.querySelector(`input[data-packing-list-id="${packingListId}"].packing-list-checkbox`);
            const isChecked = checkbox.checked;
            console.log('üìã Checkbox checked state:', isChecked);
            
            updateSelectAllCheckbox();
        }

        function updateSelectAllCheckbox() {
            const allCheckboxes = document.querySelectorAll('.packing-list-checkbox');
            const allChecked = Array.from(allCheckboxes).every(cb => cb.checked);
            const anyChecked = Array.from(allCheckboxes).some(cb => cb.checked);
            
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            selectAllCheckbox.checked = allChecked;
            selectAllCheckbox.indeterminate = anyChecked && !allChecked;
        }

        function getSelectedPackingListIds() {
            const selectedCheckboxes = document.querySelectorAll('.packing-list-checkbox:checked');
            const ids = Array.from(selectedCheckboxes).map(cb => cb.getAttribute('data-packing-list-id'));
            console.log('üîç getSelectedPackingListIds found:', ids.length, 'selected checkboxes');
            console.log('üìã Selected IDs:', ids);
            return ids;
        }

        // Formatting functions moved to js/common/utils.js

        function downloadPDF(showCost = false) {
            const selectedPackingListIds = getSelectedPackingListIds();
            if (selectedPackingListIds.length === 0) {
                alert('Select a packing list to download its PDF.');
                return;
            }

            if (selectedPackingListIds.length > 1) {
                alert('Please select only one packing list to download PDF.');
                return;
            }

            const packingListId = selectedPackingListIds[0];
            const costParam = showCost ? '?show_cost=true' : '';
            const url = `${getApiBaseUrl()}/api/packing-lists/${packingListId}/pdf${costParam}`;
            window.open(url, '_blank');
        }

        function createGroupBillingNote() {
            console.log('üîÑ createGroupBillingNote called');
            const selectedPackingListIds = getSelectedPackingListIds();
            console.log('üìã Selected packing list IDs:', selectedPackingListIds);
            
            if (selectedPackingListIds.length === 0) {
                alert('Please select one or more packing lists to create a group billing note.');
                return;
            }
            
            // Show group bill creation dialog
            showGroupBillDialog(selectedPackingListIds);
        }

        function showGroupBillDialog(packingListIds) {
            console.log('üîÑ showGroupBillDialog called with packingListIds:', packingListIds);
            
            // Create modal dialog
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.style.position = 'fixed';
            modal.style.zIndex = '1000';
            modal.style.left = '0';
            modal.style.top = '0';
            modal.style.width = '100%';
            modal.style.height = '100%';
            modal.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
            
            modal.innerHTML = `
                <div style="background: var(--card-bg); margin: 5% auto; padding: 20px; border-radius: 8px; width: 80%; max-width: 500px; color: var(--text-primary); border: 1px solid var(--border-color);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid var(--border-color);">
                        <h2 style="font-size: 18px; font-weight: 600; color: var(--focus-color);">Create Group Billing Note</h2>
                        <span style="color: var(--text-secondary); font-size: 28px; font-weight: bold; cursor: pointer;" onclick="this.closest('.modal').remove()">&times;</span>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500; color: var(--text-secondary);">Invoice Date:</label>
                            <input type="text" id="invoiceDate" placeholder="DD/MM/YY" style="width: 100%; padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-tertiary); color: var(--text-primary); font-size: 12px;" required>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500; color: var(--text-secondary);">Stitching Invoice Comments (optional):</label>
                            <textarea id="stitchingComments" placeholder="Enter comments for the stitching invoice..." style="width: 100%; padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-tertiary); color: var(--text-primary); font-size: 12px; resize: vertical; min-height: 80px;"></textarea>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500; color: var(--text-secondary);">Fabric Invoice Comments (optional):</label>
                            <textarea id="fabricComments" placeholder="Enter comments for the fabric invoice..." style="width: 100%; padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-tertiary); color: var(--text-primary); font-size: 12px; resize: vertical; min-height: 80px;"></textarea>
                        </div>
                        
                        <div style="display: flex; align-items: center; gap: 8px; margin-top: 10px;">
                            <input type="checkbox" id="applyWithholdingTax" checked style="width: auto; margin: 0;">
                            <label for="applyWithholdingTax" style="color: var(--text-secondary);">Apply Withholding Tax (3%)</label>
                        </div>
                    </div>
                    
                    <div style="display: flex; justify-content: flex-end; gap: 10px; padding-top: 15px; border-top: 1px solid var(--border-color);">
                        <button id="cancelBtn" style="padding: 8px 16px; background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 4px; cursor: pointer; font-size: 12px;">Cancel</button>
                        <button id="createBtn" style="padding: 8px 16px; background: var(--focus-color); color: var(--text-primary); border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">Create Group Bill</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Set default date to today in DD/MM/YY format
            const today = new Date();
            const day = String(today.getDate()).padStart(2, '0');
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const year = String(today.getFullYear()).slice(-2);
            document.getElementById('invoiceDate').value = `${day}/${month}/${year}`;
            
            // Add date formatting to the invoice date input
            const invoiceDateInput = document.getElementById('invoiceDate');
            if (invoiceDateInput) {
                invoiceDateInput.addEventListener('input', () => formatDateInput(invoiceDateInput));
            }
            
            // Add event listeners to buttons
            const cancelBtn = document.getElementById('cancelBtn');
            const createBtn = document.getElementById('createBtn');
            
            if (cancelBtn) {
                cancelBtn.addEventListener('click', () => {
                    modal.remove();
                });
            }
            
            if (createBtn) {
                createBtn.addEventListener('click', () => {
                    console.log('üîÑ Create Group Bill button clicked');
                    submitGroupBill(packingListIds);
                });
            }
        }

        async function submitGroupBill(packingListIds) {
            console.log('üîÑ submitGroupBill called with packingListIds:', packingListIds);
            console.log('üîÑ submitGroupBill type:', typeof packingListIds);
            console.log('üîÑ submitGroupBill length:', packingListIds ? packingListIds.length : 'undefined');
            
            const invoiceDateInput = document.getElementById('invoiceDate').value;
            const stitchingComments = document.getElementById('stitchingComments').value;
            const fabricComments = document.getElementById('fabricComments').value;
            const applyWithholdingTax = document.getElementById('applyWithholdingTax').checked;
            
            console.log('üìã Form data:', {
                invoiceDateInput,
                stitchingComments,
                fabricComments,
                applyWithholdingTax
            });
            
            if (!invoiceDateInput) {
                alert('Please enter an invoice date.');
                return;
            }
            
            // Convert DD/MM/YY to YYYY-MM-DD
            let invoiceDate;
            try {
                const parts = invoiceDateInput.split('/');
                if (parts.length === 3) {
                    const day = parts[0];
                    const month = parts[1];
                    const year = '20' + parts[2]; // Assume 20xx for YY format
                    invoiceDate = `${year}-${month}-${day}`;
                } else {
                    throw new Error('Invalid date format');
                }
            } catch (error) {
                alert('Please enter a valid date in DD/MM/YY format.');
                return;
            }
            
            try {
                const requestData = {
                    packing_list_ids: packingListIds,
                    invoice_date: invoiceDate,
                    stitching_comments: stitchingComments,
                    fabric_comments: fabricComments,
                    apply_withholding_tax: applyWithholdingTax
                };
                
                const apiUrl = `${getApiBaseUrl()}/api/group-bills/create`;
                console.log('üåê Sending request to:', apiUrl);
                console.log('üì§ Request data:', requestData);
                console.log('üì§ Request data JSON:', JSON.stringify(requestData));
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });
                
                console.log('üì° Response status:', response.status);
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('‚úÖ Success response:', result);
                    alert(`Group bill ${result.group_bill.group_number} created successfully!`);
                    
                    // Close modal
                    document.querySelector('.modal').remove();
                    
                    // Refresh the packing list table
                    refreshPackingListTable();
                } else {
                    const errorText = await response.text();
                    console.error('‚ùå Error response:', errorText);
                    let errorMessage = 'Unknown error';
                    try {
                        const error = JSON.parse(errorText);
                        errorMessage = error.error || errorMessage;
                    } catch (e) {
                        errorMessage = errorText;
                    }
                    alert(`Failed to create group bill: ${errorMessage}`);
                }
            } catch (error) {
                console.error('‚ùå Error creating group bill:', error);
                alert('Error creating group bill: ' + error.message);
            }
        }

        function assignTaxInvoice() {
            const selectedPackingListIds = getSelectedPackingListIds();
            if (selectedPackingListIds.length === 0) {
                alert('Please select one or more packing lists to assign a Tax Invoice Number.');
                return;
            }

            // Prompt for Tax Invoice Number
            const taxInvoiceNumber = prompt('Enter Tax Invoice Number:');
            if (taxInvoiceNumber === null) {
                return; // User cancelled
            }

            const taxInv = taxInvoiceNumber.trim();
            if (taxInv === '') {
                alert('Please enter a valid Tax Invoice Number.');
                return;
            }

            // Update in database
            const updateData = {
                packing_list_ids: selectedPackingListIds,
                tax_invoice_number: taxInv === '0' ? null : taxInv
            };

            fetch(`${getApiBaseUrl()}/api/packing-lists/assign-tax-invoice`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(updateData)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    alert(`${taxInv === '0' ? 'Removed' : 'Assigned'} Tax Invoice # for ${selectedPackingListIds.length} packing list(s).`);
                    refreshPackingListTable();
                } else {
                    alert('Error: ' + (result.error || 'Unknown error'));
                }
            })
            .catch(error => {
                alert('Error assigning Tax Invoice #: ' + error.message);
            });
        }

        function deleteSelectedPackingList() {
            const selectedPackingListIds = getSelectedPackingListIds();
            if (selectedPackingListIds.length === 0) {
                alert('Please select a packing list to delete.');
                return;
            }

            if (selectedPackingListIds.length > 1) {
                alert('Please select only one packing list to delete.');
                return;
            }

            const packingListId = selectedPackingListIds[0];
            const packingList = packingListData.find(pl => pl.id == packingListId);
            const confirmMessage = `Are you sure you want to delete packing list ${packingList ? packingList.packing_list_serial : packingListId}?`;
            
            if (confirm(confirmMessage)) {
                fetch(`${getApiBaseUrl()}/api/packing-lists/${packingListId}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(result => {
                    if (result.message) {
                        alert(result.message);
                        refreshPackingListTable();
                    } else {
                        alert('Error: ' + (result.error || 'Unknown error'));
                    }
                })
                .catch(error => {
                    alert('Error deleting packing list: ' + error.message);
                });
            }
        }

        // Authentication functions moved to js/common/utils.js

        // Theme Management
        // Theme functions moved to js/common/utils.js

        /**
         * Custom data getter for packing list sorting (maps header data-sort to API fields)
         */
        function getPackingListValueForSorting(item, column) {
            if (!item) return '';
            const firstLine = item.lines && item.lines[0];
            switch (column) {
                case 'created_at':
                    return item.created_at || item.delivery_date || '';
                case 'packing_list_number':
                    return item.packing_list_serial || item.packing_list_number || '';
                case 'serial_number':
                    return (firstLine && firstLine.stitching_invoice_number) || item.serial_number || '';
                case 'garment':
                    return (firstLine && firstLine.stitched_item) || item.garment || '';
                case 'fabric':
                    return (firstLine && firstLine.fabric_name) || item.fabric || '';
                case 'color':
                    return (firstLine && firstLine.color) || item.color || '';
                case 'customer':
                    return item.customer_name || item.customer || '';
                case 'tax_invoice_number':
                    return item.beta_tax_invoice_number || item.tax_invoice_number || '';
                case 'msk_invoice_number':
                    return item.tax_invoice_number || item.msk_invoice_number || '';
                case 'group_bill_number':
                    return item.group_bill_number || '';
                case 'fabric_invoice':
                    return (firstLine && firstLine.fabric_invoice_number) || item.fabric_invoice || '';
                case 'fabric_delivery_note':
                    return (firstLine && firstLine.delivery_note) || item.fabric_delivery_note || '';
                case 'fabric_used':
                    return (firstLine && parseFloat(firstLine.yards_consumed)) ?? item.fabric_used ?? '';
                case 'fabric_cost':
                    return (firstLine && parseFloat(firstLine.fabric_unit_price)) ?? item.fabric_cost ?? '';
                case 'fabric_value':
                    return (firstLine && parseFloat(firstLine.total_value)) ?? item.fabric_value ?? '';
                case 'size_s':
                case 'size_m':
                case 'size_l':
                case 'size_xl':
                case 'size_xxl':
                case 'size_xxxl': {
                    const key = column.replace('size_', '').toUpperCase();
                    if (firstLine && firstLine.size_qty_json) {
                        try {
                            const qty = JSON.parse(firstLine.size_qty_json.replace(/'/g, '"'));
                            return parseInt(qty[key] || qty[key.toLowerCase()]) || 0;
                        } catch (e) { return 0; }
                    }
                    return item[column] ?? 0;
                }
                case 'total_qty':
                    return item.total_items ?? item.total_qty ?? 0;
                case 'sewing_cost':
                    return (firstLine && parseFloat(firstLine.price)) ?? item.sewing_cost ?? '';
                case 'sewing_value':
                    return (firstLine && parseFloat(firstLine.total_value)) ?? item.sewing_value ?? '';
                default:
                    return item[column] ?? '';
            }
        }
    </script>
</body>
</html>