<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Packing Lists - Garment Management System</title>
    <link rel="stylesheet" href="css/common.css">
    <link rel="stylesheet" href="css/table-sorting.css">
    <style>
        /* Page-specific styles only - common styles moved to common.css */

        /* Filter Controls - Compact Design */
        .filter-controls {
            background: var(--card-bg);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .filter-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-group label {
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .filter-input {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 14px;
            min-width: 120px;
            transition: border-color 0.3s ease;
        }

        .filter-input:focus {
            outline: none;
            border-color: var(--focus-color);
        }

        .filter-select {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 14px;
            min-width: 120px;
            transition: border-color 0.3s ease;
        }

        .radio-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
        }

        .radio-option input[type="radio"] {
            margin: 0;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .btn-primary {
            background: var(--focus-color);
            color: #fff;
        }

        .btn-primary:hover {
            background: var(--nav-active);
        }

        .btn-secondary {
            background: #757575;
            color: #fff;
        }

        .btn-secondary:hover {
            background: #9e9e9e;
        }

        .btn-success {
            background: #388e3c;
            color: #fff;
        }

        .btn-success:hover {
            background: #4caf50;
        }

        .btn-warning {
            background: #f57c00;
            color: #fff;
        }

        .btn-warning:hover {
            background: #ff9800;
        }

        .btn-danger {
            background: #d32f2f;
            color: #fff;
        }

        .btn-danger:hover {
            background: #f44336;
        }

        .btn-info {
            background: #1976d2;
            color: #fff;
        }

        .btn-info:hover {
            background: #2196f3;
        }

        /* Table Styles */
        .table-container {
            background: var(--card-bg);
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 10px;
            border: 1px solid var(--border-color);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .data-table-container {
            background: var(--card-bg);
            border-radius: 8px;
            overflow-x: auto;
            margin-bottom: 10px;
            max-height: 600px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
            white-space: nowrap;
            min-width: 2300px; /* Ensure minimum width for all columns */
        }

        .data-table th {
            background: var(--nav-active);
            color: var(--text-primary);
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .data-table td {
            padding: 10px 8px;
            border-bottom: 1px solid var(--border-color);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: var(--text-primary);
        }

        .data-table tr:hover {
            background: var(--bg-tertiary);
        }

        .data-table tr.selected {
            background: var(--focus-color) !important;
            color: var(--text-primary);
        }

        /* Pagination Styles */
        .table-container {
            max-height: 500px;
            overflow-y: auto;
            background: var(--card-bg);
            border-radius: 8px;
            margin-bottom: 10px;
            border: 1px solid var(--border-color);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .table-container::-webkit-scrollbar,
        .data-table-container::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        .table-container::-webkit-scrollbar-track,
        .data-table-container::-webkit-scrollbar-track {
            background: var(--bg-tertiary);
            border-radius: 4px;
        }

        .table-container::-webkit-scrollbar-thumb,
        .data-table-container::-webkit-scrollbar-thumb {
            background: var(--focus-color);
            border-radius: 4px;
        }

        .table-container::-webkit-scrollbar-thumb:hover,
        .data-table-container::-webkit-scrollbar-thumb:hover {
            background: var(--nav-active);
        }



        .data-table tr:hover {
            background: var(--bg-tertiary) !important;
        }

        .data-table tr:hover td {
            background: var(--bg-tertiary) !important;
        }

        .parent-row {
            background: var(--bg-tertiary);
            font-weight: bold;
        }

        .parent-row td {
            background: var(--bg-secondary);
            color: var(--focus-color);
        }

        .parent-row td:first-child {
            cursor: default;
        }

        .child-row {
            background: var(--bg-secondary);
            display: none;
        }

        .child-row.expanded {
            display: table-row;
        }

        .child-row td {
            padding-left: 20px;
            background: var(--bg-secondary);
        }

        .child-row td:first-child {
            cursor: default;
        }

        .secondary-fabric-row {
            background: var(--bg-tertiary);
            display: none;
        }

        .secondary-fabric-row.expanded {
            display: table-row;
        }

        .secondary-fabric-row td {
            padding-left: 20px;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
        }

        .secondary-fabric-row td:first-child {
            cursor: default;
        }

        .lining-fabric-row {
            background: var(--bg-tertiary);
            display: none;
        }

        .lining-fabric-row.expanded {
            display: table-row;
        }

        .lining-fabric-row td {
            padding-left: 20px;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
        }

        .lining-fabric-row td:first-child {
            cursor: default;
        }

        /* Checkbox styling */
        .checkbox-wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .checkbox-wrapper input[type="checkbox"] {
            margin: 0;
            cursor: pointer;
            width: 16px;
            height: 16px;
            accent-color: #5c6bc0;
        }

        /* Make it clear that rows are not clickable */
        .data-table tr {
            cursor: default;
        }

        /* Expand/Collapse indicator */
        .expand-indicator {
            cursor: pointer;
            user-select: none;
            font-weight: bold;
            color: var(--focus-color);
        }

        .expand-indicator:hover {
            color: var(--text-primary);
        }

        /* Checkbox styling */
        .checkbox-wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .checkbox-wrapper input[type="checkbox"] {
            margin: 0;
            cursor: pointer;
            width: 16px;
            height: 16px;
            accent-color: #5c6bc0;
        }

        /* Make it clear that rows are not clickable */
        .data-table tr {
            cursor: default;
        }

        .data-table tr:hover {
            background: var(--bg-tertiary) !important;
        }

        .data-table tr:hover td {
            background: var(--bg-tertiary) !important;
        }

        /* Loading and Error States */
        .loading-state {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .error-state {
            text-align: center;
            padding: 40px;
            color: #e57373;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .filter-row {
                flex-direction: column;
                align-items: stretch;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .data-table-container {
                overflow-x: auto;
            }
        }

        /* Ensure table cells don't wrap and show ellipsis for long content */
        .data-table th,
        .data-table td {
            max-width: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* Specific column widths to prevent wrapping */
        .data-table th:nth-child(1),
        .data-table td:nth-child(1) { /* Checkbox column */
            width: 30px;
            min-width: 30px;
            max-width: 30px;
            text-align: center;
        }

        .data-table th:nth-child(2),
        .data-table td:nth-child(2) { /* Created At */
            width: 80px;
            min-width: 80px;
            max-width: 80px;
        }

        .data-table th:nth-child(3),
        .data-table td:nth-child(3) { /* PL # */
            width: 120px;
            min-width: 120px;
            max-width: 120px;
        }

        .data-table th:nth-child(4),
        .data-table td:nth-child(4) { /* Serial # */
            width: 120px;
            min-width: 120px;
            max-width: 120px;
        }

        .data-table th:nth-child(5),
        .data-table td:nth-child(5) { /* Garment */
            width: 80px;
            min-width: 80px;
            max-width: 80px;
        }

        .data-table th:nth-child(6),
        .data-table td:nth-child(6) { /* Fabric */
            width: 100px;
            min-width: 100px;
            max-width: 100px;
        }

        .data-table th:nth-child(7),
        .data-table td:nth-child(7) { /* Color */
            width: 80px;
            min-width: 80px;
            max-width: 80px;
        }

        .data-table th:nth-child(8),
        .data-table td:nth-child(8) { /* Customer */
            width: 120px;
            min-width: 120px;
            max-width: 120px;
        }

        .data-table th:nth-child(9),
        .data-table td:nth-child(9) { /* Beta T# */
            width: 100px;
            min-width: 100px;
            max-width: 100px;
        }

        .data-table th:nth-child(10),
        .data-table td:nth-child(10) { /* MSK T# */
            width: 100px;
            min-width: 100px;
            max-width: 100px;
        }

        .data-table th:nth-child(11),
        .data-table td:nth-child(11) { /* Group Bill # */
            width: 140px;
            min-width: 140px;
            max-width: 140px;
        }

        .data-table th:nth-child(12),
        .data-table td:nth-child(12) { /* Fabric Inv */
            width: 100px;
            min-width: 100px;
            max-width: 100px;
        }

        .data-table th:nth-child(13),
        .data-table td:nth-child(13) { /* Fabric DN */
            width: 100px;
            min-width: 100px;
            max-width: 100px;
        }

        .data-table th:nth-child(14),
        .data-table td:nth-child(14) { /* Fab Used */
            width: 70px;
            min-width: 70px;
            max-width: 70px;
            text-align: right;
        }

        .data-table th:nth-child(15),
        .data-table td:nth-child(15) { /* Fab Cost */
            width: 70px;
            min-width: 70px;
            max-width: 70px;
            text-align: right;
        }

        .data-table th:nth-child(16),
        .data-table td:nth-child(16) { /* Fab Value */
            width: 80px;
            min-width: 80px;
            max-width: 80px;
            text-align: right;
        }

        .data-table th:nth-child(17),
        .data-table td:nth-child(17),
        .data-table th:nth-child(18),
        .data-table td:nth-child(18),
        .data-table th:nth-child(19),
        .data-table td:nth-child(19),
        .data-table th:nth-child(20),
        .data-table td:nth-child(20),
        .data-table th:nth-child(21),
        .data-table td:nth-child(21),
        .data-table th:nth-child(22),
        .data-table td:nth-child(22) { /* Size columns */
            width: 40px;
            min-width: 40px;
            max-width: 40px;
            text-align: center;
        }

        .data-table th:nth-child(23),
        .data-table td:nth-child(23) { /* Total Qty */
            width: 70px;
            min-width: 70px;
            max-width: 70px;
            text-align: center;
        }

        .data-table th:nth-child(24),
        .data-table td:nth-child(24) { /* Sew Cost */
            width: 70px;
            min-width: 70px;
            max-width: 70px;
            text-align: right;
        }

        .data-table th:nth-child(25),
        .data-table td:nth-child(25) { /* Sew Value */
            width: 80px;
            min-width: 80px;
            max-width: 80px;
            text-align: right;
        }

        /* Pagination Styles */
        .pagination-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            padding: 15px 20px;
            background: var(--card-bg);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .pagination-info {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .pagination-buttons {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .pagination-btn {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
            min-width: 60px;
        }

        .pagination-btn:hover:not(:disabled) {
            background: var(--focus-color);
            border-color: var(--nav-active);
        }

        .pagination-btn:disabled {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            cursor: not-allowed;
        }

        .pagination-btn.active {
            background: var(--focus-color);
            border-color: var(--nav-active);
            font-weight: bold;
        }

        .page-numbers {
            display: flex;
            gap: 5px;
        }
    </style>
    <script src="js/common/nav-bar.js"></script>
    <script src="js/common/utils.js"></script>
    <script src="js/table-sorting.js"></script>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="nav-bar">
        <!-- Navigation will be rendered by nav-bar.js -->
    </nav>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Filter Controls - Compact Design -->
        <div class="filter-controls">
            <div class="filter-row">
                <div class="filter-group">
                    <label class="filter-label">PL#:</label>
                    <input type="text" class="filter-input" id="plFilter" placeholder="PL#">
                </div>
                <div class="filter-group">
                    <label class="filter-label">Serial#:</label>
                    <input type="text" class="filter-input" id="serialFilter" placeholder="Serial #">
                </div>
                <div class="filter-group">
                    <label class="filter-label">Fab.:</label>
                    <input type="text" class="filter-input" id="fabricFilter" placeholder="Fabric">
                </div>
                <div class="filter-group">
                    <label class="filter-label">Cust.:</label>
                    <input type="text" class="filter-input" id="customerFilter" placeholder="Customer">
                </div>
                <div class="filter-group">
                    <label class="filter-label">Tax Inv #:</label>
                    <input type="text" class="filter-input" id="taxInvFilter" placeholder="Tax Inv #">
                </div>
                <div class="filter-group">
                    <label class="filter-label">Fab. Inv:</label>
                    <input type="text" class="filter-input" id="fabInvFilter" placeholder="Fabric Inv">
                </div>
                <div class="filter-group">
                    <label class="filter-label">Fab. DN:</label>
                    <input type="text" class="filter-input" id="fabDnFilter" placeholder="Fabric DN">
                </div>
                <div class="filter-group">
                    <label>From:</label>
                    <input type="text" class="filter-input" id="dateFromFilter" placeholder="DD/MM/YY">
                </div>
                <div class="filter-group">
                    <label>To:</label>
                    <input type="text" class="filter-input" id="dateToFilter" placeholder="DD/MM/YY">
                </div>
                <div class="filter-group">
                    <label class="filter-label">Show:</label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="billingStatus" value="unbilled" checked>
                            <span>Unbilled</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="billingStatus" value="billed">
                            <span>Billed</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="billingStatus" value="all">
                            <span>All</span>
                        </label>
                    </div>
                </div>
                <div class="filter-group">
                    <button class="btn btn-secondary" onclick="clearFilters()">Clear Filter</button>
                </div>
            </div>
    </div>

        <!-- Action Buttons -->
        <div class="action-buttons">
            <button class="btn btn-success" onclick="downloadPDF(false)">
                <i class="fas fa-download"></i> Save PDF
            </button>
            <button class="btn btn-warning" onclick="downloadPDF(true)">
                <i class="fas fa-download"></i> Save PDF with Cost
            </button>
            <button class="btn btn-success" onclick="createGroupBillingNote()">
                <i class="fas fa-file-invoice"></i> Group and Create Billing Note
            </button>
            <button class="btn btn-secondary" onclick="refreshPackingListTable()">
            <i class="fas fa-sync-alt"></i> Refresh
        </button>
            <button class="btn btn-warning" onclick="assignTaxInvoice()">
                <i class="fas fa-tag"></i> Apply MSK Tax #
            </button>
            <div style="flex-grow: 1;"></div>
            <span style="color: var(--text-secondary); font-size: 12px; align-self: center;">
                Tip: Use checkboxes to select packing lists, then click 'Save PDF' to download PDFs or 'Group and Create Billing Note' to create billing notes.
            </span>
            <button class="btn btn-danger" onclick="deleteSelectedPackingList()">
                <i class="fas fa-trash"></i> Delete Selected Packing List
        </button>
    </div>

        <!-- Data Table -->
        <div class="data-table-container">
            <table class="data-table" id="packingListTable">
                <thead>
                    <tr>
                        <th style="width: 30px;">
                            <input type="checkbox" id="selectAllCheckbox" onclick="toggleSelectAll()">
                        </th>
                        <th class="sortable-header" data-sort="created_at" style="width: 90px;">Created At</th>
                        <th class="sortable-header" data-sort="packing_list_number" style="width: 130px;">PL #</th>
                        <th class="sortable-header" data-sort="serial_number" style="width: 130px;">Serial #</th>
                        <th class="sortable-header" data-sort="garment" style="width: 90px;">Garment</th>
                        <th class="sortable-header" data-sort="fabric" style="width: 110px;">Fabric</th>
                        <th class="sortable-header" data-sort="color" style="width: 90px;">Color</th>
                        <th class="sortable-header" data-sort="customer" style="width: 130px;">Customer</th>
                        <th class="sortable-header" data-sort="tax_invoice_number" style="width: 110px;">Beta T#</th>
                        <th class="sortable-header" data-sort="msk_invoice_number" style="width: 110px;">MSK T#</th>
                        <th class="sortable-header" data-sort="group_bill_number" style="width: 150px;">Group Bill #</th>
                        <th class="sortable-header" data-sort="fabric_invoice" style="width: 110px;">Fabric Inv.</th>
                        <th class="sortable-header" data-sort="fabric_delivery_note" style="width: 110px;">Fabric DN.</th>
                        <th class="sortable-header" data-sort="fabric_used" style="width: 80px;">Fab Used</th>
                        <th class="sortable-header" data-sort="fabric_cost" style="width: 80px;">Fab Cost</th>
                        <th class="sortable-header" data-sort="fabric_value" style="width: 90px;">Fab Value</th>
                        <th class="sortable-header" data-sort="size_s" style="width: 45px;">S</th>
                        <th class="sortable-header" data-sort="size_m" style="width: 45px;">M</th>
                        <th class="sortable-header" data-sort="size_l" style="width: 45px;">L</th>
                        <th class="sortable-header" data-sort="size_xl" style="width: 45px;">XL</th>
                        <th class="sortable-header" data-sort="size_xxl" style="width: 45px;">2XL</th>
                        <th class="sortable-header" data-sort="size_xxxl" style="width: 45px;">3XL</th>
                        <th class="sortable-header" data-sort="total_qty" style="width: 70px;">Total Qty</th>
                        <th class="sortable-header" data-sort="sewing_cost" style="width: 70px;">Sew Cost</th>
                        <th class="sortable-header" data-sort="sewing_value" style="width: 80px;">Sew Value</th>
                    </tr>
                </thead>
                <tbody id="packingListTableBody">
                    <tr>
                        <td colspan="23" class="loading-state">Loading packing lists...</td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <!-- Pagination Controls -->
        <div class="pagination-controls">
            <div class="pagination-info">
                <span id="paginationInfo">Showing 0 of 0 records</span>
            </div>
            <div class="pagination-buttons">
                <button class="pagination-btn" onclick="goToPage(1)" id="firstPage">First</button>
                <button class="pagination-btn" onclick="goToPage(currentPage - 1)" id="prevPage">Previous</button>
                <div id="pageNumbers" class="page-numbers"></div>
                <button class="pagination-btn" onclick="goToPage(currentPage + 1)" id="nextPage">Next</button>
                <button class="pagination-btn" onclick="goToPage(getTotalPages())" id="lastPage">Last</button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let packingListData = [];
        let filteredPackingListData = []; // Add this to track filtered data
        let selectedPackingListIds = [];
        let currentPage = 1;
        const itemsPerPage = 50;

        function getApiBaseUrl() {
            const hostname = window.location.hostname;
            const port = window.location.port;
            const protocol = window.location.protocol;
            
            console.log('üîç getApiBaseUrl debug:', { hostname, port, protocol });
            
            // Local development - Flask backend runs on port 8000
            if (hostname === 'localhost' || hostname === '127.0.0.1') {
                // If frontend is on port 3000, backend should be on 8000
                if (port === '3000') {
                    return 'http://localhost:8000';
                }
                // If frontend is on port 5000, backend is on 8000
                if (port === '5000') {
                    return 'http://localhost:8000';
                }
                // Default to port 8000 for local development
                return 'http://localhost:8000';
            }
            
            // Railway deployment - force HTTPS
            if (hostname.includes('railway.app') || hostname.includes('up.railway.app')) {
                // Force HTTPS for Railway
                const httpsUrl = `https://${hostname}`;
                console.log('üöÄ Using Railway HTTPS URL:', httpsUrl);
                return httpsUrl;
            }
            
            // Other deployments - use same protocol and domain, but prefer HTTPS
            const origin = window.location.origin;
            if (protocol === 'https:') {
                return origin;
            } else {
                // Force HTTPS for production
                return origin.replace('http://', 'https://');
            }
        }

        // Authentication functions moved to js/common/utils.js

        window.addEventListener('load', async () => {
            console.log('üîÑ Packing Lists page loaded');
            
            // Render navigation bar
            renderNavBar('packing-lists');
            
            // Check authentication first
            if (!checkAuth()) {
                return;
            }
            
            setupFilters();
            await refreshPackingListTable();
            // Default to unbilled and apply filter automatically
            document.querySelector('input[name="billingStatus"][value="unbilled"]').checked = true;
            filterData();
        });

        function setupFilters() {
            // Setup filter event listeners
            document.getElementById('plFilter').addEventListener('input', filterData);
            document.getElementById('serialFilter').addEventListener('input', filterData);
            document.getElementById('fabricFilter').addEventListener('input', filterData);
            document.getElementById('customerFilter').addEventListener('input', filterData);
            document.getElementById('taxInvFilter').addEventListener('input', filterData);
            document.getElementById('fabInvFilter').addEventListener('input', filterData);
            document.getElementById('fabDnFilter').addEventListener('input', filterData);
            document.getElementById('dateFromFilter').addEventListener('input', filterData);
            document.getElementById('dateToFilter').addEventListener('input', filterData);
            
            // Add date input formatting
            const dateFromInput = document.getElementById('dateFromFilter');
            const dateToInput = document.getElementById('dateToFilter');
            
            if (dateFromInput) {
                dateFromInput.addEventListener('input', () => formatDateInput(dateFromInput));
            }
            if (dateToInput) {
                dateToInput.addEventListener('input', () => formatDateInput(dateToInput));
            }
            
            // Radio button listeners
            document.querySelectorAll('input[name="billingStatus"]').forEach(radio => {
                radio.addEventListener('change', filterData);
            });
        }

        // Formatting functions moved to js/common/utils.js

        function clearFilters() {
            document.getElementById('plFilter').value = '';
            document.getElementById('serialFilter').value = '';
            document.getElementById('fabricFilter').value = '';
            document.getElementById('customerFilter').value = '';
            document.getElementById('taxInvFilter').value = '';
            document.getElementById('fabInvFilter').value = '';
            document.getElementById('fabDnFilter').value = '';
            document.getElementById('dateFromFilter').value = '';
            document.getElementById('dateToFilter').value = '';
            document.querySelector('input[name="billingStatus"][value="unbilled"]').checked = true;
            filterData();
        }

        function filterData() {
            const plFilter = document.getElementById('plFilter').value.toLowerCase();
            const serialFilter = document.getElementById('serialFilter').value.toLowerCase();
            const fabricFilter = document.getElementById('fabricFilter').value.toLowerCase();
            const customerFilter = document.getElementById('customerFilter').value.toLowerCase();
            const taxInvFilter = document.getElementById('taxInvFilter').value.toLowerCase();
            const fabInvFilter = document.getElementById('fabInvFilter').value.toLowerCase();
            const fabDnFilter = document.getElementById('fabDnFilter').value.toLowerCase();
            const dateFrom = document.getElementById('dateFromFilter').value;
            const dateTo = document.getElementById('dateToFilter').value;
            const billingStatus = document.querySelector('input[name="billingStatus"]:checked').value;

            filteredPackingListData = packingListData.filter(packingList => {
                // PL Serial filter
                if (plFilter && !packingList.packing_list_serial.toLowerCase().includes(plFilter)) {
                    return false;
                }

                // Customer filter
                if (customerFilter && !packingList.customer_name.toLowerCase().includes(customerFilter)) {
                    return false;
                }

                // Date range filter
                if (dateFrom || dateTo) {
                    const createdDate = new Date(packingList.created_at);
                    if (dateFrom && !isDateInRange(createdDate, dateFrom, 'from')) {
                        return false;
                    }
                    if (dateTo && !isDateInRange(createdDate, dateTo, 'to')) {
                        return false;
                    }
                }

                // Check if any lines match the other filters
                const hasMatchingLines = packingList.lines && packingList.lines.some(line => {
                    // Serial filter
                    if (serialFilter && !line.stitching_invoice_number.toLowerCase().includes(serialFilter)) {
                        return false;
                    }

                    // Fabric filter
                    if (fabricFilter && !line.fabric_name.toLowerCase().includes(fabricFilter)) {
                        return false;
                    }

                    // Tax invoice filter
                    if (taxInvFilter && !(line.tax_invoice_number || '').toLowerCase().includes(taxInvFilter)) {
                        return false;
                    }

                    // Fabric invoice filter
                    if (fabInvFilter && !(line.fabric_invoice_number || '').toLowerCase().includes(fabInvFilter)) {
                        return false;
                    }

                    // Fabric DN filter
                    if (fabDnFilter && !(line.delivery_note || '').toLowerCase().includes(fabDnFilter)) {
                        return false;
                    }

                    return true;
                });

                if (!hasMatchingLines) {
                    return false;
                }

                // Billing status filter
                if (billingStatus !== 'all') {
                    console.log('üîç Checking billing status for PL:', packingList.packing_list_serial, 'Status:', billingStatus);
                    console.log('üìã Lines data:', packingList.lines);
                    
                    const hasBilledRecords = packingList.lines && packingList.lines.some(line => {
                        console.log('üîç Line billing_group_id:', line.billing_group_id, 'Type:', typeof line.billing_group_id);
                        return line.billing_group_id !== null && line.billing_group_id !== undefined;
                    });
                    
                    console.log('üîç Has billed records:', hasBilledRecords);
                    
                    if (billingStatus === 'billed' && !hasBilledRecords) {
                        console.log('‚ùå Filtering out - billed status but no billed records');
                        return false;
                    }
                    if (billingStatus === 'unbilled' && hasBilledRecords) {
                        console.log('‚ùå Filtering out - unbilled status but has billed records');
                        return false;
                    }
                }

                return true;
            });

            currentPage = 1; // Reset to first page when filtering
            populatePackingListTable(filteredPackingListData);
        }

        function isDateInRange(date, filterDate, type) {
            if (!filterDate || filterDate.length !== 8 || filterDate.split('/').length !== 3) {
                return true;
            }

            try {
                const [day, month, year] = filterDate.split('/');
                const fullYear = year.length === 2 ? (parseInt(year) < 50 ? '20' + year : '19' + year) : year;
                const filterDateObj = new Date(`${fullYear}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`);
                
                if (type === 'from') {
                    return date >= filterDateObj;
                } else {
                    return date <= filterDateObj;
                }
            } catch (error) {
                return true;
            }
        }

        async function refreshPackingListTable() {
            try {
                const tableBody = document.getElementById('packingListTableBody');
                if (!tableBody) {
                    console.error('‚ùå Could not find packing table body');
                    return;
                }
                
                tableBody.innerHTML = '<tr><td colspan="23" class="loading-state">Loading packing lists...</td></tr>';
                
                const apiUrl = getApiBaseUrl();
                const requestUrl = `${apiUrl}/api/packing-lists?_t=${Date.now()}`;
                console.log('üîç API URL debug:', { apiUrl, requestUrl, windowLocation: window.location.href });
                console.log('üåê Fetching', requestUrl);
                
                const response = await fetch(requestUrl, {
                    method: 'GET',
                    headers: {
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    }
                });
                console.log('üì° Response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('‚ùå Failed to load packing data, status:', response.status);
                    tableBody.innerHTML = `<tr><td colspan="23" class="error-state">Failed to load packing lists: ${errorText}</td></tr>`;
                    return;
                }
                
                const data = await response.json();
                console.log('üìä Received packing list data:', data.length, 'records');
                
                packingListData = data;
                filteredPackingListData = data; // Initialize filtered data with all data
                currentPage = 1; // Reset to first page when new data is loaded
                populatePackingListTable(data);
                console.log('‚úÖ Packing list data loaded successfully');
                
            } catch (error) {
                console.error('‚ùå Error loading packing list data:', error);
                const tableBody = document.getElementById('packingListTableBody');
                if (tableBody) {
                    tableBody.innerHTML = `<tr><td colspan="23" class="error-state">Error loading packing lists: ${error.message}</td></tr>`;
                }
            }
        }

        function populatePackingListTable(data) {
            const tableBody = document.getElementById('packingListTableBody');
            if (!tableBody) {
                console.error('‚ùå Could not find table body for population');
                return;
            }
            
            if (data.length === 0) {
                console.log('üì≠ No packing lists found');
                tableBody.innerHTML = '<tr><td colspan="24" class="loading-state">No packing lists found.</td></tr>';
                updatePaginationControls();
                return;
            }
            
            // Calculate pagination
            const totalPages = Math.ceil(data.length / itemsPerPage);
            if (currentPage > totalPages && totalPages > 0) {
                currentPage = totalPages;
            }
            
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, data.length);
            const pageData = data.slice(startIndex, endIndex);
            
            console.log('üìã Populating table with', pageData.length, 'packing lists (page', currentPage, 'of', totalPages, ')');
            let html = '';
            
            pageData.forEach((packingList, pageIndex) => {
                const actualIndex = startIndex + pageIndex;
                console.log('üì¶ Processing packing list', actualIndex + 1, ':', packingList.packing_list_serial);
                
                // Create parent row (packing list summary)
                html += `
                    <tr class="parent-row" data-packing-list-id="${packingList.id}">
                        <td class="checkbox-wrapper">
                            <input type="checkbox" class="packing-list-checkbox" data-packing-list-id="${packingList.id}" onclick="togglePackingListSelection(${packingList.id})">
                        </td>
                        <td>${formatDate(packingList.delivery_date || packingList.created_at)}</td>
                        <td onclick="toggleExpansion(${packingList.id})">
                            <span class="expand-indicator">‚ñ∂</span> ${packingList.packing_list_serial || ''}
                        </td>
                        <td>Summary (${packingList.total_records || 0} records)</td>
                        <td>Total Items: ${packingList.total_items || 0}</td>
                        <td></td>
                        <td></td>
                        <td>${packingList.customer_name || ''}</td>
                        <td>${packingList.beta_tax_invoice_number || ''}</td>
                        <td>${packingList.tax_invoice_number || ''}</td>
                        <td>${packingList.group_bill_number || ''}</td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td>${formatInteger(packingList.total_items || 0)}</td>
                        <td></td>
                        <td></td>
                    </tr>
                `;
                
                // Add child rows (stitching records)
                if (packingList.lines && packingList.lines.length > 0) {
                    console.log('üìÑ Adding', packingList.lines.length, 'child rows for', packingList.packing_list_serial);
                    packingList.lines.forEach(line => {
                        let sizeQty = {};
                        if (line.size_qty_json) {
                            try {
                                // Parse the JSON string from the database
                                sizeQty = JSON.parse(line.size_qty_json.replace(/'/g, '"'));
                            } catch (e) {
                                console.error('Error parsing size_qty_json:', e, line.size_qty_json);
                                sizeQty = {};
                            }
                        }
                        const totalQty = Object.values(sizeQty).reduce((sum, qty) => sum + (parseInt(qty) || 0), 0);
                        
                        // Calculate fabric values
                        const fabricUnitPrice = parseFloat(line.fabric_unit_price || 0);
                        const yardsConsumed = parseFloat(line.yards_consumed || 0);
                        const fabricCost = fabricUnitPrice;
                        const fabricValue = fabricUnitPrice * yardsConsumed;
                        
                        // Calculate VAT-inclusive price
                        const basePrice = parseFloat(line.price || 0);
                        const addVat = line.add_vat || false;
                        const vatInclusivePrice = addVat ? basePrice * 1.07 : basePrice;
                        
                        html += `
                            <tr class="child-row" data-packing-list-id="${packingList.id}" data-stitching-id="${line.stitching_invoice_id}">
                                <td></td>
                                <td>${formatDate(line.created_at)}</td>
                                <td>${packingList.packing_list_serial || ''}</td>
                                <td>${line.stitching_invoice_number || ''}</td>
                                <td>${line.stitched_item || ''}</td>
                                <td>${line.fabric_name || ''}</td>
                                <td>${line.color || ''}</td>
                                <td>${packingList.customer_name || ''}</td>
                                <td>${line.beta_tax_invoice_number || ''}</td>
                                <td>${line.tax_invoice_number || ''}</td>
                                <td>${line.group_bill_number || ''}</td>
                                <td>${line.fabric_invoice_number || ''}</td>
                                <td>${line.delivery_note || ''}</td>
                                <td>${formatNumber(yardsConsumed)}</td>
                                <td>${formatNumber(fabricCost)}</td>
                                <td>${formatNumber(fabricValue)}</td>
                                <td>${formatInteger(sizeQty.S || 0)}</td>
                                <td>${formatInteger(sizeQty.M || 0)}</td>
                                <td>${formatInteger(sizeQty.L || 0)}</td>
                                <td>${formatInteger(sizeQty.XL || 0)}</td>
                                <td>${formatInteger(sizeQty.XXL || 0)}</td>
                                <td>${formatInteger(sizeQty.XXXL || 0)}</td>
                                <td>${formatInteger(totalQty)}</td>
                                <td>${formatNumber(vatInclusivePrice)}</td>
                                <td>${formatNumber(line.total_value || 0)}</td>
                            </tr>
                        `;
                        
                        // Add secondary fabric rows if they exist
                        if (line.garment_fabrics && line.garment_fabrics.length > 0) {
                            line.garment_fabrics.forEach(fabric => {
                                const fabricValue = parseFloat(fabric.total_fabric_cost || 0);
                                html += `
                                    <tr class="secondary-fabric-row" data-packing-list-id="${packingList.id}" data-stitching-id="${line.stitching_invoice_id}">
                                        <td></td>
                                        <td>${formatDate(line.created_at)}</td>
                                        <td>${packingList.packing_list_serial || ''}</td>
                                        <td>${line.stitching_invoice_number || ''}</td>
                                        <td>${line.stitched_item || ''}</td>
                                        <td style="padding-left: 20px; color: var(--text-secondary);">‚Ü≥ ${fabric.lining_name || fabric.fabric_name || ''}</td>
                                        <td>${fabric.color || ''}</td>
                                        <td>${packingList.customer_name || ''}</td>
                                        <td>${fabric.beta_tax_invoice_number || ''}</td>
                                        <td>${fabric.tax_invoice_number || ''}</td>
                                        <td>${line.group_bill_number || ''}</td>
                                        <td>${fabric.fabric_invoice_number || ''}</td>
                                        <td>${fabric.delivery_note || ''}</td>
                                        <td>${formatNumber(parseFloat(fabric.consumption_yards || 0))}</td>
                                        <td>${formatNumber(parseFloat(fabric.unit_price || 0))}</td>
                                        <td>${formatNumber(fabricValue)}</td>
                                        <td colspan="6"></td>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                    </tr>
                                `;
                            });
                        }
                        
                        // Add lining fabric rows if they exist
                        if (line.lining_fabrics && line.lining_fabrics.length > 0) {
                            line.lining_fabrics.forEach(lining => {
                                const liningValue = parseFloat(lining.total_cost || 0);
                                html += `
                                    <tr class="lining-fabric-row" data-packing-list-id="${packingList.id}" data-stitching-id="${line.stitching_invoice_id}">
                                        <td></td>
                                        <td>${formatDate(line.created_at)}</td>
                                        <td>${packingList.packing_list_serial || ''}</td>
                                        <td>${line.stitching_invoice_number || ''}</td>
                                        <td>${line.stitched_item || ''}</td>
                                        <td style="padding-left: 20px; color: var(--text-secondary);">‚Ü≥ Lining: ${lining.lining_name || ''}</td>
                                        <td>${lining.color || ''}</td>
                                        <td>${packingList.customer_name || ''}</td>
                                        <td></td>
                                        <td></td>
                                        <td>${line.group_bill_number || ''}</td>
                                        <td></td>
                                        <td></td>
                                        <td>${formatNumber(parseFloat(lining.consumption_yards || 0))}</td>
                                        <td>${formatNumber(parseFloat(lining.unit_price || 0))}</td>
                                        <td>${formatNumber(liningValue)}</td>
                                        <td colspan="6"></td>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                    </tr>
                                `;
                            });
                        }
                    });
                }
            });
            
            tableBody.innerHTML = html;
            updatePaginationControls();
            console.log('‚úÖ Table population completed');
        }

        function toggleExpansion(packingListId) {
            const childRows = document.querySelectorAll(`tr[data-packing-list-id="${packingListId}"].child-row`);
            const secondaryFabricRows = document.querySelectorAll(`tr[data-packing-list-id="${packingListId}"].secondary-fabric-row`);
            const liningFabricRows = document.querySelectorAll(`tr[data-packing-list-id="${packingListId}"].lining-fabric-row`);
            const parentRow = document.querySelector(`tr[data-packing-list-id="${packingListId}"].parent-row`);
            const expandIndicator = parentRow.querySelector('.expand-indicator');
            
            const allDetailRows = [...childRows, ...secondaryFabricRows, ...liningFabricRows];
            const isExpanded = allDetailRows[0] && allDetailRows[0].classList.contains('expanded');
            
            allDetailRows.forEach(row => {
                if (isExpanded) {
                    row.classList.remove('expanded');
                } else {
                    row.classList.add('expanded');
                }
            });
            
            // Update expand indicator
            if (isExpanded) {
                expandIndicator.textContent = '‚ñ∂';
            } else {
                expandIndicator.textContent = '‚ñº';
            }
        }

        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            const isChecked = selectAllCheckbox.checked;
            
            // Select/deselect all packing list checkboxes
            document.querySelectorAll('.packing-list-checkbox').forEach(checkbox => {
                checkbox.checked = isChecked;
            });
        }

        function togglePackingListSelection(packingListId) {
            console.log('üîÑ togglePackingListSelection called with packingListId:', packingListId);
            const checkbox = document.querySelector(`input[data-packing-list-id="${packingListId}"].packing-list-checkbox`);
            const isChecked = checkbox.checked;
            console.log('üìã Checkbox checked state:', isChecked);
            
            updateSelectAllCheckbox();
        }

        function updateSelectAllCheckbox() {
            const allCheckboxes = document.querySelectorAll('.packing-list-checkbox');
            const allChecked = Array.from(allCheckboxes).every(cb => cb.checked);
            const anyChecked = Array.from(allCheckboxes).some(cb => cb.checked);
            
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            selectAllCheckbox.checked = allChecked;
            selectAllCheckbox.indeterminate = anyChecked && !allChecked;
        }

        function getSelectedPackingListIds() {
            const selectedCheckboxes = document.querySelectorAll('.packing-list-checkbox:checked');
            const ids = Array.from(selectedCheckboxes).map(cb => cb.getAttribute('data-packing-list-id'));
            console.log('üîç getSelectedPackingListIds found:', ids.length, 'selected checkboxes');
            console.log('üìã Selected IDs:', ids);
            return ids;
        }

        // Formatting functions moved to js/common/utils.js

        function downloadPDF(showCost = false) {
            const selectedPackingListIds = getSelectedPackingListIds();
            if (selectedPackingListIds.length === 0) {
                alert('Select a packing list to download its PDF.');
                return;
            }

            if (selectedPackingListIds.length > 1) {
                alert('Please select only one packing list to download PDF.');
                return;
            }

            const packingListId = selectedPackingListIds[0];
            const costParam = showCost ? '?show_cost=true' : '';
            const url = `${getApiBaseUrl()}/api/packing-lists/${packingListId}/pdf${costParam}`;
            window.open(url, '_blank');
        }

        function createGroupBillingNote() {
            console.log('üîÑ createGroupBillingNote called');
            const selectedPackingListIds = getSelectedPackingListIds();
            console.log('üìã Selected packing list IDs:', selectedPackingListIds);
            
            if (selectedPackingListIds.length === 0) {
                alert('Please select one or more packing lists to create a group billing note.');
                return;
            }
            
            // Show group bill creation dialog
            showGroupBillDialog(selectedPackingListIds);
        }

        function showGroupBillDialog(packingListIds) {
            console.log('üîÑ showGroupBillDialog called with packingListIds:', packingListIds);
            
            // Create modal dialog
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.style.position = 'fixed';
            modal.style.zIndex = '1000';
            modal.style.left = '0';
            modal.style.top = '0';
            modal.style.width = '100%';
            modal.style.height = '100%';
            modal.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
            
            modal.innerHTML = `
                <div style="background: var(--card-bg); margin: 5% auto; padding: 20px; border-radius: 8px; width: 80%; max-width: 500px; color: var(--text-primary); border: 1px solid var(--border-color);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid var(--border-color);">
                        <h2 style="font-size: 18px; font-weight: 600; color: var(--focus-color);">Create Group Billing Note</h2>
                        <span style="color: var(--text-secondary); font-size: 28px; font-weight: bold; cursor: pointer;" onclick="this.closest('.modal').remove()">&times;</span>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500; color: var(--text-secondary);">Invoice Date:</label>
                            <input type="text" id="invoiceDate" placeholder="DD/MM/YY" style="width: 100%; padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-tertiary); color: var(--text-primary); font-size: 12px;" required>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500; color: var(--text-secondary);">Stitching Invoice Comments (optional):</label>
                            <textarea id="stitchingComments" placeholder="Enter comments for the stitching invoice..." style="width: 100%; padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-tertiary); color: var(--text-primary); font-size: 12px; resize: vertical; min-height: 80px;"></textarea>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500; color: var(--text-secondary);">Fabric Invoice Comments (optional):</label>
                            <textarea id="fabricComments" placeholder="Enter comments for the fabric invoice..." style="width: 100%; padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-tertiary); color: var(--text-primary); font-size: 12px; resize: vertical; min-height: 80px;"></textarea>
                        </div>
                        
                        <div style="display: flex; align-items: center; gap: 8px; margin-top: 10px;">
                            <input type="checkbox" id="applyWithholdingTax" checked style="width: auto; margin: 0;">
                            <label for="applyWithholdingTax" style="color: var(--text-secondary);">Apply Withholding Tax (3%)</label>
                        </div>
                    </div>
                    
                    <div style="display: flex; justify-content: flex-end; gap: 10px; padding-top: 15px; border-top: 1px solid var(--border-color);">
                        <button id="cancelBtn" style="padding: 8px 16px; background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 4px; cursor: pointer; font-size: 12px;">Cancel</button>
                        <button id="createBtn" style="padding: 8px 16px; background: var(--focus-color); color: var(--text-primary); border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">Create Group Bill</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Set default date to today in DD/MM/YY format
            const today = new Date();
            const day = String(today.getDate()).padStart(2, '0');
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const year = String(today.getFullYear()).slice(-2);
            document.getElementById('invoiceDate').value = `${day}/${month}/${year}`;
            
            // Add date formatting to the invoice date input
            const invoiceDateInput = document.getElementById('invoiceDate');
            if (invoiceDateInput) {
                invoiceDateInput.addEventListener('input', () => formatDateInput(invoiceDateInput));
            }
            
            // Add event listeners to buttons
            const cancelBtn = document.getElementById('cancelBtn');
            const createBtn = document.getElementById('createBtn');
            
            if (cancelBtn) {
                cancelBtn.addEventListener('click', () => {
                    modal.remove();
                });
            }
            
            if (createBtn) {
                createBtn.addEventListener('click', () => {
                    console.log('üîÑ Create Group Bill button clicked');
                    submitGroupBill(packingListIds);
                });
            }
        }

        async function submitGroupBill(packingListIds) {
            console.log('üîÑ submitGroupBill called with packingListIds:', packingListIds);
            console.log('üîÑ submitGroupBill type:', typeof packingListIds);
            console.log('üîÑ submitGroupBill length:', packingListIds ? packingListIds.length : 'undefined');
            
            const invoiceDateInput = document.getElementById('invoiceDate').value;
            const stitchingComments = document.getElementById('stitchingComments').value;
            const fabricComments = document.getElementById('fabricComments').value;
            const applyWithholdingTax = document.getElementById('applyWithholdingTax').checked;
            
            console.log('üìã Form data:', {
                invoiceDateInput,
                stitchingComments,
                fabricComments,
                applyWithholdingTax
            });
            
            if (!invoiceDateInput) {
                alert('Please enter an invoice date.');
                return;
            }
            
            // Convert DD/MM/YY to YYYY-MM-DD
            let invoiceDate;
            try {
                const parts = invoiceDateInput.split('/');
                if (parts.length === 3) {
                    const day = parts[0];
                    const month = parts[1];
                    const year = '20' + parts[2]; // Assume 20xx for YY format
                    invoiceDate = `${year}-${month}-${day}`;
                } else {
                    throw new Error('Invalid date format');
                }
            } catch (error) {
                alert('Please enter a valid date in DD/MM/YY format.');
                return;
            }
            
            try {
                const requestData = {
                    packing_list_ids: packingListIds,
                    invoice_date: invoiceDate,
                    stitching_comments: stitchingComments,
                    fabric_comments: fabricComments,
                    apply_withholding_tax: applyWithholdingTax
                };
                
                const apiUrl = `${getApiBaseUrl()}/api/group-bills/create`;
                console.log('üåê Sending request to:', apiUrl);
                console.log('üì§ Request data:', requestData);
                console.log('üì§ Request data JSON:', JSON.stringify(requestData));
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });
                
                console.log('üì° Response status:', response.status);
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('‚úÖ Success response:', result);
                    alert(`Group bill ${result.group_bill.group_number} created successfully!`);
                    
                    // Close modal
                    document.querySelector('.modal').remove();
                    
                    // Refresh the packing list table
                    refreshPackingListTable();
                } else {
                    const errorText = await response.text();
                    console.error('‚ùå Error response:', errorText);
                    let errorMessage = 'Unknown error';
                    try {
                        const error = JSON.parse(errorText);
                        errorMessage = error.error || errorMessage;
                    } catch (e) {
                        errorMessage = errorText;
                    }
                    alert(`Failed to create group bill: ${errorMessage}`);
                }
            } catch (error) {
                console.error('‚ùå Error creating group bill:', error);
                alert('Error creating group bill: ' + error.message);
            }
        }

        function assignTaxInvoice() {
            const selectedPackingListIds = getSelectedPackingListIds();
            if (selectedPackingListIds.length === 0) {
                alert('Please select one or more packing lists to assign a Tax Invoice Number.');
                return;
            }

            // Prompt for Tax Invoice Number
            const taxInvoiceNumber = prompt('Enter Tax Invoice Number:');
            if (taxInvoiceNumber === null) {
                return; // User cancelled
            }

            const taxInv = taxInvoiceNumber.trim();
            if (taxInv === '') {
                alert('Please enter a valid Tax Invoice Number.');
                return;
            }

            // Update in database
            const updateData = {
                packing_list_ids: selectedPackingListIds,
                tax_invoice_number: taxInv === '0' ? null : taxInv
            };

            fetch(`${getApiBaseUrl()}/api/packing-lists/assign-tax-invoice`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(updateData)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    alert(`${taxInv === '0' ? 'Removed' : 'Assigned'} Tax Invoice # for ${selectedPackingListIds.length} packing list(s).`);
                    refreshPackingListTable();
                } else {
                    alert('Error: ' + (result.error || 'Unknown error'));
                }
            })
            .catch(error => {
                alert('Error assigning Tax Invoice #: ' + error.message);
            });
        }

        function deleteSelectedPackingList() {
            const selectedPackingListIds = getSelectedPackingListIds();
            if (selectedPackingListIds.length === 0) {
                alert('Please select a packing list to delete.');
                return;
            }

            if (selectedPackingListIds.length > 1) {
                alert('Please select only one packing list to delete.');
                return;
            }

            const packingListId = selectedPackingListIds[0];
            const packingList = packingListData.find(pl => pl.id == packingListId);
            const confirmMessage = `Are you sure you want to delete packing list ${packingList ? packingList.packing_list_serial : packingListId}?`;
            
            if (confirm(confirmMessage)) {
                fetch(`${getApiBaseUrl()}/api/packing-lists/${packingListId}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(result => {
                    if (result.message) {
                        alert(result.message);
                        refreshPackingListTable();
                    } else {
                        alert('Error: ' + (result.error || 'Unknown error'));
                    }
                })
                .catch(error => {
                    alert('Error deleting packing list: ' + error.message);
                });
            }
        }

        // Authentication functions moved to js/common/utils.js

        // Theme Management
        // Theme functions moved to js/common/utils.js

        // Pagination Functions
        function getTotalPages() {
            return Math.ceil(filteredPackingListData.length / itemsPerPage);
        }

        function goToPage(page) {
            const totalPages = getTotalPages();
            if (page < 1 || page > totalPages) {
                return;
            }
            currentPage = page;
            populatePackingListTable(filteredPackingListData);
        }

        function updatePaginationControls() {
            const totalPages = getTotalPages();
            const startRecord = (currentPage - 1) * itemsPerPage + 1;
            const endRecord = Math.min(currentPage * itemsPerPage, filteredPackingListData.length);
            
            // Update pagination info
            const paginationInfo = document.getElementById('paginationInfo');
            if (paginationInfo) {
                paginationInfo.textContent = `Showing ${startRecord} to ${endRecord} of ${filteredPackingListData.length} records`;
            }
            
            // Update button states
            const firstPageBtn = document.getElementById('firstPage');
            const prevPageBtn = document.getElementById('prevPage');
            const nextPageBtn = document.getElementById('nextPage');
            const lastPageBtn = document.getElementById('lastPage');
            
            if (firstPageBtn) firstPageBtn.disabled = currentPage === 1;
            if (prevPageBtn) prevPageBtn.disabled = currentPage === 1;
            if (nextPageBtn) nextPageBtn.disabled = currentPage === totalPages;
            if (lastPageBtn) lastPageBtn.disabled = currentPage === totalPages;
            
            // Update page numbers
            const pageNumbersContainer = document.getElementById('pageNumbers');
            if (pageNumbersContainer) {
                pageNumbersContainer.innerHTML = '';
                
                const maxVisiblePages = 5;
                let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
                let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
                
                if (endPage - startPage + 1 < maxVisiblePages) {
                    startPage = Math.max(1, endPage - maxVisiblePages + 1);
                }
                
                for (let i = startPage; i <= endPage; i++) {
                    const pageBtn = document.createElement('button');
                    pageBtn.className = `pagination-btn ${i === currentPage ? 'active' : ''}`;
                    pageBtn.textContent = i;
                    pageBtn.onclick = () => goToPage(i);
                    pageNumbersContainer.appendChild(pageBtn);
                }
            }
        }

        // ===== TABLE SORTING FUNCTIONALITY =====
        
        // Initialize table sorter
        let tableSorter = null;

        // Custom data getter for packing list data
        function getPackingListValueForSorting(item, column) {
            switch (column) {
                case 'created_at':
                    return item.created_at;
                case 'packing_list_number':
                    return item.packing_list_number;
                case 'serial_number':
                    return item.serial_number;
                case 'garment':
                    return item.garment;
                case 'fabric':
                    return item.fabric;
                case 'color':
                    return item.color;
                case 'customer':
                    return item.customer;
                case 'tax_invoice_number':
                    return item.tax_invoice_number;
                case 'msk_invoice_number':
                    return item.msk_invoice_number;
                case 'group_bill_number':
                    return item.group_bill_number;
                case 'fabric_invoice':
                    return item.fabric_invoice;
                case 'fabric_delivery_note':
                    return item.fabric_delivery_note;
                case 'fabric_used':
                    return item.fabric_used;
                case 'fabric_cost':
                    return item.fabric_cost;
                case 'fabric_value':
                    return item.fabric_value;
                case 'size_s':
                    return item.size_s;
                case 'size_m':
                    return item.size_m;
                case 'size_l':
                    return item.size_l;
                case 'size_xl':
                    return item.size_xl;
                case 'size_xxl':
                    return item.size_xxl;
                case 'size_xxxl':
                    return item.size_xxxl;
                case 'total_qty':
                    return item.total_qty;
                case 'sewing_cost':
                    return item.sewing_cost;
                case 'sewing_value':
                    return item.sewing_value;
                default:
                    return '';
            }
        }

        // Initialize table sorter when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Load theme immediately to prevent flashing
            loadTheme();
            
            // Initialize table sorter
            tableSorter = createTableSorter('packingListTable', {
                dataGetter: getPackingListValueForSorting
            });
            
            // Listen for sort events
            document.getElementById('packingListTable').addEventListener('tableSorted', function(event) {
                const { data } = event.detail;
                packingListData = data;
                populatePackingListTable(packingListData);
            });
            
            console.log('‚úÖ Packing list table sorter initialized and ready');
        });

        // Override the refreshPackingListTable function to update table sorter
        const originalRefreshPackingListTable = refreshPackingListTable;
        refreshPackingListTable = async function() {
            await originalRefreshPackingListTable();
            
            // Initialize table sorter if not already done
            if (!tableSorter) {
                tableSorter = createTableSorter('packingListTable', {
                    dataGetter: getPackingListValueForSorting
                });
                
                // Listen for sort events
                document.getElementById('packingListTable').addEventListener('tableSorted', function(event) {
                    const { data } = event.detail;
                    packingListData = data;
                    populatePackingListTable(packingListData);
                });
                
                console.log('‚úÖ Packing list table sorter initialized after data load');
            }
            
            // Update table sorter with new data
            if (tableSorter && packingListData && packingListData.length > 0) {
                tableSorter.setData(packingListData, getPackingListValueForSorting);
                console.log(`üíæ Updated packing list table sorter with ${packingListData.length} records`);
            } else {
                console.log('‚ö†Ô∏è No packing list data available for table sorter');
            }
        }
    </script>
</body>
</html>