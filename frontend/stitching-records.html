<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stitching Records - Garment Management System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #212121;
            color: #eceff1;
            font-size: 13px;
        }

        /* Navigation Bar */
        .nav-bar {
            background: #23272f;
            border-bottom: 1px solid #3949ab;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            height: 60px;
            display: flex;
            align-items: center;
            padding: 0 20px;
        }

        .nav-tabs {
            display: flex;
            list-style: none;
            gap: 0;
        }

        .nav-tab {
            background: transparent;
            border: none;
            color: #eceff1;
            padding: 15px 25px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            text-decoration: none;
            display: inline-block;
        }

        .nav-tab:hover {
            background-color: #3949ab;
            color: #ffffff;
        }

        .nav-tab.active {
            background-color: #3949ab;
            color: #ffffff;
            border-bottom-color: #5c6bc0;
        }

        .nav-user {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .nav-user span {
            color: #b0bec5;
            font-size: 12px;
        }

        .logout-btn {
            background: #d32f2f;
            color: #ffffff;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: #f44336;
        }

        /* Main Content */
        .main-content {
            margin-top: 60px;
            padding: 20px;
            min-height: calc(100vh - 60px);
        }



        /* Filter Controls */
        .filter-controls {
            background: #2c2c2c;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .filter-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-group label {
            font-size: 12px;
            color: #b0bec5;
            font-weight: 500;
        }

        .filter-input {
            background: #424242;
            border: 1px solid #555;
            color: #eceff1;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 14px;
            min-width: 120px;
        }

        .filter-input:focus {
            outline: none;
            border-color: #5c6bc0;
        }

        .filter-select {
            background: #424242;
            border: 1px solid #555;
            color: #eceff1;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 14px;
            min-width: 120px;
        }

        .filter-select:focus {
            outline: none;
            border-color: #5c6bc0;
        }

        .radio-group {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .radio-group input[type="radio"] {
            margin-right: 5px;
        }

        .radio-group label {
            color: #b0bec5;
            font-size: 12px;
            cursor: pointer;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: #3949ab;
            color: #fff;
        }

        .btn-primary:hover {
            background: #5c6bc0;
        }

        .btn-secondary {
            background: #757575;
            color: #fff;
        }

        .btn-secondary:hover {
            background: #9e9e9e;
        }

        .btn-success {
            background: #388e3c;
            color: #fff;
        }

        .btn-success:hover {
            background: #4caf50;
        }

        .btn-warning {
            background: #f57c00;
            color: #fff;
        }

        .btn-warning:hover {
            background: #ff9800;
        }

        .btn-danger {
            background: #d32f2f;
            color: #fff;
        }

        .btn-danger:hover {
            background: #f44336;
        }

        .btn-info {
            background: #1976d2;
            color: #fff;
        }

        .btn-info:hover {
            background: #2196f3;
        }

        /* Table Styles */
        .table-container {
            background: #2c2c2c;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        .data-table th {
            background: #3949ab;
            color: #eceff1;
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .data-table td {
            padding: 10px 8px;
            border-bottom: 1px solid #444;
        }

        .data-table tr:hover {
            background: #3c3c3c;
        }

        .data-table tr.selected {
            background: #5c6bc0 !important;
            color: #ffffff;
        }

        /* Pagination Styles */
        .table-container {
            max-height: 500px;
            overflow-y: auto;
            background: #2c2c2c;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .table-container::-webkit-scrollbar {
            width: 8px;
        }

        .table-container::-webkit-scrollbar-track {
            background: #424242;
            border-radius: 4px;
        }

        .table-container::-webkit-scrollbar-thumb {
            background: #5c6bc0;
            border-radius: 4px;
        }

        .table-container::-webkit-scrollbar-thumb:hover {
            background: #3949ab;
        }

        .pagination-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #2c2c2c;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .pagination-info {
            color: #b0bec5;
            font-size: 14px;
        }

        .pagination-buttons {
            display: flex;
            gap: 10px;
        }

        .pagination-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            background: #424242;
            color: #eceff1;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .pagination-btn:hover:not(:disabled) {
            background: #5c6bc0;
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination-btn.active {
            background: #5c6bc0;
            color: #fff;
        }

        /* Checkbox styling */
        .checkbox-wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .checkbox-wrapper input[type="checkbox"] {
            margin: 0;
            cursor: pointer;
            width: 16px;
            height: 16px;
            accent-color: #5c6bc0;
        }

        /* Make it clear that rows are not clickable */
        .data-table tr {
            cursor: default;
        }

        .data-table tr:hover {
            background: #424242 !important;
        }

        .data-table tr:hover td {
            background: #424242 !important;
        }

        /* Status badges */
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            text-transform: uppercase;
        }

        .status-billed {
            background: #4caf50;
            color: #ffffff;
        }

        .status-unbilled {
            background: #ff9800;
            color: #ffffff;
        }

        /* Image preview */
        .image-preview {
            width: 40px;
            height: 40px;
            border-radius: 4px;
            object-fit: cover;
            cursor: pointer;
            border: 1px solid #555;
        }

        .image-preview:hover {
            transform: scale(1.1);
            transition: transform 0.2s ease;
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
        }

        .modal-content {
            background-color: #2c2c2c;
            margin: 5% auto;
            padding: 20px;
            border-radius: 8px;
            width: 80%;
            max-width: 800px;
            max-height: 80%;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #555;
        }

        .modal-title {
            color: #5c6bc0;
            font-size: 20px;
            font-weight: 600;
        }

        .close {
            color: #888;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #eceff1;
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            padding-top: 15px;
            border-top: 1px solid #555;
        }

        /* Detail sections */
        .detail-section {
            margin-bottom: 20px;
        }

        .detail-section h3 {
            color: #5c6bc0;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .detail-item {
            background: #424242;
            padding: 10px;
            border-radius: 4px;
        }

        .detail-label {
            color: #b0bec5;
            font-size: 12px;
            margin-bottom: 5px;
        }

        .detail-value {
            color: #eceff1;
            font-weight: 500;
        }

        /* Size quantities */
        .size-quantities {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .size-item {
            background: #424242;
            padding: 8px;
            border-radius: 4px;
            text-align: center;
        }

        .size-label {
            color: #b0bec5;
            font-size: 11px;
            margin-bottom: 5px;
        }

        .size-value {
            color: #eceff1;
            font-weight: bold;
            font-size: 14px;
        }

        /* Treeview Styles */
        .treeview-container {
            background: #2c2c2c;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .treeview-header {
            overflow-x: auto;
        }

        .treeview-table {
            width: 100%;
            border-collapse: collapse;
            background: #2c2c2c;
            font-size: 12px;
        }

        .treeview-table th {
            background: #555;
            color: #eceff1;
            padding: 8px 4px;
            text-align: left;
            border-bottom: 1px solid #666;
            font-weight: 600;
            white-space: nowrap;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .treeview-table td {
            padding: 6px 4px;
            border-bottom: 1px solid #444;
            color: #eceff1;
            white-space: nowrap;
        }

        .treeview-table tbody tr:hover {
            background: #424242;
        }

        .treeview-table tbody tr.selected {
            background: #3949ab;
        }

        /* Parent row styling */
        .treeview-parent {
            background: #3c3c3c;
            font-weight: 500;
        }

        .treeview-parent:hover {
            background: #4a4a4a;
        }

        /* Child row styling */
        .treeview-child {
            background: #2a2a2a;
            font-size: 11px;
        }

        .treeview-child:hover {
            background: #353535;
        }

        .treeview-child td {
            padding-left: 20px;
            color: #b0bec5;
        }

        /* Expand/collapse indicator */
        .expand-indicator {
            cursor: pointer;
            color: #5c6bc0;
            font-weight: bold;
            margin-right: 5px;
        }

        .expand-indicator:hover {
            color: #7986cb;
        }

        /* Column widths matching Qt app */
        .treeview-table th:nth-child(1), .treeview-table td:nth-child(1) { width: 30px; } /* Checkbox */
        .treeview-table th:nth-child(2), .treeview-table td:nth-child(2) { width: 70px; } /* PL # */
        .treeview-table th:nth-child(3), .treeview-table td:nth-child(3) { width: 90px; } /* Serial # */
        .treeview-table th:nth-child(4), .treeview-table td:nth-child(4) { width: 110px; } /* Garment */
        .treeview-table th:nth-child(5), .treeview-table td:nth-child(5) { width: 90px; } /* Fabric */
        .treeview-table th:nth-child(6), .treeview-table td:nth-child(6) { width: 60px; } /* Color */
        .treeview-table th:nth-child(7), .treeview-table td:nth-child(7) { width: 100px; } /* Customer */
        .treeview-table th:nth-child(8), .treeview-table td:nth-child(8) { width: 90px; } /* Tax Inv # */
        .treeview-table th:nth-child(9), .treeview-table td:nth-child(9) { width: 90px; } /* Fabric Inv */
        .treeview-table th:nth-child(10), .treeview-table td:nth-child(10) { width: 90px; } /* Fabric DN */
        .treeview-table th:nth-child(11), .treeview-table td:nth-child(11) { width: 80px; } /* Fab Used */
        .treeview-table th:nth-child(12), .treeview-table td:nth-child(12) { width: 80px; } /* Fab Cost */
        .treeview-table th:nth-child(13), .treeview-table td:nth-child(13) { width: 120px; } /* Fab Value */
        .treeview-table th:nth-child(14), .treeview-table td:nth-child(14) { width: 32px; } /* S */
        .treeview-table th:nth-child(15), .treeview-table td:nth-child(15) { width: 32px; } /* M */
        .treeview-table th:nth-child(16), .treeview-table td:nth-child(16) { width: 32px; } /* L */
        .treeview-table th:nth-child(17), .treeview-table td:nth-child(17) { width: 36px; } /* XL */
        .treeview-table th:nth-child(18), .treeview-table td:nth-child(18) { width: 38px; } /* XXL */
        .treeview-table th:nth-child(19), .treeview-table td:nth-child(19) { width: 40px; } /* XXXL */
        .treeview-table th:nth-child(20), .treeview-table td:nth-child(20) { width: 60px; } /* Total Qty */
        .treeview-table th:nth-child(21), .treeview-table td:nth-child(21) { width: 80px; } /* Sew Cost */
        .treeview-table th:nth-child(22), .treeview-table td:nth-child(22) { width: 110px; } /* Sew Value */
        .treeview-table th:nth-child(23), .treeview-table td:nth-child(23) { width: 60px; } /* Yd/Pcs */
        .treeview-table th:nth-child(24), .treeview-table td:nth-child(24) { width: 80px; } /* Grmt Cost */
        .treeview-table th:nth-child(25), .treeview-table td:nth-child(25) { width: 110px; } /* Created At */
        .treeview-table th:nth-child(26), .treeview-table td:nth-child(26) { width: 100px; } /* Actions */

        /* Responsive */
        @media (max-width: 768px) {
            .filter-row {
                flex-direction: column;
                align-items: stretch;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .pagination-controls {
                flex-direction: column;
                gap: 10px;
            }
            
            .detail-grid {
                grid-template-columns: 1fr;
            }
            
            .size-quantities {
                grid-template-columns: repeat(3, 1fr);
            }
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="nav-bar">
        <ul class="nav-tabs">
            <li><a href="fabric-invoices.html" class="nav-tab">Fabric Invoices</a></li>
            <li><a href="stitching-records.html" class="nav-tab active">Stitching Records</a></li>
            <li><a href="packing-lists.html" class="nav-tab">Packing Lists</a></li>
            <li><a href="group-bills.html" class="nav-tab">Group Bills</a></li>
        </ul>
        <div class="nav-user">
            <span id="currentUser"></span>
            <button onclick="logout()" class="logout-btn">Logout</button>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">

        <!-- Enhanced Filter Controls like Qt App -->
        <div class="filter-controls">
            <div class="filter-row">
                <div class="filter-group">
                    <label>PL#:</label>
                    <input type="text" id="filterPLNumber" class="filter-input" placeholder="Filter by PL#">
                </div>
                <div class="filter-group">
                    <label>Serial#:</label>
                    <input type="text" id="filterSerialNumber" class="filter-input" placeholder="Filter by Serial#">
                </div>
                <div class="filter-group">
                    <label>Fabric:</label>
                    <input type="text" id="filterFabricName" class="filter-input" placeholder="Filter by Fabric">
                </div>
                <div class="filter-group">
                    <label>Customer:</label>
                    <input type="text" id="filterCustomer" class="filter-input" placeholder="Filter by Customer">
                </div>
                <div class="filter-group">
                    <label>From:</label>
                    <input type="text" id="filterDateFrom" class="filter-input" placeholder="DD/MM/YY" oninput="formatDateInput(this)">
                </div>
                <div class="filter-group">
                    <label>To:</label>
                    <input type="text" id="filterDateTo" class="filter-input" placeholder="DD/MM/YY" oninput="formatDateInput(this)">
                </div>
                <div class="filter-group">
                    <label>Delivery Status:</label>
                    <div class="radio-group">
                        <input type="radio" id="showAllRecords" name="deliveryStatus" value="all" checked onchange="loadStitchingData()">
                        <label for="showAllRecords">All Records</label>
                        <input type="radio" id="showDelivered" name="deliveryStatus" value="delivered" onchange="loadStitchingData()">
                        <label for="showDelivered">Delivered Only</label>
                        <input type="radio" id="showUndelivered" name="deliveryStatus" value="undelivered" onchange="loadStitchingData()">
                        <label for="showUndelivered">Undelivered Only</label>
                    </div>
                </div>
                <div class="filter-group">
                    <button onclick="applyFilters()" class="btn btn-primary">Apply Filters</button>
                    <button onclick="clearFilters()" class="btn btn-secondary">Clear</button>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons">
            <button class="btn btn-primary" onclick="refreshStitchingTable()">Refresh</button>
            <button class="btn btn-success" onclick="exportStitchingRecords()">Export</button>
            <button class="btn btn-warning" onclick="generatePackingList()">Generate Packing List</button>

            <button class="btn btn-danger" onclick="deleteSelectedStitchingRecords()">Delete Selected</button>
        </div>

        <!-- Stitching Records Treeview -->
        <div class="treeview-container">
            <div class="treeview-header">
                <table class="treeview-table" id="stitchingTreeview">
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="selectAllTree" onchange="toggleSelectAllTree()"></th>
                            <th onclick="sortStitchingTable(1)" style="cursor: pointer;">PL # ↕</th>
                            <th onclick="sortStitchingTable(2)" style="cursor: pointer;">Serial # ↕</th>
                            <th onclick="sortStitchingTable(3)" style="cursor: pointer;">Garment ↕</th>
                            <th onclick="sortStitchingTable(4)" style="cursor: pointer;">Fabric ↕</th>
                            <th onclick="sortStitchingTable(5)" style="cursor: pointer;">Color ↕</th>
                            <th onclick="sortStitchingTable(6)" style="cursor: pointer;">Customer ↕</th>
                            <th onclick="sortStitchingTable(7)" style="cursor: pointer;">Tax Inv # ↕</th>
                            <th onclick="sortStitchingTable(8)" style="cursor: pointer;">Fabric Inv. ↕</th>
                            <th onclick="sortStitchingTable(9)" style="cursor: pointer;">Fabric DN. ↕</th>
                            <th onclick="sortStitchingTable(10)" style="cursor: pointer;">Fab Used ↕</th>
                            <th onclick="sortStitchingTable(11)" style="cursor: pointer;">Fab Cost ↕</th>
                            <th onclick="sortStitchingTable(12)" style="cursor: pointer;">Fab Value ↕</th>
                            <th onclick="sortStitchingTable(13)" style="cursor: pointer;">S ↕</th>
                            <th onclick="sortStitchingTable(14)" style="cursor: pointer;">M ↕</th>
                            <th onclick="sortStitchingTable(15)" style="cursor: pointer;">L ↕</th>
                            <th onclick="sortStitchingTable(16)" style="cursor: pointer;">XL ↕</th>
                            <th onclick="sortStitchingTable(17)" style="cursor: pointer;">XXL ↕</th>
                            <th onclick="sortStitchingTable(18)" style="cursor: pointer;">XXXL ↕</th>
                            <th onclick="sortStitchingTable(19)" style="cursor: pointer;">Total Qty ↕</th>
                            <th onclick="sortStitchingTable(20)" style="cursor: pointer;">Sew Cost ↕</th>
                            <th onclick="sortStitchingTable(21)" style="cursor: pointer;">Sew Value ↕</th>
                            <th onclick="sortStitchingTable(22)" style="cursor: pointer;">Yd/Pcs ↕</th>
                            <th onclick="sortStitchingTable(23)" style="cursor: pointer;">Grmt Cost ↕</th>
                            <th onclick="sortStitchingTable(24)" style="cursor: pointer;">Created At ↕</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="stitchingTreeviewBody">
                        <tr>
                            <td colspan="26" style="text-align: center; padding: 20px; color: #b0bec5;">Loading stitching records...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Pagination Controls -->
        <div class="pagination-controls">
            <div class="pagination-info">
                Showing <span id="currentPageInfo">0-0</span> of <span id="totalRecords">0</span> records
            </div>
            <div class="pagination-buttons">
                <button class="pagination-btn" onclick="goToPage(1)" id="firstPage">First</button>
                <button class="pagination-btn" onclick="goToPage(currentPage - 1)" id="prevPage">Previous</button>
                <span id="pageNumbers"></span>
                <button class="pagination-btn" onclick="goToPage(currentPage + 1)" id="nextPage">Next</button>
                <button class="pagination-btn" onclick="goToPage(totalPages)" id="lastPage">Last</button>
            </div>
        </div>
    </main>

    <!-- Stitching Record Detail Modal -->
    <div id="stitchingDetailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Stitching Record Details</h2>
                <span class="close" onclick="closeStitchingDetailModal()">&times;</span>
            </div>
            <div class="modal-body" id="stitchingDetailContent">
                <!-- Content will be populated dynamically -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeStitchingDetailModal()">Close</button>
                <button class="btn btn-warning" onclick="toggleAmendMode()">Amend</button>
                <button class="btn btn-primary" onclick="confirmAmendStitchingRecord()" style="display: none;">Confirm Amendment</button>
                <button class="btn btn-danger" onclick="deleteStitchingRecord()">Delete Record</button>
            </div>
        </div>
    </div>



    <script>
        // Stitching Records Functions
        let stitchingData = [];
        let selectedRows = [];
        let currentPage = 1;
        const itemsPerPage = 30;
        let currentStitchingRecord = null;


        // Check authentication
        function checkAuth() {
            const isLoggedIn = localStorage.getItem('gms_logged_in');
            if (isLoggedIn !== 'true') {
                window.location.href = 'login.html';
                return false;
            }
            return true;
        }

        // Load data when page loads
        window.addEventListener('load', async () => {
            console.log('🔄 Stitching Records page loaded');
            
            // Check authentication first
            if (!checkAuth()) {
                return;
            }
            
            // Display current user
            const username = localStorage.getItem('gms_username');
            document.getElementById('currentUser').textContent = `Welcome, ${username}`;
            
            // Set default filter to undelivered items
            const undeliveredRadio = document.querySelector('input[name="deliveryStatus"][value="undelivered"]');
            if (undeliveredRadio) {
                undeliveredRadio.checked = true;
                console.log('✅ Set default filter to undelivered items');
            }
            
            await loadStitchingData();
        });

        function formatDateForAPI(dateString) {
            if (!dateString) return '';
            // Convert DD/MM/YY to YYYY-MM-DD
            const parts = dateString.split('/');
            if (parts.length === 3) {
                const day = parts[0];
                const month = parts[1];
                const year = parts[2];
                // Ensure year is 4 digits (assume 20xx for YY format)
                const fullYear = year.length === 2 ? '20' + year : year;
                return `${fullYear}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
            }
            return dateString;
        }

        function formatDateInput(input) {
            // Auto-format date input to DD/MM/YY format (like old Qt app)
            let text = input.value;
            // Remove any non-digit characters
            let digitsOnly = text.replace(/\D/g, '');
            
            // Format as DD/MM/YY
            let formatted = "";
            if (digitsOnly.length >= 1) {
                formatted += digitsOnly.slice(0, 2);
            }
            if (digitsOnly.length >= 3) {
                formatted += "/" + digitsOnly.slice(2, 4);
            }
            if (digitsOnly.length >= 5) {
                formatted += "/" + digitsOnly.slice(4, 6);
            }
            
            // Update text if different
            if (formatted !== text) {
                input.value = formatted;
            }
        }

        async function loadStitchingData() {
            console.log('🔄 loadStitchingData called');
            
            const tbody = document.getElementById('stitchingTreeviewBody');
            if (!tbody) {
                console.error('❌ Stitching table body not found');
                return;
            }
            
            console.log('✅ Found stitching table body, showing loading state');
            tbody.innerHTML = '<tr><td colspan="26" style="text-align: center; padding: 20px; color: #b0bec5;">Loading stitching records...</td></tr>';
            
            try {
                // Build query parameters from filters
                const params = new URLSearchParams();
                
                const plNumberFilter = document.getElementById('filterPLNumber')?.value;
                const serialNumberFilter = document.getElementById('filterSerialNumber')?.value;
                const fabricNameFilter = document.getElementById('filterFabricName')?.value;
                const customerFilter = document.getElementById('filterCustomer')?.value;
                const dateFrom = document.getElementById('filterDateFrom')?.value;
                const dateTo = document.getElementById('filterDateTo')?.value;
                const deliveryStatusFilter = document.querySelector('input[name="deliveryStatus"]:checked')?.value;
                
                if (plNumberFilter) params.append('pl_number', plNumberFilter);
                if (serialNumberFilter) params.append('serial_number', serialNumberFilter);
                if (fabricNameFilter) params.append('fabric_name', fabricNameFilter);
                if (customerFilter) params.append('customer', customerFilter);
                if (dateFrom) params.append('date_from', formatDateForAPI(dateFrom));
                if (dateTo) params.append('date_to', formatDateForAPI(dateTo));
                if (deliveryStatusFilter === 'delivered') params.append('delivered_only', 'true');
                if (deliveryStatusFilter === 'undelivered') params.append('undelivered_only', 'true');
                
                console.log('🌐 Fetching /api/stitching with filters...');
                const apiBaseUrl = getApiBaseUrl();
                const apiUrl = `${apiBaseUrl}/api/stitching?${params.toString()}`;
                console.log('🌐 Full API URL:', apiUrl);
                
                const response = await fetch(apiUrl, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                });
                
                console.log('📡 Response status:', response.status);
                
                if (response.ok) {
                    stitchingData = await response.json();
                    console.log('📊 Received stitching data:', stitchingData.length, 'records');
                    currentPage = 1; // Reset to first page when new data is loaded
                    populateStitchingTreeview();
                } else {
                    console.error('❌ Failed to load stitching data, status:', response.status);
                    const errorText = await response.text();
                    console.error('❌ Error response:', errorText);
                    tbody.innerHTML = '<tr><td colspan="26" style="text-align: center; padding: 20px; color: #f44336;">Failed to load stitching data. Please try refreshing the page.</td></tr>';
                }
            } catch (error) {
                console.error('❌ Error loading stitching data:', error);
                tbody.innerHTML = '<tr><td colspan="26" style="text-align: center; padding: 20px; color: #f44336;">Error loading stitching data. Please check your connection and try again.</td></tr>';
            }
        }

        function populateStitchingTreeview() {
            console.log('🔄 populateStitchingTreeview called with', stitchingData.length, 'records');
            const tbody = document.getElementById('stitchingTreeviewBody');
            tbody.innerHTML = '';

            if (stitchingData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="26" style="text-align: center; padding: 20px; color: #b0bec5;">No stitching records found. Try creating some stitching records from the Fabric Invoices page.</td></tr>';
                updatePaginationControls();
                return;
            }

            // Calculate pagination
            const totalPages = Math.ceil(stitchingData.length / itemsPerPage);
            if (currentPage > totalPages && totalPages > 0) {
                currentPage = totalPages;
            }
            
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, stitchingData.length);
            const pageData = stitchingData.slice(startIndex, endIndex);

            // Populate treeview
            pageData.forEach((record, pageIndex) => {
                const actualIndex = startIndex + pageIndex;
                
                // Create parent row
                const parentRow = document.createElement('tr');
                parentRow.className = 'treeview-parent';
                parentRow.setAttribute('data-record-id', record.id);

                
                // Calculate values like Qt app
                const sizeQty = record.size_qty || {};
                const totalQty = Object.values(sizeQty).reduce((sum, qty) => sum + (qty || 0), 0);
                const fabricUnitPrice = parseFloat(record.fabric_unit_price) || 0;
                const yardsConsumed = record.yard_consumed || 0;
                const fabricValue = fabricUnitPrice * yardsConsumed;
                
                // Calculate VAT-inclusive price
                const basePrice = record.price || 0;
                const addVat = record.add_vat || false;
                const vatInclusivePrice = addVat ? basePrice * 1.07 : basePrice;
                
                // Calculate yards per piece
                const yardsPerPiece = totalQty > 0 ? yardsConsumed / totalQty : 0;
                
                // Calculate garment cost per piece (like Qt app)
                // Get main fabric cost
                const mainFabricCost = fabricValue;
                
                // Get multi-fabric costs
                const multiFabricCost = record.garment_fabrics ? 
                    record.garment_fabrics.reduce((sum, fabric) => sum + (parseFloat(fabric.total_fabric_cost) || 0), 0) : 0;
                
                // Get lining costs
                const liningCost = record.lining_fabrics ? 
                    record.lining_fabrics.reduce((sum, lining) => sum + (parseFloat(lining.total_cost) || 0), 0) : 0;
                
                // Calculate total fabric cost (main + multi + lining)
                const totalFabricCost = mainFabricCost + multiFabricCost + liningCost;
                
                // Calculate fabric cost per piece
                const fabricCostPerGarment = totalQty > 0 ? totalFabricCost / totalQty : 0;
                
                // Stitching cost per piece (with VAT if applicable)
                const sewingPrice = record.price || 0;
                let sewingCostPerGarment;
                if (record.add_vat) {
                    const baseSewingCost = parseFloat(sewingPrice);
                    const vatAmount = baseSewingCost * 0.07;
                    sewingCostPerGarment = baseSewingCost + vatAmount;
                } else {
                    sewingCostPerGarment = parseFloat(sewingPrice);
                }
                
                // Total cost per piece
                const garmentCostPerPiece = fabricCostPerGarment + sewingCostPerGarment;
                
                // Format date
                const createdDate = record.created_at ? new Date(record.created_at).toLocaleDateString('en-GB') : '';
                
                // Check if record has multi-fabrics or lining
                const hasMultiFabrics = record.garment_fabrics && record.garment_fabrics.length > 0;
                const hasLining = record.lining_fabrics && record.lining_fabrics.length > 0;
                const isExpandable = hasMultiFabrics || hasLining;
                
                // Create expand indicator
                const expandIndicator = isExpandable ? 
                    `<span class="expand-indicator" onclick="event.stopPropagation(); toggleRecordExpansion(${record.id})">▶</span>` : '';
                
                const isSelected = selectedRows.includes(actualIndex);
                console.log(`🔍 Row ${actualIndex}: isSelected = ${isSelected}, selectedRows = [${selectedRows.join(', ')}]`);
                
                parentRow.innerHTML = `
                    <td><input type="checkbox" onchange="event.stopPropagation(); toggleRowSelection(${actualIndex})" ${isSelected ? 'checked' : ''}></td>
                    <td>${record.packing_list_number || ''}</td>
                    <td>${expandIndicator}${record.stitching_invoice_number || ''}</td>
                    <td>${record.stitched_item || ''}</td>
                    <td>${record.item_name || ''}</td>
                    <td>${record.color || ''}</td>
                    <td>${record.customer_name || ''}</td>
                    <td>${record.tax_invoice_number || ''}</td>
                    <td>${record.fabric_invoice_number || ''}</td>
                    <td>${record.delivery_note || ''}</td>
                    <td>${yardsConsumed.toFixed(2)}</td>
                    <td>${fabricUnitPrice.toFixed(2)}</td>
                    <td>${fabricValue.toFixed(2)}</td>
                    <td>${sizeQty.S || 0}</td>
                    <td>${sizeQty.M || 0}</td>
                    <td>${sizeQty.L || 0}</td>
                    <td>${sizeQty.XL || 0}</td>
                    <td>${sizeQty.XXL || 0}</td>
                    <td>${sizeQty.XXXL || 0}</td>
                    <td>${totalQty}</td>
                    <td>${vatInclusivePrice.toFixed(2)}</td>
                    <td>${record.total_value.toFixed(2)}</td>
                    <td>${yardsPerPiece.toFixed(3)}</td>
                    <td>${garmentCostPerPiece.toFixed(2)}</td>
                    <td>${createdDate}</td>
                    <td>
                        <button onclick="event.stopPropagation(); viewStitchingDetail(${record.id})" class="btn btn-primary" style="padding: 4px 8px; font-size: 11px;">View</button>
                        <button onclick="event.stopPropagation(); deleteStitchingRecord(${record.id})" class="btn btn-danger" style="padding: 4px 8px; font-size: 11px;">Delete</button>
                    </td>
                `;
                tbody.appendChild(parentRow);
                
                // Add child rows for multi-fabrics and lining (initially hidden)
                if (isExpandable) {
                    // Add multi-fabric child rows
                    if (hasMultiFabrics) {
                        record.garment_fabrics.forEach(fabric => {
                            const childRow = createFabricChildRow(record, fabric, 'multi_fabric');
                            childRow.style.display = 'none';
                            childRow.setAttribute('data-parent-id', record.id);
                            tbody.appendChild(childRow);
                        });
                    }
                    
                    // Add lining child rows
                    if (hasLining) {
                        record.lining_fabrics.forEach(lining => {
                            const childRow = createLiningChildRow(record, lining);
                            childRow.style.display = 'none';
                            childRow.setAttribute('data-parent-id', record.id);
                            tbody.appendChild(childRow);
                        });
                    }
                }
            });

            console.log('✅ Stitching treeview populated with', pageData.length, 'rows (page', currentPage, 'of', totalPages, ')');
            updatePaginationControls();
            updateSelectAllCheckbox();
        }
        
        function createFabricChildRow(parentRecord, fabric, type) {
            const childRow = document.createElement('tr');
            childRow.className = 'treeview-child';
            childRow.setAttribute('data-type', type);
            
            const sizeQty = parentRecord.size_qty || {};
            const totalQty = Object.values(sizeQty).reduce((sum, qty) => sum + (qty || 0), 0);
            const yardsPerPiece = totalQty > 0 ? fabric.consumption_yards / totalQty : 0;
            
            childRow.innerHTML = `
                <td></td>
                <td></td>
                <td>  └─ ${fabric.fabric_name || ''}</td>
                <td></td>
                <td>${fabric.fabric_name || ''}</td>
                <td>${fabric.color || ''}</td>
                <td></td>
                <td></td>
                <td>${fabric.invoice_number || ''}</td>
                <td></td>
                <td>${parseFloat(fabric.consumption_yards).toFixed(2)}</td>
                <td>${parseFloat(fabric.unit_price).toFixed(2)}</td>
                <td>${parseFloat(fabric.total_fabric_cost).toFixed(2)}</td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td>${yardsPerPiece.toFixed(3)}</td>
                <td></td>
                <td></td>
                <td></td>
            `;
            
            return childRow;
        }
        
        function createLiningChildRow(parentRecord, lining) {
            const childRow = document.createElement('tr');
            childRow.className = 'treeview-child';
            childRow.setAttribute('data-type', 'lining');
            
            const sizeQty = parentRecord.size_qty || {};
            const totalQty = Object.values(sizeQty).reduce((sum, qty) => sum + (qty || 0), 0);
            const yardsPerPiece = totalQty > 0 ? lining.consumption_yards / totalQty : 0;
            
            childRow.innerHTML = `
                <td></td>
                <td></td>
                <td>  └─ ${lining.lining_name || ''}</td>
                <td></td>
                <td>${lining.lining_name || ''}</td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td>${parseFloat(lining.consumption_yards).toFixed(2)}</td>
                <td>${parseFloat(lining.unit_price).toFixed(2)}</td>
                <td>${parseFloat(lining.total_cost).toFixed(2)}</td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td>${yardsPerPiece.toFixed(3)}</td>
                <td></td>
                <td></td>
                <td></td>
            `;
            
            return childRow;
        }
        
        function toggleRecordExpansion(recordId) {
            const parentRow = document.querySelector(`tr[data-record-id="${recordId}"]`);
            const childRows = document.querySelectorAll(`tr[data-parent-id="${recordId}"]`);
            const expandIndicator = parentRow.querySelector('.expand-indicator');
            
            const isExpanded = childRows[0] && childRows[0].style.display !== 'none';
            
            childRows.forEach(row => {
                row.style.display = isExpanded ? 'none' : '';
            });
            
            if (expandIndicator) {
                expandIndicator.textContent = isExpanded ? '▶' : '▼';
            }
        }
        

        

        

        

        

        

        
        async function confirmAmendStitchingRecord() {
            if (!currentStitchingRecord) {
                alert('No stitching record selected for amendment.');
                return;
            }
            
            // Validate inputs
            const stitchedItem = document.getElementById('amendStitchedItem').value.trim();
            const price = parseFloat(document.getElementById('amendPrice').value) || 0;
            
            if (!stitchedItem) {
                alert('Please enter a stitched item name.');
                return;
            }
            
            if (price <= 0) {
                alert('Please enter a valid price.');
                return;
            }
            
            // Collect size quantities
            const sizeQty = {};
            ['S', 'M', 'L', 'XL', 'XXL', 'XXXL'].forEach(size => {
                const qty = parseInt(document.getElementById(`amendSize${size}`).value) || 0;
                if (qty > 0) sizeQty[size] = qty;
            });
            
            const totalQty = Object.values(sizeQty).reduce((sum, qty) => sum + qty, 0);
            if (totalQty === 0) {
                alert('Please enter quantities for at least one size.');
                return;
            }
            
            // Collect fabric consumption
            const fabricConsumption = {};
            if (document.getElementById('amendMainFabricConsumption')) {
                fabricConsumption.main = parseFloat(document.getElementById('amendMainFabricConsumption').value) || 0;
            }
            
            // Collect multi-fabric consumption
            const multiFabricConsumption = [];
            if (currentStitchingRecord.garment_fabrics) {
                currentStitchingRecord.garment_fabrics.forEach((fabric, index) => {
                    const consumption = parseFloat(document.getElementById(`amendMultiFabric${index}`).value) || 0;
                    multiFabricConsumption.push({
                        id: fabric.id,
                        consumption_yards: consumption
                    });
                });
            }
            
            // Collect lining consumption
            const liningConsumption = [];
            if (currentStitchingRecord.lining_fabrics) {
                currentStitchingRecord.lining_fabrics.forEach((lining, index) => {
                    const consumption = parseFloat(document.getElementById(`amendLining${index}`).value) || 0;
                    liningConsumption.push({
                        id: lining.id,
                        consumption_yards: consumption
                    });
                });
            }
            
            // Prepare amendment data
            const amendmentData = {
                stitched_item: stitchedItem,
                price: price,
                add_vat: document.getElementById('amendAddVat').checked,
                size_qty: sizeQty,
                fabric_consumption: fabricConsumption,
                multi_fabric_consumption: multiFabricConsumption,
                lining_consumption: liningConsumption
            };
            
            try {
                const response = await fetch(`${getApiBaseUrl()}/api/stitching/${currentStitchingRecord.id}/amend`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(amendmentData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    alert('Stitching record amended successfully!');
                    closeStitchingDetailModal();
                    loadStitchingData(); // Refresh the data
                } else {
                    const error = await response.json();
                    alert(`Error amending stitching record: ${error.error}`);
                }
            } catch (error) {
                console.error('Error amending stitching record:', error);
                alert('Error amending stitching record.');
            }
        }

        function updatePaginationControls() {
            const totalPages = Math.ceil(stitchingData.length / itemsPerPage);
            const startRecord = (currentPage - 1) * itemsPerPage + 1;
            const endRecord = Math.min(currentPage * itemsPerPage, stitchingData.length);
            
            // Update info
            document.getElementById('currentPageInfo').textContent = `${startRecord}-${endRecord}`;
            document.getElementById('totalRecords').textContent = stitchingData.length;
            
            // Update buttons
            document.getElementById('firstPage').disabled = currentPage === 1;
            document.getElementById('prevPage').disabled = currentPage === 1;
            document.getElementById('nextPage').disabled = currentPage === totalPages;
            document.getElementById('lastPage').disabled = currentPage === totalPages;
            
            // Update page numbers
            const pageNumbers = document.getElementById('pageNumbers');
            pageNumbers.innerHTML = '';
            
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
            
            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }
            
            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.className = `pagination-btn ${i === currentPage ? 'active' : ''}`;
                pageBtn.textContent = i;
                pageBtn.onclick = () => goToPage(i);
                pageNumbers.appendChild(pageBtn);
            }
        }

        function goToPage(page) {
            const totalPages = Math.ceil(stitchingData.length / itemsPerPage);
            if (page >= 1 && page <= totalPages) {
                currentPage = page;
                populateStitchingTable();
            }
        }



        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('#stitchingTableBody input[type="checkbox"]');
            
            checkboxes.forEach((checkbox, index) => {
                const actualIndex = (currentPage - 1) * itemsPerPage + index;
                if (selectAllCheckbox.checked) {
                    checkbox.checked = true;
                    if (!selectedRows.includes(actualIndex)) {
                        selectedRows.push(actualIndex);
                    }
                } else {
                    checkbox.checked = false;
                    selectedRows = selectedRows.filter(i => i !== actualIndex);
                }
            });
        }
      
        function toggleSelectAllTree() {
            const selectAllCheckbox = document.getElementById('selectAllTree');
            const checkboxes = document.querySelectorAll('#stitchingTreeviewBody input[type="checkbox"]');
            
            console.log('🔍 toggleSelectAllTree called, selectAllCheckbox.checked:', selectAllCheckbox.checked);
            
            // Convert NodeList to Array for forEach method
            const checkboxesArray = Array.from(checkboxes);
            checkboxesArray.forEach((checkbox, index) => {
                const actualIndex = (currentPage - 1) * itemsPerPage + index;
                if (selectAllCheckbox.checked) {
                    checkbox.checked = true;
                    if (!selectedRows.includes(actualIndex)) {
                        selectedRows.push(actualIndex);
                    }
                } else {
                    checkbox.checked = false;
                    selectedRows = selectedRows.filter(i => i !== actualIndex);
                }
            });
            
            console.log('📋 Updated selectedRows:', selectedRows);
        }

        function toggleRowSelection(actualIndex) {
            console.log('🔍 toggleRowSelection called with actualIndex:', actualIndex);
            console.log('📋 Current selectedRows:', selectedRows);
            
            if (selectedRows.includes(actualIndex)) {
                // Remove from selection
                selectedRows = selectedRows.filter(i => i !== actualIndex);
                console.log('❌ Removed from selection, new selectedRows:', selectedRows);
            } else {
                // Add to selection
                selectedRows.push(actualIndex);
                console.log('✅ Added to selection, new selectedRows:', selectedRows);
            }
            
            // Update the checkbox state
            const checkboxes = document.querySelectorAll('#stitchingTreeviewBody input[type="checkbox"]');
            checkboxes.forEach((checkbox, index) => {
                const checkboxActualIndex = (currentPage - 1) * itemsPerPage + index;
                if (checkboxActualIndex === actualIndex) {
                    checkbox.checked = selectedRows.includes(actualIndex);
                }
            });
            
            // Update select all checkbox
            updateSelectAllCheckbox();
        }

        function updateSelectAllCheckbox() {
            const checkboxes = document.querySelectorAll('#stitchingTreeviewBody input[type="checkbox"]');
            const selectAllCheckbox = document.getElementById('selectAllTree');
            
            if (checkboxes.length === 0) {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;
                return;
            }
            
            // Convert NodeList to Array for filter method
            const checkboxesArray = Array.from(checkboxes);
            const checkedCount = checkboxesArray.filter(checkbox => checkbox.checked).length;
            
            if (checkedCount === 0) {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;
            } else if (checkedCount === checkboxes.length) {
                selectAllCheckbox.checked = true;
                selectAllCheckbox.indeterminate = false;
            } else {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = true;
            }
        }

        function applyFilters() {
            loadStitchingData();
        }

        function clearFilters() {
            document.getElementById('filterPLNumber').value = '';
            document.getElementById('filterSerialNumber').value = '';
            document.getElementById('filterFabricName').value = '';
            document.getElementById('filterCustomer').value = '';
            document.getElementById('filterDateFrom').value = '';
            document.getElementById('filterDateTo').value = '';
            document.getElementById('showAllRecords').checked = true;
            loadStitchingData();
        }

        function refreshStitchingTable() {
            loadStitchingData();
        }

        function exportStitchingRecords() {
            // TODO: Implement export functionality
            alert('Export functionality will be implemented soon.');
        }

        function groupAndBill() {
            if (selectedRows.length === 0) {
                alert('Please select one or more unbilled stitching records to group and bill.');
                return;
            }
            
            // TODO: Implement group and bill functionality
            alert('Group and Bill functionality will be implemented soon.');
        }

        function deleteSelectedRecords() {
            if (selectedRows.length === 0) {
                alert('Please select one or more stitching records to delete.');
                return;
            }
            
            if (confirm(`Are you sure you want to delete ${selectedRows.length} selected stitching record(s)?`)) {
                // TODO: Implement bulk delete
                alert('Bulk delete functionality will be implemented soon.');
            }
        }

        let isAmendMode = false;
        
        async function viewStitchingDetail(recordId) {
            try {
                const response = await fetch(`${getApiBaseUrl()}/api/stitching/${recordId}`);
                if (response.ok) {
                    const record = await response.json();
                    currentStitchingRecord = record;
                    showStitchingDetailModal(record);
                } else {
                    alert('Error loading stitching record details.');
                }
            } catch (error) {
                console.error('Error loading stitching record:', error);
                alert('Error loading stitching record details.');
            }
        }

        function showStitchingDetailModal(record) {
            const modal = document.getElementById('stitchingDetailModal');
            const content = document.getElementById('stitchingDetailContent');
            
            // Format size quantities
            const sizeQty = record.size_qty || {};
            const sizeQuantitiesHtml = Object.entries(sizeQty).map(([size, qty]) => `
                <div class="size-item">
                    <div class="size-label">${size}</div>
                    <div class="size-value">${qty}</div>
                </div>
            `).join('');
            
            // Format lining fabrics
            const liningFabricsHtml = record.lining_fabrics && record.lining_fabrics.length > 0 ? 
                record.lining_fabrics.map(lining => `
                    <tr>
                        <td>${lining.lining_name}</td>
                        <td>${lining.consumption_yards.toFixed(2)}</td>
                        <td>${lining.unit_price.toFixed(2)}</td>
                        <td>${lining.total_cost.toFixed(2)}</td>
                    </tr>
                `).join('') : '<tr><td colspan="4" style="text-align: center; color: #666;">No lining fabrics</td></tr>';
            
            // Format garment fabrics
            const garmentFabricsHtml = record.garment_fabrics && record.garment_fabrics.length > 0 ? 
                record.garment_fabrics.map(fabric => `
                    <tr>
                        <td>${fabric.fabric_name || 'N/A'}</td>
                        <td>${fabric.color || 'N/A'}</td>
                        <td>${fabric.invoice_number || 'N/A'}</td>
                        <td>${fabric.consumption_yards.toFixed(2)}</td>
                        <td>${fabric.unit_price.toFixed(2)}</td>
                        <td>${fabric.total_fabric_cost.toFixed(2)}</td>
                    </tr>
                `).join('') : '<tr><td colspan="6" style="text-align: center; color: #666;">No additional fabrics</td></tr>';
            
            content.innerHTML = `
                <div class="detail-section">
                    <h3>Basic Information</h3>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-label">Stitching Number</div>
                            <div class="detail-value">${record.stitching_invoice_number}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Created Date</div>
                            <div class="detail-value">${new Date(record.created_at).toLocaleString()}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Customer</div>
                            <div class="detail-value">${record.customer_name || 'N/A'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Fabric Item</div>
                            <div class="detail-value">${record.item_name}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Stitched Item</div>
                            <div class="detail-value">${record.stitched_item}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Yards Consumed</div>
                            <div class="detail-value">${record.yard_consumed.toFixed(2)}</div>
                        </div>
                    </div>
                </div>
                
                <div class="detail-section">
                    <h3>Size Quantities</h3>
                    <div class="size-quantities">
                        ${sizeQuantitiesHtml}
                    </div>
                </div>
                
                <div class="detail-section">
                    <h3>Pricing Information</h3>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-label">Unit Price</div>
                            <div class="detail-value">${record.price.toFixed(2)} THB</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Total Value</div>
                            <div class="detail-value">${record.total_value.toFixed(2)} THB</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">VAT Included</div>
                            <div class="detail-value">${record.add_vat ? 'Yes (7%)' : 'No'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Lining Cost</div>
                            <div class="detail-value">${record.total_lining_cost.toFixed(2)} THB</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Fabric Cost</div>
                            <div class="detail-value">${record.total_fabric_cost.toFixed(2)} THB</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Billing Status</div>
                            <div class="detail-value">${record.billing_group_id ? 'Billed' : 'Unbilled'}</div>
                        </div>
                    </div>
                </div>
                
                <div class="detail-section">
                    <h3>Lining Fabrics</h3>
                    <table style="width: 100%; border-collapse: collapse; background: #424242; border-radius: 4px;">
                        <thead>
                            <tr style="background: #555;">
                                <th style="padding: 8px; text-align: left;">Lining Name</th>
                                <th style="padding: 8px; text-align: left;">Consumption (yards)</th>
                                <th style="padding: 8px; text-align: left;">Unit Price (THB)</th>
                                <th style="padding: 8px; text-align: left;">Total Cost</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${liningFabricsHtml}
                        </tbody>
                    </table>
                </div>
                
                <div class="detail-section">
                    <h3>Additional Fabrics</h3>
                    <table style="width: 100%; border-collapse: collapse; background: #424242; border-radius: 4px;">
                        <thead>
                            <tr style="background: #555;">
                                <th style="padding: 8px; text-align: left;">Fabric Name</th>
                                <th style="padding: 8px; text-align: left;">Color</th>
                                <th style="padding: 8px; text-align: left;">Invoice</th>
                                <th style="padding: 8px; text-align: left;">Consumption (yards)</th>
                                <th style="padding: 8px; text-align: left;">Unit Price (THB)</th>
                                <th style="padding: 8px; text-align: left;">Total Cost</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${garmentFabricsHtml}
                        </tbody>
                    </table>
                </div>
                
                <div class="detail-section" id="amendFields" style="display: none;">
                    <h3>Amend Fields</h3>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-label">Stitched Item</div>
                            <input type="text" id="amendStitchedItem" value="${record.stitched_item}" style="width: 100%; padding: 8px; background: #424242; border: 1px solid #555; color: #eceff1; border-radius: 4px;">
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Price (THB)</div>
                            <input type="number" id="amendPrice" value="${record.price}" step="0.01" min="0" style="width: 100%; padding: 8px; background: #424242; border: 1px solid #555; color: #eceff1; border-radius: 4px;">
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Add VAT</div>
                            <input type="checkbox" id="amendAddVat" ${record.add_vat ? 'checked' : ''} style="width: 16px; height: 16px;">
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <h4>Size Quantities</h4>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <div class="detail-label">S</div>
                                <input type="number" id="amendSizeS" value="${record.size_qty.S || 0}" min="0" style="width: 100%; padding: 8px; background: #424242; border: 1px solid #555; color: #eceff1; border-radius: 4px;">
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">M</div>
                                <input type="number" id="amendSizeM" value="${record.size_qty.M || 0}" min="0" style="width: 100%; padding: 8px; background: #424242; border: 1px solid #555; color: #eceff1; border-radius: 4px;">
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">L</div>
                                <input type="number" id="amendSizeL" value="${record.size_qty.L || 0}" min="0" style="width: 100%; padding: 8px; background: #424242; border: 1px solid #555; color: #eceff1; border-radius: 4px;">
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">XL</div>
                                <input type="number" id="amendSizeXL" value="${record.size_qty.XL || 0}" min="0" style="width: 100%; padding: 8px; background: #424242; border: 1px solid #555; color: #eceff1; border-radius: 4px;">
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">XXL</div>
                                <input type="number" id="amendSizeXXL" value="${record.size_qty.XXL || 0}" min="0" style="width: 100%; padding: 8px; background: #424242; border: 1px solid #555; color: #eceff1; border-radius: 4px;">
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">XXXL</div>
                                <input type="number" id="amendSizeXXXL" value="${record.size_qty.XXXL || 0}" min="0" style="width: 100%; padding: 8px; background: #424242; border: 1px solid #555; color: #eceff1; border-radius: 4px;">
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <h4>Fabric Consumption</h4>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <div class="detail-label">Main Fabric Yards</div>
                                <input type="number" id="amendMainFabricConsumption" value="${record.yard_consumed}" step="0.01" min="0" style="width: 100%; padding: 8px; background: #424242; border: 1px solid #555; color: #eceff1; border-radius: 4px;">
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <h4>Multi-Fabric Consumption</h4>
                        <div id="amendMultiFabricConsumption">
                            ${record.garment_fabrics ? record.garment_fabrics.map((fabric, index) => `
                                <div class="detail-item" style="margin-bottom: 10px;">
                                    <div class="detail-label">${fabric.fabric_name}</div>
                                    <input type="number" id="amendMultiFabric${index}" value="${fabric.consumption_yards}" step="0.01" min="0" style="width: 100%; padding: 8px; background: #424242; border: 1px solid #555; color: #eceff1; border-radius: 4px;">
                                </div>
                            `).join('') : '<p style="color: #b0bec5;">No multi-fabrics found</p>'}
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <h4>Lining Consumption</h4>
                        <div id="amendLiningConsumption">
                            ${record.lining_fabrics ? record.lining_fabrics.map((lining, index) => `
                                <div class="detail-item" style="margin-bottom: 10px;">
                                    <div class="detail-label">${lining.lining_name}</div>
                                    <input type="number" id="amendLining${index}" value="${lining.consumption_yards}" step="0.01" min="0" style="width: 100%; padding: 8px; background: #424242; border: 1px solid #555; color: #eceff1; border-radius: 4px;">
                                </div>
                            `).join('') : '<p style="color: #b0bec5;">No lining fabrics found</p>'}
                        </div>
                    </div>
                </div>
            `;
            
            // Reset amend mode when showing modal
            console.log('🔄 Resetting amend mode to false when showing modal');
            isAmendMode = false;
            
            // Ensure amend fields are hidden initially
            const amendFields = document.getElementById('amendFields');
            if (amendFields) {
                amendFields.style.display = 'none';
                console.log('📝 Amend fields hidden on modal show');
            }
            
            modal.style.display = 'block';
            
            // Reset button states after modal is displayed
            setTimeout(() => {
                const amendButton = document.querySelector('button[onclick="toggleAmendMode()"]');
                const confirmButton = document.querySelector('button[onclick="confirmAmendStitchingRecord()"]');
                
                console.log('🔄 Resetting button states after modal display');
                
                if (amendButton) {
                    amendButton.textContent = 'Amend';
                    amendButton.className = 'btn btn-warning';
                    console.log('🔘 Reset amend button to: Amend');
                } else {
                    console.log('❌ Amend button not found');
                }
                
                if (confirmButton) {
                    confirmButton.style.display = 'none';
                    console.log('✅ Hidden confirm button');
                } else {
                    console.log('❌ Confirm button not found');
                }
            }, 10);
        }

        function closeStitchingDetailModal() {
            const modal = document.getElementById('stitchingDetailModal');
            modal.style.display = 'none';
            currentStitchingRecord = null;
            isAmendMode = false;
        }
        
        function toggleAmendMode() {
            isAmendMode = !isAmendMode;
            const amendFields = document.getElementById('amendFields');
            const amendButton = document.querySelector('button[onclick="toggleAmendMode()"]');
            const confirmButton = document.querySelector('button[onclick="confirmAmendStitchingRecord()"]');
            
            console.log('🔄 Toggling amend mode to:', isAmendMode);
            
            if (amendFields) {
                amendFields.style.display = isAmendMode ? 'block' : 'none';
                console.log('📝 Amend fields display set to:', amendFields.style.display);
            }
            
            if (amendButton) {
                amendButton.textContent = isAmendMode ? 'Cancel Amend' : 'Amend';
                amendButton.className = isAmendMode ? 'btn btn-secondary' : 'btn btn-warning';
                console.log('🔘 Amend button text set to:', amendButton.textContent);
            }
            
            if (confirmButton) {
                confirmButton.style.display = isAmendMode ? 'inline-block' : 'none';
                console.log('✅ Confirm button display set to:', confirmButton.style.display);
            }
        }

        function deleteStitchingRecord(recordId) {
            if (!recordId && currentStitchingRecord) {
                recordId = currentStitchingRecord.id;
            }
            
            if (!recordId) {
                alert('No record selected for deletion.');
                return;
            }
            
            const confirmMessage = `Are you sure you want to delete this stitching record?\n\nThis will:\n• Revert fabric inventory changes\n• Remove associated images\n• Remove from packing lists (if any)\n• Remove from group bills (if any)\n\nThis action cannot be undone.`;
            
            if (confirm(confirmMessage)) {
                fetch(`${getApiBaseUrl()}/api/stitching/${recordId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(errorData => {
                            throw new Error(errorData.error || 'Failed to delete record');
                        });
                    }
                    return response.json();
                })
                .then(result => {
                    if (result.message) {
                        alert(result.message);
                        closeStitchingDetailModal();
                        loadStitchingData(); // Refresh the table
                    } else {
                        alert('Error: ' + (result.error || 'Unknown error'));
                    }
                })
                .catch(error => {
                    alert('Error deleting stitching record: ' + error.message);
                });
            }
        }

        function deleteSelectedStitchingRecords() {
            if (selectedRows.length === 0) {
                alert('Please select one or more stitching records to delete.');
                return;
            }
            
            const selectedRecords = selectedRows.map(index => stitchingData[index]);
            const recordIds = selectedRecords.map(record => record.id);
            
            const confirmMessage = `Are you sure you want to delete ${selectedRecords.length} stitching record(s)?\n\nThis will:\n• Revert fabric inventory changes\n• Remove associated images\n• Remove from packing lists (if any)\n• Remove from group bills (if any)\n\nThis action cannot be undone.`;
            
            if (confirm(confirmMessage)) {
                fetch(`${getApiBaseUrl()}/api/stitching/bulk-delete`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ record_ids: recordIds })
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(errorData => {
                            throw new Error(errorData.error || 'Failed to delete records');
                        });
                    }
                    return response.json();
                })
                .then(result => {
                    if (result.message) {
                        alert(result.message);
                        selectedRows = []; // Clear selection
                        loadStitchingData(); // Refresh the table
                    } else {
                        alert('Error: ' + (result.error || 'Unknown error'));
                    }
                })
                .catch(error => {
                    alert('Error deleting stitching records: ' + error.message);
                });
            }
        }

        function viewImage(imageId) {
            // TODO: Implement image viewer
            alert('Image viewer will be implemented soon.');
        }

        function getApiBaseUrl() {
            const hostname = window.location.hostname;
            const port = window.location.port;
            const protocol = window.location.protocol;
            
            // Local development - Flask backend runs on port 8000
            if (hostname === 'localhost' || hostname === '127.0.0.1') {
                // If frontend is on port 3000, backend should be on 8000
                if (port === '3000') {
                    return 'http://localhost:8000';
                }
                // If frontend is on port 5000, backend is on 8000
                if (port === '5000') {
                    return 'http://localhost:8000';
                }
                // Default to port 8000 for local development
                return 'http://localhost:8000';
            }
            
            // Railway deployment - ensure HTTPS
            if (hostname.includes('railway.app') || hostname.includes('up.railway.app')) {
                return `https://${hostname}`;
            }
            
            // Other deployments - use same protocol and domain
            return window.location.origin;
        }



        function applyFilters() {
            loadStitchingData();
        }

        function clearFilters() {
            document.getElementById('filterPLNumber').value = '';
            document.getElementById('filterSerialNumber').value = '';
            document.getElementById('filterFabricName').value = '';
            document.getElementById('filterCustomer').value = '';
            document.getElementById('filterDateFrom').value = '';
            document.getElementById('filterDateTo').value = '';
            document.getElementById('showAllRecords').checked = true;
            loadStitchingData();
        }

        function refreshStitchingTable() {
            loadStitchingData();
        }

        function exportStitchingRecords() {
            // TODO: Implement export functionality
            alert('Export functionality will be implemented soon.');
        }



        function generatePackingList() {
            if (selectedRows.length === 0) {
                alert('Please select one or more stitching records to generate a packing list.');
                return;
            }
            
            // Get selected records
            const selectedRecords = selectedRows.map(index => stitchingData[index]);
            const stitchingIds = selectedRecords.map(record => record.id);
            
            // Create dialog for packing list options
            const dialogHtml = `
                <div id="packingListDialog" class="modal" style="display: block;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2 class="modal-title">Create Packing List</h2>
                            <span class="close" onclick="closePackingListDialog()">&times;</span>
                        </div>
                        <div class="modal-body">
                            <div style="margin-bottom: 15px;">
                                <label for="deliveryDate" style="display: block; margin-bottom: 5px; font-weight: bold;">Delivery Date:</label>
                                <input type="date" id="deliveryDate" value="${new Date().toISOString().split('T')[0]}" style="width: 100%; padding: 8px; border: 1px solid #555; background: #424242; color: #eceff1; border-radius: 4px;">
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label for="packingComments" style="display: block; margin-bottom: 5px; font-weight: bold;">Comments (optional):</label>
                                <textarea id="packingComments" placeholder="Enter any comments that will appear in the packing list header..." style="width: 100%; height: 80px; padding: 8px; border: 1px solid #555; background: #424242; color: #eceff1; border-radius: 4px; resize: vertical;"></textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="closePackingListDialog()">Cancel</button>
                            <button class="btn btn-primary" onclick="confirmPackingListCreation()">Create Packing List</button>
                        </div>
                    </div>
                </div>
            `;
            
            // Add dialog to page
            document.body.insertAdjacentHTML('beforeend', dialogHtml);
            
            // Store selected IDs globally for later use
            window.selectedStitchingIds = stitchingIds;
        }
        
        function closePackingListDialog() {
            const dialog = document.getElementById('packingListDialog');
            if (dialog) {
                dialog.remove();
            }
            window.selectedStitchingIds = null;
        }
        
        function confirmPackingListCreation() {
            const deliveryDate = document.getElementById('deliveryDate').value;
            const comments = document.getElementById('packingComments').value.trim();
            
            if (!window.selectedStitchingIds) {
                alert('No stitching records selected.');
                return;
            }
            
            const packingListData = {
                stitching_ids: window.selectedStitchingIds,
                delivery_date: deliveryDate,
                comments: comments
            };
            
            // Call the packing list generation API
            fetch(`${getApiBaseUrl()}/api/packing-lists/generate`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(packingListData)
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(errorData => {
                        throw new Error(errorData.error || 'Failed to create packing list');
                    });
                }
                return response.json();
            })
            .then(result => {
                if (result.message) {
                    alert(result.message);
                    selectedRows = []; // Clear selection
                    loadStitchingData(); // Refresh the table
                    closePackingListDialog();
                } else {
                    alert('Error: ' + (result.error || 'Unknown error'));
                }
            })
            .catch(error => {
                alert('Error generating packing list: ' + error.message);
            });
        }

        function deleteSelectedRecords() {
            if (selectedRows.length === 0) {
                alert('Please select one or more stitching records to delete.');
                return;
            }
            
            if (confirm(`Are you sure you want to delete ${selectedRows.length} selected stitching record(s)?`)) {
                // TODO: Implement bulk delete
                alert('Bulk delete functionality will be implemented soon.');
            }
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('stitchingDetailModal');
            if (event.target === modal) {
                closeStitchingDetailModal();
            }
        }

        function logout() {
            localStorage.removeItem('gms_logged_in');
            localStorage.removeItem('gms_username');
            window.location.href = 'login.html';
        }

        // Global variables for sorting
        let currentStitchingSortColumn = 0; // Default to created_at column
        let currentStitchingSortDirection = 'desc'; // Default to descending
        
        // Function to load stitching data with sorting
        async function loadStitchingData() {
            try {
                showLoading();
                
                // Build query parameters
                const params = new URLSearchParams();
                
                // Add filter parameters
                const plNumberFilter = document.getElementById('plNumberFilter').value;
                const serialNumberFilter = document.getElementById('serialNumberFilter').value;
                const fabricNameFilter = document.getElementById('fabricNameFilter').value;
                const customerFilter = document.getElementById('customerFilter').value;
                const dateFromFilter = document.getElementById('dateFromFilter').value;
                const dateToFilter = document.getElementById('dateToFilter').value;
                const deliveredOnlyFilter = document.getElementById('deliveredOnlyFilter').checked;
                const undeliveredOnlyFilter = document.getElementById('undeliveredOnlyFilter').checked;
                
                if (plNumberFilter) params.append('pl_number', plNumberFilter);
                if (serialNumberFilter) params.append('serial_number', serialNumberFilter);
                if (fabricNameFilter) params.append('fabric_name', fabricNameFilter);
                if (customerFilter) params.append('customer', customerFilter);
                if (dateFromFilter) params.append('date_from', dateFromFilter);
                if (dateToFilter) params.append('date_to', dateToFilter);
                if (deliveredOnlyFilter) params.append('delivered_only', 'true');
                if (undeliveredOnlyFilter) params.append('undelivered_only', 'true');
                
                // Add sorting parameters
                const sortColumnMapping = {
                    0: 'created_at',
                    1: 'stitching_invoice_number',
                    2: 'item_name',
                    3: 'quantity',
                    4: 'unit_price',
                    5: 'total_amount',
                    6: 'customer',
                    7: 'fabric_invoice_number',
                    8: 'tax_invoice_number',
                    9: 'packing_list_number'
                };
                
                const sortColumn = sortColumnMapping[currentStitchingSortColumn] || 'created_at';
                params.append('sort_column', sortColumn);
                params.append('sort_direction', currentStitchingSortDirection);
                
                const response = await fetch(`/api/stitching/?${params.toString()}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                // Clear existing data
                const tbody = document.querySelector('#stitchingTable tbody');
                tbody.innerHTML = '';
                
                // Populate table with sorted data from server
                data.forEach(item => {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${formatDate(item.created_at)}</td>
                        <td>${item.stitching_invoice_number}</td>
                        <td>${item.item_name}</td>
                        <td>${item.quantity}</td>
                        <td>${item.unit_price.toFixed(2)}</td>
                        <td>${item.total_amount.toFixed(2)}</td>
                        <td>${item.customer_name || ''}</td>
                        <td>${item.fabric_invoice_number || ''}</td>
                        <td>${item.tax_invoice_number || ''}</td>
                        <td>${item.packing_list_number || ''}</td>
                        <td>
                            <button onclick="editStitchingRecord(${item.id})" class="btn btn-sm btn-primary">Edit</button>
                            <button onclick="deleteStitchingRecord(${item.id})" class="btn btn-sm btn-danger">Delete</button>
                            <button onclick="uploadImage(${item.id})" class="btn btn-sm btn-success">Upload Image</button>
                        </td>
                    `;
                });
                
                updateStitchingSortArrows();
                hideLoading();
                
            } catch (error) {
                console.error('Error loading stitching data:', error);
                hideLoading();
                alert('Error loading data: ' + error.message);
            }
        }
        
        // Function to handle stitching column sorting
        function sortStitchingTable(columnIndex) {
            // Skip actions column (last column)
            if (columnIndex === 10) return;
            
            // If clicking the same column, toggle direction
            if (currentStitchingSortColumn === columnIndex) {
                currentStitchingSortDirection = currentStitchingSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                // New column, default to ascending
                currentStitchingSortColumn = columnIndex;
                currentStitchingSortDirection = 'asc';
            }
            
            // Reload data with new sorting
            loadStitchingData();
        }
        
        // Function to update stitching sort arrows in headers
        function updateStitchingSortArrows() {
            const headers = document.querySelectorAll('#stitchingTable th');
            headers.forEach((header, index) => {
                if (index === 10) return; // Skip actions column
                
                // Remove existing arrows
                header.textContent = header.textContent.replace(/[↑↓]/, '');
                
                // Add appropriate arrow
                if (index === currentStitchingSortColumn) {
                    const arrow = currentStitchingSortDirection === 'asc' ? ' ↑' : ' ↓';
                    header.textContent = header.textContent.replace(' ↕', '') + arrow;
                } else {
                    // Add neutral arrow for sortable columns
                    if (!header.textContent.includes(' ↕')) {
                        header.textContent = header.textContent.replace(/[↑↓]/, '') + ' ↕';
                    }
                }
            });
        }
    </script>
</body>
</html>
