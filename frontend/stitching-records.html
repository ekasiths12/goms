<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stitching Records - Garment Management System</title>
    <link rel="stylesheet" href="css/table-sorting.css">
    <style>
        :root {
            /* Dark theme (default) */
            --bg-primary: #212121;
            --bg-secondary: #2c2c2c;
            --bg-tertiary: #424242;
            --text-primary: #eceff1;
            --text-secondary: #b0bec5;
            --nav-bg: #23272f;
            --nav-border: #3949ab;
            --nav-active: #3949ab;
            --nav-hover: #3949ab;
            --border-color: #555;
            --focus-color: #5c6bc0;
            --card-bg: #2c2c2c;
            --chart-grid: #37474f;
        }

        [data-theme="light"] {
            /* Light theme */
            --bg-primary: #f5f5f5;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f8f9fa;
            --text-primary: #212121;
            --text-secondary: #666666;
            --nav-bg: #ffffff;
            --nav-border: #e0e0e0;
            --nav-active: #1976d2;
            --nav-hover: #f5f5f5;
            --border-color: #e0e0e0;
            --focus-color: #1976d2;
            --card-bg: #ffffff;
            --chart-grid: #e0e0e0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            font-size: 13px;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* Navigation Bar */
        .nav-bar {
            background: var(--nav-bg);
            border-bottom: 1px solid var(--nav-border);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            height: 60px;
            display: flex;
            align-items: center;
            padding: 0 20px;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .nav-tabs {
            display: flex;
            list-style: none;
            gap: 0;
        }

        .nav-tab {
            background: transparent;
            border: none;
            color: var(--text-primary);
            padding: 15px 25px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            text-decoration: none;
            display: inline-block;
        }

        .nav-tab:hover {
            background-color: var(--nav-hover);
            color: var(--text-primary);
        }

        .nav-tab.active {
            background-color: var(--nav-active);
            color: var(--text-primary);
            border-bottom-color: var(--focus-color);
        }

        .nav-user {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .nav-user span {
            color: var(--text-secondary);
            font-size: 12px;
        }

        /* Theme Toggle Button */
        .theme-toggle {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .theme-toggle:hover {
            background: var(--bg-secondary);
            border-color: var(--focus-color);
        }

        .theme-toggle .icon {
            font-size: 14px;
        }

        .logout-btn {
            background: #d32f2f;
            color: #fff;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: #f44336;
        }

        /* Main Content */
        .main-content {
            margin-top: 60px;
            padding: 20px;
            min-height: calc(100vh - 60px);
        }



        /* Filter Controls */
        .filter-controls {
            background: var(--card-bg);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .filter-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-group label {
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .filter-input {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 14px;
            min-width: 120px;
            transition: border-color 0.3s ease;
        }

        .filter-input:focus {
            outline: none;
            border-color: var(--focus-color);
        }

        .filter-select {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 14px;
            min-width: 120px;
            transition: border-color 0.3s ease;
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--focus-color);
        }

        .radio-group {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .radio-group input[type="radio"] {
            margin-right: 5px;
        }

        .radio-group label {
            color: var(--text-secondary);
            font-size: 12px;
            cursor: pointer;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: var(--focus-color);
            color: #fff;
        }

        .btn-primary:hover {
            background: var(--nav-active);
        }

        .btn-secondary {
            background: #757575;
            color: #fff;
        }

        .btn-secondary:hover {
            background: #9e9e9e;
        }

        .btn-success {
            background: #388e3c;
            color: #fff;
        }

        .btn-success:hover {
            background: #4caf50;
        }

        .btn-warning {
            background: #f57c00;
            color: #fff;
        }

        .btn-warning:hover {
            background: #ff9800;
        }

        .btn-danger {
            background: #d32f2f;
            color: #fff;
        }

        .btn-danger:hover {
            background: #f44336;
        }

        .btn-info {
            background: #1976d2;
            color: #fff;
        }

        .btn-info:hover {
            background: #2196f3;
        }

        /* Table Styles */
        .table-container {
            background: var(--card-bg);
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 10px;
            border: 1px solid var(--border-color);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        .data-table th {
            background: var(--nav-active);
            color: var(--text-primary);
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .data-table td {
            padding: 10px 8px;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-primary);
        }

        .data-table tr:hover {
            background: var(--bg-tertiary);
        }

        .data-table tr.selected {
            background: var(--focus-color) !important;
            color: var(--text-primary);
        }

        /* Pagination Styles */
        .table-container {
            max-height: 600px;
            overflow-y: auto;
            background: var(--card-bg);
            border-radius: 8px;
            margin-bottom: 10px;
            border: 1px solid var(--border-color);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .table-container::-webkit-scrollbar {
            width: 8px;
        }

        .table-container::-webkit-scrollbar-track {
            background: var(--bg-tertiary);
            border-radius: 4px;
        }

        .table-container::-webkit-scrollbar-thumb {
            background: var(--focus-color);
            border-radius: 4px;
        }

        .table-container::-webkit-scrollbar-thumb:hover {
            background: var(--nav-active);
        }

        .treeview-container::-webkit-scrollbar {
            width: 8px;
        }

        .treeview-container::-webkit-scrollbar-track {
            background: var(--bg-tertiary);
            border-radius: 4px;
        }

        .treeview-container::-webkit-scrollbar-thumb {
            background: var(--focus-color);
            border-radius: 4px;
        }

        .treeview-container::-webkit-scrollbar-thumb:hover {
            background: var(--nav-active);
        }

        .pagination-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--card-bg);
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
            border: 1px solid var(--border-color);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .pagination-info {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .pagination-buttons {
            display: flex;
            gap: 10px;
        }

        .pagination-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .pagination-btn:hover:not(:disabled) {
            background: var(--focus-color);
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination-btn.active {
            background: var(--focus-color);
            color: #fff;
        }

        /* Checkbox styling */
        .checkbox-wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .checkbox-wrapper input[type="checkbox"] {
            margin: 0;
            cursor: pointer;
            width: 16px;
            height: 16px;
            accent-color: #5c6bc0;
        }

        /* Make it clear that rows are not clickable */
        .data-table tr {
            cursor: default;
        }

        .data-table tr:hover {
            background: #424242 !important;
        }

        .data-table tr:hover td {
            background: #424242 !important;
        }

        /* Status badges */
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            text-transform: uppercase;
        }

        .status-billed {
            background: #4caf50;
            color: var(--text-primary);
        }

        .status-unbilled {
            background: #ff9800;
            color: var(--text-primary);
        }

        /* Image preview */
        .image-preview {
            width: 40px;
            height: 40px;
            border-radius: 4px;
            object-fit: cover;
            cursor: pointer;
            border: 1px solid var(--border-color);
        }

        .image-preview:hover {
            transform: scale(1.1);
            transition: transform 0.2s ease;
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
        }

        .modal-content {
            background-color: var(--card-bg);
            margin: 5% auto;
            padding: 20px;
            border-radius: 8px;
            width: 80%;
            max-width: 800px;
            max-height: 80%;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-title {
            color: var(--focus-color);
            font-size: 20px;
            font-weight: 600;
        }

        .close {
            color: var(--text-secondary);
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: var(--text-primary);
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
        }

        /* Detail sections */
        .detail-section {
            margin-bottom: 20px;
        }

        .detail-section h3 {
            color: var(--focus-color);
            margin-bottom: 10px;
            font-size: 16px;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .detail-item {
            background: var(--bg-tertiary);
            padding: 10px;
            border-radius: 4px;
            border: 1px solid var(--border-color);
        }

        .detail-label {
            color: var(--text-secondary);
            font-size: 12px;
            margin-bottom: 5px;
        }

        .detail-value {
            color: var(--text-primary);
            font-weight: 500;
        }

        /* Size quantities */
        .size-quantities {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .size-item {
            background: var(--bg-tertiary);
            padding: 8px;
            border-radius: 4px;
            text-align: center;
            border: 1px solid var(--border-color);
        }

        .size-label {
            color: var(--text-secondary);
            font-size: 11px;
            margin-bottom: 5px;
        }

        .size-value {
            color: var(--text-primary);
            font-weight: bold;
            font-size: 14px;
        }

        /* Treeview Styles */
        .treeview-container {
            background: var(--card-bg);
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 20px;
            max-height: 600px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .treeview-header {
            overflow-x: auto;
        }

        .treeview-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--card-bg);
            font-size: 12px;
        }

        .treeview-table th {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            padding: 8px 4px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            font-weight: 600;
            white-space: nowrap;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .treeview-table td {
            padding: 6px 4px;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-primary);
            white-space: nowrap;
        }

        .treeview-table tbody tr:hover {
            background: var(--bg-tertiary);
        }

        .treeview-table tbody tr.selected {
            background: var(--nav-active);
        }

        /* Parent row styling */
        .treeview-parent {
            background: var(--bg-secondary);
            font-weight: 500;
        }

        .treeview-parent:hover {
            background: var(--bg-tertiary);
        }

        /* Child row styling */
        .treeview-child {
            background: var(--card-bg);
            font-size: 11px;
        }

        .treeview-child:hover {
            background: var(--bg-tertiary);
        }

        .treeview-child td {
            padding-left: 20px;
            color: var(--text-secondary);
        }

        /* Expand/collapse indicator */
        .expand-indicator {
            cursor: pointer;
            color: var(--focus-color);
            font-weight: bold;
            margin-right: 5px;
        }

        .expand-indicator:hover {
            color: var(--nav-active);
        }

        /* Column widths matching Qt app */
        .treeview-table th:nth-child(1), .treeview-table td:nth-child(1) { width: 30px; } /* Checkbox */
        .treeview-table th:nth-child(2), .treeview-table td:nth-child(2) { width: 80px; } /* Created At */
        .treeview-table th:nth-child(3), .treeview-table td:nth-child(3) { width: 100px; } /* PL # */
        .treeview-table th:nth-child(4), .treeview-table td:nth-child(4) { width: 120px; } /* Serial # */
        .treeview-table th:nth-child(5), .treeview-table td:nth-child(5) { width: 100px; } /* Garment */
        .treeview-table th:nth-child(6), .treeview-table td:nth-child(6) { width: 70px; } /* Fabric */
        .treeview-table th:nth-child(7), .treeview-table td:nth-child(7) { width: 110px; } /* Color */
        .treeview-table th:nth-child(8), .treeview-table td:nth-child(8) { width: 100px; } /* Customer */
        .treeview-table th:nth-child(9), .treeview-table td:nth-child(9) { width: 100px; } /* Tax Inv # */
        .treeview-table th:nth-child(10), .treeview-table td:nth-child(10) { width: 100px; } /* Fabric Inv */
        .treeview-table th:nth-child(11), .treeview-table td:nth-child(11) { width: 100px; } /* Fabric DN */
        .treeview-table th:nth-child(12), .treeview-table td:nth-child(12) { width: 90px; } /* Fab Used */
        .treeview-table th:nth-child(13), .treeview-table td:nth-child(13) { width: 90px; } /* Fab Cost */
        .treeview-table th:nth-child(14), .treeview-table td:nth-child(14) { width: 130px; } /* Fab Value */
        .treeview-table th:nth-child(15), .treeview-table td:nth-child(15) { width: 35px; } /* S */
        .treeview-table th:nth-child(16), .treeview-table td:nth-child(16) { width: 35px; } /* M */
        .treeview-table th:nth-child(17), .treeview-table td:nth-child(17) { width: 35px; } /* L */
        .treeview-table th:nth-child(18), .treeview-table td:nth-child(18) { width: 40px; } /* XL */
        .treeview-table th:nth-child(19), .treeview-table td:nth-child(19) { width: 45px; } /* 2XL */
        .treeview-table th:nth-child(19), .treeview-table td:nth-child(19) { width: 45px; } /* 3XL */
        .treeview-table th:nth-child(20), .treeview-table td:nth-child(20) { width: 60px; } /* Total Qty */
        .treeview-table th:nth-child(21), .treeview-table td:nth-child(21) { width: 80px; } /* Cost */
        .treeview-table th:nth-child(22), .treeview-table td:nth-child(22) { width: 110px; } /* Price */
        .treeview-table th:nth-child(23), .treeview-table td:nth-child(23) { width: 60px; } /* Yd/Pcs */
        .treeview-table th:nth-child(24), .treeview-table td:nth-child(24) { width: 80px; } /* Grmt Cost */
        .treeview-table th:nth-child(25), .treeview-table td:nth-child(25) { width: 110px; } /* Created At */
        .treeview-table th:nth-child(26), .treeview-table td:nth-child(26) { width: 100px; } /* Actions */

        /* Responsive */
        @media (max-width: 768px) {
            .filter-row {
                flex-direction: column;
                align-items: stretch;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .pagination-controls {
                flex-direction: column;
                gap: 10px;
            }
            
            .detail-grid {
                grid-template-columns: 1fr;
            }
            
            .size-quantities {
                grid-template-columns: repeat(3, 1fr);
            }
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="nav-bar">
        <ul class="nav-tabs">
            <li><a href="fabric-invoices.html" class="nav-tab">Fabric Invoices</a></li>
            <li><a href="stitching-records.html" class="nav-tab active">Stitching Records</a></li>
            <li><a href="packing-lists.html" class="nav-tab">Packing Lists</a></li>
            <li><a href="group-bills.html" class="nav-tab">Group Bills</a></li>
            <li><a href="dashboard.html" class="nav-tab">Dashboard</a></li>
        </ul>
        <div class="nav-user">
            <button onclick="toggleTheme()" class="theme-toggle" id="themeToggle">
                <span class="icon" id="themeIcon">üåô</span>
                <span id="themeText">Dark</span>
            </button>
            <span id="currentUser"></span>
            <button onclick="logout()" class="logout-btn">Logout</button>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">

        <!-- Enhanced Filter Controls like Qt App -->
        <div class="filter-controls">
            <div class="filter-row">
                <div class="filter-group">
                    <label>PL#:</label>
                    <input type="text" id="filterPLNumber" class="filter-input" placeholder="Filter by PL#">
                </div>
                <div class="filter-group">
                    <label>Serial#:</label>
                    <input type="text" id="filterSerialNumber" class="filter-input" placeholder="Filter by Serial#">
                </div>
                <div class="filter-group">
                    <label>Fabric:</label>
                    <input type="text" id="filterFabricName" class="filter-input" placeholder="Filter by Fabric">
                </div>
                <div class="filter-group">
                    <label>Customer:</label>
                    <input type="text" id="filterCustomer" class="filter-input" placeholder="Filter by Customer">
                </div>
                <div class="filter-group">
                    <label>From:</label>
                    <input type="text" id="filterDateFrom" class="filter-input" placeholder="DD/MM/YY" oninput="formatDateInput(this)">
                </div>
                <div class="filter-group">
                    <label>To:</label>
                    <input type="text" id="filterDateTo" class="filter-input" placeholder="DD/MM/YY" oninput="formatDateInput(this)">
                </div>
                <div class="filter-group">
                    <label>Delivery Status:</label>
                    <div class="radio-group">
                        <input type="radio" id="showAllRecords" name="deliveryStatus" value="all" checked onchange="loadStitchingData()">
                        <label for="showAllRecords">All Records</label>
                        <input type="radio" id="showDelivered" name="deliveryStatus" value="delivered" onchange="loadStitchingData()">
                        <label for="showDelivered">Delivered Only</label>
                        <input type="radio" id="showUndelivered" name="deliveryStatus" value="undelivered" onchange="loadStitchingData()">
                        <label for="showUndelivered">Undelivered Only</label>
                    </div>
                </div>
                <div class="filter-group">
                    <button onclick="applyFilters()" class="btn btn-primary">Apply Filters</button>
                    <button onclick="clearFilters()" class="btn btn-secondary">Clear</button>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons">
            <button class="btn btn-primary" onclick="refreshStitchingTable()">Refresh</button>
            <button class="btn btn-success" onclick="exportStitchingRecords()">Export</button>
            <button class="btn btn-success" onclick="generatePackingList()">Generate Packing List</button>

            <button class="btn btn-danger" onclick="deleteSelectedStitchingRecords()">Delete Selected</button>
        </div>

        <!-- Stitching Records Treeview -->
        <div class="treeview-container">
            <div class="treeview-header">
                <table class="treeview-table" id="stitchingTreeview">
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="selectAllTree" onchange="toggleSelectAllTree()"></th>
                            <th class="sortable-header" data-sort="created_at">Created At</th>
                            <th class="sortable-header" data-sort="packing_list_number">PL #</th>
                            <th class="sortable-header" data-sort="serial_number">Serial #</th>
                            <th class="sortable-header" data-sort="garment">Garment</th>
                            <th class="sortable-header" data-sort="fabric">Fabric</th>
                            <th class="sortable-header" data-sort="color">Color</th>
                            <th class="sortable-header" data-sort="customer">Customer</th>
                            <th class="sortable-header" data-sort="tax_invoice_number">Beta T#</th>
                            <th class="sortable-header" data-sort="fabric_invoice">Fabric Inv.</th>
                            <th class="sortable-header" data-sort="fabric_delivery_note">Fabric DN.</th>
                            <th class="sortable-header" data-sort="fabric_used">Fab Used</th>
                            <th class="sortable-header" data-sort="fabric_cost">Fab Cost</th>
                            <th class="sortable-header" data-sort="fabric_value">Fab Value</th>
                            <th class="sortable-header" data-sort="size_s">S</th>
                            <th class="sortable-header" data-sort="size_m">M</th>
                            <th class="sortable-header" data-sort="size_l">L</th>
                            <th class="sortable-header" data-sort="size_xl">XL</th>
                            <th class="sortable-header" data-sort="size_xxl" style="width: 45px;">2XL</th>
                            <th class="sortable-header" data-sort="size_xxxl" style="width: 45px;">3XL</th>
                            <th class="sortable-header" data-sort="total_qty">Total Qty</th>
                            <th class="sortable-header" data-sort="sewing_cost">Cost</th>
                            <th class="sortable-header" data-sort="sewing_price">Price</th>
                            <th class="sortable-header" data-sort="sewing_profit">Profit</th>
                            <th class="sortable-header" data-sort="sewing_value">Value</th>
                            <th class="sortable-header" data-sort="sewing_earning">Earnings</th>
                            <th class="sortable-header" data-sort="yards_per_piece">Yd/Pcs</th>
                            <th class="sortable-header" data-sort="garment_cost">Grmt Cost</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="stitchingTreeviewBody">
                        <tr>
                            <td colspan="29" style="text-align: center; padding: 20px; color: var(--text-secondary);">Loading stitching records...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Pagination Controls -->
        <div class="pagination-controls">
            <div class="pagination-info">
                Showing <span id="currentPageInfo">0-0</span> of <span id="totalRecords">0</span> records
            </div>
            <div class="pagination-buttons">
                <button class="pagination-btn" onclick="goToPage(1)" id="firstPage">First</button>
                <button class="pagination-btn" onclick="goToPage(currentPage - 1)" id="prevPage">Previous</button>
                <span id="pageNumbers"></span>
                <button class="pagination-btn" onclick="goToPage(currentPage + 1)" id="nextPage">Next</button>
                <button class="pagination-btn" onclick="goToPage(totalPages)" id="lastPage">Last</button>
            </div>
        </div>
    </main>

    <!-- Stitching Record Detail Modal -->
    <div id="stitchingDetailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Stitching Record Details</h2>
                <span class="close" onclick="closeStitchingDetailModal()">&times;</span>
            </div>
            <div class="modal-body" id="stitchingDetailContent">
                <!-- Content will be populated dynamically -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeStitchingDetailModal()">Close</button>
                <button class="btn btn-warning" onclick="toggleAmendMode()">Amend</button>
                <button class="btn btn-primary" onclick="confirmAmendStitchingRecord()" style="display: none;">Confirm Amendment</button>
                <button class="btn btn-danger" onclick="deleteStitchingRecord()">Delete Record</button>
            </div>
        </div>
    </div>

    <!-- Image Modal for Full Size View -->
    <div id="imageModal" class="modal">
        <div class="modal-content" style="max-width: 90%; max-height: 90%; padding: 10px;">
            <div class="modal-header">
                <h2 class="modal-title" id="imageModalTitle">Image</h2>
                <span class="close" onclick="closeImageModal()">&times;</span>
            </div>
            <div class="modal-body" style="text-align: center; padding: 10px;">
                <img id="fullSizeImage" src="" alt="Full Size Image" style="max-width: 100%; max-height: 70vh; border-radius: 4px;">
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeImageModal()">Close</button>
            </div>
        </div>
    </div>

    <script>
        // Stitching Records Functions
        let stitchingData = [];
        let selectedRows = [];
        let currentPage = 1;
        const itemsPerPage = 50;
        let currentStitchingRecord = null;


        // Check authentication
        function checkAuth() {
            const isLoggedIn = localStorage.getItem('gms_logged_in');
            if (isLoggedIn !== 'true') {
                window.location.href = 'login.html';
                return false;
            }
            return true;
        }

        // Load data when page loads
        window.addEventListener('load', async () => {
            console.log('üîÑ Stitching Records page loaded');
            
            // Check authentication first
            if (!checkAuth()) {
                return;
            }
            
            // Display current user
            const username = localStorage.getItem('gms_username');
            document.getElementById('currentUser').textContent = `Welcome, ${username}`;
            
            // Set default filter to undelivered items
            const undeliveredRadio = document.querySelector('input[name="deliveryStatus"][value="undelivered"]');
            if (undeliveredRadio) {
                undeliveredRadio.checked = true;
                console.log('‚úÖ Set default filter to undelivered items');
            }
            
            await loadStitchingData();
        });

        function formatDateForAPI(dateString) {
            if (!dateString) return '';
            // Convert DD/MM/YY to YYYY-MM-DD
            const parts = dateString.split('/');
            if (parts.length === 3) {
                const day = parts[0];
                const month = parts[1];
                const year = parts[2];
                // Ensure year is 4 digits (assume 20xx for YY format)
                const fullYear = year.length === 2 ? '20' + year : year;
                return `${fullYear}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
            }
            return dateString;
        }

        function formatDateInput(input) {
            // Auto-format date input to DD/MM/YY format (like old Qt app)
            let text = input.value;
            // Remove any non-digit characters
            let digitsOnly = text.replace(/\D/g, '');
            
            // Format as DD/MM/YY
            let formatted = "";
            if (digitsOnly.length >= 1) {
                formatted += digitsOnly.slice(0, 2);
            }
            if (digitsOnly.length >= 3) {
                formatted += "/" + digitsOnly.slice(2, 4);
            }
            if (digitsOnly.length >= 5) {
                formatted += "/" + digitsOnly.slice(4, 6);
            }
            
            // Update text if different
            if (formatted !== text) {
                input.value = formatted;
            }
        }

        async function loadStitchingData() {
            console.log('üîÑ loadStitchingData called');
            
            const tbody = document.getElementById('stitchingTreeviewBody');
            if (!tbody) {
                console.error('‚ùå Stitching table body not found');
                return;
            }
            
            console.log('‚úÖ Found stitching table body, showing loading state');
            tbody.innerHTML = '<tr><td colspan="26" style="text-align: center; padding: 20px; color: var(--text-secondary);">Loading stitching records...</td></tr>';
            
            try {
                // Build query parameters from filters
                const params = new URLSearchParams();
                
                const plNumberFilter = document.getElementById('filterPLNumber')?.value;
                const serialNumberFilter = document.getElementById('filterSerialNumber')?.value;
                const fabricNameFilter = document.getElementById('filterFabricName')?.value;
                const customerFilter = document.getElementById('filterCustomer')?.value;
                const dateFrom = document.getElementById('filterDateFrom')?.value;
                const dateTo = document.getElementById('filterDateTo')?.value;
                const deliveryStatusFilter = document.querySelector('input[name="deliveryStatus"]:checked')?.value;
                
                if (plNumberFilter) params.append('pl_number', plNumberFilter);
                if (serialNumberFilter) params.append('serial_number', serialNumberFilter);
                if (fabricNameFilter) params.append('fabric_name', fabricNameFilter);
                if (customerFilter) params.append('customer', customerFilter);
                if (dateFrom) params.append('date_from', formatDateForAPI(dateFrom));
                if (dateTo) params.append('date_to', formatDateForAPI(dateTo));
                if (deliveryStatusFilter === 'delivered') params.append('delivered_only', 'true');
                if (deliveryStatusFilter === 'undelivered') params.append('undelivered_only', 'true');
                
                console.log('üåê Fetching /api/stitching with filters...');
                const apiBaseUrl = getApiBaseUrl();
                const apiUrl = `${apiBaseUrl}/api/stitching?${params.toString()}`;
                console.log('üåê Full API URL:', apiUrl);
                
                const response = await fetch(apiUrl, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                });
                
                console.log('üì° Response status:', response.status);
                
                if (response.ok) {
                    stitchingData = await response.json();
                    console.log('üìä Received stitching data:', stitchingData.length, 'records');
                    currentPage = 1; // Reset to first page when new data is loaded
                    populateStitchingTreeview();
                } else {
                    console.error('‚ùå Failed to load stitching data, status:', response.status);
                    const errorText = await response.text();
                    console.error('‚ùå Error response:', errorText);
                    tbody.innerHTML = '<tr><td colspan="29" style="text-align: center; padding: 20px; color: #f44336;">Failed to load stitching data. Please try refreshing the page.</td></tr>';
                }
            } catch (error) {
                console.error('‚ùå Error loading stitching data:', error);
                tbody.innerHTML = '<tr><td colspan="29" style="text-align: center; padding: 20px; color: #f44336;">Error loading stitching data. Please check your connection and try again.</td></tr>';
            }
        }

        function populateStitchingTreeview() {
            console.log('üîÑ populateStitchingTreeview called with', stitchingData.length, 'records');
            const tbody = document.getElementById('stitchingTreeviewBody');
            tbody.innerHTML = '';

            if (stitchingData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="29" style="text-align: center; padding: 20px; color: var(--text-secondary);">No stitching records found. Try creating some stitching records from the Fabric Invoices page.</td></tr>';
                updatePaginationControls();
                return;
            }

            // Calculate pagination
            const totalPages = Math.ceil(stitchingData.length / itemsPerPage);
            if (currentPage > totalPages && totalPages > 0) {
                currentPage = totalPages;
            }
            
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, stitchingData.length);
            const pageData = stitchingData.slice(startIndex, endIndex);

            // Populate treeview
            pageData.forEach((record, pageIndex) => {
                const actualIndex = startIndex + pageIndex;
                
                // Create parent row
                const parentRow = document.createElement('tr');
                parentRow.className = 'treeview-parent';
                parentRow.setAttribute('data-record-id', record.id);

                
                // Calculate values like Qt app
                let sizeQty = {};
                if (record.size_qty_json) {
                    try {
                        // Parse the JSON string from the database
                        sizeQty = JSON.parse(record.size_qty_json.replace(/'/g, '"'));
                    } catch (e) {
                        console.error('Error parsing size_qty_json:', e, record.size_qty_json);
                        sizeQty = {};
                    }
                }
                const totalQty = Object.values(sizeQty).reduce((sum, qty) => sum + (parseInt(qty) || 0), 0);
                const fabricUnitPrice = parseFloat(record.fabric_unit_price) || 0;
                const yardsConsumed = record.yard_consumed || 0;
                const fabricValue = fabricUnitPrice * yardsConsumed;
                
                // Calculate VAT-inclusive price
                const basePrice = record.price || 0;
                const addVat = record.add_vat || false;
                const vatInclusivePrice = addVat ? basePrice * 1.07 : basePrice;
                
                // Calculate yards per piece
                const yardsPerPiece = totalQty > 0 ? yardsConsumed / totalQty : 0;
                
                // Calculate garment cost per piece (like Qt app)
                // Get main fabric cost
                const mainFabricCost = fabricValue;
                
                // Get multi-fabric costs
                const multiFabricCost = record.garment_fabrics ? 
                    record.garment_fabrics.reduce((sum, fabric) => sum + (parseFloat(fabric.total_fabric_cost) || 0), 0) : 0;
                
                // Get lining costs
                const liningCost = record.lining_fabrics ? 
                    record.lining_fabrics.reduce((sum, lining) => sum + (parseFloat(lining.total_cost) || 0), 0) : 0;
                
                // Calculate total fabric cost (main + multi + lining)
                const totalFabricCost = mainFabricCost + multiFabricCost + liningCost;
                
                // Calculate fabric cost per piece
                const fabricCostPerGarment = totalQty > 0 ? totalFabricCost / totalQty : 0;
                
                // Stitching cost per piece (with VAT if applicable)
                const sewingPrice = record.price || 0;
                let sewingCostPerGarment;
                if (record.add_vat) {
                    const baseSewingCost = parseFloat(sewingPrice);
                    const vatAmount = baseSewingCost * 0.07;
                    sewingCostPerGarment = baseSewingCost + vatAmount;
                } else {
                    sewingCostPerGarment = parseFloat(sewingPrice);
                }
                
                // Total cost per piece
                const garmentCostPerPiece = fabricCostPerGarment + sewingCostPerGarment;
                
                // Format date
                const createdDate = record.created_at ? new Date(record.created_at).toLocaleDateString('en-GB') : '';
                
                // Check if record has multi-fabrics or lining
                const hasMultiFabrics = record.garment_fabrics && record.garment_fabrics.length > 0;
                const hasLining = record.lining_fabrics && record.lining_fabrics.length > 0;
                const isExpandable = hasMultiFabrics || hasLining;
                
                // Create expand indicator
                const expandIndicator = isExpandable ? 
                    `<span class="expand-indicator" onclick="event.stopPropagation(); toggleRecordExpansion(${record.id})">‚ñ∂</span>` : '';
                
                const isSelected = selectedRows.includes(actualIndex);
                console.log(`üîç Row ${actualIndex}: isSelected = ${isSelected}, selectedRows = [${selectedRows.join(', ')}]`);
                
                parentRow.innerHTML = `
                    <td><input type="checkbox" onchange="event.stopPropagation(); toggleRowSelection(${actualIndex})" ${isSelected ? 'checked' : ''}></td>
                    <td>${createdDate}</td>
                    <td>${record.packing_list_number || ''}</td>
                    <td>${expandIndicator}${record.stitching_invoice_number || ''}</td>
                    <td>${record.stitched_item || ''}</td>
                    <td>${record.item_name || ''}</td>
                    <td>${record.color || ''}</td>
                    <td>${record.customer_name || ''}</td>
                    <td>${record.tax_invoice_number || ''}</td>
                    <td>${record.fabric_invoice_number || ''}</td>
                    <td>${record.delivery_note || ''}</td>
                    <td>${yardsConsumed.toFixed(2)}</td>
                    <td>${fabricUnitPrice.toFixed(2)}</td>
                    <td>${fabricValue.toFixed(2)}</td>
                    <td>${sizeQty.S || 0}</td>
                    <td>${sizeQty.M || 0}</td>
                    <td>${sizeQty.L || 0}</td>
                    <td>${sizeQty.XL || 0}</td>
                    <td>${sizeQty.XXL || 0}</td>
                    <td>${sizeQty.XXXL || 0}</td>
                    <td>${totalQty}</td>
                    <td>${(record.stitching_cost || 0).toFixed(2)}</td>
                    <td>${vatInclusivePrice.toFixed(2)}</td>
                    <td>${(record.stitching_profit || 0).toFixed(2)}</td>
                    <td>${record.total_value.toFixed(2)}</td>
                    <td>${((record.stitching_profit || 0) * totalQty).toFixed(2)}</td>
                    <td>${yardsPerPiece.toFixed(3)}</td>
                    <td>${garmentCostPerPiece.toFixed(2)}</td>
                    <td>
                        <button onclick="event.stopPropagation(); viewStitchingDetail(${record.id})" class="btn btn-primary" style="padding: 4px 8px; font-size: 11px;">View</button>
                        <button onclick="event.stopPropagation(); deleteStitchingRecord(${record.id})" class="btn btn-danger" style="padding: 4px 8px; font-size: 11px;">Delete</button>
                    </td>
                `;
                tbody.appendChild(parentRow);
                
                // Add child rows for multi-fabrics and lining (initially hidden)
                if (isExpandable) {
                    // Add multi-fabric child rows
                    if (hasMultiFabrics) {
                        record.garment_fabrics.forEach(fabric => {
                            const childRow = createFabricChildRow(record, fabric, 'multi_fabric');
                            childRow.style.display = 'none';
                            childRow.setAttribute('data-parent-id', record.id);
                            tbody.appendChild(childRow);
                        });
                    }
                    
                    // Add lining child rows
                    if (hasLining) {
                        record.lining_fabrics.forEach(lining => {
                            const childRow = createLiningChildRow(record, lining);
                            childRow.style.display = 'none';
                            childRow.setAttribute('data-parent-id', record.id);
                            tbody.appendChild(childRow);
                        });
                    }
                }
            });

            console.log('‚úÖ Stitching treeview populated with', pageData.length, 'rows (page', currentPage, 'of', totalPages, ')');
            updatePaginationControls();
            updateSelectAllCheckbox();
        }
        
        function createFabricChildRow(parentRecord, fabric, type) {
            const childRow = document.createElement('tr');
            childRow.className = 'treeview-child';
            childRow.setAttribute('data-type', type);
            
            let sizeQty = {};
            if (parentRecord.size_qty_json) {
                try {
                    sizeQty = JSON.parse(parentRecord.size_qty_json.replace(/'/g, '"'));
                } catch (e) {
                    console.error('Error parsing size_qty_json:', e, parentRecord.size_qty_json);
                    sizeQty = {};
                }
            }
            const totalQty = Object.values(sizeQty).reduce((sum, qty) => sum + (parseInt(qty) || 0), 0);
            const yardsPerPiece = totalQty > 0 ? fabric.consumption_yards / totalQty : 0;
            
            childRow.innerHTML = `
                <td></td>
                <td></td>
                <td></td>
                <td>  ‚îî‚îÄ ${fabric.fabric_name || ''}</td>
                <td></td>
                <td>${fabric.fabric_name || ''}</td>
                <td>${fabric.color || ''}</td>
                <td></td>
                <td></td>
                <td>${fabric.invoice_number || ''}</td>
                <td></td>
                <td>${parseFloat(fabric.consumption_yards).toFixed(2)}</td>
                <td>${parseFloat(fabric.unit_price).toFixed(2)}</td>
                <td>${parseFloat(fabric.total_fabric_cost).toFixed(2)}</td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td>${yardsPerPiece.toFixed(3)}</td>
                <td></td>
                <td></td>
            `;
            
            return childRow;
        }
        
        function createLiningChildRow(parentRecord, lining) {
            const childRow = document.createElement('tr');
            childRow.className = 'treeview-child';
            childRow.setAttribute('data-type', 'lining');
            
            let sizeQty = {};
            if (parentRecord.size_qty_json) {
                try {
                    sizeQty = JSON.parse(parentRecord.size_qty_json.replace(/'/g, '"'));
                } catch (e) {
                    console.error('Error parsing size_qty_json:', e, parentRecord.size_qty_json);
                    sizeQty = {};
                }
            }
            const totalQty = Object.values(sizeQty).reduce((sum, qty) => sum + (parseInt(qty) || 0), 0);
            const yardsPerPiece = totalQty > 0 ? lining.consumption_yards / totalQty : 0;
            
            childRow.innerHTML = `
                <td></td>
                <td></td>
                <td></td>
                <td>  ‚îî‚îÄ ${lining.lining_name || ''}</td>
                <td></td>
                <td>${lining.lining_name || ''}</td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td>${parseFloat(lining.consumption_yards).toFixed(2)}</td>
                <td>${parseFloat(lining.unit_price).toFixed(2)}</td>
                <td>${parseFloat(lining.total_cost).toFixed(2)}</td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td>${yardsPerPiece.toFixed(3)}</td>
                <td></td>
                <td></td>
            `;
            
            return childRow;
        }
        
        function toggleRecordExpansion(recordId) {
            const parentRow = document.querySelector(`tr[data-record-id="${recordId}"]`);
            const childRows = document.querySelectorAll(`tr[data-parent-id="${recordId}"]`);
            const expandIndicator = parentRow.querySelector('.expand-indicator');
            
            const isExpanded = childRows[0] && childRows[0].style.display !== 'none';
            
            childRows.forEach(row => {
                row.style.display = isExpanded ? 'none' : '';
            });
            
            if (expandIndicator) {
                expandIndicator.textContent = isExpanded ? '‚ñ∂' : '‚ñº';
            }
        }
        

        

        

        

        

        

        
        async function confirmAmendStitchingRecord() {
            if (!currentStitchingRecord) {
                alert('No stitching record selected for amendment.');
                return;
            }
            
            // Validate inputs
            const stitchedItem = document.getElementById('amendStitchedItem').value.trim();
            const price = parseFloat(document.getElementById('amendPrice').value) || 0;
            
            if (!stitchedItem) {
                alert('Please enter a stitched item name.');
                return;
            }
            
            if (price <= 0) {
                alert('Please enter a valid price.');
                return;
            }
            
            // Collect size quantities
            const sizeQty = {};
            ['S', 'M', 'L', 'XL', 'XXL', 'XXXL'].forEach(size => {
                const qty = parseInt(document.getElementById(`amendSize${size}`).value) || 0;
                if (qty > 0) sizeQty[size] = qty;
            });
            
            const totalQty = Object.values(sizeQty).reduce((sum, qty) => sum + qty, 0);
            if (totalQty === 0) {
                alert('Please enter quantities for at least one size.');
                return;
            }
            
            // Collect fabric consumption
            const fabricConsumption = {};
            if (document.getElementById('amendMainFabricConsumption')) {
                fabricConsumption.main = parseFloat(document.getElementById('amendMainFabricConsumption').value) || 0;
            }
            
            // Collect multi-fabric consumption
            const multiFabricConsumption = [];
            if (currentStitchingRecord.garment_fabrics) {
                currentStitchingRecord.garment_fabrics.forEach((fabric, index) => {
                    const consumption = parseFloat(document.getElementById(`amendMultiFabric${index}`).value) || 0;
                    multiFabricConsumption.push({
                        id: fabric.id,
                        consumption_yards: consumption
                    });
                });
            }
            
            // Collect lining consumption
            const liningConsumption = [];
            if (currentStitchingRecord.lining_fabrics) {
                currentStitchingRecord.lining_fabrics.forEach((lining, index) => {
                    const consumption = parseFloat(document.getElementById(`amendLining${index}`).value) || 0;
                    liningConsumption.push({
                        id: lining.id,
                        consumption_yards: consumption
                    });
                });
            }
            
            // Prepare amendment data
            const amendmentData = {
                stitched_item: stitchedItem,
                price: price,
                add_vat: document.getElementById('amendAddVat').checked,
                size_qty: sizeQty,
                fabric_consumption: fabricConsumption,
                multi_fabric_consumption: multiFabricConsumption,
                lining_consumption: liningConsumption
            };
            
            try {
                const response = await fetch(`${getApiBaseUrl()}/api/stitching/${currentStitchingRecord.id}/amend`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(amendmentData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    alert('Stitching record amended successfully!');
                    closeStitchingDetailModal();
                    loadStitchingData(); // Refresh the data
                } else {
                    const error = await response.json();
                    alert(`Error amending stitching record: ${error.error}`);
                }
            } catch (error) {
                console.error('Error amending stitching record:', error);
                alert('Error amending stitching record.');
            }
        }

        function updatePaginationControls() {
            const totalPages = Math.ceil(stitchingData.length / itemsPerPage);
            const startRecord = (currentPage - 1) * itemsPerPage + 1;
            const endRecord = Math.min(currentPage * itemsPerPage, stitchingData.length);
            
            // Update info
            document.getElementById('currentPageInfo').textContent = `${startRecord}-${endRecord}`;
            document.getElementById('totalRecords').textContent = stitchingData.length;
            
            // Update buttons
            document.getElementById('firstPage').disabled = currentPage === 1;
            document.getElementById('prevPage').disabled = currentPage === 1;
            document.getElementById('nextPage').disabled = currentPage === totalPages;
            document.getElementById('lastPage').disabled = currentPage === totalPages;
            
            // Update page numbers
            const pageNumbers = document.getElementById('pageNumbers');
            pageNumbers.innerHTML = '';
            
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
            
            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }
            
            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.className = `pagination-btn ${i === currentPage ? 'active' : ''}`;
                pageBtn.textContent = i;
                pageBtn.onclick = () => goToPage(i);
                pageNumbers.appendChild(pageBtn);
            }
        }

        function goToPage(page) {
            const totalPages = Math.ceil(stitchingData.length / itemsPerPage);
            if (page >= 1 && page <= totalPages) {
                currentPage = page;
                populateStitchingTreeview();
            }
        }



        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('#stitchingTableBody input[type="checkbox"]');
            
            checkboxes.forEach((checkbox, index) => {
                const actualIndex = (currentPage - 1) * itemsPerPage + index;
                if (selectAllCheckbox.checked) {
                    checkbox.checked = true;
                    if (!selectedRows.includes(actualIndex)) {
                        selectedRows.push(actualIndex);
                    }
                } else {
                    checkbox.checked = false;
                    selectedRows = selectedRows.filter(i => i !== actualIndex);
                }
            });
        }
      
        function toggleSelectAllTree() {
            const selectAllCheckbox = document.getElementById('selectAllTree');
            const checkboxes = document.querySelectorAll('#stitchingTreeviewBody input[type="checkbox"]');
            
            console.log('üîç toggleSelectAllTree called, selectAllCheckbox.checked:', selectAllCheckbox.checked);
            
            // Convert NodeList to Array for forEach method
            const checkboxesArray = Array.from(checkboxes);
            checkboxesArray.forEach((checkbox, index) => {
                const actualIndex = (currentPage - 1) * itemsPerPage + index;
                if (selectAllCheckbox.checked) {
                    checkbox.checked = true;
                    if (!selectedRows.includes(actualIndex)) {
                        selectedRows.push(actualIndex);
                    }
                } else {
                    checkbox.checked = false;
                    selectedRows = selectedRows.filter(i => i !== actualIndex);
                }
            });
            
            console.log('üìã Updated selectedRows:', selectedRows);
        }

        function toggleRowSelection(actualIndex) {
            console.log('üîç toggleRowSelection called with actualIndex:', actualIndex);
            console.log('üìã Current selectedRows:', selectedRows);
            
            if (selectedRows.includes(actualIndex)) {
                // Remove from selection
                selectedRows = selectedRows.filter(i => i !== actualIndex);
                console.log('‚ùå Removed from selection, new selectedRows:', selectedRows);
            } else {
                // Add to selection
                selectedRows.push(actualIndex);
                console.log('‚úÖ Added to selection, new selectedRows:', selectedRows);
            }
            
            // Update the checkbox state
            const checkboxes = document.querySelectorAll('#stitchingTreeviewBody input[type="checkbox"]');
            checkboxes.forEach((checkbox, index) => {
                const checkboxActualIndex = (currentPage - 1) * itemsPerPage + index;
                if (checkboxActualIndex === actualIndex) {
                    checkbox.checked = selectedRows.includes(actualIndex);
                }
            });
            
            // Update select all checkbox
            updateSelectAllCheckbox();
        }

        function updateSelectAllCheckbox() {
            const checkboxes = document.querySelectorAll('#stitchingTreeviewBody input[type="checkbox"]');
            const selectAllCheckbox = document.getElementById('selectAllTree');
            
            if (checkboxes.length === 0) {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;
                return;
            }
            
            // Convert NodeList to Array for filter method
            const checkboxesArray = Array.from(checkboxes);
            const checkedCount = checkboxesArray.filter(checkbox => checkbox.checked).length;
            
            if (checkedCount === 0) {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;
            } else if (checkedCount === checkboxes.length) {
                selectAllCheckbox.checked = true;
                selectAllCheckbox.indeterminate = false;
            } else {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = true;
            }
        }

        function applyFilters() {
            loadStitchingData();
        }

        function clearFilters() {
            document.getElementById('filterPLNumber').value = '';
            document.getElementById('filterSerialNumber').value = '';
            document.getElementById('filterFabricName').value = '';
            document.getElementById('filterCustomer').value = '';
            document.getElementById('filterDateFrom').value = '';
            document.getElementById('filterDateTo').value = '';
            document.getElementById('showAllRecords').checked = true;
            loadStitchingData();
        }

        function refreshStitchingTable() {
            loadStitchingData();
        }

        function exportStitchingRecords() {
            // TODO: Implement export functionality
            alert('Export functionality will be implemented soon.');
        }

        function groupAndBill() {
            if (selectedRows.length === 0) {
                alert('Please select one or more unbilled stitching records to group and bill.');
                return;
            }
            
            // TODO: Implement group and bill functionality
            alert('Group and Bill functionality will be implemented soon.');
        }

        function deleteSelectedRecords() {
            if (selectedRows.length === 0) {
                alert('Please select one or more stitching records to delete.');
                return;
            }
            
            if (confirm(`Are you sure you want to delete ${selectedRows.length} selected stitching record(s)?`)) {
                // TODO: Implement bulk delete
                alert('Bulk delete functionality will be implemented soon.');
            }
        }

        let isAmendMode = false;
        
        async function viewStitchingDetail(recordId) {
            try {
                const response = await fetch(`${getApiBaseUrl()}/api/stitching/${recordId}`);
                if (response.ok) {
                    const record = await response.json();
                    currentStitchingRecord = record;
                    showStitchingDetailModal(record);
                } else {
                    alert('Error loading stitching record details.');
                }
            } catch (error) {
                console.error('Error loading stitching record:', error);
                alert('Error loading stitching record details.');
            }
        }

        function showStitchingDetailModal(record) {
            const modal = document.getElementById('stitchingDetailModal');
            const content = document.getElementById('stitchingDetailContent');
            
            // Parse size_qty_json for the record
            let sizeQty = {};
            if (record.size_qty_json) {
                try {
                    sizeQty = JSON.parse(record.size_qty_json.replace(/'/g, '"'));
                } catch (e) {
                    console.error('Error parsing size_qty_json:', e, record.size_qty_json);
                    sizeQty = {};
                }
            }
            
            // Format size quantities using the parsed sizeQty
            const sizeQuantitiesHtml = Object.entries(sizeQty).map(([size, qty]) => `
                <div class="size-item">
                    <div class="size-label">${size}</div>
                    <div class="size-value">${qty}</div>
                </div>
            `).join('');
            
            // Format lining fabrics
            const liningFabricsHtml = record.lining_fabrics && record.lining_fabrics.length > 0 ? 
                record.lining_fabrics.map(lining => `
                    <tr>
                        <td>${lining.lining_name}</td>
                        <td>${lining.consumption_yards.toFixed(2)}</td>
                        <td>${lining.unit_price.toFixed(2)}</td>
                        <td>${lining.total_cost.toFixed(2)}</td>
                    </tr>
                `).join('') : '<tr><td colspan="4" style="text-align: center; color: var(--text-secondary);">No lining fabrics</td></tr>';
            
            // Format garment fabrics
            const garmentFabricsHtml = record.garment_fabrics && record.garment_fabrics.length > 0 ? 
                record.garment_fabrics.map(fabric => `
                    <tr>
                        <td>${fabric.fabric_name || 'N/A'}</td>
                        <td>${fabric.color || 'N/A'}</td>
                        <td>${fabric.invoice_number || 'N/A'}</td>
                        <td>${fabric.consumption_yards.toFixed(2)}</td>
                        <td>${fabric.unit_price.toFixed(2)}</td>
                        <td>${fabric.total_fabric_cost.toFixed(2)}</td>
                    </tr>
                `).join('') : '<tr><td colspan="6" style="text-align: center; color: var(--text-secondary);">No additional fabrics</td></tr>';
            
            // Format image section
            console.log('üîç Image data:', record.image);
            
            let imageHtml = '';
            if (record.image && record.image.id) {
                console.log('üîç Image ID:', record.image.id);
                console.log('üîç Image URL:', record.image.image_url);
                console.log('üîç Image filename:', record.image.filename);
                
                // Use the new image serving endpoint
                const apiBaseUrl = getApiBaseUrl();
                const imageUrl = `${apiBaseUrl}/api/images/serve/${record.image.id}`;
                
                console.log('üîç API Base URL:', apiBaseUrl);
                console.log('üîç Image ID:', record.image.id);
                console.log('üîç Final image URL:', imageUrl);
                
                // Test the URL immediately
                fetch(imageUrl, { method: 'HEAD' })
                    .then(response => {
                        console.log('üîç Image URL test response:', response.status, response.statusText);
                    })
                    .catch(error => {
                        console.log('üîç Image URL test error:', error);
                    });
                
                imageHtml = `
                    <div class="detail-section">
                        <h3>Uploaded Image</h3>
                        <div style="text-align: center; margin: 20px 0;">
                            <img src="${imageUrl}" 
                                 alt="Stitching Record Image" 
                                 style="max-width: 50%; max-height: 200px; border-radius: 8px; border: 1px solid var(--border-color); cursor: pointer; display: block; margin: 0 auto;"
                                 onclick="openImageModal('${imageUrl}', '${record.image.filename || 'Stitching Image'}')"
                                 title="Click to view full size"
                                 onload="console.log('‚úÖ Image loaded successfully:', this.src); this.style.border='2px solid green';"
                                 onerror="console.log('‚ùå Image failed to load:', this.src); this.style.display='none'; this.nextElementSibling.style.display='block';">
                            <div style="margin-top: 10px; color: var(--text-secondary); font-size: 12px;">
                                ${record.image.filename || 'Image'} - Click to view full size
                            </div>
                            <div style="display: none; margin-top: 10px; color: #f44336; font-size: 12px;">
                                Image could not be loaded. URL: ${imageUrl}
                            </div>

                            <div style="margin-top: 10px; color: var(--text-secondary); font-size: 10px;">
                                <a href="${imageUrl}" target="_blank">Open image in new tab</a>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                imageHtml = `
                    <div class="detail-section">
                        <h3>Uploaded Image</h3>
                        <div style="text-align: center; margin: 20px 0; color: var(--text-secondary);">
                            No image uploaded for this stitching record
                        </div>
                    </div>
                `;
            }
            
            content.innerHTML = `
                <div class="detail-section">
                    <h3>Basic Information</h3>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-label">Stitching Number</div>
                            <div class="detail-value">${record.stitching_invoice_number}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Created Date</div>
                            <div class="detail-value">${new Date(record.created_at).toLocaleString()}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Customer</div>
                            <div class="detail-value">${record.customer_name || 'N/A'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Fabric Item</div>
                            <div class="detail-value">${record.item_name}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Stitched Item</div>
                            <div class="detail-value">${record.stitched_item}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Yards Consumed</div>
                            <div class="detail-value">${record.yard_consumed.toFixed(2)}</div>
                        </div>
                    </div>
                </div>
                
                ${imageHtml}
                
                <div class="detail-section">
                    <h3>Size Quantities</h3>
                    <div class="size-quantities">
                        ${sizeQuantitiesHtml}
                    </div>
                </div>
                
                <div class="detail-section">
                    <h3>Pricing Information</h3>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-label">Unit Price</div>
                            <div class="detail-value">${record.price.toFixed(2)} THB</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Total Value</div>
                            <div class="detail-value">${record.total_value.toFixed(2)} THB</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">VAT Included</div>
                            <div class="detail-value">${record.add_vat ? 'Yes (7%)' : 'No'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Lining Cost</div>
                            <div class="detail-value">${record.total_lining_cost.toFixed(2)} THB</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Fabric Cost</div>
                            <div class="detail-value">${record.total_fabric_cost.toFixed(2)} THB</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Billing Status</div>
                            <div class="detail-value">${record.billing_group_id ? 'Billed' : 'Unbilled'}</div>
                        </div>
                    </div>
                </div>
                
                <div class="detail-section">
                    <h3>Lining Fabrics</h3>
                    <table style="width: 100%; border-collapse: collapse; background: var(--bg-tertiary); border-radius: 4px;">
                        <thead>
                            <tr style="background: var(--bg-secondary);">
                                <th style="padding: 8px; text-align: left; color: var(--text-primary);">Lining Name</th>
                                <th style="padding: 8px; text-align: left; color: var(--text-primary);">Consumption (yards)</th>
                                <th style="padding: 8px; text-align: left; color: var(--text-primary);">Unit Price (THB)</th>
                                <th style="padding: 8px; text-align: left; color: var(--text-primary);">Total Cost</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${liningFabricsHtml}
                        </tbody>
                    </table>
                </div>
                
                <div class="detail-section">
                    <h3>Additional Fabrics</h3>
                    <table style="width: 100%; border-collapse: collapse; background: var(--bg-tertiary); border-radius: 4px;">
                        <thead>
                            <tr style="background: var(--bg-secondary);">
                                <th style="padding: 8px; text-align: left; color: var(--text-primary);">Fabric Name</th>
                                <th style="padding: 8px; text-align: left; color: var(--text-primary);">Color</th>
                                <th style="padding: 8px; text-align: left; color: var(--text-primary);">Invoice</th>
                                <th style="padding: 8px; text-align: left; color: var(--text-primary);">Consumption (yards)</th>
                                <th style="padding: 8px; text-align: left; color: var(--text-primary);">Unit Price (THB)</th>
                                <th style="padding: 8px; text-align: left; color: var(--text-primary);">Total Cost</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${garmentFabricsHtml}
                        </tbody>
                    </table>
                </div>
                
                <div class="detail-section" id="amendFields" style="display: none;">
                    <h3>Amend Fields</h3>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-label">Stitched Item</div>
                            <input type="text" id="amendStitchedItem" value="${record.stitched_item}" style="width: 100%; padding: 8px; background: var(--bg-tertiary); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 4px;">
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Price (THB)</div>
                            <input type="number" id="amendPrice" value="${record.price}" step="0.01" min="0" style="width: 100%; padding: 8px; background: var(--bg-tertiary); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 4px;">
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Add VAT</div>
                            <input type="checkbox" id="amendAddVat" ${record.add_vat ? 'checked' : ''} style="width: 16px; height: 16px;">
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <h4>Size Quantities</h4>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <div class="detail-label">S</div>
                                <input type="number" id="amendSizeS" value="${sizeQty.S || 0}" min="0" style="width: 100%; padding: 8px; background: var(--bg-tertiary); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 4px;">
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">M</div>
                                <input type="number" id="amendSizeM" value="${sizeQty.M || 0}" min="0" style="width: 100%; padding: 8px; background: var(--bg-tertiary); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 4px;">
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">L</div>
                                <input type="number" id="amendSizeL" value="${sizeQty.L || 0}" min="0" style="width: 100%; padding: 8px; background: var(--bg-tertiary); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 4px;">
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">XL</div>
                                <input type="number" id="amendSizeXL" value="${sizeQty.XL || 0}" min="0" style="width: 100%; padding: 8px; background: var(--bg-tertiary); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 4px;">
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">XXL</div>
                                <input type="number" id="amendSizeXXL" value="${sizeQty.XXL || 0}" min="0" style="width: 100%; padding: 8px; background: var(--bg-tertiary); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 4px;">
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">XXXL</div>
                                <input type="number" id="amendSizeXXXL" value="${sizeQty.XXXL || 0}" min="0" style="width: 100%; padding: 8px; background: var(--bg-tertiary); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 4px;">
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <h4>Fabric Consumption</h4>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <div class="detail-label">Main Fabric Yards</div>
                                <input type="number" id="amendMainFabricConsumption" value="${record.yard_consumed}" step="0.01" min="0" style="width: 100%; padding: 8px; background: var(--bg-tertiary); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 4px;">
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <h4>Multi-Fabric Consumption</h4>
                        <div id="amendMultiFabricConsumption">
                            ${record.garment_fabrics ? record.garment_fabrics.map((fabric, index) => `
                                <div class="detail-item" style="margin-bottom: 10px;">
                                    <div class="detail-label">${fabric.fabric_name}</div>
                                    <input type="number" id="amendMultiFabric${index}" value="${fabric.consumption_yards}" step="0.01" min="0" style="width: 100%; padding: 8px; background: var(--bg-tertiary); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 4px;">
                                </div>
                            `).join('') : '<p style="color: var(--text-secondary);">No multi-fabrics found</p>'}
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <h4>Lining Consumption</h4>
                        <div id="amendLiningConsumption">
                            ${record.lining_fabrics ? record.lining_fabrics.map((lining, index) => `
                                <div class="detail-item" style="margin-bottom: 10px;">
                                    <div class="detail-label">${lining.lining_name}</div>
                                    <input type="number" id="amendLining${index}" value="${lining.consumption_yards}" step="0.01" min="0" style="width: 100%; padding: 8px; background: var(--bg-tertiary); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 4px;">
                                </div>
                            `).join('') : '<p style="color: var(--text-secondary);">No lining fabrics found</p>'}
                        </div>
                    </div>
                </div>
            `;
            
            // Reset amend mode when showing modal
            console.log('üîÑ Resetting amend mode to false when showing modal');
            isAmendMode = false;
            
            // Ensure amend fields are hidden initially
            const amendFields = document.getElementById('amendFields');
            if (amendFields) {
                amendFields.style.display = 'none';
                console.log('üìù Amend fields hidden on modal show');
            }
            
            modal.style.display = 'block';
            
            // Reset button states after modal is displayed
            setTimeout(() => {
                const amendButton = document.querySelector('button[onclick="toggleAmendMode()"]');
                const confirmButton = document.querySelector('button[onclick="confirmAmendStitchingRecord()"]');
                
                console.log('üîÑ Resetting button states after modal display');
                
                if (amendButton) {
                    amendButton.textContent = 'Amend';
                    amendButton.className = 'btn btn-warning';
                    console.log('üîò Reset amend button to: Amend');
                } else {
                    console.log('‚ùå Amend button not found');
                }
                
                if (confirmButton) {
                    confirmButton.style.display = 'none';
                    console.log('‚úÖ Hidden confirm button');
                } else {
                    console.log('‚ùå Confirm button not found');
                }
            }, 10);
        }

        function closeStitchingDetailModal() {
            const modal = document.getElementById('stitchingDetailModal');
            modal.style.display = 'none';
            currentStitchingRecord = null;
            isAmendMode = false;
        }
        
        function openImageModal(imageUrl, imageTitle) {
            const modal = document.getElementById('imageModal');
            const image = document.getElementById('fullSizeImage');
            const title = document.getElementById('imageModalTitle');
            
            image.src = imageUrl;
            title.textContent = imageTitle || 'Image';
            modal.style.display = 'block';
        }
        
        function closeImageModal() {
            const modal = document.getElementById('imageModal');
            modal.style.display = 'none';
        }
        
        function toggleAmendMode() {
            isAmendMode = !isAmendMode;
            const amendFields = document.getElementById('amendFields');
            const amendButton = document.querySelector('button[onclick="toggleAmendMode()"]');
            const confirmButton = document.querySelector('button[onclick="confirmAmendStitchingRecord()"]');
            
            console.log('üîÑ Toggling amend mode to:', isAmendMode);
            
            if (amendFields) {
                amendFields.style.display = isAmendMode ? 'block' : 'none';
                console.log('üìù Amend fields display set to:', amendFields.style.display);
            }
            
            if (amendButton) {
                amendButton.textContent = isAmendMode ? 'Cancel Amend' : 'Amend';
                amendButton.className = isAmendMode ? 'btn btn-secondary' : 'btn btn-warning';
                console.log('üîò Amend button text set to:', amendButton.textContent);
            }
            
            if (confirmButton) {
                confirmButton.style.display = isAmendMode ? 'inline-block' : 'none';
                console.log('‚úÖ Confirm button display set to:', confirmButton.style.display);
            }
        }

        function deleteStitchingRecord(recordId) {
            if (!recordId && currentStitchingRecord) {
                recordId = currentStitchingRecord.id;
            }
            
            if (!recordId) {
                alert('No record selected for deletion.');
                return;
            }
            
            const confirmMessage = `Are you sure you want to delete this stitching record?\n\nThis will:\n‚Ä¢ Revert fabric inventory changes\n‚Ä¢ Remove associated images\n‚Ä¢ Remove from packing lists (if any)\n‚Ä¢ Remove from group bills (if any)\n\nThis action cannot be undone.`;
            
            if (confirm(confirmMessage)) {
                fetch(`${getApiBaseUrl()}/api/stitching/${recordId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(errorData => {
                            throw new Error(errorData.error || 'Failed to delete record');
                        });
                    }
                    return response.json();
                })
                .then(result => {
                    if (result.message) {
                        alert(result.message);
                        closeStitchingDetailModal();
                        loadStitchingData(); // Refresh the table
                    } else {
                        alert('Error: ' + (result.error || 'Unknown error'));
                    }
                })
                .catch(error => {
                    alert('Error deleting stitching record: ' + error.message);
                });
            }
        }

        function deleteSelectedStitchingRecords() {
            if (selectedRows.length === 0) {
                alert('Please select one or more stitching records to delete.');
                return;
            }
            
            const selectedRecords = selectedRows.map(index => stitchingData[index]);
            const recordIds = selectedRecords.map(record => record.id);
            
            const confirmMessage = `Are you sure you want to delete ${selectedRecords.length} stitching record(s)?\n\nThis will:\n‚Ä¢ Revert fabric inventory changes\n‚Ä¢ Remove associated images\n‚Ä¢ Remove from packing lists (if any)\n‚Ä¢ Remove from group bills (if any)\n\nThis action cannot be undone.`;
            
            if (confirm(confirmMessage)) {
                fetch(`${getApiBaseUrl()}/api/stitching/bulk-delete`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ record_ids: recordIds })
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(errorData => {
                            throw new Error(errorData.error || 'Failed to delete records');
                        });
                    }
                    return response.json();
                })
                .then(result => {
                    if (result.message) {
                        alert(result.message);
                        selectedRows = []; // Clear selection
                        loadStitchingData(); // Refresh the table
                    } else {
                        alert('Error: ' + (result.error || 'Unknown error'));
                    }
                })
                .catch(error => {
                    alert('Error deleting stitching records: ' + error.message);
                });
            }
        }

        function viewImage(imageId) {
            // TODO: Implement image viewer
            alert('Image viewer will be implemented soon.');
        }

        function getApiBaseUrl() {
            const hostname = window.location.hostname;
            const port = window.location.port;
            const protocol = window.location.protocol;
            
            console.log('üîç getApiBaseUrl debug:', { hostname, port, protocol });
            
            // Local development - Flask backend runs on port 8000
            if (hostname === 'localhost' || hostname === '127.0.0.1') {
                // If frontend is on port 3000, backend should be on 8000
                if (port === '3000') {
                    return 'http://localhost:8000';
                }
                // If frontend is on port 5000, backend is on 8000
                if (port === '5000') {
                    return 'http://localhost:8000';
                }
                // Default to port 8000 for local development
                return 'http://localhost:8000';
            }
            
            // Railway deployment - force HTTPS
            if (hostname.includes('railway.app') || hostname.includes('up.railway.app')) {
                const httpsUrl = `https://${hostname}`;
                console.log('üöÄ Using Railway HTTPS URL:', httpsUrl);
                return httpsUrl;
            }
            
            // Other deployments - use same protocol and domain, but prefer HTTPS
            const origin = window.location.origin;
            if (protocol === 'https:') {
                return origin;
            } else {
                // Force HTTPS for production
                return origin.replace('http://', 'https://');
            }
        }



        function applyFilters() {
            loadStitchingData();
        }

        function clearFilters() {
            document.getElementById('filterPLNumber').value = '';
            document.getElementById('filterSerialNumber').value = '';
            document.getElementById('filterFabricName').value = '';
            document.getElementById('filterCustomer').value = '';
            document.getElementById('filterDateFrom').value = '';
            document.getElementById('filterDateTo').value = '';
            document.getElementById('showAllRecords').checked = true;
            loadStitchingData();
        }

        function refreshStitchingTable() {
            loadStitchingData();
        }

        function exportStitchingRecords() {
            // TODO: Implement export functionality
            alert('Export functionality will be implemented soon.');
        }



        function generatePackingList() {
            if (selectedRows.length === 0) {
                alert('Please select one or more stitching records to generate a packing list.');
                return;
            }
            
            // Get selected records
            const selectedRecords = selectedRows.map(index => stitchingData[index]);
            const stitchingIds = selectedRecords.map(record => record.id);
            
            // Create dialog for packing list options
            const dialogHtml = `
                <div id="packingListDialog" class="modal" style="display: block;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2 class="modal-title">Create Packing List</h2>
                            <span class="close" onclick="closePackingListDialog()">&times;</span>
                        </div>
                        <div class="modal-body">
                            <div style="margin-bottom: 15px;">
                                <label for="deliveryDate" style="display: block; margin-bottom: 5px; font-weight: bold;">Delivery Date:</label>
                                <input type="date" id="deliveryDate" value="${new Date().toISOString().split('T')[0]}" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); background: var(--bg-tertiary); color: var(--text-primary); border-radius: 4px;">
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label for="packingComments" style="display: block; margin-bottom: 5px; font-weight: bold;">Comments (optional):</label>
                                <textarea id="packingComments" placeholder="Enter any comments that will appear in the packing list header..." style="width: 100%; height: 80px; padding: 8px; border: 1px solid var(--border-color); background: var(--bg-tertiary); color: var(--text-primary); border-radius: 4px; resize: vertical;"></textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="closePackingListDialog()">Cancel</button>
                            <button class="btn btn-primary" onclick="confirmPackingListCreation()">Create Packing List</button>
                        </div>
                    </div>
                </div>
            `;
            
            // Add dialog to page
            document.body.insertAdjacentHTML('beforeend', dialogHtml);
            
            // Store selected IDs globally for later use
            window.selectedStitchingIds = stitchingIds;
        }
        
        function closePackingListDialog() {
            const dialog = document.getElementById('packingListDialog');
            if (dialog) {
                dialog.remove();
            }
            window.selectedStitchingIds = null;
        }
        
        function confirmPackingListCreation() {
            const deliveryDate = document.getElementById('deliveryDate').value;
            const comments = document.getElementById('packingComments').value.trim();
            
            if (!window.selectedStitchingIds) {
                alert('No stitching records selected.');
                return;
            }
            
            const packingListData = {
                stitching_ids: window.selectedStitchingIds,
                delivery_date: deliveryDate,
                comments: comments
            };
            
            // Call the packing list generation API
            fetch(`${getApiBaseUrl()}/api/packing-lists/generate`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(packingListData)
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(errorData => {
                        throw new Error(errorData.error || 'Failed to create packing list');
                    });
                }
                return response.json();
            })
            .then(result => {
                if (result.message) {
                    alert(result.message);
                    selectedRows = []; // Clear selection
                    loadStitchingData(); // Refresh the table
                    closePackingListDialog();
                } else {
                    alert('Error: ' + (result.error || 'Unknown error'));
                }
            })
            .catch(error => {
                alert('Error generating packing list: ' + error.message);
            });
        }

        function deleteSelectedRecords() {
            if (selectedRows.length === 0) {
                alert('Please select one or more stitching records to delete.');
                return;
            }
            
            if (confirm(`Are you sure you want to delete ${selectedRows.length} selected stitching record(s)?`)) {
                // TODO: Implement bulk delete
                alert('Bulk delete functionality will be implemented soon.');
            }
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const stitchingModal = document.getElementById('stitchingDetailModal');
            const imageModal = document.getElementById('imageModal');
            
            if (event.target === stitchingModal) {
                closeStitchingDetailModal();
            }
            
            if (event.target === imageModal) {
                closeImageModal();
            }
        }

        function logout() {
            localStorage.removeItem('gms_logged_in');
            localStorage.removeItem('gms_username');
            window.location.href = 'login.html';
        }

        // Theme Management
        function toggleTheme() {
            const html = document.documentElement;
            const themeIcon = document.getElementById('themeIcon');
            const themeText = document.getElementById('themeText');
            
            if (html.getAttribute('data-theme') === 'light') {
                // Switch to dark theme
                html.removeAttribute('data-theme');
                localStorage.setItem('theme', 'dark');
                themeIcon.textContent = 'üåô';
                themeText.textContent = 'Dark';
            } else {
                // Switch to light theme
                html.setAttribute('data-theme', 'light');
                localStorage.setItem('theme', 'light');
                themeIcon.textContent = '‚òÄÔ∏è';
                themeText.textContent = 'Light';
            }
            
            // Update any charts if they exist
            if (window.charts) {
                setTimeout(() => {
                    Object.values(window.charts).forEach(chart => {
                        if (chart && chart.update) {
                            chart.update('none');
                        }
                    });
                }, 100);
            }
        }

        function loadTheme() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            const html = document.documentElement;
            const themeIcon = document.getElementById('themeIcon');
            const themeText = document.getElementById('themeText');
            
            if (savedTheme === 'light') {
                html.setAttribute('data-theme', 'light');
                themeIcon.textContent = '‚òÄÔ∏è';
                themeText.textContent = 'Light';
            } else {
                html.removeAttribute('data-theme');
                themeIcon.textContent = 'üåô';
                themeText.textContent = 'Dark';
            }
        }

        // ===== TABLE SORTING FUNCTIONALITY =====
        
        // Initialize table sorter
        let tableSorter = null;

        // Custom data getter for stitching data
        function getStitchingValueForSorting(item, column) {
            switch (column) {
                case 'created_at':
                    return item.created_at;
                case 'packing_list_number':
                    return item.packing_list_number;
                case 'serial_number':
                    return item.serial_number;
                case 'garment':
                    return item.garment;
                case 'fabric':
                    return item.fabric;
                case 'color':
                    return item.color;
                case 'customer':
                    return item.customer;
                case 'tax_invoice_number':
                    return item.tax_invoice_number;
                case 'fabric_invoice':
                    return item.fabric_invoice;
                case 'fabric_delivery_note':
                    return item.fabric_delivery_note;
                case 'fabric_used':
                    return item.fabric_used;
                case 'fabric_cost':
                    return item.fabric_cost;
                case 'fabric_value':
                    return item.fabric_value;
                case 'size_s':
                    return item.size_s;
                case 'size_m':
                    return item.size_m;
                case 'size_l':
                    return item.size_l;
                case 'size_xl':
                    return item.size_xl;
                case 'size_xxl':
                    return item.size_xxl;
                case 'size_xxxl':
                    return item.size_xxxl;
                case 'total_qty':
                    return item.total_qty;
                case 'sewing_cost':
                    return item.sewing_cost;
                case 'sewing_price':
                    return item.price || 0;
                case 'sewing_profit':
                    return item.stitching_profit || 0;
                case 'sewing_value':
                    return item.total_value || 0;
                case 'sewing_earning':
                    return (item.stitching_profit || 0) * (item.total_qty || 0);
                case 'yards_per_piece':
                    return item.yards_per_piece;
                case 'garment_cost':
                    return item.garment_cost;
                default:
                    return '';
            }
        }

        // Initialize table sorter when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Load theme immediately to prevent flashing
            loadTheme();
            
            // Initialize table sorter
            tableSorter = createTableSorter('stitchingTreeview', {
                dataGetter: getStitchingValueForSorting
            });
            
            // Listen for sort events
            document.getElementById('stitchingTreeview').addEventListener('tableSorted', function(event) {
                const { data } = event.detail;
                stitchingData = data;
                populateStitchingTreeview();
            });
            
            console.log('‚úÖ Stitching table sorter initialized and ready');
        });

        // Override the loadStitchingData function to update table sorter
        const originalLoadStitchingData = loadStitchingData;
        loadStitchingData = async function() {
            await originalLoadStitchingData();
            
            // Initialize table sorter if not already done
            if (!tableSorter) {
                tableSorter = createTableSorter('stitchingTreeview', {
                    dataGetter: getStitchingValueForSorting
                });
                
                // Listen for sort events
                document.getElementById('stitchingTreeview').addEventListener('tableSorted', function(event) {
                    const { data } = event.detail;
                    stitchingData = data;
                    populateStitchingTreeview();
                });
                
                console.log('‚úÖ Stitching table sorter initialized after data load');
            }
            
            // Update table sorter with new data
            if (tableSorter && stitchingData && stitchingData.length > 0) {
                tableSorter.setData(stitchingData, getStitchingValueForSorting);
                console.log(`üíæ Updated stitching table sorter with ${stitchingData.length} records`);
            } else {
                console.log('‚ö†Ô∏è No stitching data available for table sorter');
            }
        }
    </script>
    <script src="js/table-sorting.js"></script>
</body>
</html>
